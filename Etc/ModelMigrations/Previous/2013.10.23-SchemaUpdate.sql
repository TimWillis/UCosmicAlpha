/*
Deployment script for UCosmicTest

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
PRINT N'Dropping FK_Agreements.Agreement_Agreements.Agreement_UmbrellaId...';


GO
ALTER TABLE [Agreements].[Agreement] DROP CONSTRAINT [FK_Agreements.Agreement_Agreements.Agreement_UmbrellaId];


GO
PRINT N'Dropping FK_Agreements.AgreementContact_Agreements.Agreement_AgreementId...';


GO
ALTER TABLE [Agreements].[AgreementContact] DROP CONSTRAINT [FK_Agreements.AgreementContact_Agreements.Agreement_AgreementId];


GO
PRINT N'Dropping FK_Agreements.AgreementFile_Agreements.Agreement_AgreementId...';


GO
ALTER TABLE [Agreements].[AgreementFile] DROP CONSTRAINT [FK_Agreements.AgreementFile_Agreements.Agreement_AgreementId];


GO
PRINT N'Dropping FK_Agreements.AgreementNode_Agreements.Agreement_AncestorId...';


GO
ALTER TABLE [Agreements].[AgreementNode] DROP CONSTRAINT [FK_Agreements.AgreementNode_Agreements.Agreement_AncestorId];


GO
PRINT N'Dropping FK_Agreements.AgreementNode_Agreements.Agreement_OffspringId...';


GO
ALTER TABLE [Agreements].[AgreementNode] DROP CONSTRAINT [FK_Agreements.AgreementNode_Agreements.Agreement_OffspringId];


GO
PRINT N'Dropping FK_Agreements.AgreementParticipant_Agreements.Agreement_AgreementId...';


GO
ALTER TABLE [Agreements].[AgreementParticipant] DROP CONSTRAINT [FK_Agreements.AgreementParticipant_Agreements.Agreement_AgreementId];


GO
PRINT N'Starting rebuilding table [Agreements].[Agreement]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [Agreements].[tmp_ms_xx_Agreement] (
    [Id]                    INT              IDENTITY (1, 1) NOT NULL,
    [Guid]                  UNIQUEIDENTIFIER NOT NULL,
    [UmbrellaId]            INT              NULL,
    [Title]                 NVARCHAR (500)   NOT NULL,
    [IsTitleDerived]        BIT              NOT NULL,
    [Name]                  NVARCHAR (500)   NULL,
    [Description]           NVARCHAR (MAX)   NULL,
    [Content]               NTEXT            NULL,
    [ContentSearchable]     NVARCHAR (MAX)   NULL,
    [Notes]                 NVARCHAR (MAX)   NULL,
    [Type]                  NVARCHAR (150)   NOT NULL,
    [IsAutoRenew]           BIT              NULL,
    [Status]                NVARCHAR (50)    NOT NULL,
    [StartsOn]              DATETIME         NOT NULL,
    [ExpiresOn]             DATETIME         NOT NULL,
    [IsExpirationEstimated] BIT              NOT NULL,
    [Visibility]            NVARCHAR (10)    NOT NULL,
    [CreatedOnUtc]          DATETIME         NOT NULL,
    [CreatedByPrincipal]    NVARCHAR (256)   NULL,
    [UpdatedOnUtc]          DATETIME         NULL,
    [UpdatedByPrincipal]    NVARCHAR (256)   NULL,
    [Version]               ROWVERSION       NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Agreements.Agreement] PRIMARY KEY CLUSTERED ([Id] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [Agreements].[Agreement])
    BEGIN
        SET IDENTITY_INSERT [Agreements].[tmp_ms_xx_Agreement] ON;
        INSERT INTO [Agreements].[tmp_ms_xx_Agreement] ([Id], [Guid], [UmbrellaId], [Title], [IsTitleDerived], [Name], [Description], [Content], [ContentSearchable], [Notes], [Type], [IsAutoRenew], [Status], [StartsOn], [ExpiresOn], [IsExpirationEstimated], [Visibility], [CreatedOnUtc], [CreatedByPrincipal], [UpdatedOnUtc], [UpdatedByPrincipal])
        SELECT   [Id],
                 [Guid],
                 [UmbrellaId],
                 [Title],
                 [IsTitleDerived],
                 [Name],
                 [Description],
                 [Content],
                 [Content],
                 [Notes],
                 [Type],
                 [IsAutoRenew],
                 [Status],
                 [StartsOn],
                 [ExpiresOn],
                 [IsExpirationEstimated],
                 [Visibility],
                 [CreatedOnUtc],
                 [CreatedByPrincipal],
                 [UpdatedOnUtc],
                 [UpdatedByPrincipal]
        FROM     [Agreements].[Agreement]
        ORDER BY [Id] ASC;
        SET IDENTITY_INSERT [Agreements].[tmp_ms_xx_Agreement] OFF;
    END

DROP TABLE [Agreements].[Agreement];

EXECUTE sp_rename N'[Agreements].[tmp_ms_xx_Agreement]', N'Agreement';

EXECUTE sp_rename N'[Agreements].[tmp_ms_xx_constraint_PK_Agreements.Agreement]', N'PK_Agreements.Agreement', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [Agreements].[Agreement].[IX_UmbrellaId]...';


GO
CREATE NONCLUSTERED INDEX [IX_UmbrellaId]
    ON [Agreements].[Agreement]([UmbrellaId] ASC);


GO
PRINT N'Creating FK_Agreements.Agreement_Agreements.Agreement_UmbrellaId...';


GO
ALTER TABLE [Agreements].[Agreement] WITH NOCHECK
    ADD CONSTRAINT [FK_Agreements.Agreement_Agreements.Agreement_UmbrellaId] FOREIGN KEY ([UmbrellaId]) REFERENCES [Agreements].[Agreement] ([Id]);


GO
PRINT N'Creating FK_Agreements.AgreementContact_Agreements.Agreement_AgreementId...';


GO
ALTER TABLE [Agreements].[AgreementContact] WITH NOCHECK
    ADD CONSTRAINT [FK_Agreements.AgreementContact_Agreements.Agreement_AgreementId] FOREIGN KEY ([AgreementId]) REFERENCES [Agreements].[Agreement] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_Agreements.AgreementFile_Agreements.Agreement_AgreementId...';


GO
ALTER TABLE [Agreements].[AgreementFile] WITH NOCHECK
    ADD CONSTRAINT [FK_Agreements.AgreementFile_Agreements.Agreement_AgreementId] FOREIGN KEY ([AgreementId]) REFERENCES [Agreements].[Agreement] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_Agreements.AgreementNode_Agreements.Agreement_AncestorId...';


GO
ALTER TABLE [Agreements].[AgreementNode] WITH NOCHECK
    ADD CONSTRAINT [FK_Agreements.AgreementNode_Agreements.Agreement_AncestorId] FOREIGN KEY ([AncestorId]) REFERENCES [Agreements].[Agreement] ([Id]);


GO
PRINT N'Creating FK_Agreements.AgreementNode_Agreements.Agreement_OffspringId...';


GO
ALTER TABLE [Agreements].[AgreementNode] WITH NOCHECK
    ADD CONSTRAINT [FK_Agreements.AgreementNode_Agreements.Agreement_OffspringId] FOREIGN KEY ([OffspringId]) REFERENCES [Agreements].[Agreement] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_Agreements.AgreementParticipant_Agreements.Agreement_AgreementId...';


GO
ALTER TABLE [Agreements].[AgreementParticipant] WITH NOCHECK
    ADD CONSTRAINT [FK_Agreements.AgreementParticipant_Agreements.Agreement_AgreementId] FOREIGN KEY ([AgreementId]) REFERENCES [Agreements].[Agreement] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Checking existing data against newly created constraints';


GO
ALTER TABLE [Agreements].[Agreement] WITH CHECK CHECK CONSTRAINT [FK_Agreements.Agreement_Agreements.Agreement_UmbrellaId];

ALTER TABLE [Agreements].[AgreementContact] WITH CHECK CHECK CONSTRAINT [FK_Agreements.AgreementContact_Agreements.Agreement_AgreementId];

ALTER TABLE [Agreements].[AgreementFile] WITH CHECK CHECK CONSTRAINT [FK_Agreements.AgreementFile_Agreements.Agreement_AgreementId];

ALTER TABLE [Agreements].[AgreementNode] WITH CHECK CHECK CONSTRAINT [FK_Agreements.AgreementNode_Agreements.Agreement_AncestorId];

ALTER TABLE [Agreements].[AgreementNode] WITH CHECK CHECK CONSTRAINT [FK_Agreements.AgreementNode_Agreements.Agreement_OffspringId];

ALTER TABLE [Agreements].[AgreementParticipant] WITH CHECK CHECK CONSTRAINT [FK_Agreements.AgreementParticipant_Agreements.Agreement_AgreementId];


GO
PRINT N'Update complete.';


GO
