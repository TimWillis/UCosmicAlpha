/*
Deployment script for UCosmicPreview

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
--:setvar DatabaseName "UCosmicPreview"
--:setvar DefaultFilePrefix "UCosmicPreview"
--:setvar DefaultDataPath "c:\Program Files\Microsoft SQL Server\MSSQL10.SQLEXPRESS\MSSQL\DATA\"
--:setvar DefaultLogPath "c:\Program Files\Microsoft SQL Server\MSSQL10.SQLEXPRESS\MSSQL\DATA\"

--GO
--:on error exit
--GO
--/*
--Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
--To re-enable the script after enabling SQLCMD mode, execute the following:
--SET NOEXEC OFF; 
--*/
--:setvar __IsSqlCmdEnabled "True"
--GO
--IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
--    BEGIN
--        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
--        SET NOEXEC ON;
--    END


--GO
USE [UCosmicPreview];


GO
PRINT N'Dropping FK_Employees.EmployeeModuleSettings_Establishments.Establishment_EstablishmentId...';


GO
ALTER TABLE [Employees].[EmployeeModuleSettings] DROP CONSTRAINT [FK_Employees.EmployeeModuleSettings_Establishments.Establishment_EstablishmentId];


GO
PRINT N'Dropping FK_Employees.EmployeeFacultyRank_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId...';


GO
ALTER TABLE [Employees].[EmployeeFacultyRank] DROP CONSTRAINT [FK_Employees.EmployeeFacultyRank_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId];


GO
PRINT N'Dropping FK_Employees.EmployeeModuleSettingsNotifyingAdmins_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId...';


GO
ALTER TABLE [Employees].[EmployeeModuleSettingsNotifyingAdmins] DROP CONSTRAINT [FK_Employees.EmployeeModuleSettingsNotifyingAdmins_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId];


GO
PRINT N'Creating [Representatives]...';


GO
CREATE SCHEMA [Representatives]
    AUTHORIZATION [dbo];


GO
PRINT N'Starting rebuilding table [Employees].[EmployeeModuleSettings]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [Employees].[tmp_ms_xx_EmployeeModuleSettings] (
    [Id]                         INT           IDENTITY (1, 1) NOT NULL,
    [NotifyAdminOnUpdate]        BIT           NOT NULL,
    [PersonalInfoAnchorText]     NVARCHAR (64) NULL,
    [OfferCountry]               BIT           NOT NULL,
    [OfferActivityType]          BIT           NOT NULL,
    [OfferFundingQuestions]      BIT           NOT NULL,
    [InternationalPedigreeTitle] NVARCHAR (64) NULL,
    [EstablishmentId]            INT           NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Employees.EmployeeModuleSettings] PRIMARY KEY CLUSTERED ([Id] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [Employees].[EmployeeModuleSettings])
    BEGIN
        SET IDENTITY_INSERT [Employees].[tmp_ms_xx_EmployeeModuleSettings] ON;
        INSERT INTO [Employees].[tmp_ms_xx_EmployeeModuleSettings] ([Id], [NotifyAdminOnUpdate], [PersonalInfoAnchorText], [OfferCountry], [OfferActivityType], [OfferFundingQuestions], [EstablishmentId])
        SELECT   [Id],
                 [NotifyAdminOnUpdate],
                 [PersonalInfoAnchorText],
                 [OfferCountry],
                 [OfferActivityType],
                 [OfferFundingQuestions],
                 [EstablishmentId]
        FROM     [Employees].[EmployeeModuleSettings]
        ORDER BY [Id] ASC;
        SET IDENTITY_INSERT [Employees].[tmp_ms_xx_EmployeeModuleSettings] OFF;
    END

DROP TABLE [Employees].[EmployeeModuleSettings];

EXECUTE sp_rename N'[Employees].[tmp_ms_xx_EmployeeModuleSettings]', N'EmployeeModuleSettings';

EXECUTE sp_rename N'[Employees].[tmp_ms_xx_constraint_PK_Employees.EmployeeModuleSettings]', N'PK_Employees.EmployeeModuleSettings', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [Employees].[EmployeeModuleSettings].[IX_EstablishmentId]...';


GO
CREATE NONCLUSTERED INDEX [IX_EstablishmentId]
    ON [Employees].[EmployeeModuleSettings]([EstablishmentId] ASC);


GO
PRINT N'Creating [Representatives].[RepModuleSettings]...';


GO
CREATE TABLE [Representatives].[RepModuleSettings] (
    [Id]             INT            IDENTITY (1, 1) NOT NULL,
    [WelcomeMessage] NTEXT          NULL,
    [EmailAddress]   NVARCHAR (MAX) NULL,
    [OwnerId]        INT            NOT NULL,
    CONSTRAINT [PK_Representatives.RepModuleSettings] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating FK_Employees.EmployeeModuleSettings_Establishments.Establishment_EstablishmentId...';


GO
ALTER TABLE [Employees].[EmployeeModuleSettings] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees.EmployeeModuleSettings_Establishments.Establishment_EstablishmentId] FOREIGN KEY ([EstablishmentId]) REFERENCES [Establishments].[Establishment] ([RevisionId]);


GO
PRINT N'Creating FK_Employees.EmployeeFacultyRank_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId...';


GO
ALTER TABLE [Employees].[EmployeeFacultyRank] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees.EmployeeFacultyRank_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId] FOREIGN KEY ([EmployeeModuleSettingsId]) REFERENCES [Employees].[EmployeeModuleSettings] ([Id]);


GO
PRINT N'Creating FK_Employees.EmployeeModuleSettingsNotifyingAdmins_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId...';


GO
ALTER TABLE [Employees].[EmployeeModuleSettingsNotifyingAdmins] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees.EmployeeModuleSettingsNotifyingAdmins_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId] FOREIGN KEY ([EmployeeModuleSettingsId]) REFERENCES [Employees].[EmployeeModuleSettings] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_Representatives.RepModuleSettings_Establishments.Establishment_OwnerId...';


GO
ALTER TABLE [Representatives].[RepModuleSettings] WITH NOCHECK
    ADD CONSTRAINT [FK_Representatives.RepModuleSettings_Establishments.Establishment_OwnerId] FOREIGN KEY ([OwnerId]) REFERENCES [Establishments].[Establishment] ([RevisionId]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_ActivitiesV2.Activity_People.Person_PersonId...';


GO
ALTER TABLE [ActivitiesV2].[Activity] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.Activity_People.Person_PersonId] FOREIGN KEY ([PersonId]) REFERENCES [People].[Person] ([RevisionId]);


GO
PRINT N'Creating FK_ActivitiesV2.ActivityLocation_ActivitiesV2.ActivityValues_ActivityValuesId...';


GO
ALTER TABLE [ActivitiesV2].[ActivityLocation] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.ActivityLocation_ActivitiesV2.ActivityValues_ActivityValuesId] FOREIGN KEY ([ActivityValuesId]) REFERENCES [ActivitiesV2].[ActivityValues] ([RevisionId]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_ActivitiesV2.ActivityLocation_Places.Place_PlaceId...';


GO
ALTER TABLE [ActivitiesV2].[ActivityLocation] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.ActivityLocation_Places.Place_PlaceId] FOREIGN KEY ([PlaceId]) REFERENCES [Places].[Place] ([RevisionId]);


GO
PRINT N'Creating FK_ActivitiesV2.ActivityTag_ActivitiesV2.Activity_ActivityId...';


GO
ALTER TABLE [ActivitiesV2].[ActivityTag] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.ActivityTag_ActivitiesV2.Activity_ActivityId] FOREIGN KEY ([ActivityId]) REFERENCES [ActivitiesV2].[Activity] ([RevisionId]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_ActivitiesV2.ActivityType_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId...';


GO
ALTER TABLE [ActivitiesV2].[ActivityType] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.ActivityType_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId] FOREIGN KEY ([EmployeeModuleSettingsId]) REFERENCES [Employees].[EmployeeModuleSettings] ([Id]);


GO
PRINT N'Creating FK_ActivitiesV2.ActivityValues_ActivitiesV2.Activity_ActivityId...';


GO
ALTER TABLE [ActivitiesV2].[ActivityValues] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.ActivityValues_ActivitiesV2.Activity_ActivityId] FOREIGN KEY ([ActivityId]) REFERENCES [ActivitiesV2].[Activity] ([RevisionId]) ON DELETE CASCADE;


GO
PRINT N'Creating FK_ActivitiesV2.ActivityValues_ActivitiesV2.ActivityType_TypeId...';


GO
ALTER TABLE [ActivitiesV2].[ActivityValues] WITH NOCHECK
    ADD CONSTRAINT [FK_ActivitiesV2.ActivityValues_ActivitiesV2.ActivityType_TypeId] FOREIGN KEY ([TypeId]) REFERENCES [ActivitiesV2].[ActivityType] ([Id]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
ALTER TABLE [Employees].[EmployeeModuleSettings] WITH CHECK CHECK CONSTRAINT [FK_Employees.EmployeeModuleSettings_Establishments.Establishment_EstablishmentId];

ALTER TABLE [Employees].[EmployeeFacultyRank] WITH CHECK CHECK CONSTRAINT [FK_Employees.EmployeeFacultyRank_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId];

ALTER TABLE [Employees].[EmployeeModuleSettingsNotifyingAdmins] WITH CHECK CHECK CONSTRAINT [FK_Employees.EmployeeModuleSettingsNotifyingAdmins_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId];

ALTER TABLE [Representatives].[RepModuleSettings] WITH CHECK CHECK CONSTRAINT [FK_Representatives.RepModuleSettings_Establishments.Establishment_OwnerId];

ALTER TABLE [ActivitiesV2].[Activity] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.Activity_People.Person_PersonId];

ALTER TABLE [ActivitiesV2].[ActivityLocation] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.ActivityLocation_ActivitiesV2.ActivityValues_ActivityValuesId];

ALTER TABLE [ActivitiesV2].[ActivityLocation] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.ActivityLocation_Places.Place_PlaceId];

ALTER TABLE [ActivitiesV2].[ActivityTag] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.ActivityTag_ActivitiesV2.Activity_ActivityId];

ALTER TABLE [ActivitiesV2].[ActivityType] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.ActivityType_Employees.EmployeeModuleSettings_EmployeeModuleSettingsId];

ALTER TABLE [ActivitiesV2].[ActivityValues] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.ActivityValues_ActivitiesV2.Activity_ActivityId];

ALTER TABLE [ActivitiesV2].[ActivityValues] WITH CHECK CHECK CONSTRAINT [FK_ActivitiesV2.ActivityValues_ActivitiesV2.ActivityType_TypeId];


GO
PRINT N'Update complete.';


GO
