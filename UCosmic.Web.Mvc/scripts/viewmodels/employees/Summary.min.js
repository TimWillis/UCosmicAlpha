var Employees;(function(n){(function(t){var u=function(){function n(){}return n.areEqual=function(n,t){if(!n&&!t)return!0;if(!n&&t||n&&!t)return!1;var i=!0;return n.pivot!=t.pivot&&(i=!1),n.placeId!=t.placeId&&(i=!1),i},n.isEmpty=function(n){return n?!n.pivot&&!n.placeId:!0},n.isIncomplete=function(n){return n?!n.pivot||!n.placeId:!0},n}(),i,f,r,e;t.SummaryRouteState=u,function(n){n[n.unknown=0]="unknown",n[n.people=1]="people",n[n.activities=2]="activities",n[n.degress=3]="degress"}(t.DataGraphPivot||(t.DataGraphPivot={})),i=t.DataGraphPivot,f=function(){function n(n,t){var i=this;this.hoverSrc=ko.observable(""),this.noHoverSrc=ko.observable(""),this._state=ko.observable("none"),this.isNoHover=ko.computed(function(){return i._state()=="none"}),this.isHover=ko.computed(function(){return i._state()=="hover"}),this.src=ko.computed(function(){return i.isHover()?i.hoverSrc():i.noHoverSrc()}),this.noHoverSrc(n||""),this.hoverSrc(t||"")}return n.prototype.onMouseEnter=function(){this._state("hover")},n.prototype.onMouseLeave=function(){this._state("none")},n}(),t.ImageSwapper=f,r=function(){function n(n){this.loader=n,this._promise=$.Deferred(),this._isLoading=!1}return n.prototype.ready=function(){var n=this;return this._isLoading||(this._isLoading=!0,this.loader().done(function(t){n.cached=t,n._promise.resolve(n.cached)}).fail(function(){n._promise.reject()})),this._promise},n}(),t.DataCacher=r,e=function(){function t(n){var u=this;this.settings=n,this._bindingsApplied=$.Deferred(),this.bindingsApplied=this._bindingsApplied,this.areBindingsApplied=ko.observable(!1),this.pivot=ko.observable(parseInt(sessionStorage.getItem(t._pivotKey))||t._pivotDefault),this._pivotChanged=ko.computed(function(){u._onPivotChanged()}),this.isPivotPeople=ko.computed(function(){return u.pivot()==i.people}),this.isPivotActivities=ko.computed(function(){return u.pivot()==i.activities}),this.placeId=ko.observable(parseInt(sessionStorage.getItem(t._placeIdKey))||t._placeIdDefault),this._placeIdChanged=ko.computed(function(){u._onPlaceIdChanged()}),this.hasPlaceId=ko.computed(function(){var n=u.placeId();return n&&n>1}),this.hasNoPlaceId=ko.computed(function(){return!u.hasPlaceId()}),this.routeState=ko.computed(function(){return{pivot:u.pivot(),placeId:u.placeId()}}),this._routeStateChanged=ko.computed(function(){u._onRouteStateChanged()}).extend({throttle:1}),this.hasPlaceData=ko.observable(!1),this.placeData=new r(function(){return u._loadPlaceData()}),this.activityTotals={personCount:ko.observable("?"),activityCount:ko.observable("?"),locationCount:ko.observable("?")},this.activityCountsData=new r(function(){return u._loadActivityCounts()}),this.selectedPlaceSummary={personCount:ko.observable("?"),activityCount:ko.observable("?"),locationCount:ko.observable("?")},this._placeSelected=ko.computed(function(){u._onPlaceSelected()}),this.geoChart=new App.Google.GeoChart(document.getElementById(this.settings.geoChart.googleElementId)),this.geoChartSpinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this.isGeoChartReady=ko.observable(!1),this._geoChartDataTable=this._newGeoChartDataTable(),this.activityTypeChart=new App.Google.ColumnChart(document.getElementById(this.settings.activityTypesChart.googleElementId)),this.isActivityTypeChartReady=ko.observable(!1),this._activityTypeChartDataTable=this._newActivityTypeChartDataTable(),this.activityTypes=ko.observableArray(),this.activityYearChart=new App.Google.LineChart(document.getElementById(this.settings.activityYearsChart.googleElementId)),this.isActivityYearChartReady=ko.observable(!1),this._activityYearChartDataTable=this._newActivityYearChartDataTable(),this.activityYears=ko.observableArray(),this.arePlaceOverlaysVisible=ko.computed(function(){var e=u.placeId(),r=u.isGeoChartReady(),o=u.isPlaceOverlaySelected?u.isPlaceOverlaySelected():!1,i,f,n;return r?(i=(e==1||o)&&r,t._isD3Defined()&&u.settings.geoChart.googleElementId&&(f="{0}_place_overlays_root".format(u.settings.geoChart.googleElementId),n=d3.select("#{0}".format(f)),n.length&&(i?n.attr("style",""):n.attr("style","display: none;"))),i):!1}),this.isPlaceOverlaySelected=ko.computed(function(){var r=u.placeId(),f=u.areBindingsApplied(),t=u.placeOverlays?u.placeOverlays():undefined,n,i;return!f||!t?!1:(n=!1,i=Enumerable.From(t).SingleOrDefault(undefined,function(n){return n.placeId==r}),i&&(n=!0),n)}),this.isD3Defined=ko.computed(function(){return t._isD3Defined()}),this.isD3Undefined=ko.computed(function(){return!t._isD3Defined()}),this._tooltips=ko.observableArray(),this._parsePlaceOverlays(),HistoryJS.Adapter.bind(window,"statechange",function(){u._onRouteChanged()}),this.activityCountsData.ready(),this._initGeoChart(),this._initActivityTypeChart(),this._initActivityYearChart(),this.bindingsApplied.done(function(){u._applyState()})}return t.loadGoogleVisualization=function(){return google.load("visualization","1",{packages:["corechart","geochart"]}),google.setOnLoadCallback(function(){t._googleVisualizationLoadedPromise.resolve()}),t._googleVisualizationLoadedPromise},t.prototype.applyBindings=function(){var n=this.settings.element;n&&ko.applyBindings(this,n),this.areBindingsApplied(!0),this._bindingsApplied.resolve()},t.prototype._onPivotChanged=function(){var n=this.pivot(),i=parseInt(sessionStorage.getItem(t._pivotKey))||0;n!==i&&sessionStorage.setItem(t._pivotKey,n.toString())},t.prototype.pivotPeople=function(){this.pivot(i.people)},t.prototype.pivotActivities=function(){this.pivot(i.activities)},t.prototype.isPivot=function(n){return this.pivot()==n},t.prototype._onPlaceIdChanged=function(){var n=this.placeId(),i=parseInt(sessionStorage.getItem(t._placeIdKey))||undefined;n!==i&&sessionStorage.setItem(t._placeIdKey,n.toString())},t.prototype._getUrlState=function(){var n=location.search.indexOf("?")==0?location.search.substr(1):location.search;return t._isD3Defined()||(n=location.hash.indexOf("#?")==0?location.hash.substr(2):""),App.deparam(n,!0)},t.prototype._onRouteStateChanged=function(){var n=this.routeState(),t=this._getUrlState(),i=this.areBindingsApplied();u.isIncomplete(t)||u.areEqual(n,t)?HistoryJS.replaceState(n,"","?"+$.param(n)):i?HistoryJS.pushState(n,"","?"+$.param(n)):this._updateState(t)},t.prototype._onRouteChanged=function(){var n=this._getUrlState();this._updateState(n),this._applyState()},t.prototype._updateState=function(n){this.pivot(n.pivot),this.placeId(n.placeId)},t.prototype._applyState=function(){this._drawGeoChart(),this._drawActivityTypeChart(),this._drawActivityYearChart()},t.prototype._loadPlaceData=function(){var i=this,t=$.Deferred(),r={countries:!0,placeIds:this._getOverlayPlaceIds(),placeAgnostic:!0};return this.geoChartSpinner.start(),n.Servers.EmployeesPlaces(this.settings.tenantDomain,r).done(function(n){i.hasPlaceData(n&&n.length>0),t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load employee location summary data.",!0),t.reject()}).always(function(){i.geoChartSpinner.stop()}),t},t.prototype._getPlaceById=function(n){return Enumerable.From(this.placeData.cached).FirstOrDefault(undefined,function(t){return t.placeId==n})},t.prototype._getPlaceByName=function(n){return Enumerable.From(this.placeData.cached).FirstOrDefault(undefined,function(t){return t.placeName==n})},t.prototype._loadActivityCounts=function(){var i=this,t=$.Deferred();return n.Servers.ActivityCounts(this.settings.tenantDomain).done(function(n){ko.mapping.fromJS(n,{},i.activityTotals),t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load activity total summary data.",!0),t.reject()}),t},t.prototype._onPlaceSelected=function(){var n=this,t=this.placeId(),i=this.areBindingsApplied();t!=1&&i?$.when(this.placeData.ready()).then(function(){var i=n._getPlaceById(t);n.selectedPlaceSummary.personCount(i.activityPersonIds.length.toString()),n.selectedPlaceSummary.activityCount(i.activityIds.length.toString()),n.selectedPlaceSummary.locationCount(i.placeName)}):i&&(this.selectedPlaceSummary.personCount("?"),this.selectedPlaceSummary.activityCount("?"),this.selectedPlaceSummary.locationCount("?"))},t.prototype.clearPlaceSelection=function(){this.placeId(1)},t.prototype._getGeoChartOptions=function(n){this._geoChartGradientLo||(this._geoChartGradientLo=$('<div class="charts-color-gradient-lo" />').hide().appendTo("body").css("color")||"#ccc"),this._geoChartGradientHi||(this._geoChartGradientHi=$('<div class="charts-color-gradient-hi" />').hide().appendTo("body").css("color")||"#333");var t={displayMode:"regions",region:"world",keepAspectRatio:this.settings.geoChart.keepAspectRatio?!0:!1,height:this.settings.geoChart.keepAspectRatio?480:500,colorAxis:{minValue:1,colors:[this._geoChartGradientLo,this._geoChartGradientHi]},backgroundColor:"#acccfd"};return n&&n.region&&(t.region=n.region),n&&(n.keepAspectRatio||n.keepAspectRatio==!1)&&(t.keepAspectRatio=n.keepAspectRatio),t},t.prototype._newGeoChartDataTable=function(){var n=new google.visualization.DataTable;return n.addColumn("string","Place"),n.addColumn("number","Total"),n},t.prototype._initGeoChart=function(){var n=this,t=$.Deferred();return this.isGeoChartReady()?t.resolve():this.geoChart.draw(this._geoChartDataTable,this._getGeoChartOptions()).then(function(){n.isGeoChartReady()||(n.isGeoChartReady(!0),n.bindingsApplied.done(function(){n._svgInjectPlaceOverlays(),google.visualization.events.addListener(n.geoChart.geoChart,"select",function(){n._onGeoChartSelect()}),google.visualization.events.addListener(n.geoChart.geoChart,"regionClick",function(t){n._onGeoChartRegionClick(t)})})),t.resolve()}),t},t.prototype._drawGeoChart=function(){var n=this,u=this.placeData.cached,f=!u,t=this.placeId(),i=this._getPlaceById(t),r=this._getGeoChartOptions();r.region=!t||t==1||!i||!i.countryCode?"world":i.countryCode,r.keepAspectRatio=t&&t>1&&i&&i.countryCode?!1:this.settings.geoChart.keepAspectRatio?!0:!1,this._initGeoChart().then(function(){n.placeData.ready().done(function(t){if(f){n._drawGeoChart();return}var i=n.isPivotPeople();n._geoChartDataTable.setColumnLabel(1,"Total {0}".format(i?"People":"Activities")),n._geoChartDataTable.removeRows(0,n._geoChartDataTable.getNumberOfRows()),$.each(t,function(t,r){if(r.placeId){var u=i?r.activityPersonIds.length:r.activityIds.length;n._geoChartDataTable.addRow([r.placeName,u])}}),n.geoChart.draw(n._geoChartDataTable,n._getGeoChartOptions(r)).then(function(){setTimeout(function(){n._svgInjectPlaceOverlays()},0),n._applyPlaceOverlayTotals(t),n._createOverlayTooltips()})})})},t.prototype._onGeoChartSelect=function(){var n=this.geoChart.geoChart.getSelection();if(n&&n.length){var i=n[0].row,r=this._geoChartDataTable.getFormattedValue(i,0),t=this._getPlaceByName(r);t&&this.placeId(t.placeId)}},t.prototype._onGeoChartRegionClick=function(){},t.prototype._getChartDataColor=function(){return this._chartDataColor||(this._chartDataColor=$('<div class="charts-color-dark" />').hide().appendTo("body").css("color")||"#333"),this._chartDataColor},t.prototype._getActivityTypeChartOptions=function(){return{animation:{duration:250},hAxis:{textPosition:"none"},vAxis:{textPosition:"none"},chartArea:{top:16,left:10,width:"100%",height:"75%"},legend:{position:"none"},isStacked:!0,series:[{type:"bars",color:this._getChartDataColor()},{type:"line",color:"black",lineWidth:0,pointSize:0,visibleInLegend:!1}]}},t.prototype._newActivityTypeChartDataTable=function(){var n=new google.visualization.DataTable;return n.addColumn("string","Activity Type"),n.addColumn("number","Count"),n.addColumn({type:"number",role:"annotation"}),n},t.prototype._initActivityTypeChart=function(){var n=this,t=$.Deferred();return this.isActivityTypeChartReady()?t.resolve():this.activityTypeChart.draw(this._activityTypeChartDataTable,this._getActivityTypeChartOptions()).then(function(){n.isActivityTypeChartReady()||(n.isActivityTypeChartReady(!0),n.bindingsApplied.done(function(){})),t.resolve()}),t},t.prototype._drawActivityTypeChart=function(){var n=this,t=this.placeData.cached,i=!t,r=this.placeId();this._initActivityTypeChart().then(function(){n.placeData.ready().done(function(){var u,t,r;if(i){n._drawActivityTypeChart();return}u=n.isPivotPeople(),n._activityTypeChartDataTable.removeRows(0,n._activityTypeChartDataTable.getNumberOfRows()),t=n._getActivityTypes(),n.activityTypes(t),$.each(t,function(t,i){var r=u?i.activityPersonIds.length:i.activityIds.length;n._activityTypeChartDataTable.addRow([i.text,r,r])}),r=new google.visualization.DataView(n._activityTypeChartDataTable),r.setColumns([0,1,1,2]),n.activityTypeChart.draw(r,n._getActivityTypeChartOptions()).then(function(){})})})},t.prototype._getActivityTypes=function(){var n=this.placeId(),t,i;return n==1&&(n=null),t=this.placeData.cached,i=Enumerable.From(t).Where(function(t){return n==null?!t.placeId:t.placeId==n}).SelectMany(function(n){return n.activityTypes}).Distinct(function(n){return n.activityTypeId}).OrderBy(function(n){return n.rank}).Select(function(n){return n.iconSrc=Routes.Api.Employees.Settings.ActivityTypes.icon(n.activityTypeId),n}).ToArray(),i},t.prototype._getActivityYearChartOptions=function(){return{animation:{duration:250},vAxis:{minValue:0},chartArea:{top:8,left:0,width:"100%",height:"60%"},legend:{position:"none"},colors:[this._getChartDataColor()]}},t.prototype._newActivityYearChartDataTable=function(){var n=new google.visualization.DataTable;return n.addColumn("string","Year"),n.addColumn("number","Count"),n},t.prototype._initActivityYearChart=function(){var n=this,t=$.Deferred();return this.isActivityYearChartReady()?t.resolve():this.activityYearChart.draw(this._activityYearChartDataTable,this._getActivityYearChartOptions()).then(function(){n.isActivityYearChartReady()||(n.isActivityYearChartReady(!0),n.bindingsApplied.done(function(){})),t.resolve()}),t},t.prototype._drawActivityYearChart=function(){var n=this,t=this.placeData.cached,i=!t,r=this.placeId();this._initActivityYearChart().then(function(){n.placeData.ready().done(function(){var r,t;if(i){n._drawActivityYearChart();return}r=n.isPivotPeople(),n._activityYearChartDataTable.removeRows(0,n._activityYearChartDataTable.getNumberOfRows()),t=n._getActivityYears(),n.activityYears(t),$.each(t,function(t,i){var u=r?i.activityPersonIds.length:i.activityIds.length;n._activityYearChartDataTable.addRow([i.year.toString(),u])}),n.activityYearChart.draw(n._activityYearChartDataTable,n._getActivityYearChartOptions()).then(function(){})})})},t.prototype._getActivityYears=function(){var n=this.placeId();n==1&&(n=null);var i=this.placeData.cached,t=(new Date).getFullYear(),r=t-10;return Enumerable.From(i).Where(function(t){return n==null?!t.placeId:t.placeId==n}).SelectMany(function(n){return n.years}).Distinct(function(n){return n.year}).OrderBy(function(n){return n.year}).Where(function(n){return n.year>=r&&n.year<=t}).ToArray()},t.prototype._parsePlaceOverlays=function(){var t=this,n;this.placeOverlays||(this.placeOverlays=ko.observableArray(),n=$("#{0} .overlays .places .data".format(this.settings.geoChart.boxElementId)).children(),$.each(n,function(n,i){var r=$(i),u={total:ko.observable(0),placeId:parseInt(r.data("place-id")),title:r.attr("title"),className:r.attr("class"),imageSwapper:new f(r.find("img.no-hover").first().attr("src"),r.find("img.hover").first().attr("src"))};t.placeOverlays.push(u)}))},t.prototype._getOverlayPlaceIds=function(){return Enumerable.From(this.placeOverlays()).Select(function(n){return n.placeId}).ToArray()},t.prototype.clickPlaceOverlay=function(n){var t=this._getPlaceById(n.placeId);if(t){if(!t.activityPersonIds.length)return;this.placeId(t.placeId)}},t._isD3Defined=function(){return typeof d3!="undefined"},t.prototype._svgInjectPlaceOverlays=function(){var f=this,n,i,u;if(t._isD3Defined()&&this.settings.geoChart.googleElementId&&this.settings.geoChart.boxElementId&&(n="{0}_place_overlays_root".format(this.settings.geoChart.googleElementId),!$("#{0}".format(n)).length)){var e=d3.select("#{0} svg > g".format(this.settings.geoChart.googleElementId)),r=e.append("g").attr("id",n),o=this.arePlaceOverlaysVisible();o||r.attr("style","display: none;"),i=$("#{0} .overlays .places .data".format(this.settings.geoChart.boxElementId)),i.show(),u=this.placeOverlays(),$.each(u,function(n,t){f._svgInjectPlaceOverlay(r,t)}),i.hide(),$("#{0} svg > g > g:last-child".format(this.settings.geoChart.googleElementId)).insertAfter("#{0} svg > g > g:nth-child(2)".format(this.settings.geoChart.googleElementId))}},t.prototype._svgInjectPlaceOverlay=function(n,t){var i=$("#{0} .overlays .places .data .{1}".format(this.settings.geoChart.boxElementId,t.className)),r=n.append("g").attr("class",t.className),u=i.position().left,f=i.position().top,e=i.outerWidth(),o=i.outerHeight(),s=r.append("image").attr("xlink:href",t.imageSwapper.noHoverSrc()).attr("x",u).attr("y",f).attr("width",e).attr("height",o).attr("class","no-hover"),h=r.append("image").attr("xlink:href",t.imageSwapper.hoverSrc()).attr("x",u).attr("y",f).attr("width",e).attr("height",o).attr("class","hover").attr("style","display: none;");return t.placeId==this.placeId()&&(h.attr("style",""),s.attr("style","display: none;")),this._svgApplyPlaceOverlayHover(t,s,h),r},t.prototype._svgApplyPlaceOverlayHover=function(n,t,i){var r=this;n.imageSwapper.isHover.subscribe(function(u){var f=r.placeId();if(f==n.placeId){i.attr("style",""),t.attr("style","display:none");return}u?(i.attr("style",""),t.attr("style","display:none")):(t.attr("style",""),i.attr("style","display:none"))}),this.placeId.subscribe(function(){var u=r.placeId();u==n.placeId?(i.attr("style",""),t.attr("style","display:none")):(t.attr("style",""),i.attr("style","display:none"))})},t.prototype._createOverlayTooltips=function(){var n=this,i=this._tooltips(),t;i.length&&($.each(this._tooltips(),function(n,t){t.tooltip("destroy")}),this._tooltips([])),t=this.placeOverlays(),$.each(t,function(t,i){var r=$("#{0} .overlays .places .ui .{1}".format(n.settings.geoChart.boxElementId,i.className)),u=r.find(".tooltip"),f=u.html()||"tooltip";n._createOverlayTooltip(r,f),n._tooltips.push(r)})},t.prototype._createOverlayTooltip=function(n,t){n.tooltip({content:t||"tooltip content goes here",items:"*",track:!0,show:!1,hide:!1,tooltipClass:"geochart",position:{my:"right-15 bottom-15",of:".ui-tooltip-content",within:"#{0}".format(this.settings.geoChart.googleElementId)},open:function(n,t){var i=t.tooltip.find(".ui-tooltip-content").outerWidth();t.tooltip.css({width:"{0}px".format(i)})}})},t.prototype._applyPlaceOverlayTotals=function(n){var t=this.isPivotPeople(),i=this.placeOverlays();$.each(i,function(i,r){var u=Enumerable.From(n).Where(function(n){return n.placeId==r.placeId}).Sum(function(n){return t?n.activityPersonIds.length:n.activityIds.length});r.total(u)})},t._googleVisualizationLoadedPromise=$.Deferred(),t._pivotDefault=i.activities,t._pivotKey="EmployeeSummaryPivot",t._placeIdDefault=1,t._placeIdKey="EmployeeSummaryPlaceId",t}(),t.Summary=e})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Employees||(Employees={}))