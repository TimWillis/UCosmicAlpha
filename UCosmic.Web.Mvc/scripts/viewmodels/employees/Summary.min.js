var Employees;(function(n){(function(t){var u=function(){function n(){}return n.areEqual=function(n,t){if(!n&&!t)return!0;if(!n&&t||n&&!t)return!1;var i=!0;return n.pivot!=t.pivot&&(i=!1),n.placeId!=t.placeId&&(i=!1),i},n.isEmpty=function(n){return n?!n.pivot&&!n.placeId:!0},n.isIncomplete=function(n){return n?!n.pivot||!n.placeId:!0},n}(),i,f,r,e;t.SummaryRouteState=u,function(n){n[n.unknown=0]="unknown",n[n.people=1]="people",n[n.activities=2]="activities",n[n.degress=3]="degress"}(t.DataGraphPivot||(t.DataGraphPivot={})),i=t.DataGraphPivot,f=function(){function n(n,t){var i=this;this.hoverSrc=ko.observable(""),this.noHoverSrc=ko.observable(""),this._state=ko.observable("none"),this.isNoHover=ko.computed(function(){return i._state()=="none"}),this.isHover=ko.computed(function(){return i._state()=="hover"}),this.src=ko.computed(function(){return i.isHover()?i.hoverSrc():i.noHoverSrc()}),this.noHoverSrc(n||""),this.hoverSrc(t||"")}return n.prototype.onMouseEnter=function(){this._state("hover")},n.prototype.onMouseLeave=function(){this._state("none")},n}(),t.ImageSwapper=f,r=function(){function n(n){this.loader=n,this._promise=$.Deferred()}return n.prototype.ready=function(){var n=this;return this.cached||this.loader().done(function(t){n.cached=t,n._promise.resolve(n.cached)}).fail(function(){n._promise.reject()}),this._promise},n}(),t.DataCacher=r,e=function(){function t(n){var u=this;this.settings=n,this._bindingsApplied=$.Deferred(),this.bindingsApplied=this._bindingsApplied,this.areBindingsApplied=ko.observable(!1),this.pivot=ko.observable(parseInt(sessionStorage.getItem(t._pivotKey))||t._pivotDefault),this._pivotChanged=ko.computed(function(){u._onPivotChanged()}),this.isPivotPeople=ko.computed(function(){return u.pivot()==i.people}),this.isPivotActivities=ko.computed(function(){return u.pivot()==i.activities}),this.placeId=ko.observable(parseInt(sessionStorage.getItem(t._placeIdKey))||t._placeIdDefault),this._placeIdChanged=ko.computed(function(){u._onPlaceIdChanged()}),this.hasPlaceId=ko.computed(function(){var n=u.placeId();return n&&n>1}),this.hasNoPlaceId=ko.computed(function(){return!u.hasPlaceId()}),this.routeState=ko.computed(function(){return{pivot:u.pivot(),placeId:u.placeId()}}),this._routeStateChanged=ko.computed(function(){u._onRouteStateChanged()}).extend({throttle:1}),this.hasPivotData=ko.observable(!1),this.activitiesPlaceData=new r(function(){return u._loadActivitiesPlaceData()}),this.peoplePlaceData=new r(function(){return u._loadPeoplePlaceData()}),this.geoChart=new App.Google.GeoChart(document.getElementById(this.settings.chart.googleElementId)),this.geoChartSpinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this.isGeoChartReady=ko.observable(!1),this._geoChartDataTable=this._newGeoChartDataTable(),this._geoChartOptions={displayMode:"regions",region:"world",keepAspectRatio:this.settings.chart.keepAspectRatio?!0:!1,height:this.settings.chart.keepAspectRatio?480:500,colorAxis:{minValue:1,colors:["#dceadc","#006400"]},backgroundColor:"#acccfd"},this.arePlaceOverlaysVisible=ko.computed(function(){var n=u.placeId(),f=u.isGeoChartReady(),r,e,i;return f?(r=(typeof n=="undefined"||n==null||isNaN(n)||n==1||n==0)&&f,t._isD3Defined()&&u.settings.chart.googleElementId&&(e="{0}_place_overlays_root".format(u.settings.chart.googleElementId),i=d3.select("#{0}".format(e)),i.length&&(r?i.attr("style",""):i.attr("style","display: none;"))),r):!1}),this.isD3Defined=ko.computed(function(){return t._isD3Defined()}),this.isD3Undefined=ko.computed(function(){return!t._isD3Defined()}),this._tooltips=ko.observableArray(),this.activitiesSummary={personCount:ko.observable("?"),activityCount:ko.observable("?"),locationCount:ko.observable("?")},this.activitiesSummaryData=new r(function(){return u._loadActivitiesSummary()}),this._parsePlaceOverlays(),HistoryJS.Adapter.bind(window,"statechange",function(){u._onRouteChanged()}),this.activitiesSummaryData.ready(),this._initGeoChart(),this.bindingsApplied.done(function(){u._applyState()})}return t.loadGoogleVisualization=function(){return google.load("visualization","1",{packages:["corechart","geochart"]}),google.setOnLoadCallback(function(){t._googleVisualizationLoadedPromise.resolve()}),t._googleVisualizationLoadedPromise},t.prototype.applyBindings=function(){var n=this.settings.element;n&&ko.applyBindings(this,n),this.areBindingsApplied(!0),this._bindingsApplied.resolve()},t.prototype._onPivotChanged=function(){var n=this.pivot(),i=parseInt(sessionStorage.getItem(t._pivotKey))||0;n!==i&&sessionStorage.setItem(t._pivotKey,n.toString())},t.prototype.pivotPeople=function(){this.pivot(i.people)},t.prototype.pivotActivities=function(){this.pivot(i.activities)},t.prototype.isPivot=function(n){return this.pivot()==n},t.prototype._onPlaceIdChanged=function(){var n=this.placeId(),i=parseInt(sessionStorage.getItem(t._placeIdKey))||undefined;n!==i&&sessionStorage.setItem(t._placeIdKey,n.toString())},t.prototype._getUrlState=function(){var n=location.search.indexOf("?")==0?location.search.substr(1):location.search;return App.deparam(n,!0)},t.prototype._onRouteStateChanged=function(){var n=this.routeState(),i=HistoryJS.getState().data,t=this._getUrlState();u.areEqual(n,t)||(u.isIncomplete(t)?HistoryJS.replaceState(n,"","?"+$.param(n)):u.isEmpty(i)?this._updateState(t):HistoryJS.pushState(n,"","?"+$.param(n)))},t.prototype._onRouteChanged=function(){var n=this._getUrlState();this._updateState(n),this._applyState()},t.prototype._updateState=function(n){this.pivot(n.pivot),this.placeId(n.placeId)},t.prototype._applyState=function(){this._drawGeoChart()},t.prototype._loadActivitiesPlaceData=function(){var i=this,t=$.Deferred(),r={countries:!0,placeIds:this._getOverlayPlaceIds()};return this.geoChartSpinner.start(),n.Servers.ActivitiesPlaces(this.settings.tenantDomain,r).done(function(n){i.hasPivotData(n&&n.length>0),t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load activity location summary data.",!0),t.reject()}).always(function(){i.geoChartSpinner.stop()}),t},t.prototype._loadPeoplePlaceData=function(){var i=this,t=$.Deferred(),r={countries:!0,placeIds:this._getOverlayPlaceIds()};return this.geoChartSpinner.start(),n.Servers.PeoplePlaces(this.settings.tenantDomain,r).done(function(n){i.hasPivotData(n&&n.length>0),t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load employee location summary data.",!0),t.reject()}).always(function(){i.geoChartSpinner.stop()}),t},t.prototype._getPlacesForEnumeration=function(){var n=this.isPivotActivities()?this.activitiesPlaceData:this.peoplePlaceData;return n?n.cached:undefined},t.prototype._getPlaceById=function(n){var t=this._getPlacesForEnumeration();return t?Enumerable.From(t).FirstOrDefault(undefined,function(t){return t.placeId==n}):undefined},t.prototype._getPlaceByName=function(n){var t=this._getPlacesForEnumeration();return t?Enumerable.From(t).FirstOrDefault(undefined,function(t){return t.placeName==n}):undefined},t.prototype._newGeoChartDataTable=function(){var n=new google.visualization.DataTable;return n.addColumn("string","Place"),n.addColumn("number","Total"),n},t.prototype._initGeoChart=function(){var n=this,t=$.Deferred();return this.isGeoChartReady()?t.resolve():this.geoChart.draw(this._geoChartDataTable,this._geoChartOptions).then(function(){n.isGeoChartReady()||(n.isGeoChartReady(!0),n.bindingsApplied.done(function(){n._svgInjectPlaceOverlays(),google.visualization.events.addListener(n.geoChart.geoChart,"select",function(){n._onGeoChartSelect()}),google.visualization.events.addListener(n.geoChart.geoChart,"regionClick",function(t){n._onGeoChartRegionClick(t)})})),t.resolve()}),t},t.prototype._drawGeoChart=function(){var n=this,u=this._getPlacesForEnumeration(),r=!u,t=this.placeId(),i=this._getPlaceById(t);this._geoChartOptions.region=!t||t==1||!i||!i.countryCode?"world":i.countryCode,this._geoChartOptions.keepAspectRatio=t&&t>1&&i&&i.countryCode?!1:this.settings.chart.keepAspectRatio?!0:!1,this._initGeoChart().then(function(){n.isPivotPeople()?n.peoplePlaceData.ready().done(function(t){if(r){n._drawGeoChart();return}n._geoChartDataTable.removeRows(0,n._geoChartDataTable.getNumberOfRows()),$.each(t,function(t,i){n._geoChartDataTable.addRow([i.placeName,i.personIds.length])}),n.geoChart.draw(n._geoChartDataTable,n._geoChartOptions).then(function(){setTimeout(function(){n._svgInjectPlaceOverlays()},0),n._geoChartDataTable.setColumnLabel(1,"Total {0}".format(n.isPivotPeople()?"People":"Activities")),n._applyPeopleOverlayTotals(t),n._createOverlayTooltips()})}):n.activitiesPlaceData.ready().done(function(t){if(r){n._drawGeoChart();return}n._geoChartDataTable.removeRows(0,n._geoChartDataTable.getNumberOfRows()),$.each(t,function(t,i){n._geoChartDataTable.addRow([i.placeName,i.activityIds.length])}),n.geoChart.draw(n._geoChartDataTable,n._geoChartOptions).then(function(){setTimeout(function(){n._svgInjectPlaceOverlays()},0),n._geoChartDataTable.setColumnLabel(1,"Total {0}".format(n.isPivotPeople()?"People":"Activities")),n._applyActivitiesOverlayTotals(t),n._createOverlayTooltips()})})})},t.prototype._onGeoChartSelect=function(){var n=this.geoChart.geoChart.getSelection();if(n&&n.length){var i=n[0].row,r=this._geoChartDataTable.getFormattedValue(i,0),t=this._getPlaceByName(r);t&&this.placeId(t.placeId)}},t.prototype._onGeoChartRegionClick=function(){},t.prototype._parsePlaceOverlays=function(){var t=this,n;this.placeOverlays||(this.placeOverlays=ko.observableArray(),n=$("#{0} .overlays .places .data".format(this.settings.chart.boxElementId)).children(),$.each(n,function(n,i){var r=$(i),u={total:ko.observable(0),placeId:parseInt(r.data("place-id")),title:r.attr("title"),className:r.attr("class"),imageSwapper:new f(r.find("img.no-hover").first().attr("src"),r.find("img.hover").first().attr("src"))};t.placeOverlays.push(u)}))},t.prototype._getOverlayPlaceIds=function(){return Enumerable.From(this.placeOverlays()).Select(function(n){return n.placeId}).ToArray()},t._isD3Defined=function(){return typeof d3!="undefined"},t.prototype._svgInjectPlaceOverlays=function(){var f=this,n,i,u;if(t._isD3Defined()&&this.settings.chart.googleElementId&&this.settings.chart.boxElementId&&(n="{0}_place_overlays_root".format(this.settings.chart.googleElementId),!$("#{0}".format(n)).length)){var e=d3.select("#{0} svg > g".format(this.settings.chart.googleElementId)),r=e.append("g").attr("id",n),o=this.arePlaceOverlaysVisible();o||r.attr("style","display: none;"),i=$("#{0} .overlays .places .data".format(this.settings.chart.boxElementId)),i.show(),u=this.placeOverlays(),$.each(u,function(n,t){f._svgInjectPlaceOverlay(r,t)}),i.hide(),$("#{0} svg > g > g:last-child".format(this.settings.chart.googleElementId)).insertAfter("#{0} svg > g > g:nth-child(2)".format(this.settings.chart.googleElementId))}},t.prototype._svgInjectPlaceOverlay=function(n,t){var i=$("#{0} .overlays .places .data .{1}".format(this.settings.chart.boxElementId,t.className)),r=n.append("g").attr("class",t.className),u=i.position().left,f=i.position().top,e=i.outerWidth(),o=i.outerHeight(),s=r.append("image").attr("xlink:href",t.imageSwapper.noHoverSrc()).attr("x",u).attr("y",f).attr("width",e).attr("height",o).attr("class","no-hover"),h=r.append("image").attr("xlink:href",t.imageSwapper.hoverSrc()).attr("x",u).attr("y",f).attr("width",e).attr("height",o).attr("class","hover").attr("style","display: none;");return this._svgApplyPlaceOverlayHover(t,s,h),r},t.prototype._svgApplyPlaceOverlayHover=function(n,t,i){n.imageSwapper.isHover.subscribe(function(n){n?(i.attr("style",""),t.attr("style","display:none")):(t.attr("style",""),i.attr("style","display:none"))})},t.prototype._createOverlayTooltips=function(){var n=this,i=this._tooltips(),t;i.length&&($.each(this._tooltips(),function(n,t){t.tooltip("destroy")}),this._tooltips([])),t=this.placeOverlays(),$.each(t,function(t,i){var r=$("#{0} .overlays .places .ui .{1}".format(n.settings.chart.boxElementId,i.className)),u=r.find(".tooltip"),f=u.html()||"tooltip";n._createOverlayTooltip(r,f),n._tooltips.push(r)})},t.prototype._createOverlayTooltip=function(n,t){n.tooltip({content:t||"tooltip content goes here",items:"*",track:!0,show:!1,hide:!1,tooltipClass:"geochart",position:{my:"right-15 bottom-15",of:".ui-tooltip-content",within:"#{0}".format(this.settings.chart.googleElementId)},open:function(n,t){var i=t.tooltip.find(".ui-tooltip-content").outerWidth();t.tooltip.css({width:"{0}px".format(i)})}})},t.prototype._applyActivitiesOverlayTotals=function(n){var t=this.placeOverlays();$.each(t,function(t,i){var r=Enumerable.From(n).Where(function(n){return n.placeId==i.placeId}).Sum(function(n){return n.activityIds.length});i.total(r)})},t.prototype._applyPeopleOverlayTotals=function(n){var t=this.placeOverlays();$.each(t,function(t,i){var r=Enumerable.From(n).Where(function(n){return n.placeId==i.placeId}).Sum(function(n){return n.personIds.length});i.total(r)})},t.prototype._loadActivitiesSummary=function(){var i=this,t=$.Deferred();return n.Servers.ActivitiesSummary(this.settings.tenantDomain).done(function(n){ko.mapping.fromJS(n,{},i.activitiesSummary),t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load activity total summary data.",!0),t.reject()}),t},t._googleVisualizationLoadedPromise=$.Deferred(),t._pivotDefault=i.activities,t._pivotKey="EmployeeSummaryPivot",t._placeIdDefault=1,t._placeIdKey="EmployeeSummaryPlaceId",t}(),t.Summary=e})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Employees||(Employees={}))