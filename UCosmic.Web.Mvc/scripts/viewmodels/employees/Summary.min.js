var Employees;(function(n){(function(t){var r,i,u,f;(function(n){n[n.unknown=0]="unknown",n[n.people=1]="people",n[n.activities=2]="activities",n[n.degress=3]="degress"})(t.DataGraphPivot||(t.DataGraphPivot={})),r=t.DataGraphPivot,i=function(){function n(){var n=this;this._state=ko.observable("up"),this.isUp=ko.computed(function(){return n._state()=="up"}),this.isHover=ko.computed(function(){return n._state()=="hover"})}return n.prototype.onMouseEnter=function(){this._state("hover")},n.prototype.onMouseLeave=function(){this._state("up")},n}(),t.ImageSwapper=i,u=function(){function n(n){this.loader=n,this._promise=$.Deferred()}return n.prototype.ready=function(){var n=this;return this._response||this.loader().done(function(t){n._response=t,n._promise.resolve(n._response)}).fail(function(){n._promise.reject()}),this._promise},n}(),t.DataCacher=u,f=function(){function t(n){var f=this;this.settings=n,this._bindingsApplied=$.Deferred(),this.bindingsApplied=this._bindingsApplied,this.areBindingsApplied=ko.observable(!1),this.pivot=ko.observable(parseInt(sessionStorage.getItem(t._pivotKey))||t._pivotDefault),this._pivotChanged=ko.computed(function(){f._onPivotChanged()}),this.isPivotPeople=ko.computed(function(){return f.pivot()==r.people}),this.isPivotActivities=ko.computed(function(){return f.pivot()==r.activities}),this.routeState=ko.computed(function(){return{pivot:f.pivot()}}),this._routeStateChanged=ko.computed(function(){f._onRouteStateChanged()}).extend({throttle:1}),this.activitiesPlaceData=new u(function(){return f._loadActivitiesPlaceData()}),this.peoplePlaceData=new u(function(){return f._loadPeoplePlaceData()}),this.geoChart=new App.Google.GeoChart(document.getElementById(this.settings.geoChartElementId)),this.geoChartSpinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this.isGeoChartReady=ko.observable(!1),this.isD3Undefined=ko.computed(function(){return!t._isD3Defined()}),this.pacificOceanSwapper=new i,this.gulfOfMexicoSwapper=new i,this.caribbeanSeaSwapper=new i,this.atlanticOceanSwapper=new i,this.southernOceanSwapper=new i,this.arcticOceanSwapper=new i,this.indianOceanSwapper=new i,this.antarcticaSwapper=new i,this.activitiesSummary={personCount:ko.observable("?"),activityCount:ko.observable("?"),locationCount:ko.observable("?")},this.activitiesSummaryData=new u(function(){return f._loadActivitiesSummary()}),HistoryJS.Adapter.bind(window,"statechange",function(){f._onRouteChanged()}),this.activitiesSummaryData.ready(),this._initGeoChart(),this.bindingsApplied.done(function(){f._applyState()})}return t.loadGoogleVisualization=function(){return google.load("visualization","1",{packages:["corechart","geochart"]}),google.setOnLoadCallback(function(){t._googleVisualizationLoadedPromise.resolve()}),t._googleVisualizationLoadedPromise},t.prototype.applyBindings=function(){var n=this.settings.element;n||(n=document.getElementById(this.settings.elementId)),ko.applyBindings(this,n),this.areBindingsApplied(!0),this._bindingsApplied.resolve()},t.prototype._onPivotChanged=function(){var n=this.pivot(),i=parseInt(sessionStorage.getItem(t._pivotKey))||0;n!==i&&sessionStorage.setItem(t._pivotKey,n.toString())},t.prototype.pivotPeople=function(){this.pivot(r.people)},t.prototype.pivotActivities=function(){this.pivot(r.activities)},t.prototype.isPivot=function(n){return this.pivot()==n},t.prototype._onRouteStateChanged=function(){var n=this.routeState(),t=HistoryJS.getState();t.data.pivot?HistoryJS.pushState(n,document.title,"?"+$.param(n)):HistoryJS.replaceState(n,document.title,"?"+$.param(n))},t.prototype._onRouteChanged=function(){var n=HistoryJS.getState(),t=n.data;this.pivot(t.pivot),this._applyState()},t.prototype._applyState=function(){this._drawGeoChart()},t.prototype._loadActivitiesPlaceData=function(){var i=this,t=$.Deferred();return this.geoChartSpinner.start(),n.Servers.ActivitiesPlaces(this.settings.tenantDomain,{countries:!0}).done(function(n){t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load activity location summary data.",!0),t.reject()}).always(function(){i.geoChartSpinner.stop()}),t},t.prototype._loadPeoplePlaceData=function(){var i=this,t=$.Deferred();return this.geoChartSpinner.start(),n.Servers.PeoplePlaces(this.settings.tenantDomain,{countries:!0}).done(function(n){t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load employee location summary data.",!0),t.reject()}).always(function(){i.geoChartSpinner.stop()}),t},t._geoChartOptions=function(n){return{displayMode:"regions",region:"world",keepAspectRatio:n.geoChartKeepAspectRatio?!0:!1,height:n.geoChartKeepAspectRatio?480:500,colorAxis:{minValue:1,colors:["#dceadc","#006400"]},backgroundColor:"#acccfd"}},t.prototype._newGeoChartDataTable=function(){var n=new google.visualization.DataTable;return n.addColumn("string","Place"),n.addColumn("number","Total {0}".format(this.isPivotPeople()?"People":"Activities")),n},t.prototype._initGeoChart=function(){var n=this,i=$.Deferred(),r,u;return this.isGeoChartReady()?i.resolve():(r=this._newGeoChartDataTable(),u=t._geoChartOptions(this.settings),this.geoChart.draw(r,u).then(function(){n.isGeoChartReady()||(n.isGeoChartReady(!0),n.bindingsApplied.done(function(){n._injectGeoChartOverlays()})),i.resolve()})),i},t.prototype._drawGeoChart=function(){var n=this,r=t._geoChartOptions(this.settings),i=this._newGeoChartDataTable();this._initGeoChart().then(function(){n.isPivotPeople()?n.peoplePlaceData.ready().done(function(t){$.each(t,function(n,t){i.addRow([t.placeName,t.personIds.length])}),n.geoChart.draw(i,r)}):n.activitiesPlaceData.ready().done(function(t){$.each(t,function(n,t){i.addRow([t.placeName,t.activityIds.length])}),n.geoChart.draw(i,r)})})},t._isD3Defined=function(){return typeof d3!="undefined"},t.prototype._injectGeoChartOverlays=function(){var i;if(t._isD3Defined()&&this.settings.geoChartWaterOverlaysElementId&&!$("#{0}_root".format(this.settings.geoChartWaterOverlaysElementId)).length){var r=d3.select("#{0} svg > g".format(this.settings.geoChartElementId)),u=r.append("g").attr("id","{0}_root".format(this.settings.geoChartWaterOverlaysElementId)),n=$("#{0}".format(this.settings.geoChartWaterOverlaysElementId));n.show(),i=n.children(),$.each(i,function(n,t){var i=u.append("g"),r=$(t);$.each($(t).children(),function(n,t){var u=$(t);if(u.prop("tagName").toUpperCase()==="IMG"){var e=r.position().left,o=r.position().top,s=u.css("width"),h=u.css("height"),c=u.attr("src"),f=u.css("display"),l=i.append("image").attr("xlink:href",c).attr("x",e).attr("y",o).attr("width",s).attr("height",h);f&&f.toLowerCase()=="none"&&l.attr("style","display: none;")}}),$.each($(i[0][0]).children(),function(n,t){var r=$(t),i=d3.select(t),f=r.css("display"),s=r.siblings("image"),h=f&&f.toLowerCase()=="none"?"mouseleave":"mouseenter",u,e,o;i.on(h,function(){r.hide(),s.show()});u=i.attr("xlink:href"),u&&u.toLowerCase().indexOf("caribbean")>0&&(e=i.attr("y"),o=parseInt(e)+5,i.attr("y",o))})}),n.hide(),$("#google_geochart svg > g > g:last-child").insertAfter("#google_geochart svg > g > g:nth-child(2)")}},t.prototype._loadActivitiesSummary=function(){var i=this,t=$.Deferred();return n.Servers.ActivitiesSummary(this.settings.tenantDomain).done(function(n){ko.mapping.fromJS(n,{},i.activitiesSummary),t.resolve(n)}).fail(function(n){App.Failures.message(n,"while trying to load activity total summary data.",!0),t.reject()}),t},t._googleVisualizationLoadedPromise=$.Deferred(),t._pivotDefault=r.activities,t._pivotKey="EmployeeSummaryPivot",t}(),t.Summary=f})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Employees||(Employees={}))