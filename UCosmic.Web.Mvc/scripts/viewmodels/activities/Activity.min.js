var ViewModels;(function(n){(function(n){var t=function(){function n(n){this.ready=ko.observable(!1),this.locations=ko.observableArray(),this.selectedLocations=ko.observableArray(),this.activityTypes=ko.observableArray(),this.newTag=ko.observable(),this.fileUploadErrors=ko.observableArray(),this.inititializationErrors="",this.AUTOSAVE_KEYCOUNT=10,this.keyCounter=0,this.dirtyFlag=ko.observable(!1),this.saving=!1,this._initialize(n)}return n.iconMaxSide=64,n.prototype._initialize=function(n){var t=this;this.id=ko.observable(n),this.dirty=ko.computed(function(){t.dirtyFlag()&&t.autoSave(t,null)})},n.prototype.dismissFileUploadError=function(n){this.fileUploadErrors.splice(n,1)},n.prototype.setupWidgets=function(n,t,i,r,u){var e=this,f;$("#"+n).kendoDatePicker({open:function(){this.options.format="MM/dd/yyyy"}}),$("#"+t).kendoDatePicker({open:function(){this.options.format="MM/dd/yyyy"}}),$("#"+i).kendoMultiSelect({filter:"contains",ignoreCase:"true",dataTextField:"officialName()",dataValueField:"id()",dataSource:this.locations(),change:function(n){e.updateLocations(n.sender.value())},placeholder:"[Select Country/Location, Body of Water or Global]"}),f=[],$("#"+r).kendoUpload({multiple:!0,showFileList:!1,localization:{select:"Choose one or more documents to share..."},async:{saveUrl:App.Routes.WebApi.Activities.Documents.post(this.id(),this.modeText())},select:function(n){for(var i,t=0;t<n.files.length;t++)i=n.files[t],$.ajax({async:!1,type:"POST",url:App.Routes.WebApi.Activities.Documents.validateUpload(),data:{fileName:i.name,length:i.size}}).fail(function(r){r.status===400&&($.inArray(n.files[t].name,f)<0&&f.push(i.name),e.fileUploadErrors.push({message:r.responseText}))})},upload:function(n){for(var i,t=0;t<n.files.length;t++)if(i=$.inArray(n.files[t].name,f),i>=0){n.preventDefault(),f.splice(i,1);return}},success:function(){e.loadDocuments()}}),$("#"+u).kendoAutoComplete({minLength:3,placeholder:"[Enter tag or keyword]",dataTextField:"officialName",dataSource:new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(n){$.ajax({url:App.Routes.WebApi.Establishments.get(),data:{keyword:n.data.filter.filters[0].value,pageNumber:1,pageSize:2147483647},success:function(t){n.success(t.items)}})}}}),select:function(n){var i=$("#"+u).data("kendoAutoComplete"),t=i.dataItem(n.item.index());e.newEstablishment={officialName:t.officialName,id:t.id}}})},n.prototype.setupValidation=function(){ko.validation.rules.atLeast={validator:function(n,t){return n.length>=t},message:"At least {0} must be selected."},ko.validation.rules.nullSafeDate={validator:function(n){var i=!0,t=null,r=new RegExp("^\\d{4}$"),u=new RegExp("^\\d{1,}/\\d{4}$"),f=new RegExp("^\\d{1,}/\\d{1,}/\\d{4}$");return n!=null&&n.length>0&&(n=$.trim(n),r.test(n)?(n="01/01/"+n,t="YYYY"):u.test(n)?t="MM/YYYY":f.test(n)&&(t="MM/DD/YYYY"),i=t!=null?moment(n,t).isValid():!1),i},message:"Date must be valid."},ko.validation.registerExtenders(),ko.validation.group(this.values),this.values.title.extend({required:!0,minLength:1,maxLength:200}),this.values.locations.extend({atLeast:1}),this.values.types.extend({atLeast:1}),this.values.startsOn.extend({nullSafeDate:{message:"Start date must valid."}}),this.values.endsOn.extend({nullSafeDate:{message:"End date must valid."}})},n.prototype.setupSubscriptions=function(){var n=this;this.values.title.subscribe(function(){n.dirtyFlag(!0)}),this.values.content.subscribe(function(t){n.keyCountAutoSave(t)}),this.values.startsOn.subscribe(function(){n.dirtyFlag(!0)}),this.values.endsOn.subscribe(function(){n.dirtyFlag(!0)}),this.values.onGoing.subscribe(function(){n.dirtyFlag(!0)}),this.values.wasExternallyFunded.subscribe(function(){n.dirtyFlag(!0)}),this.values.wasInternallyFunded.subscribe(function(){n.dirtyFlag(!0)}),this.values.types.subscribe(function(){n.dirtyFlag(!0)})},n.prototype.load=function(){var t=this,u=$.Deferred(),f=$.Deferred(),i,r;return $.get(App.Routes.WebApi.Activities.Locations.get()).done(function(n){f.resolve(n)}).fail(function(n,t,i){f.reject(n,t,i)}),i=$.Deferred(),$.get(App.Routes.WebApi.Employees.ModuleSettings.ActivityTypes.get()).done(function(n){i.resolve(n)}).fail(function(n,t,r){i.reject(n,t,r)}),r=$.Deferred(),$.ajax({type:"GET",url:App.Routes.WebApi.Activities.getEdit(this.id()),success:function(n){r.resolve(n)},error:function(n,t,i){r.reject(n,t,i)}}),$.when(i,f,r).done(function(i,r,f){var o,s,e;for(t.activityTypes=ko.mapping.fromJS(i),t.locations=ko.mapping.fromJS(r),o=function(t){ko.mapping.fromJS(t,{},this),this.proxyImageSource=ko.observable(App.Routes.WebApi.Activities.Documents.Thumbnail.get(t.activityId,t.id,{maxSide:n.iconMaxSide}))},s={documents:{create:function(n){return new o(n.data)}},startsOn:{create:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}},endsOn:{create:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}}},ko.mapping.fromJS(f,s,t),e=0;e<t.values.locations().length;e+=1)t.selectedLocations.push(t.values.locations()[e].placeId());for(e=0;e<t.activityTypes().length;e+=1)t.activityTypes()[e].checked=ko.computed(t.defHasActivityTypeCallback(e));u.resolve()}).fail(function(n,t,i){u.reject(n,t,i)}),u},n.prototype.keyCountAutoSave=function(){this.keyCounter+=1,this.keyCounter>this.AUTOSAVE_KEYCOUNT&&(this.dirtyFlag(!0),this.keyCounter=0)},n.prototype.getDateFormat=function(n){var t=null,i=new RegExp("^\\d{4}$"),r=new RegExp("^\\d{1,}/\\d{4}$"),u=new RegExp("^\\d{1,}/\\d{1,}/\\d{4}$");return n!=null&&n.length>0&&(n=$.trim(n),t=i.test(n)?"yyyy":r.test(n)?"MM/yyyy":"MM/dd/yyyy"),t},n.prototype.convertDate=function(n){var i=null,r=new RegExp("^\\d{4}$"),u=new RegExp("^\\d{1,}/\\d{4}$"),f=new RegExp("^\\d{1,}/\\d{1,}/\\d{4}$"),t;return typeof n=="object"?i=moment(n).format():(t=n,t!=null&&t.length>0&&(t=$.trim(t),r.test(t)?(t="01/01/"+t,i=moment(t,["MM/DD/YYYY"]).format()):u.test(t)?i=moment(t,["MM/YYYY"]).format():f.test(t)&&(i=moment(t,["MM/DD/YYYY"]).format()))),i},n.prototype.autoSave=function(n){var i=this,t,r;this.saving||this.dirtyFlag()&&(t=ko.mapping.toJS(this),t.values.startsOn!=null&&(r=$("#fromDatePicker").get(0).value,t.values.dateFormat=this.getDateFormat(r),t.values.startsOn=this.convertDate(t.values.startsOn)),this.values.onGoing!=null&&this.values.onGoing()?t.values.endsOn=null:t.values.endsOn!=null&&(t.values.endsOn=this.convertDate(t.values.endsOn)),this.saving=!0,$.ajax({type:"PUT",url:App.Routes.WebApi.Activities.put(n.id()),data:ko.toJSON(t),dataType:"json",contentType:"application/json",success:function(){i.saving=!1,i.dirtyFlag(!1)},error:function(n,t,r){i.saving=!1,i.dirtyFlag(!1),alert(t+"; "+r)}}))},n.prototype.save=function(n,t,i){var r=this;if(this.autoSave(n,t),!this.values.isValid()){this.values.errors.showAllMessages();return}while(this.saving)alert("Please wait while activity is saved.");this.saving=!0,$.ajax({async:!1,type:"PUT",url:App.Routes.WebApi.Activities.putEdit(n.id()),data:ko.toJSON(i),dataType:"json",contentType:"application/json",success:function(){r.saving=!1,r.dirtyFlag(!1)},error:function(n,t,i){r.saving=!1,r.dirtyFlag(!1),alert(t+"; "+i)}}),location.href=App.Routes.Mvc.My.Profile.get()},n.prototype.cancel=function(n){$("#cancelConfirmDialog").dialog({modal:!0,resizable:!1,width:450,buttons:{"Do not cancel":function(){$(this).dialog("close")},"Cancel and lose changes":function(){$.ajax({async:!1,type:"DELETE",url:App.Routes.WebApi.Activities.del(n.id()),dataType:"json",contentType:"application/json",success:function(){},error:function(n,t,i){alert(t+"; "+i)}}),$(this).dialog("close"),location.href=App.Routes.Mvc.My.Profile.get()}}})},n.prototype.addActivityType=function(n){var i=this.getActivityTypeIndexById(n),t;i==-1&&(t=ko.mapping.fromJS({id:0,typeId:n,version:""}),this.values.types.push(t))},n.prototype.removeActivityType=function(n){var t=this.getActivityTypeIndexById(n),i;t!=-1&&(i=this.values.types()[t],this.values.types.remove(i))},n.prototype.getTypeName=function(n){var t="",i=this.getActivityTypeIndexById(n);return i!=-1&&(t=this.activityTypes[i].type),t},n.prototype.getActivityTypeIndexById=function(n){var i=-1,t;if(this.values.types!=null&&this.values.types().length>0){for(t=0;t<this.values.types().length&&n!=this.values.types()[t].typeId();)t+=1;t<this.values.types().length&&(i=t)}return i},n.prototype.hasActivityType=function(n){return this.getActivityTypeIndexById(n)!=-1},n.prototype.defHasActivityTypeCallback=function(n){var t=this;return{read:function(){return t.hasActivityType(t.activityTypes()[n].id())},write:function(i){i?t.addActivityType(t.activityTypes()[n].id()):t.removeActivityType(t.activityTypes()[n].id())},owner:this}},n.prototype.updateLocations=function(n){var t,i;for(this.values.locations.removeAll(),t=0;t<n.length;t+=1)i=ko.mapping.fromJS({id:0,placeId:n[t],version:""}),this.values.locations.push(i);this.dirtyFlag(!0)},n.prototype.addTag=function(){var n=null,t="Custom",i=null,r=!1,u,f;this.newEstablishment==null?n=this.newTag():(n=this.newEstablishment.officialName,t="Establishment",i=this.newEstablishment.id,r=!0,this.newEstablishment=null),n=n!=null?$.trim(n):null,n==null||n.length==0||this.haveTag(n)||(u={id:0,number:0,text:n,domainTypeText:t,domainKey:i,modeText:this.modeText(),isInstitution:r},f=ko.mapping.fromJS(u),this.values.tags.push(f)),this.newTag(null),this.dirtyFlag(!0)},n.prototype.removeTag=function(n){this.values.tags.remove(n),this.dirtyFlag(!0)},n.prototype.haveTag=function(n){return this.tagIndex(n)!=-1},n.prototype.tagIndex=function(n){for(var t=0;t<this.values.tags().length&&n!=this.values.tags()[t].text();)t+=1;return this.values.tags().length>0&&t<this.values.tags().length?t:-1},n.prototype.loadDocuments=function(){var t=this;$.ajax({type:"GET",url:App.Routes.WebApi.Activities.Documents.get(this.id(),null,this.modeText()),dataType:"json",success:function(i){var f=function(t){ko.mapping.fromJS(t,{},this),this.proxyImageSource=ko.observable(App.Routes.WebApi.Activities.Documents.Thumbnail.get(t.activityId,t.id,{maxSide:n.iconMaxSide}))},e={create:function(n){return new f(n.data)}},u=ko.mapping.fromJS(i,e),r;for(t.values.documents.removeAll(),r=0;r<u().length;r+=1)t.values.documents.push(u()[r])},error:function(n,t,i){alert("Unable to update documents list. "+t+"|"+i)}})},n.prototype.deleteDocument=function(n,t){var i=this;$.ajax({type:"DELETE",url:App.Routes.WebApi.Activities.Documents.del(this.id(),n.id()),dataType:"json",success:function(){i.values.documents.splice(t,1)},error:function(n,t,i){alert("Unable to delete document. "+t+"|"+i)}})},n.prototype.startDocumentTitleEdit=function(n,t){var u=this,r=t.target,i;$(r).hide(),this.previousDocumentTitle=n.title(),i=$(r).siblings("#documentTitleInput")[0],$(i).show(),$(i).focusout(t,function(t){u.endDocumentTitleEdit(n,t)}),$(i).keypress(t,function(n){n.which==13&&i.blur()})},n.prototype.endDocumentTitleEdit=function(n,t){var r=this,i=t.target;$(i).unbind("focusout"),$(i).unbind("keypress"),$(i).attr("disabled","disabled"),$.ajax({type:"PUT",url:App.Routes.WebApi.Activities.Documents.rename(this.id(),n.id()),data:ko.toJSON(n.title()),contentType:"application/json",dataType:"json",success:function(){$(i).hide(),$(i).removeAttr("disabled");var n=$(i).siblings("#documentTitle")[0];$(n).show()},error:function(t){n.title(r.previousDocumentTitle),$(i).hide(),$(i).removeAttr("disabled");var u=$(i).siblings("#documentTitle")[0];$(u).show(),$("#documentRenameErrorDialog > #message")[0].innerText=t.responseText,$("#documentRenameErrorDialog").dialog({modal:!0,resizable:!1,width:400,buttons:{Ok:function(){$(this).dialog("close")}}})}})},n}();n.Activity=t})(n.Activities||(n.Activities={}));var t=n.Activities})(ViewModels||(ViewModels={}))