var Activities;(function(n){(function(n){var r=function(){function n(n,t){var i=this;this.ready=ko.observable(!1),this.activityId=ko.observable(),this.mode=ko.observable(),this.title=ko.observable(),this.content=ko.observable(),this.onGoing=ko.observable(),this.isExternallyFunded=ko.observable(),this.isInternallyFunded=ko.observable(),this.updatedByPrincipal=ko.observable(),this.updatedOnUtc=ko.observable(),this.isDraft=ko.computed(function(){var n=i.mode();return n?n.toLowerCase()=="draft":!1}),this.isPublished=ko.computed(function(){var n=i.mode();return n?n.toLowerCase()=="public":!1}),this.updatedOnDate=ko.computed(function(){var n=i.updatedOnUtc();return n?moment(n).format("M/D/YYYY"):undefined}),this._isDirty=ko.observable(!1),this._descriptionIsDirtyCurrent=0,this.saveSpinner=new App.Spinner(new App.SpinnerOptions(200)),this._isAutoSaving=!1,this._isSaved=!1,this._isDeleted=!1,this.selectedPlaces=ko.observableArray(),this.placeOptions=ko.observableArray(),this.kendoPlaceIds=ko.observableArray(),this.typeOptions=ko.observableArray(),this.selectedTypeIds=ko.observableArray(),this.tags=ko.observableArray(),this.newTag=ko.observable(),this.documents=ko.observableArray(),this.fileUploadErrors=ko.observableArray(),this._invalidFileNames=ko.observableArray([]),this._originalId=n,this._workCopyId=t,ko.computed(function(){i._isDirty()&&i._autoSave()})}return n.prototype.load=function(){var n=this,s=$.Deferred(),h=$.Deferred(),i,r,u,f,e,o;return $.get(App.Routes.WebApi.Activities.Locations.get()).done(function(n){h.resolve(n)}).fail(function(n){h.reject(n)}),i=$.Deferred(),$.get(App.Routes.WebApi.Employees.ModuleSettings.ActivityTypes.get()).done(function(n){i.resolve(n)}).fail(function(n){i.reject(n)}),r=$.Deferred(),$.ajax({url:$("#activity_get_url_format").text().format(this._workCopyId),cache:!1}).done(function(n){r.resolve(n)}).fail(function(n){r.reject(n)}),u=$.Deferred(),$.ajax({url:$("#places_get_url_format").text().format(this._workCopyId),cache:!1}).done(function(n){u.resolve(n)}).fail(function(n){u.reject(n)}),f=$.Deferred(),$.ajax({url:$("#types_get_url_format").text().format(this._workCopyId),cache:!1}).done(function(n){f.resolve(n)}).fail(function(n){f.reject(n)}),e=$.Deferred(),$.ajax({url:$("#tags_get_url_format").text().format(this._workCopyId),cache:!1}).done(function(n){e.resolve(n)}).fail(function(n){e.reject(n)}),o=$.Deferred(),$.ajax({url:$("#documents_get_url_format").text().format(this._workCopyId),cache:!1}).done(function(n){o.resolve(n)}).fail(function(n){o.reject(n)}),$.when(i,h,r,u,f,e,o).done(function(i,r,u,f,e,o,h){var c;ko.mapping.fromJS(u,{ignore:["startsOn","endsOn","startsFormat","endsFormat"]},n),n.startsOn=new t(u.startsOn,u.startsFormat),n.endsOn=new t(u.endsOn,u.endsFormat),ko.mapping.fromJS(r,{},n.placeOptions),n.selectedPlaces(f),c=Enumerable.From(f).Select(function(n){return n.placeId}).ToArray(),n.kendoPlaceIds(c.slice(0)),n._bindTypes(i,e),n.tags(o),ko.mapping.fromJS(h,{},n.documents),s.resolve()}).fail(function(n){s.reject(n)}),s},n.prototype.setupWidgets=function(n,t){$("#"+n).kendoDatePicker({value:this.startsOn.date(),format:this.startsOn.format(),open:function(){this.options.format="M/d/yyyy"}}),this.startsOn.kendoDatePicker=$("#"+n).data("kendoDatePicker"),$("#"+t).kendoDatePicker({value:this.endsOn.date(),format:this.endsOn.format(),open:function(){this.options.format="M/d/yyyy"}}),this.endsOn.kendoDatePicker=$("#"+t).data("kendoDatePicker"),this._initPlacesKendoMultiSelect(),this._initDocumentsKendoUpload(),this._initTagsKendoAutoComplete()},n.prototype.setupValidation=function(){ko.validation.rules.atLeast={validator:function(n,t){return n.length>=t},message:"At least {0} must be selected."},ko.validation.rules.formattedDate={validator:function(n,t){return t.isValid()},message:"Date is not valid."},ko.validation.registerExtenders(),ko.validation.group(this),this.title.extend({required:!0,minLength:1,maxLength:500}),this.selectedPlaces.extend({atLeast:1}),this.typeOptions().length&&this.selectedTypeIds.extend({atLeast:1}),this.startsOn.input.extend({formattedDate:{params:this.startsOn,message:"Start date is not valid."}}),this.endsOn.input.extend({formattedDate:{params:this.endsOn,message:"End date is not valid."}})},n.prototype.setupSubscriptions=function(){var n=this;this.title.subscribe(function(){n._isDirty(!0)}),this.content.subscribe(function(t){n._descriptionCheckIsDirty(t)}),this.startsOn.input.subscribe(function(){n._isDirty(!0)}),this.endsOn.input.subscribe(function(){n._isDirty(!0)}),this.onGoing.subscribe(function(){n._isDirty(!0)}),this.isExternallyFunded.subscribe(function(){n._isDirty(!0)}),this.isInternallyFunded.subscribe(function(){n._isDirty(!0)}),window.onbeforeunload=function(){if(n._hasData()||n._isDeleted)n._autoSave();else return"This activity currently has no data. If you continue, the activity will be kept and you can come back to add data later. If you intended to delete it, please stay on this page and click one of the 'Cancel' buttons provided instead."}},n.prototype._descriptionCheckIsDirty=function(){++this._descriptionIsDirtyCurrent,this._descriptionIsDirtyCurrent>=n._descriptionIsDirtyAfter&&(this._isDirty(!0),this._descriptionIsDirtyCurrent=0)},n.prototype._autoSave=function(){var i=this,t=$.Deferred();if(this._isSaved||this._isDeleted||this._isAutoSaving||!this._isDirty()&&this._descriptionIsDirtyCurrent==0)return t.resolve(),t;this.saveSpinner.start(),this._isAutoSaving=!0;var n=ko.mapping.toJS(this),r=$("#activity_put_url_format").text().format(this.activityId()),u={title:n.title,content:n.content,startsOn:this.startsOn.isoString(),startsFormat:this.startsOn.format(),onGoing:n.onGoing,endsOn:n.onGoing?undefined:this.endsOn.isoString(),endsFormat:n.onGoing?undefined:this.endsOn.format(),isExternallyFunded:n.isExternallyFunded,isInternallyFunded:n.isInternallyFunded};return $.ajax({type:"PUT",url:r,data:u}).done(function(){t.resolve()}).fail(function(n){t.reject(n)}).always(function(){i._isDirty(!1),i.saveSpinner.stop(),i._isAutoSaving=!1}),t},n.prototype._save=function(n){var t=this;this._autoSave().done(function(){if(!t.isValid()){t.errors.showAllMessages();return}t.saveSpinner.start();var i=$("#activity_replace_url_format").text().format(t._workCopyId,t._originalId,n);$.ajax({type:"PUT",url:i}).done(function(){t._isSaved=!0,location.href=App.Routes.Mvc.My.Profile.get()}).fail(function(n){App.Failures.message(n,"while trying to save your activity",!0)}).always(function(){t._isDirty(!1),t.saveSpinner.stop()})}).fail(function(n){App.Failures.message(n,"while trying to save your activity",!0)})},n.prototype.saveDraft=function(){this._save("Draft")},n.prototype.publish=function(){this._save("Public")},n.prototype.cancel=function(){var t=this,n=$("#cancelConfirmDialog");n.dialog({dialogClass:"jquery-ui no-close",closeOnEscape:!1,modal:!0,resizable:!1,width:450,buttons:[{text:"Cancel and lose changes",click:function(){var i=n.parents(".ui-dialog").find("button");$.each(i,function(){$(this).attr("disabled","disabled")}),n.find(".spinner").css("visibility",""),t._purge().done(function(){n.dialog("close"),location.href=App.Routes.Mvc.My.Profile.get()}).fail(function(n){App.Failures.message(n,"while trying to discard your activity edits",!0)}).always(function(){$.each(i,function(){$(this).removeAttr("disabled")}),n.find(".spinner").css("visibility","hidden")})}},{text:"Do not cancel",click:function(){n.dialog("close")},"data-css-link":!0}]})},n.prototype._purge=function(n){typeof n=="undefined"&&(n=!0);var i=this,t=$.Deferred(),r=$("#activity_delete_url_format").text().format(this.activityId());return $.ajax({type:"DELETE",url:r,async:n}).done(function(){i._isDeleted=!0,t.resolve()}).fail(function(n){t.reject(n)}).always(function(){t.always()}),t},n.prototype._hasData=function(){return this.title()||this.content()||this.onGoing()||this.startsOn.input()||this.endsOn.input()||this.isExternallyFunded()||this.isInternallyFunded()||this.selectedTypeIds().length||this.selectedPlaces().length||this.tags().length||this.documents().length},n.prototype._initPlacesKendoMultiSelect=function(){var n=this;$("#countrySelector").kendoMultiSelect({filter:"contains",ignoreCase:"true",dataTextField:"officialName()",dataValueField:"id()",dataSource:this.placeOptions(),value:this.kendoPlaceIds(),dataBound:function(t){n._currentPlaceIds=t.sender.value().slice(0)},change:function(t){n._onPlaceMultiSelectChange(t)},placeholder:"[Select Country/Location, Body of Water or Global]"})},n.prototype._onPlaceMultiSelectChange=function(n){var t=n.sender.value(),i=$(t).not(this._currentPlaceIds).get(),r=$(this._currentPlaceIds).not(t).get();i.length===1?this._addPlaceId(i[0],n):r.length===1&&this._removePlaceId(r[0],n)},n.prototype._addPlaceId=function(n,t){var i=this,r=$("#place_put_url_format").text().format(this.activityId(),n);$.ajax({type:"PUT",url:r,async:!1}).done(function(){i._currentPlaceIds.push(n);var r=Enumerable.From(t.sender.dataItems()).Single(function(t){return t.id()==n});i.selectedPlaces.push({activityId:i.activityId(),placeId:n,placeName:r.officialName()})}).fail(function(n){App.Failures.message(n,"while trying to add this location, please try again",!0);var r=i._currentPlaceIds.slice(0);t.sender.dataSource.filter({}),t.sender.value(r),i._currentPlaceIds=r})},n.prototype._removePlaceId=function(n,t){var i=this,r=$("#place_delete_url_format").text().format(this.activityId(),n);$.ajax({type:"DELETE",url:r,async:!1}).done(function(){var t=$.inArray(n,i._currentPlaceIds);i._currentPlaceIds.splice(t,1),i.selectedPlaces.remove(function(t){return t.placeId==n})}).fail(function(n){App.Failures.message(n,"while trying to remove this location, please try again",!0),t.sender.value(i._currentPlaceIds)})},n.prototype._bindTypes=function(n,t){var u=this,f=Enumerable.From(t).Select(function(n){return n.typeId}).ToArray(),r;this.selectedTypeIds(f),r={create:function(n){return new i(n,u)}},ko.mapping.fromJS(n,r,this.typeOptions)},n.prototype._initTagsKendoAutoComplete=function(){var n=this;$("#newTag").kendoAutoComplete({minLength:3,placeholder:"[Enter tag or keyword]",dataTextField:"text",dataSource:this._getTagAutoCompleteDataSource(),select:function(t){n._onTagAutoCompleteSelect(t)}})},n.prototype._getTagAutoCompleteDataSource=function(){return new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(n){$.ajax({url:$("#establishment_names_get_url_format").text(),data:{keyword:n.data.filter.filters[0].value,pageNumber:1,pageSize:250}}).done(function(t){n.success(t.items)}).fail(function(n){App.Failures.message(n,"while trying to search for tags",!0)})}}})},n.prototype._getTagEstablishmentId=function(n){var t,i=$("#establishment_names_get_url_format").text();return $.ajax({type:"GET",url:i,data:{keyword:n,keywordMatchStrategy:"Equals",pageNumber:1,pageSize:250},async:!1}).done(function(n){var i=Enumerable.From(n.items).Select(function(n){return n.ownerId}).Distinct().ToArray();i.length==1&&(t=i[0])}),t},n.prototype._onTagAutoCompleteSelect=function(n){var i=this,t=n.sender.dataItem(n.item.index());this._addOrReplaceTag(t.text,t.ownerId).done(function(){i.newTag(""),n.preventDefault(),n.sender.value(""),n.sender.element.focus()}).fail(function(n){App.Failures.message(n,"while trying to add this activity tag, please try again",!0)})},n.prototype.addTag=function(){var i=this,n=this.newTag(),t;n&&(n=$.trim(n)),t=this._getTagEstablishmentId(n),this._addOrReplaceTag(n,t).done(function(){i.newTag("")}).fail(function(n){App.Failures.message(n,"while trying to add this activity tag, please try again",!0)})},n.prototype.deleteTag=function(n){this._deleteTag(n.text).fail(function(n){App.Failures.message(n,"while trying to delete this activity tag, please try again",!0)})},n.prototype._addOrReplaceTag=function(n,t){var u=this,i=$.Deferred(),r;return n?(n=$.trim(n),r=Enumerable.From(this.tags()).SingleOrDefault(undefined,function(t){return t.text.toUpperCase()===n.toUpperCase()}),r?this._deleteTag(n).done(function(){u._postTag(n,t).done(function(){i.resolve()}).fail(function(n){i.reject(n)})}).fail(function(n){i.reject(n)}):this._postTag(n,t).done(function(){i.resolve()}).fail(function(n){i.reject(n)})):i.resolve(),i},n.prototype._postTag=function(n,t){var r=this,i=$.Deferred(),u=$("#tag_post_url_format").text().format(this.activityId());return $.ajax({url:u,type:"POST",data:{text:n,domainType:t?"Establishment":"Custom",domainKey:t}}).done(function(){var u={activityId:r.activityId(),text:n,domainType:t?"Establishment":"Custom",domainKey:t};r.tags.push(u),i.resolve()}).fail(function(n){i.reject(n)}),i},n.prototype._deleteTag=function(n){var i=this,t=$.Deferred(),r=$("#tag_delete_url_format").text().format(this.activityId());return $.ajax({url:r,type:"DELETE",data:{text:n}}).done(function(){var r=Enumerable.From(i.tags()).SingleOrDefault(undefined,function(t){return n&&t.text.toUpperCase()===n.toUpperCase()});r&&i.tags.remove(r),t.resolve()}).fail(function(n){t.reject(n)}),t},n.prototype._initDocumentsKendoUpload=function(){var n=this;$("#uploadFile").kendoUpload({multiple:!0,showFileList:!1,localization:{select:"Choose one or more documents to share..."},async:{saveUrl:$("#document_post_url_format").text().format(this.activityId())},select:function(t){n._onDocumentKendoSelect(t)},upload:function(t){n._onDocumentKendoUpload(t)},success:function(t){n._onDocumentKendoSuccess(t)},error:function(t){n._onDocumentKendoError(t)}})},n.prototype._onDocumentKendoSelect=function(n){for(var r=this,t,i=0;i<n.files.length;i++)t=n.files[i],$.ajax({async:!1,type:"POST",url:App.Routes.WebApi.Activities.Documents.validateUpload(),data:{name:t.name,length:t.size}}).fail(function(n){var u=Enumerable.From(r._invalidFileNames()).Any(function(n){return n==t.name}),i;u||r._invalidFileNames.push(t.name),i=n.status===400?n.responseText:App.Failures.message(n,"while trying to upload '{0}'".format(t.name)),r.fileUploadErrors.push({message:i})})},n.prototype._onDocumentKendoUpload=function(n){var t=n.files[0],i=Enumerable.From(this._invalidFileNames()).Any(function(n){return n==t.name});i&&(n.preventDefault(),this._invalidFileNames.remove(t.name))},n.prototype._onDocumentKendoSuccess=function(n){var t=this,i=n.XMLHttpRequest.getResponseHeader("location");$.get(i).done(function(n){var i=ko.mapping.fromJS(n);t.documents.push(i)})},n.prototype._onDocumentKendoError=function(n){var t=n.XMLHttpRequest.status!=500&&n.XMLHttpRequest.responseText&&n.XMLHttpRequest.responseText.length<1e3?n.XMLHttpRequest.responseText:App.Failures.message(n.XMLHttpRequest,"while uploading your document, please try again");this.fileUploadErrors.push({message:t})},n.prototype.documentIcon=function(t){var i=$("#document_icon_url_format").text().format(this.activityId(),t),r={maxSide:n.iconMaxSide};return"{0}?{1}".format(i,$.param(r))},n.prototype.deleteDocument=function(n,t){var r=this,i=$("#deleteDocumentConfirmDialog");i.dialog({dialogClass:"jquery-ui no-close",closeOnEscape:!1,width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm delete",click:function(){var u=i.parents(".ui-dialog").find("button");$.each(u,function(){$(this).attr("disabled","disabled")}),i.find(".spinner").css("visibility",""),$.ajax({type:"DELETE",url:App.Routes.WebApi.Activities.Documents.del(r.activityId(),n.id())}).done(function(){i.dialog("close"),r.documents.splice(t,1)}).fail(function(n){App.Failures.message(n,"while trying to delete your activity document",!0)}).always(function(){$.each(u,function(){$(this).removeAttr("disabled")}),i.find(".spinner").css("visibility","hidden")})}},{text:"No, cancel delete",click:function(){i.dialog("close")},"data-css-link":!0}]})},n.prototype.startDocumentTitleEdit=function(n,t){var u=this,r=t.target,i;$(r).hide(),this._previousDocumentTitle=n.title(),i=$(r).siblings("#documentTitleInput")[0],$(i).show(),$(i).focusout(t,function(t){u.endDocumentTitleEdit(n,t)}),$(i).keypress(t,function(n){n.which==13&&i.blur()})},n.prototype.endDocumentTitleEdit=function(n,t){var u=this,i=t.target,r;$(i).unbind("focusout"),$(i).unbind("keypress"),$(i).attr("disabled","disabled"),r=$("#document_put_url_format").text().format(this.activityId(),n.id()),$.ajax({type:"PUT",url:r,data:{title:n.title()},success:function(){$(i).hide(),$(i).removeAttr("disabled");var n=$(i).siblings("#documentTitle")[0];$(n).show()},error:function(t){n.title(u._previousDocumentTitle),$(i).hide(),$(i).removeAttr("disabled");var r=$(i).siblings("#documentTitle")[0];$(r).show(),$("#documentRenameErrorDialog > #message")[0].innerText=t.responseText,$("#documentRenameErrorDialog").dialog({modal:!0,resizable:!1,width:400,buttons:{Ok:function(){$(this).dialog("close")}}})}})},n.prototype.dismissFileUploadError=function(n){this.fileUploadErrors.splice(n,1)},n._descriptionIsDirtyAfter=10,n.iconMaxSide=64,n}(),i,t;n.Activity=r,i=function(){function n(n,t){var i=this,r;this.id=n.data.id,this.text=n.data.type,this._owner=t,r=Enumerable.From(this._owner.selectedTypeIds()).Any(function(n){return n==i.id}),this.checked=ko.observable(r),this.checked.subscribe(function(n){n?i._onChecked():i._onUnchecked()})}return n.prototype._onChecked=function(){var n=this,i=Enumerable.From(this._owner.selectedTypeIds()).All(function(t){return t!=n.id}),t;i&&(this._owner.saveSpinner.start(),t=$("#type_put_url_format").text().format(this._owner.activityId(),this.id),$.ajax({url:t,type:"PUT"}).done(function(){n._owner.selectedTypeIds.push(n.id),setTimeout(function(){n.checked(!0)},0)}).fail(function(t){App.Failures.message(t,"while trying to add this activity type, please try again",!0),setTimeout(function(){n.checked(!1)},0)}).always(function(){n._owner.saveSpinner.stop()}))},n.prototype._onUnchecked=function(){var n=this,i=Enumerable.From(this._owner.selectedTypeIds()).Any(function(t){return t==n.id}),t;i&&(this._owner.saveSpinner.start(),t=$("#type_delete_url_format").text().format(this._owner.activityId(),this.id),$.ajax({url:t,type:"DELETE"}).done(function(){n._owner.selectedTypeIds.remove(n.id),setTimeout(function(){n.checked(!1)},0)}).fail(function(t){App.Failures.message(t,"while trying to remove this activity type, please try again",!0),setTimeout(function(){n.checked(!0)},0)}).always(function(){n._owner.saveSpinner.stop()}))},n}(),n.ActivityTypeCheckBox=i,t=function(){function n(t,i){var r=this,u,f;(this.input=ko.observable(),this.format=ko.computed(function(){return r._computeDateFormat(r.input())}),this.date=ko.computed(function(){var n=r.input();return n?moment(n,[r.format().toUpperCase()]).toDate():undefined}),this.isoString=ko.computed(function(){var n=r.date();return n?moment(n).utc().hours(0).format():undefined}),t)&&(u=moment(t).toDate(),i=i||n._defaultFormat,f=moment(u).format(i.toUpperCase()),this.input(f),this.input.subscribe(function(n){var t=$.trim(n);t!=n&&r.input(t)}),this.format.subscribe(function(t){r.kendoDatePicker&&(r.kendoDatePicker.options.format=t||n._defaultFormat)}))}return n.prototype._computeDateFormat=function(t){return t?n._yyyy.test(t)?"yyyy":n._mYyyy.test(t)?"M/yyyy":n._mmYyyy.test(t)?"MM/yyyy":n._mDYyyy.test(t)?"M/d/yyyy":n._mmDYyyy.test(t)?"MM/d/yyyy":n._mDdYyyy.test(t)?"M/dd/yyyy":"MM/dd/yyyy":undefined},n.prototype.isValid=function(){var n=this.input(),t=this.format();return!n||moment(n,t).isValid()},n._defaultFormat="M/d/yyyy",n._yyyy=new RegExp("^\\d{4}$"),n._mYyyy=new RegExp("^\\d{1}/\\d{4}$"),n._mmYyyy=new RegExp("^\\d{2}/\\d{4}$"),n._mxYyyy=new RegExp("^\\d{1,}/\\d{4}$"),n._mDYyyy=new RegExp("^\\d{1}/\\d{1}/\\d{4}$"),n._mmDYyyy=new RegExp("^\\d{2}/\\d{1}/\\d{4}$"),n._mDdYyyy=new RegExp("^\\d{1}/\\d{2}/\\d{4}$"),n._mmDdYyyy=new RegExp("^\\d{2}/\\d{2}/\\d{4}$"),n._mxDxYyyy=new RegExp("^\\d{1,}/\\d{1,}/\\d{4}$"),n}(),n.FormattedDateInput=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Activities||(Activities={}))