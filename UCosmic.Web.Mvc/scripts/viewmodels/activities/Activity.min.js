var Activities;(function(n){(function(n){var i=function(){function n(n,t){this.ready=ko.observable(!1),this.AUTOSAVE_KEYCOUNT=10,this.keyCounter=0,this.dirtyFlag=ko.observable(!1),this.saving=!1,this.saveSpinner=new App.Spinner(new App.SpinnerOptions(200)),this.activityId=ko.observable(),this.mode=ko.observable(),this.title=ko.observable(),this.content=ko.observable(),this.startsOn=ko.observable(),this.startsFormat=ko.observable(),this.startsInput=ko.observable(),this.endsOn=ko.observable(),this.endsFormat=ko.observable(),this.endsInput=ko.observable(),this.onGoing=ko.observable(),this.isExternallyFunded=ko.observable(),this.isInternallyFunded=ko.observable(),this._yyyy=new RegExp("^\\d{4}$"),this._mYyyy=new RegExp("^\\d{1}/\\d{4}$"),this._mmYyyy=new RegExp("^\\d{2}/\\d{4}$"),this._mxYyyy=new RegExp("^\\d{1,}/\\d{4}$"),this._mDYyyy=new RegExp("^\\d{1}/\\d{1}/\\d{4}$"),this._mmDYyyy=new RegExp("^\\d{2}/\\d{1}/\\d{4}$"),this._mDdYyyy=new RegExp("^\\d{1}/\\d{2}/\\d{4}$"),this._mmDdYyyy=new RegExp("^\\d{2}/\\d{2}/\\d{4}$"),this._mxDxYyyy=new RegExp("^\\d{1,}/\\d{1,}/\\d{4}$"),this._isSaved=!1,this._isDeleted=!1,this.selectedPlaces=ko.observableArray(),this.placeOptions=ko.observableArray(),this.kendoPlaceIds=ko.observableArray(),this.typeOptions=ko.observableArray(),this.selectedTypeIds=ko.observableArray(),this.tags=ko.observableArray(),this.newTag=ko.observable(),this.fileUploadErrors=ko.observableArray(),this._initialize(n,t)}return n.prototype._initialize=function(n,t){var i=this;this.id=ko.observable(n),this.originalId=ko.observable(n),this.workCopyId=ko.observable(t),this.dirty=ko.computed(function(){i.dirtyFlag()&&i.autoSave()})},n.prototype.load=function(){var t=this,s=$.Deferred(),h=$.Deferred(),i,r,u,f,e,o;return $.get(App.Routes.WebApi.Activities.Locations.get()).done(function(n){h.resolve(n)}).fail(function(n){h.reject(n)}),i=$.Deferred(),$.get(App.Routes.WebApi.Employees.ModuleSettings.ActivityTypes.get()).done(function(n){i.resolve(n)}).fail(function(n){i.reject(n)}),r=$.Deferred(),$.get(App.Routes.WebApi.Activities.get(this.workCopyId())).done(function(n){r.resolve(n)}).fail(function(n){r.reject(n)}),u=$.Deferred(),$.get($("#activity_get_url_format").text().format(this.workCopyId())).done(function(n){u.resolve(n)}).fail(function(n){u.reject(n)}),f=$.Deferred(),$.get($("#places_get_url_format").text().format(this.workCopyId())).done(function(n){f.resolve(n)}).fail(function(n){f.reject(n)}),e=$.Deferred(),$.get($("#types_get_url_format").text().format(this.workCopyId())).done(function(n){e.resolve(n)}).fail(function(n){e.reject(n)}),o=$.Deferred(),$.get($("#tags_get_url_format").text().format(this.workCopyId())).done(function(n){o.resolve(n)}).fail(function(n){o.reject(n)}),$.when(i,h,r,u,f,e,o).done(function(i,r,u,f,e,o,h){var a=function(t){ko.mapping.fromJS(t,{},this),this.proxyImageSource=ko.observable(App.Routes.WebApi.Activities.Documents.Thumbnail.get(t.activityId,t.id,{maxSide:n.iconMaxSide}))},v={documents:{create:function(n){return new a(n.data)}},startsOn:{create:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}},endsOn:{create:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}}},c,l;ko.mapping.fromJS(u,v,t),c={startsOn:{update:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}},endsOn:{update:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}}},ko.mapping.fromJS(f,c,t),t.startsInput.subscribe(function(n){var r=$.trim(n),i,u;if(r!=n){t.startsInput(r);return}i="MM/dd/yyyy",n&&(i=t.getDateFormat(n)),t.startsFormat(i),$("#fromDatePicker").data("kendoDatePicker").options.format=t.startsFormat(),n?(u=moment(n,[i.toUpperCase()]).toDate(),t.startsOn(u)):t.startsOn(undefined)}),t.endsInput.subscribe(function(n){var r=$.trim(n),i,u;if(r!=n){t.endsInput(r);return}i="MM/dd/yyyy",n&&(i=t.getDateFormat(n)),t.endsFormat(i),$("#toDatePicker").data("kendoDatePicker").options.format=t.endsFormat(),n?(u=moment(n,[i.toUpperCase()]).toDate(),t.endsOn(u)):t.endsOn(undefined)}),t.placeOptions=ko.mapping.fromJS(r),t.selectedPlaces(e),l=Enumerable.From(e).Select(function(n){return n.placeId}).ToArray(),t.kendoPlaceIds(l.slice(0)),t._bindTypes(i,o),t.tags(h),s.resolve()}).fail(function(n){s.reject(n)}),s},n.prototype.setupWidgets=function(n,t,i,r,u){var f=this,e;$("#"+n).kendoDatePicker({value:this.startsOn(),format:this.startsFormat(),open:function(){this.options.format="M/d/yyyy"}}),$("#"+t).kendoDatePicker({value:this.endsOn(),format:this.endsFormat(),open:function(){this.options.format="M/d/yyyy"}}),$("#"+i).kendoMultiSelect({filter:"contains",ignoreCase:"true",dataTextField:"officialName()",dataValueField:"id()",dataSource:this.placeOptions(),value:this.kendoPlaceIds(),dataBound:function(n){f._onPlaceMultiSelectDataBound(n)},change:function(n){f._onPlaceMultiSelectChange(n)},placeholder:"[Select Country/Location, Body of Water or Global]"}),e=[],$("#"+r).kendoUpload({multiple:!0,showFileList:!1,localization:{select:"Choose one or more documents to share..."},async:{saveUrl:App.Routes.WebApi.Activities.Documents.post(this.id(),this.modeText())},select:function(n){for(var i,t=0;t<n.files.length;t++)i=n.files[t],$.ajax({async:!1,type:"POST",url:App.Routes.WebApi.Activities.Documents.validateUpload(),data:{name:i.name,length:i.size}}).fail(function(r){r.status===400&&($.inArray(n.files[t].name,e)<0&&e.push(i.name),f.fileUploadErrors.push({message:r.responseText}))})},upload:function(n){var i=n.files[0],t=$.inArray(i.name,e);if(t>=0){n.preventDefault(),e.splice(t,1);return}},success:function(){f._loadDocuments()},error:function(n){n.XMLHttpRequest.status!=500&&n.XMLHttpRequest.responseText&&n.XMLHttpRequest.responseText.length<1e3?f.fileUploadErrors.push({message:n.XMLHttpRequest.responseText}):f.fileUploadErrors.push({message:"UCosmic experienced an unexpected error uploading your document, please try again. If you continue to experience this issue, please use the Feedback & Support link on this page to report it."})}}),$("#"+u).kendoAutoComplete({minLength:3,placeholder:"[Enter tag or keyword]",dataTextField:"text",dataSource:this._getTagAutoCompleteDataSource(),select:function(n){f._onTagAutoCompleteSelect(n)}})},n.prototype.setupValidation=function(){var n=this;ko.validation.rules.atLeast={validator:function(n,t){return n.length>=t},message:"At least {0} must be selected."},ko.validation.rules.nullSafeDate={validator:function(t){if(!t)return!0;var i;return n._yyyy.test(t)?i="YYYY":n._mxYyyy.test(t)?i="M/YYYY":n._mxDxYyyy.test(t)&&(i="M/D/YYYY"),i&&moment(t,i).isValid()},message:"Date must be valid."},ko.validation.registerExtenders(),ko.validation.group(this.values),ko.validation.group(this),this.title.extend({required:!0,minLength:1,maxLength:500}),this.selectedPlaces.extend({atLeast:1}),this.typeOptions().length&&this.selectedTypeIds.extend({atLeast:1}),this.startsInput.extend({nullSafeDate:{message:"Start date is not valid."}}),this.endsInput.extend({nullSafeDate:{message:"End date is not valid."}})},n.prototype.setupSubscriptions=function(){var n=this;this.title.subscribe(function(){n.dirtyFlag(!0)}),this.content.subscribe(function(t){n.keyCountAutoSave(t)}),this.startsOn.subscribe(function(){n.dirtyFlag(!0)}),this.endsOn.subscribe(function(){n.dirtyFlag(!0)}),this.onGoing.subscribe(function(){n.dirtyFlag(!0)}),this.isExternallyFunded.subscribe(function(){n.dirtyFlag(!0)}),this.isInternallyFunded.subscribe(function(){n.dirtyFlag(!0)})},n.prototype.getDateFormat=function(n){var t=null;return n!=null&&n.length>0&&(n=$.trim(n),t=this._yyyy.test(n)?"yyyy":this._mYyyy.test(n)?"M/yyyy":this._mmYyyy.test(n)?"MM/yyyy":this._mDYyyy.test(n)?"M/d/yyyy":this._mmDYyyy.test(n)?"MM/d/yyyy":this._mDdYyyy.test(n)?"M/dd/yyyy":"MM/dd/yyyy"),t},n.prototype.convertDate=function(n){var i=null,t;return typeof n=="object"?i=moment(n).format():(t=n,t!=null&&t.length>0&&(t=$.trim(t),this._yyyy.test(t)?(t="01/01/"+t,i=moment(t,["MM/DD/YYYY"]).format()):i=moment(t,[this.getDateFormat(t).toUpperCase()]).format())),i},n.prototype.keyCountAutoSave=function(){this.keyCounter+=1,this.keyCounter>=this.AUTOSAVE_KEYCOUNT&&(this.dirtyFlag(!0),this.keyCounter=0)},n.prototype.autoSave=function(){var u=this,t=$.Deferred(),n,f,i,r,e;return this._isSaved||this._isDeleted||this.saving||!this.dirtyFlag()&&this.keyCounter==0?(t.resolve(),t):(this.saveSpinner.start(),this.saving=!0,n=ko.mapping.toJS(this),n.onGoing&&(n.endsOn=null),f=$("#activity_put_url_format").text().format(this.id()),i=this.startsOn(),i&&(i=moment(i).utc().hours(0).format()),r=this.endsOn(),r&&(r=moment(r).utc().hours(0).format()),e={mode:n.modeText,title:n.title,content:n.content,startsOn:i,endsOn:r,startsFormat:n.startsFormat,endsFormat:n.endsFormat,onGoing:n.onGoing,isExternallyFunded:n.isExternallyFunded,isInternallyFunded:n.isInternallyFunded},$.ajax({type:"PUT",url:f,data:e}).done(function(){t.resolve()}).fail(function(n){t.reject(n)}).always(function(){u.dirtyFlag(!1),u.saveSpinner.stop(),u.saving=!1}),t)},n.prototype._save=function(n){var t=this;this.autoSave().done(function(){if(!t.values.isValid()||!t.isValid()){t.values.errors.showAllMessages(),t.errors.showAllMessages();return}t.saveSpinner.start();var i=$("#activity_replace_url_format").text().format(t.workCopyId(),t.originalId(),n);$.ajax({type:"PUT",url:i}).done(function(){t._isSaved=!0,location.href=App.Routes.Mvc.My.Profile.get()}).fail(function(n){App.Failures.message(n,"while trying to save your activity",!0)}).always(function(){t.dirtyFlag(!1),t.saveSpinner.stop()})}).fail(function(n){App.Failures.message(n,"while trying to save your activity",!0)})},n.prototype.saveDraft=function(){this._save("Draft")},n.prototype.publish=function(){this._save("Public")},n.prototype.cancel=function(){var t=this,n=$("#cancelConfirmDialog");n.dialog({dialogClass:"jquery-ui no-close",closeOnEscape:!1,modal:!0,resizable:!1,width:450,buttons:[{text:"Cancel and lose changes",click:function(){var i=n.parents(".ui-dialog").find("button"),r;$.each(i,function(){$(this).attr("disabled","disabled")}),n.find(".spinner").css("visibility",""),r=$("#activity_delete_url_format").text().format(t.id()),$.ajax({type:"DELETE",url:r}).done(function(){n.dialog("close"),t._isDeleted=!0,location.href=App.Routes.Mvc.My.Profile.get()}).fail(function(n){App.Failures.message(n,"while trying to discard your activity edits",!0)}).always(function(){$.each(i,function(){$(this).removeAttr("disabled")}),n.find(".spinner").css("visibility","hidden")})}},{text:"Do not cancel",click:function(){n.dialog("close")},"data-css-link":!0}]})},n.prototype._onPlaceMultiSelectDataBound=function(n){this._currentPlaceIds=n.sender.value().slice(0)},n.prototype._onPlaceMultiSelectChange=function(n){var t=n.sender.value(),i=$(t).not(this._currentPlaceIds).get(),r=$(this._currentPlaceIds).not(t).get();i.length===1?this._addPlaceId(i[0],n):r.length===1&&this._removePlaceId(r[0],n)},n.prototype._addPlaceId=function(n,t){var i=this,r=$("#place_put_url_format").text().format(this.id(),n);$.ajax({type:"PUT",url:r,async:!1}).done(function(){i._currentPlaceIds.push(n);var r=Enumerable.From(t.sender.dataItems()).Single(function(t){return t.id()==n});i.selectedPlaces.push({activityId:i.id(),placeId:n,placeName:r.officialName()})}).fail(function(n){App.Failures.message(n,"while trying to add this location, please try again",!0);var r=i._currentPlaceIds.slice(0);t.sender.dataSource.filter({}),t.sender.value(r),i._currentPlaceIds=r})},n.prototype._removePlaceId=function(n,t){var i=this,r=$("#place_delete_url_format").text().format(this.id(),n);$.ajax({type:"DELETE",url:r,async:!1}).done(function(){var t=$.inArray(n,i._currentPlaceIds);i._currentPlaceIds.splice(t,1),i.selectedPlaces.remove(function(t){return t.placeId==n})}).fail(function(n){App.Failures.message(n,"while trying to remove this location, please try again",!0),t.sender.value(i._currentPlaceIds)})},n.prototype._bindTypes=function(n,i){var u=this,f=Enumerable.From(i).Select(function(n){return n.typeId}).ToArray(),r;this.selectedTypeIds(f),r={create:function(n){return new t(n,u)}},ko.mapping.fromJS(n,r,this.typeOptions)},n.prototype._getTagAutoCompleteDataSource=function(){return new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(n){$.ajax({url:$("#establishment_names_get_url_format").text(),data:{keyword:n.data.filter.filters[0].value,pageNumber:1,pageSize:250}}).done(function(t){n.success(t.items)}).fail(function(n){App.Failures.message(n,"while trying to search for tags",!0)})}}})},n.prototype._getTagEstablishmentId=function(n){var t,i=$("#establishment_names_get_url_format").text();return $.ajax({type:"GET",url:i,data:{keyword:n,keywordMatchStrategy:"Equals",pageNumber:1,pageSize:250},async:!1}).done(function(n){var i=Enumerable.From(n.items).Select(function(n){return n.ownerId}).Distinct().ToArray();i.length==1&&(t=i[0])}),t},n.prototype._onTagAutoCompleteSelect=function(n){var i=this,t=n.sender.dataItem(n.item.index());this._addOrReplaceTag(t.text,t.ownerId).done(function(){i.newTag(""),n.preventDefault(),n.sender.value(""),n.sender.element.focus()}).fail(function(n){App.Failures.message(n,"while trying to add this activity tag, please try again",!0)})},n.prototype.addTag=function(){var i=this,n=this.newTag(),t;n&&(n=$.trim(n)),t=this._getTagEstablishmentId(n),this._addOrReplaceTag(n,t).done(function(){i.newTag("")}).fail(function(n){App.Failures.message(n,"while trying to add this activity tag, please try again",!0)})},n.prototype.deleteTag=function(n){this._deleteTag(n.text).fail(function(n){App.Failures.message(n,"while trying to delete this activity tag, please try again",!0)})},n.prototype._addOrReplaceTag=function(n,t){var u=this,i=$.Deferred(),r;return n?(n=$.trim(n),r=Enumerable.From(this.tags()).SingleOrDefault(undefined,function(t){return t.text.toUpperCase()===n.toUpperCase()}),r?this._deleteTag(n).done(function(){u._postTag(n,t).done(function(){i.resolve()}).fail(function(n){i.reject(n)})}).fail(function(n){i.reject(n)}):this._postTag(n,t).done(function(){i.resolve()}).fail(function(n){i.reject(n)})):i.resolve(),i},n.prototype._postTag=function(n,t){var r=this,i=$.Deferred(),u=$("#tag_post_url_format").text().format(this.id());return $.ajax({url:u,type:"POST",data:{text:n,domainType:t?"Establishment":"Custom",domainKey:t}}).done(function(){var u={activityId:r.id(),text:n,domainType:t?"Establishment":"Custom",domainKey:t};r.tags.push(u),i.resolve()}).fail(function(n){i.reject(n)}),i},n.prototype._deleteTag=function(n){var i=this,t=$.Deferred(),r=$("#tag_delete_url_format").text().format(this.id());return $.ajax({url:r,type:"DELETE",data:{text:n}}).done(function(){var r=Enumerable.From(i.tags()).SingleOrDefault(undefined,function(t){return n&&t.text.toUpperCase()===n.toUpperCase()});r&&i.tags.remove(r),t.resolve()}).fail(function(n){t.reject(n)}),t},n.prototype._loadDocuments=function(){var t=this,i=$("#documents_get_url_format").text().format(this.id());$.ajax({type:"GET",url:i}).done(function(i){var f=function(t){ko.mapping.fromJS(t,{},this),this.proxyImageSource=ko.observable(App.Routes.WebApi.Activities.Documents.Thumbnail.get(t.activityId,t.id,{maxSide:n.iconMaxSide}))},e={create:function(n){return new f(n.data)}},u=ko.mapping.fromJS(i,e),r;for(t.values.documents.removeAll(),r=0;r<u().length;r+=1)t.values.documents.push(u()[r])}).fail(function(n){App.Failures.message(n,"while trying to load your activity documents",!0)})},n.prototype.deleteDocument=function(n,t){var r=this,i=$("#deleteDocumentConfirmDialog");i.dialog({dialogClass:"jquery-ui no-close",closeOnEscape:!1,width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm delete",click:function(){var u=i.parents(".ui-dialog").find("button");$.each(u,function(){$(this).attr("disabled","disabled")}),i.find(".spinner").css("visibility",""),$.ajax({type:"DELETE",url:App.Routes.WebApi.Activities.Documents.del(r.id(),n.id())}).done(function(){i.dialog("close"),r.values.documents.splice(t,1)}).fail(function(n){App.Failures.message(n,"while trying to delete your activity document",!0)}).always(function(){$.each(u,function(){$(this).removeAttr("disabled")}),i.find(".spinner").css("visibility","hidden")})}},{text:"No, cancel delete",click:function(){i.dialog("close")},"data-css-link":!0}]})},n.prototype.startDocumentTitleEdit=function(n,t){var u=this,r=t.target,i;$(r).hide(),this.previousDocumentTitle=n.title(),i=$(r).siblings("#documentTitleInput")[0],$(i).show(),$(i).focusout(t,function(t){u.endDocumentTitleEdit(n,t)}),$(i).keypress(t,function(n){n.which==13&&i.blur()})},n.prototype.endDocumentTitleEdit=function(n,t){var u=this,i=t.target,r;$(i).unbind("focusout"),$(i).unbind("keypress"),$(i).attr("disabled","disabled"),r=$("#document_put_url_format").text().format(this.id(),n.id()),$.ajax({type:"PUT",url:r,data:{title:n.title()},success:function(){$(i).hide(),$(i).removeAttr("disabled");var n=$(i).siblings("#documentTitle")[0];$(n).show()},error:function(t){n.title(u.previousDocumentTitle),$(i).hide(),$(i).removeAttr("disabled");var r=$(i).siblings("#documentTitle")[0];$(r).show(),$("#documentRenameErrorDialog > #message")[0].innerText=t.responseText,$("#documentRenameErrorDialog").dialog({modal:!0,resizable:!1,width:400,buttons:{Ok:function(){$(this).dialog("close")}}})}})},n.prototype.dismissFileUploadError=function(n){this.fileUploadErrors.splice(n,1)},n.iconMaxSide=64,n}(),t;n.Activity=i,t=function(){function n(n,t){var i=this,r;this.id=n.data.id,this.text=n.data.type,this._owner=t,r=Enumerable.From(this._owner.selectedTypeIds()).Any(function(n){return n==i.id}),this.checked=ko.observable(r),this.checked.subscribe(function(n){n?i._onChecked():i._onUnchecked()})}return n.prototype._onChecked=function(){var n=this,i=Enumerable.From(this._owner.selectedTypeIds()).All(function(t){return t!=n.id}),t;i&&(this._owner.saveSpinner.start(),t=$("#type_put_url_format").text().format(this._owner.id(),this.id),$.ajax({url:t,type:"PUT"}).done(function(){n._owner.selectedTypeIds.push(n.id),setTimeout(function(){n.checked(!0)},0)}).fail(function(t){App.Failures.message(t,"while trying to add this activity type, please try again",!0),setTimeout(function(){n.checked(!1)},0)}).always(function(){n._owner.saveSpinner.stop()}))},n.prototype._onUnchecked=function(){var n=this,i=Enumerable.From(this._owner.selectedTypeIds()).Any(function(t){return t==n.id}),t;i&&(this._owner.saveSpinner.start(),t=$("#type_delete_url_format").text().format(this._owner.id(),this.id),$.ajax({url:t,type:"DELETE"}).done(function(){n._owner.selectedTypeIds.remove(n.id),setTimeout(function(){n.checked(!1)},0)}).fail(function(t){App.Failures.message(t,"while trying to remove this activity type, please try again",!0),setTimeout(function(){n.checked(!0)},0)}).always(function(){n._owner.saveSpinner.stop()}))},n}(),n.ActivityTypeCheckBox=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Activities||(Activities={}))