var Activities;(function(n){(function(n){var r=function(){function r(){var t=this;this.ready=ko.observable(!1),this.mode=ko.observable(),this.updatedOnUtc=ko.observable(),this.isDraft=ko.computed(function(){var i=t.mode();return i?i==n.ActivityMode.draft:!1}),this.isPublished=ko.computed(function(){var i=t.mode();return i?i==n.ActivityMode.published:!1}),this.updatedOnDate=ko.computed(function(){var n=t.updatedOnUtc();return n?moment(n).format("M/D/YYYY"):undefined}),this.isSaving=ko.observable(!1),this.saveSpinner=new App.Spinner(new App.SpinnerOptions(200)),this._isDirty=ko.observable(!1),this._descriptionIsDirtyCurrent=0,this._isAutoSaving=!1,this._isSaved=!1,this._isDeleted=!1,this.cancelSpinner=new App.Spinner,this.placeOptions=ko.observableArray(),this.kendoPlaceIds=ko.observableArray(),this.typeOptions=ko.observableArray(),this.tags=ko.observableArray(),this.tagInput=ko.observable(),this.documents=ko.observableArray(),this.fileUploadErrors=ko.observableArray(),this._invalidFileNames=ko.observableArray([]),this.deleteDocumentSpinner=new App.Spinner}return r.bind=function(n){var t=new r;return t.bind(n).fail(function(n){App.Failures.message(n,"while trying to load the activity editor",!0)}),t},r.prototype.bind=function(n){var f=this,t,i,r,u;return this._originalId=n.activityId,this._workCopyId=n.workCopyId,this._dataUrl=n.dataUrlFormat.format(n.workCopyId),this._placeOptionsUrl=n.placeOptionsUrlFormat,this._typeOptionsUrl=n.typeOptionsUrlFormat,t=$.Deferred(),i=$.Deferred(),$.ajax({url:this._dataUrl,cache:!1}).done(function(n){i.resolve(n)}).fail(function(n){i.reject(n)}),r=$.Deferred(),$.get(this._placeOptionsUrl).done(function(n){r.resolve(n)}).fail(function(n){r.reject(n)}),u=$.Deferred(),$.get(this._typeOptionsUrl).done(function(n){u.resolve(n)}).fail(function(n){u.reject(n)}),$.when(i,r,u).done(function(i,r,u){f._applyBindings(n.target,i,r,u),t.resolve()}).fail(function(n){t.reject(n)}),t},r.prototype._applyBindings=function(n,t,i,r){this._bindData(t),this._bindPlaceOptions(i),this._bindTypeOptions(r),this._bindValidation(),this._bindSubscriptions(),ko.applyBindings(this,n),this._bindKendo(),this.ready(!0)},r.prototype._bindData=function(n){var i={types:{create:function(n){return n.data.typeId}},places:{create:function(n){return n.data.placeId}},ignore:["startsOn","endsOn","startsFormat","endsFormat"]};ko.mapping.fromJS(n,i,this),this.startsOn=new t(n.startsOn,n.startsFormat),this.endsOn=new t(n.endsOn,n.endsFormat)},r.prototype._bindValidation=function(){ko.validation.rules.atLeast={validator:function(n,t){return n.length>=t},message:"At least {0} must be selected."},ko.validation.rules.formattedDate={validator:function(n,t){return t.isValid()},message:"Date is not valid."},ko.validation.registerExtenders(),ko.validation.group(this),this.title.extend({required:{message:"Title is required."},minLength:1,maxLength:500}),this.places.extend({atLeast:1}),this.typeOptions().length&&this.types.extend({atLeast:1}),this.startsOn.input.extend({formattedDate:{params:this.startsOn,message:"Start date is not valid."}}),this.endsOn.input.extend({formattedDate:{params:this.endsOn,message:"End date is not valid."}})},r.prototype._bindSubscriptions=function(){var n=this;this.title.subscribe(function(){n._isDirty(!0)}),this.content.subscribe(function(t){n._descriptionCheckIsDirty(t)}),this.startsOn.input.subscribe(function(){n._isDirty(!0)}),this.endsOn.input.subscribe(function(){n._isDirty(!0)}),this.onGoing.subscribe(function(){n._isDirty(!0)}),this.isExternallyFunded.subscribe(function(){n._isDirty(!0)}),this.isInternallyFunded.subscribe(function(){n._isDirty(!0)}),ko.computed(function(){n._isDirty()&&n._autoSave()}),this.isSaving.subscribe(function(t){t?n.saveSpinner.start():n.saveSpinner.stop()}),window.onbeforeunload=function(){if(n._hasData()||n._isDeleted)n._autoSave();else return"This activity currently has no data. If you continue, the activity will be kept and you can come back to add data later. If you intended to delete it, please stay on this page and click one of the 'Cancel' buttons provided instead."}},r.prototype._bindKendo=function(){this._bindDatePickers(),this._bindPlacesKendoMultiSelect(),this._bindDocumentsKendoUpload(),this._bindTagsKendoAutoComplete()},r.prototype._descriptionCheckIsDirty=function(){++this._descriptionIsDirtyCurrent,this._descriptionIsDirtyCurrent>=r._descriptionIsDirtyAfter&&(this._isDirty(!0),this._descriptionIsDirtyCurrent=0)},r.prototype._autoSave=function(n){var r=this,i=$.Deferred(),t,u;return this._isSaved||this._isDeleted||this._isAutoSaving||!this._isDirty()&&this._descriptionIsDirtyCurrent==0?(i.resolve(),i):(this._isAutoSaving=!0,this.isSaving(!0),t=ko.mapping.toJS(this),u={title:t.title,content:t.content,startsOn:this.startsOn.isoString(),startsFormat:this.startsOn.format(),onGoing:t.onGoing,endsOn:t.onGoing?undefined:this.endsOn.isoString(),endsFormat:t.onGoing?undefined:this.endsOn.format(),isExternallyFunded:t.isExternallyFunded,isInternallyFunded:t.isInternallyFunded},$.ajax({type:"PUT",url:this._dataUrl,data:u}).done(function(){i.resolve()}).fail(function(n){i.reject(n)}).always(function(){r._isDirty(!1),r._isAutoSaving=!1,n&&r.isValid()||r.isSaving(!1)}),i)},r.prototype._save=function(n){var t=this;this._autoSave(!0).done(function(){if(!t.isValid()){t.errors.showAllMessages();return}var i=t.$activityReplaceUrlFormat.text().format(t._workCopyId,t._originalId,n);$.ajax({type:"PUT",url:i}).done(function(){t._isSaved=!0,location.href=App.Routes.Mvc.My.Profile.get()}).fail(function(n){App.Failures.message(n,"while trying to save your activity",!0),t.isSaving(!1)}).always(function(){t._isDirty(!1)})}).fail(function(n){App.Failures.message(n,"while trying to save your activity",!0)})},r.prototype.saveDraft=function(){this._save("Draft")},r.prototype.publish=function(){this._save("Public")},r.prototype.cancel=function(){var n=this;this.$cancelDialog.dialog({dialogClass:"jquery-ui no-close",closeOnEscape:!1,modal:!0,resizable:!1,width:450,buttons:[{text:"Cancel and lose changes",click:function(){var t=n.$cancelDialog.parents(".ui-dialog").find("button");$.each(t,function(){$(this).attr("disabled","disabled")}),n.cancelSpinner.start(),n._purge().done(function(){n.$cancelDialog.dialog("close"),location.href=App.Routes.Mvc.My.Profile.get()}).fail(function(n){App.Failures.message(n,"while trying to discard your activity edits",!0)}).always(function(){$.each(t,function(){$(this).removeAttr("disabled")}),n.cancelSpinner.stop()})}},{text:"Do not cancel",click:function(){n.$cancelDialog.dialog("close")},"data-css-link":!0}]})},r.prototype._purge=function(n){typeof n=="undefined"&&(n=!0);var i=this,t=$.Deferred(),r=this._dataUrl;return $.ajax({type:"DELETE",url:r,async:n}).done(function(){i._isDeleted=!0,t.resolve()}).fail(function(n){t.reject(n)}).always(function(){t.always()}),t},r.prototype._hasData=function(){return this.title()||this.content()||this.onGoing()||this.startsOn.input()||this.endsOn.input()||this.isExternallyFunded()||this.isInternallyFunded()||this.types().length||this.places().length||this.tags().length||this.documents().length},r.prototype._bindDatePickers=function(){this.$startsOn.kendoDatePicker({value:this.startsOn.date(),format:this.startsOn.format(),open:function(){this.options.format="M/d/yyyy"}}),this.startsOn.kendoDatePicker=this.$startsOn.data("kendoDatePicker"),this.$endsOn.kendoDatePicker({value:this.endsOn.date(),format:this.endsOn.format(),open:function(){this.options.format="M/d/yyyy"}}),this.endsOn.kendoDatePicker=this.$endsOn.data("kendoDatePicker")},r.prototype._bindPlaceOptions=function(n){ko.mapping.fromJS(n,{},this.placeOptions),this.kendoPlaceIds(this.places().slice(0))},r.prototype._bindPlacesKendoMultiSelect=function(){var n=this;this.$placeOptions.kendoMultiSelect({filter:"contains",ignoreCase:"true",dataTextField:"officialName()",dataValueField:"id()",dataSource:this.placeOptions(),value:this.kendoPlaceIds(),change:function(t){n._onPlaceMultiSelectChange(t)},placeholder:"[Select Country/Location, Body of Water or Global]"})},r.prototype._onPlaceMultiSelectChange=function(n){var t=this.places(),i=n.sender.value(),r=$(i).not(t).get(),u=$(t).not(i).get();r.length===1?this._addPlaceId(r[0],n):u.length===1&&this._removePlaceId(u[0],n)},r.prototype._addPlaceId=function(n,t){var i=this,r=this.$placeUrlFormat.text().format(this.activityId(),n);this.isSaving(!0),$.ajax({type:"PUT",url:r}).done(function(){i.places.push(n)}).fail(function(n){App.Failures.message(n,"while trying to add this location, please try again",!0);var r=i.places().slice(0);t.sender.dataSource.filter({}),t.sender.value(r),i.places(r)}).always(function(){i.isSaving(!1)})},r.prototype._removePlaceId=function(n,t){var i=this,r=this.$placeUrlFormat.text().format(this.activityId(),n);this.isSaving(!0),$.ajax({type:"DELETE",url:r}).done(function(){i.places.remove(n)}).fail(function(n){App.Failures.message(n,"while trying to remove this location, please try again",!0),t.sender.value(i.places())}).always(function(){i.isSaving(!1)})},r.prototype._bindTypeOptions=function(n){var t=this,r={create:function(n){return new i(n,t)}};ko.mapping.fromJS(n,r,this.typeOptions)},r.prototype._bindTagsKendoAutoComplete=function(){var n=this;this.$tagInput.kendoAutoComplete({minLength:3,placeholder:"[Enter tag or keyword]",dataTextField:"text",dataSource:this._getTagAutoCompleteDataSource(),select:function(t){n._onTagAutoCompleteSelect(t)}})},r.prototype._getTagAutoCompleteDataSource=function(){var n=this;return new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(t){$.ajax({url:n.$tagsAutoCompleteUrl.text(),data:{keyword:t.data.filter.filters[0].value,pageNumber:1,pageSize:250}}).done(function(n){t.success(n.items)}).fail(function(n){App.Failures.message(n,"while trying to search for tags",!0)})}}})},r.prototype._onTagAutoCompleteSelect=function(n){var t=this,i=n.sender.dataItem(n.item.index());this._addOrReplaceTag(i.text).done(function(){t.tagInput(""),n.preventDefault(),n.sender.value(""),n.sender.element.focus()}).fail(function(n){App.Failures.message(n,"while trying to add this activity tag, please try again",!0)})},r.prototype.addTag=function(){var t=this,n=this.tagInput();n&&(n=$.trim(n)),this._addOrReplaceTag(n).done(function(){t.tagInput("")}).fail(function(n){App.Failures.message(n,"while trying to add this activity tag, please try again",!0)})},r.prototype.deleteTag=function(n){this._deleteTag(n.text()).fail(function(n){App.Failures.message(n,"while trying to delete this activity tag, please try again",!0)})},r.prototype._addOrReplaceTag=function(n){var r=this,t=$.Deferred(),i;return n?(n=$.trim(n),i=Enumerable.From(this.tags()).SingleOrDefault(undefined,function(t){return t.text().toUpperCase()===n.toUpperCase()}),i?this._deleteTag(n).done(function(){r._postTag(n).done(function(){t.resolve()}).fail(function(n){t.reject(n)})}).fail(function(n){t.reject(n)}):this._postTag(n).done(function(){t.resolve()}).fail(function(n){t.reject(n)})):t.resolve(),t},r.prototype._postTag=function(t){var i=this,r=$.Deferred(),u=this.$tagsUrlFormat.text().format(this.activityId());return this.isSaving(!0),$.ajax({url:u,type:"POST",data:{text:t}}).done(function(){var u={activityId:i.activityId(),text:t,domainType:n.ActivityTagDomainType.custom,domainKey:undefined},f=ko.mapping.fromJS(u);i.tags.push(f),r.resolve()}).fail(function(n){r.reject(n)}).always(function(){i.isSaving(!1)}),r},r.prototype._deleteTag=function(n){var t=this,i=$.Deferred(),r=this.$tagsUrlFormat.text().format(this.activityId());return this.isSaving(!0),$.ajax({url:r,type:"DELETE",data:{text:n}}).done(function(){var r=Enumerable.From(t.tags()).SingleOrDefault(undefined,function(t){return n&&t.text().toUpperCase()===n.toUpperCase()});r&&t.tags.remove(r),i.resolve()}).fail(function(n){i.reject(n)}).always(function(){t.isSaving(!1)}),i},r.prototype._bindDocumentsKendoUpload=function(){var n=this;this.$fileUpload.kendoUpload({multiple:!0,showFileList:!1,localization:{select:"Choose one or more documents to share..."},async:{saveUrl:this.$documentsUrlFormat.text().format(this.activityId())},select:function(t){n._onDocumentKendoSelect(t)},upload:function(t){n._onDocumentKendoUpload(t)},success:function(t){n._onDocumentKendoSuccess(t)},error:function(t){n._onDocumentKendoError(t)},complete:function(){n.isSaving(!1)}})},r.prototype._onDocumentKendoSelect=function(n){var r=this,i,t;for(this.isSaving(!0),i=0;i<n.files.length;i++)t=n.files[i],$.ajax({async:!1,type:"POST",url:this.$documentsValidateUrl.text(),data:{name:t.name,length:t.size}}).fail(function(n){var u=Enumerable.From(r._invalidFileNames()).Any(function(n){return n==t.name}),i;u||r._invalidFileNames.push(t.name),i=n.status===400?n.responseText:App.Failures.message(n,"while trying to upload '{0}'".format(t.name)),r.fileUploadErrors.push({message:i})});this.isSaving(!1)},r.prototype._onDocumentKendoUpload=function(n){var t=n.files[0],i=Enumerable.From(this._invalidFileNames()).Any(function(n){return n==t.name});i?(n.preventDefault(),this._invalidFileNames.remove(t.name)):this.isSaving(!0)},r.prototype._onDocumentKendoSuccess=function(n){var t=this,i=n.XMLHttpRequest.getResponseHeader("location");$.get(i).done(function(n){var i=ko.mapping.fromJS(n);t.documents.push(i)})},r.prototype._onDocumentKendoError=function(n){var t=n.XMLHttpRequest.status!=500&&n.XMLHttpRequest.responseText&&n.XMLHttpRequest.responseText.length<1e3?n.XMLHttpRequest.responseText:App.Failures.message(n.XMLHttpRequest,"while uploading your document, please try again");this.fileUploadErrors.push({message:t})},r.prototype.documentIcon=function(n){var t=this.$documentIconUrlFormat.text().format(this.activityId(),n),i={maxSide:r.iconMaxSide};return"{0}?{1}".format(t,$.param(i))},r.prototype.deleteDocument=function(n,t){var i=this;this.$deleteDialog.dialog({dialogClass:"jquery-ui no-close",closeOnEscape:!1,width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm delete",click:function(){var r=i.$deleteDialog.parents(".ui-dialog").find("button");$.each(r,function(){$(this).attr("disabled","disabled")}),i.deleteDocumentSpinner.start(),$.ajax({type:"DELETE",url:i.$documentUrlFormat.text().format(i.activityId(),n.documentId())}).done(function(){i.$deleteDialog.dialog("close"),i.documents.splice(t,1)}).fail(function(n){App.Failures.message(n,"while trying to delete your activity document",!0)}).always(function(){$.each(r,function(){$(this).removeAttr("disabled")}),i.deleteDocumentSpinner.stop()})}},{text:"No, cancel delete",click:function(){i.$deleteDialog.dialog("close")},"data-css-link":!0}]})},r.prototype.startDocumentTitleEdit=function(n,t){var u=this,r=t.target,i;$(r).hide(),this._previousDocumentTitle=n.title(),i=$(r).siblings("#documentTitleInput")[0],$(i).show(),$(i).focusout(t,function(t){u.endDocumentTitleEdit(n,t)}),$(i).keypress(t,function(n){n.which==13&&i.blur()})},r.prototype.endDocumentTitleEdit=function(n,t){var r=this,i=t.target;$(i).unbind("focusout"),$(i).unbind("keypress"),$(i).attr("disabled","disabled"),$.ajax({type:"PUT",url:this.$documentUrlFormat.text().format(this.activityId(),n.documentId()),data:{title:n.title()},success:function(){$(i).hide(),$(i).removeAttr("disabled");var n=$(i).siblings("#documentTitle")[0];$(n).show()},error:function(t){n.title(r._previousDocumentTitle),$(i).hide(),$(i).removeAttr("disabled");var u=$(i).siblings("#documentTitle")[0];$(u).show(),$("#documentRenameErrorDialog > #message")[0].innerText=t.responseText,$("#documentRenameErrorDialog").dialog({modal:!0,resizable:!1,width:400,buttons:{Ok:function(){$(this).dialog("close")}}})}})},r.prototype.dismissFileUploadError=function(n){this.fileUploadErrors.splice(n,1)},r._descriptionIsDirtyAfter=10,r.iconMaxSide=64,r}(),i,t;n.ActivityForm=r,i=function(){function n(n,t){var i=this,r;this.id=n.data.id,this.text=n.data.type,this._owner=t,r=Enumerable.From(this._owner.types()).Any(function(n){return n==i.id}),this.checked=ko.observable(r),this.checked.subscribe(function(n){n?i._onChecked():i._onUnchecked()})}return n.prototype._onChecked=function(){var n=this,i=Enumerable.From(this._owner.types()).All(function(t){return t!=n.id}),t;i&&(this._owner.isSaving(!0),t=this._owner.$typeUrlFormat.text().format(this._owner.activityId(),this.id),$.ajax({url:t,type:"PUT"}).done(function(){n._owner.types.push(n.id),setTimeout(function(){n.checked(!0)},0)}).fail(function(t){App.Failures.message(t,"while trying to add this activity type, please try again",!0),setTimeout(function(){n.checked(!1)},0)}).always(function(){n._owner.isSaving(!1)}))},n.prototype._onUnchecked=function(){var n=this,i=Enumerable.From(this._owner.types()).Any(function(t){return t==n.id}),t;i&&(this._owner.isSaving(!0),t=this._owner.$typeUrlFormat.text().format(this._owner.activityId(),this.id),$.ajax({url:t,type:"DELETE"}).done(function(){n._owner.types.remove(n.id),setTimeout(function(){n.checked(!1)},0)}).fail(function(t){App.Failures.message(t,"while trying to remove this activity type, please try again",!0),setTimeout(function(){n.checked(!0)},0)}).always(function(){n._owner.isSaving(!1)}))},n}(),n.ActivityTypeCheckBox=i,t=function(){function n(t,i){var r=this,u,f;(this.input=ko.observable(),this.format=ko.computed(function(){return r._computeDateFormat(r.input())}),this.date=ko.computed(function(){var n=r.input();return n?moment(n,[r.format().toUpperCase()]).toDate():undefined}),this.isoString=ko.computed(function(){var n=r.date();return n?moment(n).utc().hours(0).format():undefined}),t)&&(u=moment(t).toDate(),i=i||n._defaultFormat,f=moment(u).format(i.toUpperCase()),this.input(f),this.input.subscribe(function(n){var t=$.trim(n);t!=n&&r.input(t)}),this.format.subscribe(function(t){r.kendoDatePicker&&(r.kendoDatePicker.options.format=t||n._defaultFormat)}))}return n.prototype._computeDateFormat=function(t){return t?n._yyyy.test(t)?"yyyy":n._mYyyy.test(t)?"M/yyyy":n._mmYyyy.test(t)?"MM/yyyy":n._mDYyyy.test(t)?"M/d/yyyy":n._mmDYyyy.test(t)?"MM/d/yyyy":n._mDdYyyy.test(t)?"M/dd/yyyy":"MM/dd/yyyy":undefined},n.prototype.isValid=function(){var n=this.input(),t=this.format();return!n||moment(n,t).isValid()},n._defaultFormat="M/d/yyyy",n._yyyy=new RegExp("^\\d{4}$"),n._mYyyy=new RegExp("^\\d{1}/\\d{4}$"),n._mmYyyy=new RegExp("^\\d{2}/\\d{4}$"),n._mxYyyy=new RegExp("^\\d{1,}/\\d{4}$"),n._mDYyyy=new RegExp("^\\d{1}/\\d{1}/\\d{4}$"),n._mmDYyyy=new RegExp("^\\d{2}/\\d{1}/\\d{4}$"),n._mDdYyyy=new RegExp("^\\d{1}/\\d{2}/\\d{4}$"),n._mmDdYyyy=new RegExp("^\\d{2}/\\d{2}/\\d{4}$"),n._mxDxYyyy=new RegExp("^\\d{1,}/\\d{1,}/\\d{4}$"),n}(),n.FormattedDateInput=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Activities||(Activities={}))