var ViewModels;(function(n){(function(n){var t=function(){function n(n){this.dirtyFlag=ko.observable(!1);this.initialLocations=[];this.selectedLocationValues=[];this._initialize(n)}return n.prototype._initialize=function(n){var i=Number(moment().format("YYYY")),t;for(this.years=[],t=0;t<80;t+=1)this.years[t]=i-t;this.id=ko.observable(n)},n.prototype.setupWidgets=function(n){var i=this,t;this.locationSelectorId=n;t=this;$("#"+n).kendoMultiSelect({autoBind:!0,dataTextField:"officialName",dataValueField:"id",minLength:3,dataSource:t.initialLocations,value:t.selectedLocationValues,change:function(n){i.updateLocations(n.sender.dataItems())},placeholder:"[Select Country/Location]"});$("#fromDate").kendoDropDownList({dataSource:this.years,value:t.from().toString(),optionLabel:" ",change:function(){var n=$("#toDate").data("kendoDropDownList");n.value()<this.value()&&n.value(this.value());t.from(this.value())}});$("#toDate").kendoDropDownList({dataSource:this.years,value:t.to(),optionLabel:" ",change:function(){var n=$("#fromDate").data("kendoDropDownList");n.value()>this.value()&&n.value(this.value());t.to(this.value())}})},n.prototype.setupValidation=function(){ko.validation.rules.atLeast={validator:function(n,t){return n.length>=t},message:"At least {0} must be selected."};ko.validation.registerExtenders();this.locations.extend({atLeast:1});this.institution.extend({required:!0,maxLength:200});this.position.extend({required:!0,maxLength:100});this.from.extend({required:!0});ko.validation.group(this)},n.prototype.setupSubscriptions=function(){var n=this;this.from.subscribe(function(){n.dirtyFlag(!0)});this.to.subscribe(function(){n.dirtyFlag(!0)});this.onGoing.subscribe(function(){n.dirtyFlag(!0)});this.institution.subscribe(function(){n.dirtyFlag(!0)});this.position.subscribe(function(){n.dirtyFlag(!0)})},n.prototype.load=function(){var n=this,r=this,t=$.Deferred(),i;return this.id()==0?(this.version=ko.observable(null),this.personId=ko.observable(0),this.from=ko.observable(0),this.to=ko.observable(0),this.onGoing=ko.observable(!1),this.institution=ko.observable(null),this.position=ko.observable(null),this.locations=ko.observableArray(),this.whenLastUpdated=ko.observable(null),this.whoLastUpdated=ko.observable(null),t.resolve()):(i=$.Deferred(),$.ajax({type:"GET",url:App.Routes.WebApi.InternationalAffiliations.get(this.id()),success:function(n){i.resolve(n)},error:function(n,t,r){i.reject(n,t,r)}}),$.when(i).done(function(i){ko.mapping.fromJS(i,{},n);for(var r=0;r<n.locations().length;r+=1)n.initialLocations.push({officialName:n.locations()[r].placeOfficialName(),id:n.locations()[r].placeId()}),n.selectedLocationValues.push(n.locations()[r].placeId());t.resolve()}).fail(function(n,i,r){t.reject(n,i,r)})),t},n.prototype.save=function(n){var i,t;if(!this.isValid()){this.errors.showAllMessages();return}for(i={id:this.id,version:this.version,personId:this.personId,whenLastUpdated:this.whenLastUpdated,whoLastUpdated:this.whoLastUpdated,from:this.from,to:this.to,onGoing:this.onGoing,institution:this.institution,position:this.position,locations:ko.observableArray()},t=0;t<this.locations().length;t+=1)i.locations.push({id:this.locations()[t].id,version:this.locations()[t].version,whenLastUpdated:this.locations()[t].whenLastUpdated,whoLastUpdated:this.locations()[t].whoLastUpdated,affiliationId:this.locations()[t].affiliationId,placeOfficialName:this.locations()[t].placeOfficialName,placeId:this.locations()[t].placeId});var r=ko.mapping.toJS(i),u=n.id()==0?App.Routes.WebApi.InternationalAffiliations.post():App.Routes.WebApi.InternationalAffiliations.put(n.id()),f=n.id()==0?"POST":"PUT";$.ajax({type:f,async:!1,url:u,data:r,success:function(){},error:function(n,t,i){alert(t+" | "+i)},complete:function(){location.href=App.Routes.Mvc.My.Profile.get("international-affiliation")}})},n.prototype.cancel=function(){this.dirtyFlag()==!0?$("#cancelConfirmDialog").dialog({modal:!0,resizable:!1,width:450,buttons:{"Do not cancel":function(){$(this).dialog("close")},"Cancel and lose changes":function(){$(this).dialog("close");location.href=App.Routes.Mvc.My.Profile.get("international-affiliation")}}}):location.href=App.Routes.Mvc.My.Profile.get("international-affiliation")},n.prototype.updateLocations=function(n){var t,i;for(this.locations.removeAll(),t=0;t<n.length;t+=1)i=ko.mapping.fromJS({id:0,placeId:n[t].id,version:""}),this.locations.push(i);this.dirtyFlag(!0)},n}();n.InternationalAffiliation=t})(n.InternationalAffiliations||(n.InternationalAffiliations={}));var t=n.InternationalAffiliations})(ViewModels||(ViewModels={}));