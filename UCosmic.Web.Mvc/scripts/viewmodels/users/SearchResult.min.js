var ViewModels;(function(n){(function(t){var f=function(){function n(){this._ruleName="validRoleGrant",this._isAwaitingResponse=!1,this.async=!0,this.message="error",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;if(!t.selectedRoleOption()){i(!0);return}this._isAwaitingResponse||(r=App.Routes.WebApi.Identity.Users.Roles.validateGrant(t.id(),t.selectedRoleOption()),this._isAwaitingResponse=!0,$.post(r).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})}))},n}(),i,r,u;new f,i=function(){function n(){this._ruleName="validRoleRevoke",this._isAwaitingResponse=!1,this.async=!0,this.message="error",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;if(!t.roleToRevoke()){i(!0);return}this._isAwaitingResponse||(r=App.Routes.WebApi.Identity.Users.Roles.validateRevoke(t.id(),t.roleToRevoke()),this._isAwaitingResponse=!0,$.post(r).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})}))},n}(),new i,r=function(){function t(t,i){var u=this,r;this.roleOptions=ko.observableArray(),this.roleOptionsCaption=ko.observable("[Loading...]"),this.selectedRoleOption=ko.observable(),this.roleToRevoke=ko.observable(),this.$roleSelect=ko.observable(),this.roleSpinner=new n.Spinner({delay:0,isVisible:!0}),this.isRevokeError=ko.observable(),this.revokeErrorText=ko.observable(),this.isGrantError=ko.observable(),this.grantErrorText=ko.observable(),this.$menu=ko.observable(),this.isEditingRoles=ko.observable(!1),this._owner=i,r={roles:{create:function(t){return new n.Users.RoleGrant(t.data,u)}}},ko.mapping.fromJS(t,r,this),this._setupPhotoComputeds(),this._setupNamingComputeds(),this._setupRoleGrantComputeds(),this._setupMenuSubscription(),this._setupValidation()}return t.prototype._setupPhotoComputeds=function(){var n=this;this.photoSrc=ko.computed(function(){return App.Routes.WebApi.People.Photo.get(n.personId(),{maxSide:100})})},t.prototype._setupNamingComputeds=function(){var n=this;this.hasUniqueDisplayName=ko.computed(function(){return n.name()!==n.personDisplayName()})},t.prototype._setupRoleGrantComputeds=function(){var n=this;this.hasGrants=ko.computed(function(){return n.roles().length>0}),this.hasNoGrants=ko.computed(function(){return!n.hasGrants()}),this.isRoleGrantDisabled=ko.computed(function(){return n.roleSpinner.isVisible()||!n.selectedRoleOption()}),this.selectedRoleOption.subscribe(function(t){t&&typeof t=="string"&&n.selectedRoleOption(parseInt(t))})},t.prototype._setupMenuSubscription=function(){this.$menu.subscribe(function(n){n&&n.length&&n.kendoMenu()})},t.prototype._setupValidation=function(){var n=this;this.selectedRoleOption.extend({validRoleGrant:this}),this.roleToRevoke.extend({validRoleRevoke:this}),this.isValidating=ko.computed(function(){return n.selectedRoleOption.isValidating()||n.roleToRevoke.isValidating()}),this.selectedRoleOption.subscribe(function(){n.roleToRevoke(undefined)}),ko.validation.group(this)},t.prototype._pullRoleOptions=function(){var i=this,n,t;return this.selectedRoleOption(undefined),this.roleSpinner.start(),n=$.Deferred(),t={pageSize:Math.pow(2,32)/2-1,orderBy:"name-asc"},$.get(App.Routes.WebApi.Identity.Roles.get(),t).done(function(t,i,r){n.resolve(t,i,r)}).fail(function(t,i,r){n.reject(t,i,r)}).always(function(){i.roleSpinner.stop()}),n},t.prototype._loadRoleOptions=function(n){var i,r,t;if(ko.mapping.fromJS(n.items,{},this.roleOptions),this.roleOptionsCaption("[Select access to grant...]"),this._syncRoleOptions(),this.$roleSelect&&this.$roleSelect().length){for(i=this.roleOptions(),r=[],r.push({name:this.roleOptionsCaption()}),t=0;t<i.length;t++)r.push({id:i[t].id(),name:i[t].name(),description:i[t].description()});this.$roleSelect().kendoDropDownList({height:300,dataSource:r,dataTextField:"name",dataValueField:"id",template:"#if (data.id) {# <div><strong>${ data.name }<\/strong><\/div>\r\n#} else {#<div>${ data.name }<\/div>\r\n #}##if (data.description) {# <div><small>${ data.description }<\/small><\/div> #}#"})}},t.prototype._syncRoleOptions=function(){for(var i,t,r,n=0;n<this.roleOptions().length;n++)for(i=this.roleOptions()[n],t=0;t<this.roles().length;t++)r=this.roles()[t],i.id()==r.id()&&(n===0?this.roleOptions.shift():n==this.roleOptions().length?this.roleOptions.pop():this.roleOptions.splice(n,1),n=-1)},t.prototype.pullRoleGrants=function(){var t=this,n;return this.roleSpinner.start(),n=$.Deferred(),$.get(App.Routes.WebApi.Identity.Users.Roles.get(this.id())).done(function(t,i,r){n.resolve(t,i,r)}).fail(function(t,i,r){n.reject(t,i,r)}).always(function(){t.roleSpinner.stop()}),n},t.prototype.loadRoleGrants=function(t){var i=this,r={create:function(t){return new n.Users.RoleGrant(t.data,i)}};ko.mapping.fromJS(t,r,this.roles)},t.prototype.impersonate=function(){var n=this._owner.impersonateForm;n&&(this._owner.impersonateUserName(this.name()),$(n).submit())},t.prototype.showRoleEditor=function(){var n=this;this.isEditingRoles(!0),this._pullRoleOptions().done(function(t){n._loadRoleOptions(t)})},t.prototype.hideRoleEditor=function(){this.roleToRevoke(undefined),this.isEditingRoles(!1)},t.prototype.grantRole=function(){var n=this,t;if(this.roleSpinner.start(),this.roleToRevoke(undefined),this.isValidating())return setTimeout(function(){n.grantRole()},50),!1;if(!this.isValid())return this.errors.showAllMessages(),this.roleSpinner.stop(),!1;t=App.Routes.WebApi.Identity.Users.Roles.put(this.id(),this.selectedRoleOption()),$.ajax({url:t,type:"PUT"}).done(function(t){App.flasher.flash(t),n.roleOptions.remove(function(t){return t.id()==n.selectedRoleOption()}),n.pullRoleGrants().done(function(t){n.loadRoleGrants(t),n._pullRoleOptions().done(function(t){n._loadRoleOptions(t)})})}).fail(function(){n.isGrantError(!0),n.grantErrorText("An unexpected error occurred while trying to grant access."),n.roleSpinner.stop()})},t.prototype.revokeRole=function(n){var t=this,i;if(this.roleSpinner.start(),this.roleToRevoke(n),this.isValidating())return setTimeout(function(){t.revokeRole(n)},50),!1;if(!this.isValid())return this.errors.showAllMessages(),this.roleSpinner.stop(),!1;i=App.Routes.WebApi.Identity.Users.Roles.del(this.id(),n),$.ajax({url:i,type:"DELETE"}).done(function(n){App.flasher.flash(n),t.roleToRevoke(undefined),t.pullRoleGrants().done(function(n){t.loadRoleGrants(n),t._pullRoleOptions().done(function(n){t._loadRoleOptions(n)})})}).fail(function(){t.isRevokeError(!0),t.grantErrorText("An unexpected error occurred while trying to revoke access."),t.roleSpinner.stop()})},t.prototype.dismissError=function(){this.isRevokeError(!1),this.revokeErrorText(undefined),this.isGrantError(!1),this.grantErrorText(undefined)},t}(),t.SearchResult=r,u=function(){function n(n,t){this._owner=t,ko.mapping.fromJS(n,{},this)}return n.prototype.revokeRole=function(){var n=this;this.$confirmPurgeDialog.dialog({dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm revoke",click:function(){n._owner.revokeRole(n.id()),n.$confirmPurgeDialog.dialog("close")}},{text:"No, cancel revoke",click:function(){n.$confirmPurgeDialog.dialog("close")},"data-css-link":!0}]})},n}(),t.RoleGrant=u})(n.Users||(n.Users={}));var t=n.Users})(ViewModels||(ViewModels={}))