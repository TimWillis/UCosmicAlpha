var ViewModels;(function(n){(function(t){var i=function(){function t(){var t=this,i;this.sammy=Sammy(),this.countries=ko.observableArray(),this.countryCode=ko.observable(),this.keywordElement=undefined,this.keyword=ko.observable($('input[type=hidden][data-bind="value: keyword"]').val()),this.orderBy=ko.observable(),this.pageSize=ko.observable(),this.pageNumber=ko.observable(),this.transitionedPageNumber=ko.observable(),this.itemTotal=ko.observable(),this.nextForceDisabled=ko.observable(!1),this.prevForceDisabled=ko.observable(!1),this.lenses=ko.observableArray([{text:"Table",value:"table"},{text:"List",value:"list"},{text:"Grid",value:"grid"},{text:"Map",value:"map"},{text:"Tree",value:"tree"}]),this.lens=ko.observable(),this.spinnerDelay=400,this.isSpinning=ko.observable(!0),this.showSpinner=ko.observable(!1),this.inTransition=ko.observable(!1),this.itemsPage=undefined,this.initialized=ko.observable(!1),this.sideSwiper=new App.SideSwiper({frameWidth:710,speed:"fast",root:"#search"}),this.trail=ko.observableArray([]),this.items=ko.observableArray(),this.resultsMapping={items:{key:function(n){return ko.utils.unwrapObservable(n.id)},create:function(t){return new n.Establishments.SearchResult(t.data)}},ignore:["pageSize","pageNumber"]},this.throttledKeyword=ko.computed(this.keyword).extend({throttle:400}),ko.computed(function(){var i=$('input[type=hidden][data-bind="value: countryCode"]').val();$.get(App.Routes.WebApi.Countries.get()).done(function(r){var u=new n.Countries.ServerApiModel("-1","[Without country]");r.splice(r.length,0,u),t.countries(r),i&&i!==t.countryCode()&&t.countryCode(i)})}).extend({throttle:1}),this.pageCount=ko.computed(function(){return Math.ceil(t.itemTotal()/t.pageSize())}),this.pageIndex=ko.computed(function(){return parseInt(t.transitionedPageNumber())-1}),this.firstIndex=ko.computed(function(){return t.pageIndex()*t.pageSize()}),this.firstNumber=ko.computed(function(){return t.firstIndex()+1}),this.lastNumber=ko.computed(function(){return t.items?t.firstIndex()+t.items().length:0}),this.lastIndex=ko.computed(function(){return t.lastNumber()-1}),this.nextEnabled=ko.computed(function(){return t.pageNumber()<t.pageCount()&&!t.nextForceDisabled()}),this.prevEnabled=ko.computed(function(){return t.pageNumber()>1&&!t.prevForceDisabled()}),this.hasManyPages=ko.computed(function(){return t.pageCount()>1}),this.hasManyItems=ko.computed(function(){return t.lastNumber()>t.firstNumber()}),this.pageCount.subscribe(function(n){t.pageNumber()&&t.pageNumber()>n&&t.pageNumber(1)}),this.pageNumber.subscribe(function(){t.setLocation()}),this.hasItems=ko.computed(function(){return t.items()&&t.items().length>0}),this.hasNoItems=ko.computed(function(){return!t.isSpinning()&&!t.hasItems()}),this.showStatus=ko.computed(function(){return t.hasItems()&&!t.showSpinner()}),i=this,this.sammy.before(/\#\/page\/(.*)/,function(){if(i.nextForceDisabled()||i.prevForceDisabled())return!1;var n=this.params.pageNumber;return n&&parseInt(n)!==parseInt(i.pageNumber())&&i.pageNumber(parseInt(n)),!0}),this.sammy.get("#/page/:pageNumber/",function(){var n=i.trail(),t;if(!(n.length>0)||n[n.length-1]!==this.path){if(n.length>1&&n[n.length-2]===this.path){n.pop(),i.swipeCallback=function(){t=i.$itemsPage().clone(!0).removeAttr("data-bind").data("bind",undefined).removeAttr("id"),t.appendTo(i.$itemsPage().parent()),i.$itemsPage().attr("data-side-swiper","off").hide(),i.lockAnimation(),$(window).scrollTop(0),i.sideSwiper.prev(1,function(){i.$itemsPage().siblings().remove(),i.unlockAnimation()})};return}n.length>0&&(i.swipeCallback=function(){t=i.$itemsPage().clone(!0).removeAttr("data-bind").data("bind",undefined).removeAttr("id"),t.insertBefore(i.$itemsPage()),i.$itemsPage().attr("data-side-swiper","off").hide(),i.lockAnimation(),$(window).scrollTop(0),i.sideSwiper.next(1,function(){i.unlockAnimation()})}),n.push(this.path)}}),this.sammy.get("/establishments[/]?",function(){this.app.setLocation("#/page/1/")}),ko.computed(function(){t.requestResults()}).extend({throttle:1})}return t.prototype.setLocation=function(){var n="#/page/"+this.pageNumber()+"/";this.sammy.getLocation()!==n&&this.sammy.setLocation(n)},t.prototype.nextPage=function(){if(this.nextEnabled()){var n=parseInt(this.pageNumber())+1;this.pageNumber(n)}},t.prototype.prevPage=function(){this.prevEnabled()&&history.back()},t.prototype.changeLens=function(n){this.lens(n.value)},t.prototype.startSpinning=function(){var n=this;this.isSpinning(!0),this.spinnerDelay<1?this.showSpinner(!0):setTimeout(function(){n.isSpinning()&&!n.inTransition()&&n.showSpinner(!0)},this.spinnerDelay)},t.prototype.stopSpinning=function(){this.inTransition(!1),this.showSpinner(!1),this.isSpinning(!1)},t.prototype.$itemsPage=function(){return $(this.itemsPage)},t.prototype.lockAnimation=function(){this.nextForceDisabled(!0),this.prevForceDisabled(!0)},t.prototype.unlockAnimation=function(){this.nextForceDisabled(!1),this.prevForceDisabled(!1)},t.prototype.swipeCallback=function(){},t.prototype.receiveResults=function(n){n?ko.mapping.fromJS(n,this.resultsMapping,this):ko.mapping.fromJS({items:[],itemTotal:0},this.resultsMapping,this),App.WindowScroller.restoreTop(),this.stopSpinning(),this.swipeCallback(),this.transitionedPageNumber(this.pageNumber())},t.prototype.requestResults=function(){var n=this;this.pageSize()!==undefined&&this.orderBy()!==undefined&&(this.startSpinning(),$.get(App.Routes.WebApi.Establishments.get(),{pageSize:this.pageSize(),pageNumber:this.pageNumber(),countryCode:this.countryCode(),keyword:this.throttledKeyword(),orderBy:this.orderBy()}).done(function(t){n.receiveResults(t),n.initialized(!0)}))},t.prototype.gotoAddNew=function(){return!0},t}();t.Search=i})(n.Establishments||(n.Establishments={}));var t=n.Establishments})(ViewModels||(ViewModels={}))