var ViewModels;(function(n){(function(t){var i=google.maps,r=function(){function t(t){var i=this;this.mapZoom=ko.observable(1),this.mapTools=ko.observable(),this.$mapCanvas=ko.observable(),this.isLoaded=ko.observable(),this.continents=ko.observableArray(),this.continentId=ko.observable(),this.countries=ko.observableArray(),this.countryId=ko.observable(),this.allowCountryFitBounds=!0,this.admin1s=ko.observableArray(),this.admin1Id=ko.observable(),this.admin1sLoading=ko.observable(!1),this.admin2s=ko.observableArray(),this.admin2Id=ko.observable(),this.admin2sLoading=ko.observable(!1),this.admin3s=ko.observableArray(),this.admin3Id=ko.observable(),this.admin3sLoading=ko.observable(!1),this.places=ko.observableArray(),this.subAdmins=ko.observableArray(),this.loadSpinner=new n.Spinner(new n.SpinnerOptions(400)),this.saveSpinner=new n.Spinner(new n.SpinnerOptions(400)),this.isEditing=ko.observable(),this.ownerId=t,this._initComputedsAndSubscriptions(),this.loadSpinner.isVisible.subscribe(function(n){i.$dataLoadingDialog&&i.$dataLoadingDialog.length&&(n?i.$dataLoadingDialog.dialog({modal:!0,resizable:!1,dialogClass:"no-close",width:"450px"}):i.$dataLoadingDialog.dialog("close"))}),this.isEditable=ko.computed(function(){return i.ownerId&&i.ownerId!==0}),this.isEditIconVisible=ko.computed(function(){return i.isEditable()&&!i.isEditing()}),this.isEditing.subscribe(function(n){n?i.mapTools().showMarkerTools():i.isEditable()&&i.mapTools().hideMarkerTools()})}return t.prototype._initComputedsAndSubscriptions=function(){var t=this;this.toolsMarkerLat=ko.computed(function(){return t.mapTools()&&t.mapTools().markerLatLng()?t.mapTools().markerLatLng().lat():null}),this.toolsMarkerLng=ko.computed(function(){return t.mapTools()&&t.mapTools().markerLatLng()?t.mapTools().markerLatLng().lng():null}),this.$mapCanvas.subscribe(function(){t.map||t.initMap()}),ko.computed(function(){$.get(App.Routes.WebApi.Places.get({isContinent:!0})).done(function(n){t.continents(n)})}).extend({throttle:1}),this.continentName=ko.computed(function(){var r=t.continentId(),i;return r?(i=n.Places.Utils.getPlaceById(t.continents(),r),i?i.officialName:"[Unknown]"):"[Unspecified]"}),this.countryOptionsCaption=ko.computed(function(){return t.countries().length>0?"[Unspecified]":"[Loading...]"}),ko.computed(function(){$.get(App.Routes.WebApi.Places.get({isCountry:!0})).done(function(n){if(t.countries(n),t._countryId){var i=t._countryId;t._countryId=undefined,t.countryId(i)}})}).extend({throttle:1}),this.countryName=ko.computed(function(){var r=t.countryId(),i;return r?(i=n.Places.Utils.getPlaceById(t.countries(),r),i?i.officialName:"[Unknown]"):"[Unspecified]"}),this.countryId.subscribe(function(r){if(r&&t.countries().length==0&&(t._countryId=r),r&&t.countries().length>0){var u=n.Places.Utils.getPlaceById(t.countries(),r);u&&(t.allowCountryFitBounds?t.map.fitBounds(n.Places.Utils.convertToLatLngBounds(u.box)):setTimeout(function(){t.allowCountryFitBounds=!0},1e3),t.continentId(u.parentId),t.loadAdmin1s(u.id))}else!r&&t.countries().length>0&&(t.map.setCenter(new i.LatLng(0,0)),t.allowCountryFitBounds?t.map.setZoom(1):setTimeout(function(){t.allowCountryFitBounds=!0},1e3),t.continentId(null))}),this.admin1OptionsCaption=ko.computed(function(){return t.admin1sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin1Input=ko.computed(function(){return t.countryId()&&(t.admin1s().length>0||t.admin1sLoading())}),this.admin1Id.subscribe(function(i){if(i&&t.admin1s().length==0&&(t._admin1Id=i),i&&t.admin1s().length>0){var r=n.Places.Utils.getPlaceById(t.admin1s(),i);r?t.loadAdmin2s(r.id):(t._admin1Id=i,t.loadAdmin1s(t.countryId()||t._countryId))}}),this.admin1Name=ko.computed(function(){var r=t.admin1Id(),i;return r?(i=n.Places.Utils.getPlaceById(t.admin1s(),r),i?i.officialName:"[Unknown]"):"[Unspecified]"}),this.admin2OptionsCaption=ko.computed(function(){return t.admin2sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin2Input=ko.computed(function(){return t.countryId()&&t.admin1Id()&&(t.admin2s().length>0||t.admin2sLoading())}),this.admin2Id.subscribe(function(i){if(i&&t.admin2s().length==0&&(t._admin2Id=i),i&&t.admin2s().length>0){var r=n.Places.Utils.getPlaceById(t.admin2s(),i);r?t.loadAdmin3s(r.id):(t._admin2Id=i,t.loadAdmin2s(t.admin1Id()||t._admin1Id))}}),this.admin2Name=ko.computed(function(){var r=t.admin2Id(),i;return r?(i=n.Places.Utils.getPlaceById(t.admin2s(),r),i?i.officialName:"[Unknown]"):"[Unspecified]"}),this.admin3OptionsCaption=ko.computed(function(){return t.admin3sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin3Input=ko.computed(function(){return t.countryId()&&t.admin1Id()&&t.admin2Id()&&(t.admin3s().length>0||t.admin3sLoading())}),this.admin3Id.subscribe(function(i){if(i&&t.admin3s().length==0&&(t._admin3Id=i),i&&t.admin3s().length>0){var r=n.Places.Utils.getPlaceById(t.admin3s(),i);r||(t._admin3Id=i,t.loadAdmin3s(t.admin2Id()||t._admin2Id))}}),this.admin3Name=ko.computed(function(){var r=t.admin3Id(),i;return r?(i=n.Places.Utils.getPlaceById(t.admin3s(),r),i?i.officialName:"[Unknown]"):"[Unspecified]"})},t.prototype.initMap=function(){var n=this,t=this,r={mapTypeId:i.MapTypeId.ROADMAP,center:new i.LatLng(0,0),zoom:t.mapZoom(),draggable:!0,scrollwheel:!1};this.map=new i.Map(this.$mapCanvas()[0],r),i.event.addListenerOnce(this.map,"idle",function(){n.mapTools(new App.GoogleMaps.ToolsOverlay(n.map)),n.mapTools().hideMarkerTools(),i.event.addListener(n.map,"zoom_changed",function(){n.mapZoom(n.map.getZoom())})});this.$mapCanvas().on("marker_destroyed",function(){n.countryId(undefined),n.continentId(undefined),n.admin1Id(undefined),n.admin2Id(undefined),n.admin3Id(undefined),n.subAdmins([])});this.$mapCanvas().on("marker_dragend marker_created",function(){var t=n.mapTools().markerLatLng(),i=App.Routes.WebApi.Places.get(t.lat(),t.lng());n.loadSpinner.start(),$.get(i).done(function(t){t&&t.length&&(n.allowCountryFitBounds=!1,n.fillPlacesHierarchy(t))}).always(function(){n.loadSpinner.stop()}).fail(function(){})});this.ownerId?(this.isLoaded(!1),$.get(App.Routes.WebApi.Establishments.Locations.get(this.ownerId)).done(function(t){i.event.addListenerOnce(n.map,"idle",function(){n.loadMapZoom(t),n.loadMapMarker(t)}),n.fillPlacesHierarchy(t.places),n.isLoaded(!0)})):i.event.addListenerOnce(this.map,"idle",function(){n.isEditing(!0)})},t.prototype.loadMapZoom=function(t){t.googleMapZoomLevel&&t.center&&t.center.hasValue?this.map.setZoom(t.googleMapZoomLevel):t.box.hasValue&&this.map.fitBounds(n.Places.Utils.convertToLatLngBounds(t.box)),t.googleMapZoomLevel&&t.googleMapZoomLevel>1&&this.map.setZoom(t.googleMapZoomLevel),(t.googleMapZoomLevel||t.box.hasValue)&&(this.allowCountryFitBounds=!1)},t.prototype.loadMapMarker=function(t){if(t.center.hasValue){var i=n.Places.Utils.convertToLatLng(t.center);this.mapTools().placeMarker(i),this.map.setCenter(i)}},t.prototype.fillPlacesHierarchy=function(t){var r,u,f,e,o,i;this.places(t),r=n.Places.Utils.getContinent(t),r&&this.continentId(r.id),u=n.Places.Utils.getCountry(t),u?this.countryId(u.id):this.countryId(undefined),f=n.Places.Utils.getAdmin1(t),f?this.admin1Id(f.id):this.admin1Id(undefined),e=n.Places.Utils.getAdmin2(t),e?this.admin2Id(e.id):this.admin2Id(undefined),o=n.Places.Utils.getAdmin3(t),o?this.admin3Id(o.id):this.admin3Id(undefined),i=n.Places.Utils.getSubAdmins(t),i&&i.length?this.subAdmins(i):this.subAdmins([])},t.prototype.loadAdmin1s=function(n){var t=this,i=App.Routes.WebApi.Places.get({isAdmin1:!0,parentId:n});this.admin1sLoading(!0),$.ajax({type:"GET",url:i,cache:!1}).done(function(n){t.admin1s(n),t._admin1Id&&t.admin1Id(t._admin1Id),t.admin1sLoading(!1)})},t.prototype.loadAdmin2s=function(n){var t=this,i=App.Routes.WebApi.Places.get({isAdmin2:!0,parentId:n});this.admin2sLoading(!0),$.ajax({type:"GET",url:i,cache:!1}).done(function(n){t.admin2s(n),t._admin2Id&&t.admin2Id(t._admin2Id),t.admin2sLoading(!1)})},t.prototype.loadAdmin3s=function(n){var t=this,i=App.Routes.WebApi.Places.get({isAdmin3:!0,parentId:n});this.admin3sLoading(!0),$.ajax({type:"GET",url:i,cache:!1}).done(function(n){t.admin3s(n),t._admin3Id&&t.admin3Id(t._admin3Id),t.admin3sLoading(!1)})},t.prototype.changePlaceInLocation=function(){this.subAdmins([])},t.prototype.clickToEdit=function(){this.isEditing(!0)},t.prototype.clickToSave=function(){var t=this,n=this;this.ownerId&&(this.saveSpinner.start(),$.ajax({url:App.Routes.WebApi.Establishments.Locations.put(n.ownerId),type:"PUT",data:n.toJs()}).always(function(){n.saveSpinner.stop()}).done(function(n){App.flasher.flash(n),t.isEditing(!1)}).fail(function(){}))},t.prototype.toJs=function(){var i,u=this.toolsMarkerLat(),f=this.toolsMarkerLng(),r=this.map.getZoom();u!=null&&f!=null&&(i={latitude:u,longitude:f}),i&&this.map.setCenter(n.Places.Utils.convertToLatLng(i));var e,o=this.map.getBounds().getNorthEast().lat(),s=this.map.getBounds().getNorthEast().lng(),h=this.map.getBounds().getSouthWest().lat(),c=this.map.getBounds().getSouthWest().lng(),t;return r&&r>1&&(e={northEast:{latitude:o,longitude:s},southWest:{latitude:h,longitude:c}}),this.subAdmins().length?t=this.subAdmins()[this.subAdmins().length-1].id:this.admin3Id()?t=this.admin3Id():this.admin2Id()?t=this.admin2Id():this.admin1Id()?t=this.admin1Id():this.countryId()?t=this.countryId():this.continentId()&&(t=this.continentId()),{center:i,box:e,googleMapZoomLevel:r,placeId:t}},t.prototype.clickToCancelEdit=function(){var n=this;(this.isEditing(!1),this.ownerId)&&(this.isLoaded(!1),$.get(App.Routes.WebApi.Establishments.Locations.get(this.ownerId)).done(function(t){n.map.setZoom(1),n.loadMapZoom(t),n.mapTools().destroyMarker(),n.loadMapMarker(t),n.fillPlacesHierarchy(t.places),n.isLoaded(!0)}))},t.prototype.clickForHelp=function(){alert("TODO: Show location help dialog here.")},t}();t.Location=r})(n.Establishments||(n.Establishments={}));var t=n.Establishments})(ViewModels||(ViewModels={}))