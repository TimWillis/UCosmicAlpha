var ViewModels;(function(n){(function(t){var f=google.maps,u=function(){function n(){this.async=!0,this.message="error",this._isAwaitingResponse=!1,this._ruleName="validEstablishmentCeebCode",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;this._isValidatable(t)?(r=App.Routes.WebApi.Establishments.validateCeebCode(t.id),this._isAwaitingResponse=!0,$.post(r,t.serializeData()).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):this._isAwaitingResponse||i(!0)},n.prototype._isValidatable=function(n){return n.id&&n.id!==0?!this._isAwaitingResponse&&n&&n.ceebCode()&&n.originalValues&&n.originalValues.ceebCode!==n.ceebCode():n&&n.ceebCode()&&!this._isAwaitingResponse},n}(),i,r;new u,i=function(){function n(){this.async=!0,this.message="error",this._isAwaitingResponse=!1,this._ruleName="validEstablishmentUCosmicCode",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;this._isValidatable(t)?(r=App.Routes.WebApi.Establishments.validateUCosmicCode(t.id),this._isAwaitingResponse=!0,$.post(r,t.serializeData()).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):this._isAwaitingResponse||i(!0)},n.prototype._isValidatable=function(n){return n.id&&n.id!==0?!this._isAwaitingResponse&&n&&n.uCosmicCode()&&n.originalValues&&n.originalValues.uCosmicCode!==n.uCosmicCode():n&&n.uCosmicCode()&&!this._isAwaitingResponse},n}(),new i,r=function(){function i(i){var r=this,f,u;this.id=0,this._isInitialized=ko.observable(!1),this.$genericAlertDialog=undefined,this.createSpinner=new n.Spinner(new n.SpinnerOptions(0)),this.validatingSpinner=new n.Spinner(new n.SpinnerOptions(200)),this.categories=ko.observableArray(),this.typeId=ko.observable(),this.ceebCode=ko.observable(),this.uCosmicCode=ko.observable(),this.languages=ko.observableArray(),this.names=ko.observableArray(),this.editingName=ko.observable(0),this.namesSpinner=new n.Spinner(new n.SpinnerOptions(0,!0)),this.urls=ko.observableArray(),this.editingUrl=ko.observable(0),this.urlsSpinner=new n.Spinner(new n.SpinnerOptions(0,!0)),this.id=i||0,this._initNamesComputeds(),this._initUrlsComputeds(),this.location=new t.Location(this.id),this.typeEmptyText=ko.computed(function(){return r.categories().length>0?"[Select a type]":"[Loading...]"}),this._computeIsInstitution(),this.typeId.extend({required:{message:"Establishment type is required"}}),this.typeId.subscribe(function(){r.isInstitution()?(r.ceebCode(r.originalValues.ceebCode),r.uCosmicCode(r.originalValues.uCosmicCode)):(r.ceebCode(undefined),r.uCosmicCode(undefined))}),this.ceebCode.extend({validEstablishmentCeebCode:this}),this.ceebCode.subscribe(function(){r.ceebCode()&&r.ceebCode($.trim(r.ceebCode()))}),this.uCosmicCode.extend({validEstablishmentUCosmicCode:this}),this.uCosmicCode.subscribe(function(){r.uCosmicCode()&&r.uCosmicCode($.trim(r.uCosmicCode()))}),f=$.Deferred(),$.get(App.Routes.WebApi.Establishments.Categories.get()).done(function(n){f.resolve(n)}).fail(function(n,t,i){f.reject(n,t,i)}),u=$.Deferred(),this.id?$.get(App.Routes.WebApi.Establishments.get(this.id)).done(function(n){u.resolve(n)}).fail(function(n,t,i){u.reject(n,t,i)}):u.resolve(undefined),$.when(f,u).then(function(n,t){ko.mapping.fromJS(n,{},r.categories),r.originalValues=t,t&&ko.mapping.fromJS(t,{ignore:["id"]},r),r._isInitialized()||r._isInitialized(!0)},function(){}),ko.computed(function(){var n,t;r.id&&r._isInitialized()&&(n=r.serializeData(),n.typeId!=r.originalValues.typeId||n.ceebCode!=r.originalValues.ceebCode||n.uCosmicCode!=r.originalValues.uCosmicCode)&&(!r.isValid()||r.ceebCode.isValidating()||r.uCosmicCode.isValidating()||(t=App.Routes.WebApi.Establishments.put(r.id),$.ajax({url:t,type:"PUT",data:n}).done(function(n){App.flasher.flash(n),$.get(App.Routes.WebApi.Establishments.get(r.id)).done(function(n){r.originalValues=n,n&&ko.mapping.fromJS(n,{ignore:["id"]},r)})}).fail(function(){})))}).extend({throttle:400}),ko.validation.group(this)}return i.prototype.requestNames=function(n){var t=this;this.namesSpinner.start(),$.get(App.Routes.WebApi.Establishments.Names.get(this.id)).done(function(i){t.receiveNames(i),n&&n(i)})},i.prototype.receiveNames=function(n){ko.mapping.fromJS(n||[],this._namesMapping,this.names),this.namesSpinner.stop(),App.Obtruder.obtrude(document)},i.prototype.addName=function(){var i=new t.ServerNameApiModel(this.id),n;this.names().length===0&&(i.isOfficialName=!0),n=new t.Name(i,this),this.names.unshift(n),n.showEditor(),App.Obtruder.obtrude(document)},i.prototype._initNamesComputeds=function(){var i=this;ko.computed(function(){$.getJSON(App.Routes.WebApi.Languages.get()).done(function(t){var r=new n.Languages.ServerApiModel(undefined,"[Language Neutral]");t.splice(0,0,r),i.languages(t)})}).extend({throttle:1}),this._namesMapping={create:function(n){return new t.Name(n.data,i)}},this.canAddName=ko.computed(function(){return!i.namesSpinner.isVisible()&&i.editingName()===0&&i.id!==0}),ko.computed(function(){i.id?i.requestNames():setTimeout(function(){i.namesSpinner.stop(),i.addName()},0)}).extend({throttle:1})},i.prototype.requestUrls=function(n){var t=this;this.urlsSpinner.start(),$.get(App.Routes.WebApi.Establishments.Urls.get(this.id)).done(function(i){t.receiveUrls(i),n&&n(i)})},i.prototype.receiveUrls=function(n){ko.mapping.fromJS(n||[],this._urlsMapping,this.urls),this.urlsSpinner.stop(),App.Obtruder.obtrude(document)},i.prototype.addUrl=function(){var i=new t.ServerUrlApiModel(this.id),n;this.urls().length===0&&(i.isOfficialUrl=!0),n=new t.Url(i,this),this.urls.unshift(n),n.showEditor(),App.Obtruder.obtrude(document)},i.prototype._initUrlsComputeds=function(){var n=this;this._urlsMapping={create:function(i){return new t.Url(i.data,n)}},this.canAddUrl=ko.computed(function(){return!n.urlsSpinner.isVisible()&&n.editingUrl()===0&&n.id!==0}),ko.computed(function(){n.id?n.requestUrls():setTimeout(function(){n.urlsSpinner.stop(),n.addUrl()},0)}).extend({throttle:1})},i.prototype.submitToCreate=function(n){var t=this,e,f,u;if(!this.id||this.id===0){e=this,this.validatingSpinner.start();var i=this.names()[0],r=this.urls()[0],o=this.location;if(i.text.isValidating()||r.value.isValidating()||this.ceebCode.isValidating()||this.uCosmicCode.isValidating())return setTimeout(function(){var i=t.submitToCreate(n);return!1},50),!1;this.isValid()||this.errors.showAllMessages(),i.isValid()||i.errors.showAllMessages(),r.isValid()||r.errors.showAllMessages(),this.validatingSpinner.stop(),i.isValid()&&r.isValid()&&(f=App.Routes.WebApi.Establishments.post(),u=this.serializeData(),u.officialName=i.serializeData(),u.officialUrl=r.serializeData(),u.location=o.serializeData(),this.createSpinner.start(),$.post(f,u).done(function(n,t,i){window.location.href=App.Routes.Mvc.Establishments.created(i.getResponseHeader("Location"))}).fail(function(n){t.createSpinner.stop(),n.status===400&&(t.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),t.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){t.$genericAlertDialog.dialog("close")}}}))}))}return!1},i.prototype.serializeData=function(){var n={};return n.typeId=this.typeId(),n.ceebCode=this.ceebCode(),n.uCosmicCode=this.uCosmicCode(),n},i.prototype._computeIsInstitution=function(){var n=this;this.isInstitution=ko.computed(function(){var i,t,u,f,r;if(n.typeId())for(i=n.categories(),t=0;t<i.length;t++)if(u=i[t].code(),u&&u.toUpperCase()==="INST")for(f=i[t].types(),r=0;r<f.length;r++)if(f[r].id()==n.typeId())return!0;return!1})},i}(),t.Item=r})(n.Establishments||(n.Establishments={}));var t=n.Establishments})(ViewModels||(ViewModels={}))