var ViewModels;(function(n){(function(t){var i=google.maps,r=function(){function r(r){var u=this;this.namesSpinner=new n.Spinner(new n.SpinnerOptions(0,!0)),this.urlsSpinner=new n.Spinner(new n.SpinnerOptions(0,!0)),this.id=0,this.$genericAlertDialog=undefined,this.languages=ko.observableArray(),this.names=ko.observableArray(),this.editingName=ko.observable(0),this.urls=ko.observableArray(),this.editingUrl=ko.observable(0),this.mapTools=ko.observable(),this.$mapCanvas=ko.observable(),this.continents=ko.observableArray(),this.continentId=ko.observable(),this.countries=ko.observableArray(),this.countryId=ko.observable(),this.admin1s=ko.observableArray(),this.admin1Id=ko.observable(),this.admin1sLoading=ko.observable(!1),this.admin2s=ko.observableArray(),this.admin2Id=ko.observable(),this.admin2sLoading=ko.observable(!1),this.admin3s=ko.observableArray(),this.admin3Id=ko.observable(),this.admin3sLoading=ko.observable(!1),this.places=ko.observableArray(),this.subAdmins=ko.observableArray(),this.id=r||0,ko.computed(function(){$.getJSON(App.Routes.WebApi.Languages.get()).done(function(t){var i=new n.Languages.ServerApiModel(undefined,"[Language Neutral]");t.splice(0,0,i),u.languages(t)})}).extend({throttle:1}),this.namesMapping={create:function(n){return new t.Name(n.data,u)}},this.canAddName=ko.computed(function(){return!u.namesSpinner.isVisible()&&u.editingName()===0&&u.id!==0}),ko.computed(function(){u.id?u.requestNames():setTimeout(function(){u.namesSpinner.stop(),u.addName()},0)}).extend({throttle:1}),this.urlsMapping={create:function(n){return new t.Url(n.data,u)}},this.canAddUrl=ko.computed(function(){return!u.urlsSpinner.isVisible()&&u.editingUrl()===0&&u.id!==0}),ko.computed(function(){u.id?u.requestUrls():setTimeout(function(){u.urlsSpinner.stop(),u.addUrl()},0)}).extend({throttle:1}),this.toolsMarkerLat=ko.computed(function(){return u.mapTools()&&u.mapTools().markerLatLng()?u.mapTools().markerLatLng().lat():null}),this.toolsMarkerLng=ko.computed(function(){return u.mapTools()&&u.mapTools().markerLatLng()?u.mapTools().markerLatLng().lng():null}),this.$mapCanvas.subscribe(function(){u.map||u.initMap()}),ko.computed(function(){$.get(App.Routes.WebApi.Places.get({isContinent:!0})).done(function(n){u.continents(n)})}).extend({throttle:1}),this.continentName=ko.computed(function(){var i=u.continentId(),t;return i?(t=n.Places.Utils.getPlaceById(u.continents(),i),t?t.officialName:"[Unknown]"):"[Unspecified]"}),this.countryOptionsCaption=ko.computed(function(){return u.countries().length>0?"[Unspecified]":"[Loading...]"}),ko.computed(function(){$.get(App.Routes.WebApi.Places.get({isCountry:!0})).done(function(n){if(u.countries(n),u._countryId){var t=u._countryId;u._countryId=undefined,u.countryId(t)}})}).extend({throttle:1}),this.countryId.subscribe(function(t){if(t&&u.countries().length==0&&(u._countryId=t),t&&u.countries().length>0){var r=n.Places.Utils.getPlaceById(u.countries(),t);r&&(u.map.fitBounds(n.Places.Utils.convertToLatLngBounds(r.box)),u.continentId(r.parentId),u.loadAdmin1s(r.id))}else!t&&u.countries().length>0&&(u.map.setCenter(new i.LatLng(0,0)),u.map.setZoom(1),u.continentId(null))}),this.admin1OptionsCaption=ko.computed(function(){return u.admin1sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin1Input=ko.computed(function(){return u.countryId()&&(u.admin1s().length>0||u.admin1sLoading())}),this.admin1Id.subscribe(function(t){if(t&&u.admin1s().length==0&&(u._admin1Id=t),t&&u.admin1s().length>0){var i=n.Places.Utils.getPlaceById(u.admin1s(),t);i?u.loadAdmin2s(i.id):(u._admin1Id=t,u.loadAdmin1s(u.countryId()||u._countryId))}}),this.admin2OptionsCaption=ko.computed(function(){return u.admin2sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin2Input=ko.computed(function(){return u.countryId()&&u.admin1Id()&&(u.admin2s().length>0||u.admin2sLoading())}),this.admin2Id.subscribe(function(t){if(t&&u.admin2s().length==0&&(u._admin2Id=t),t&&u.admin2s().length>0){var i=n.Places.Utils.getPlaceById(u.admin2s(),t);i?u.loadAdmin3s(i.id):(u._admin2Id=t,u.loadAdmin2s(u.admin1Id()||u._admin1Id))}}),this.admin3OptionsCaption=ko.computed(function(){return u.admin3sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin3Input=ko.computed(function(){return u.countryId()&&u.admin1Id()&&u.admin2Id()&&(u.admin3s().length>0||u.admin3sLoading())}),this.admin3Id.subscribe(function(t){if(t&&u.admin3s().length==0&&(u._admin3Id=t),t&&u.admin3s().length>0){var i=n.Places.Utils.getPlaceById(u.admin3s(),t);i||(u._admin3Id=t,u.loadAdmin3s(u.admin2Id()||u._admin2Id))}})}return r.prototype.requestNames=function(n){var t=this;this.namesSpinner.start(),$.get(App.Routes.WebApi.Establishments.Names.get(this.id)).done(function(i){t.receiveNames(i),n&&n(i)})},r.prototype.receiveNames=function(n){ko.mapping.fromJS(n||[],this.namesMapping,this.names),this.namesSpinner.stop(),App.Obtruder.obtrude(document)},r.prototype.addName=function(){var i=new t.ServerNameApiModel(this.id),n;this.names().length===0&&(i.isOfficialName=!0),n=new t.Name(i,this),this.names.unshift(n),n.showEditor(),App.Obtruder.obtrude(document)},r.prototype.requestUrls=function(n){var t=this;this.urlsSpinner.start(),$.get(App.Routes.WebApi.Establishments.Urls.get(this.id)).done(function(i){t.receiveUrls(i),n&&n(i)})},r.prototype.receiveUrls=function(n){ko.mapping.fromJS(n||[],this.urlsMapping,this.urls),this.urlsSpinner.stop(),App.Obtruder.obtrude(document)},r.prototype.addUrl=function(){var i=new t.ServerUrlApiModel(this.id),n;this.urls().length===0&&(i.isOfficialUrl=!0),n=new t.Url(i,this),this.urls.unshift(n),n.showEditor(),App.Obtruder.obtrude(document)},r.prototype.initMap=function(){var t=this,r={mapTypeId:i.MapTypeId.ROADMAP,center:new i.LatLng(0,0),zoom:1,draggable:!0,scrollwheel:!1};this.map=new i.Map(this.$mapCanvas()[0],r),i.event.addListenerOnce(this.map,"idle",function(){t.mapTools(new App.GoogleMaps.ToolsOverlay(t.map))});this.$mapCanvas().on("marker_destroyed",function(){t.countryId(undefined),t.subAdmins([])});this.$mapCanvas().on("marker_dragend marker_created",function(){var n=t.mapTools().markerLatLng(),i=App.Routes.WebApi.Places.get(n.lat(),n.lng());$.get(i,function(n){n&&n.length&&t.fillPlacesHierarchy(n)})});this.id&&$.get(App.Routes.WebApi.Establishments.Locations.get(this.id)).done(function(r){i.event.addListenerOnce(t.map,"idle",function(){if(r.googleMapZoomLevel?t.map.setZoom(r.googleMapZoomLevel):r.box.hasValue&&t.map.fitBounds(n.Places.Utils.convertToLatLngBounds(r.box)),r.center.hasValue){var i=n.Places.Utils.convertToLatLng(r.center);t.mapTools().placeMarker(i),t.map.setCenter(i)}}),t.fillPlacesHierarchy(r.places)})},r.prototype.fillPlacesHierarchy=function(t){var r,u,f,e,o,i;this.places(t),r=n.Places.Utils.getContinent(t),r&&this.continentId(r.id),u=n.Places.Utils.getCountry(t),u?this.countryId(u.id):this.countryId(undefined),f=n.Places.Utils.getAdmin1(t),f?this.admin1Id(f.id):this.admin1Id(undefined),e=n.Places.Utils.getAdmin2(t),e?this.admin2Id(e.id):this.admin2Id(undefined),o=n.Places.Utils.getAdmin3(t),o?this.admin3Id(o.id):this.admin3Id(undefined),i=n.Places.Utils.getSubAdmins(t),i&&i.length?this.subAdmins(i):this.subAdmins([])},r.prototype.loadAdmin1s=function(n){var t=this,i;this.admin1s([]),i=App.Routes.WebApi.Places.get({isAdmin1:!0,parentId:n}),this.admin1sLoading(!0),$.ajax({type:"GET",url:i,cache:!1}).done(function(n){t.admin1s(n),t._admin1Id&&t.admin1Id(t._admin1Id),t.admin1sLoading(!1)})},r.prototype.loadAdmin2s=function(n){var t=this,i;this.admin2s([]),i=App.Routes.WebApi.Places.get({isAdmin2:!0,parentId:n}),this.admin2sLoading(!0),$.ajax({type:"GET",url:i,cache:!1}).done(function(n){t.admin2s(n),t._admin2Id&&t.admin2Id(t._admin2Id),t.admin2sLoading(!1)})},r.prototype.loadAdmin3s=function(n){var t=this,i;this.admin3s([]),i=App.Routes.WebApi.Places.get({isAdmin3:!0,parentId:n}),this.admin3sLoading(!0),$.ajax({type:"GET",url:i,cache:!1}).done(function(n){t.admin3s(n),t._admin3Id&&t.admin3Id(t._admin3Id),t.admin3sLoading(!1)})},r.prototype.changePlaceInLocation=function(){this.subAdmins([])},r}();t.Item=r})(n.Establishments||(n.Establishments={}));var t=n.Establishments})(ViewModels||(ViewModels={}))