var ViewModels;(function(n){(function(t){var i=function(){function n(){this.id=0,this.ownerId=0,this.text="",this.isOfficialName=!1,this.isFormerName=!1,this.languageCode="",this.languageName=""}return n}(),r;t.ServerNameApiModel=i,ko.validation.rules.validEstablishmentNameText={async:!0,validator:function(n,t,i){var r=_this,u;t.isTextValidatableAsync()?r.isAwaitingResponse||(u=App.Routes.WebApi.EstablishmentNames.validateText(t.ownerId(),t.id()),r.isAwaitingResponse=!0,$.post(u,t.serializeData()).always(function(){r.isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):i(!0)},message:"error"},ko.validation.registerExtenders(),r=function(){function t(t,r){var u=this;this.id=ko.observable(),this.ownerId=ko.observable(),this.text=ko.observable(),this.isOfficialName=ko.observable(),this.isFormerName=ko.observable(),this.languageName=ko.observable(),this.languageCode=ko.observable(),this.editMode=ko.observable(),this.$textElement=undefined,this.$languagesElement=undefined,this.confirmPurgeDialog=undefined,this.saveSpinner=new n.Spinner(0),this.purgeSpinner=new n.Spinner(0),this.textValidationSpinner=new n.Spinner(0),this.saveEditorClicked=!1,this.$parent=r,t||(t=new i,t.ownerId=this.$parent.id),this.originalValues=t,ko.mapping.fromJS(t,{},this),this.isOfficialNameEnabled=ko.computed(function(){return!u.originalValues.isOfficialName}),this.isTextValidatableAsync=ko.computed(function(){return u.text()!==u.originalValues.text}),this.text.extend({required:{message:"Establishment name is required."},maxLength:400,validEstablishmentNameText:this}),this.text.isValidating.subscribe(function(n){n?u.saveSpinner.start():(u.saveSpinner.stop(),u.saveEditorClicked&&u.saveEditor())}),this.selectedLanguageCode=ko.observable(this.originalValues.languageCode),this.$parent.languages.subscribe(function(){u.selectedLanguageCode(u.languageCode())}),this.isOfficialName.subscribe(function(n){n&&u.isFormerName(!1)}),ko.validation.group(this)}return t.prototype.showEditor=function(){var n=this.$parent.editingName();n||(this.$parent.editingName(this.id()||-1),this.editMode(!0),this.$textElement.trigger("autosize"),this.$textElement.focus())},t.prototype.saveEditor=function(){this.saveEditorClicked=!0,this.isValid()?this.text.isValidating()||(this.saveEditorClicked=!1,this.saveSpinner.start(),this.id()?$.ajax({url:App.Routes.WebApi.EstablishmentNames.put(this.$parent.id,this.id()),type:"PUT",data:this.serializeData()}).done(this.mutationSuccess).fail(this.mutationError):this.$parent.id&&$.ajax({url:App.Routes.WebApi.EstablishmentNames.post(this.$parent.id),type:"POST",data:this.serializeData()}).done(this.mutationSuccess).fail(this.mutationError)):(this.saveEditorClicked=!1,this.errors.showAllMessages())},t.prototype.cancelEditor=function(){this.$parent.editingName(undefined),this.id()?(ko.mapping.fromJS(this.originalValues,{},this),this.editMode(!1)):this.$parent.names.shift()},t.prototype.clickOfficialNameCheckbox=function(){var n=this;return this.originalValues.isOfficialName&&($(this.$parent.genericAlertDialog).find("p.content").html("In order to choose a different official name for this establishment, edit the name you wish to make the new official name."),$(this.$parent.genericAlertDialog).dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){$(n).dialog("close")}}})),!0},t.prototype.purge=function(n,t){var i=this,r;if(t.stopPropagation(),!this.$parent.editingName()){if(this.isOfficialName()){$(this.$parent.genericAlertDialog).find("p.content").html("You cannot delete an establishment's official name.<br />To delete this name, first assign another name as official."),$(this.$parent.genericAlertDialog).dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){$(i).dialog("close")}}});return}this.purgeSpinner.stop(),r=!1,$(this.confirmPurgeDialog).dialog({dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,close:function(){r||i.purgeSpinner.stop()},buttons:[{text:"Yes, confirm delete",click:function(){r=!0,$(i.confirmPurgeDialog).dialog("close"),$.ajax({url:App.Routes.WebApi.EstablishmentNames.del(i.$parent.id,i.id()),type:"DELETE"}).done(i.mutationSuccess).fail(i.mutationError)}},{text:"No, cancel delete",click:function(){$(i.confirmPurgeDialog).dialog("close"),i.purgeSpinner.stop()},"data-css-link":!0}]})}},t.prototype.serializeData=function(){return{id:this.id(),ownerId:this.ownerId(),text:$.trim(this.text()),isOfficialName:this.isOfficialName(),isFormerName:this.isFormerName(),languageCode:this.selectedLanguageCode(),languageName:undefined}},t.prototype.mutationError=function(n){var t=this;n.status===400&&($(this.$parent.genericAlertDialog).find("p.content").html(n.responseText.replace("\n","<br /><br />")),$(this.$parent.genericAlertDialog).dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){$(t).dialog("close")}}}))},t.prototype.mutationSuccess=function(n){var t=this;this.$parent.requestNames(function(){t.$parent.editingName(undefined),t.editMode(!1),t.saveSpinner.stop(),t.purgeSpinner.stop(),App.flasher.flash(n)})},t}(),t.Name=r})(n.Establishments||(n.Establishments={}));var t=n.Establishments})(ViewModels||(ViewModels={}))