var Agreements;(function(n){var t=function(){function n(n,t,i,r,u){this.$file=ko.observable(),this.hasFile=ko.observable(),this.isFileExtensionInvalid=ko.observable(!1),this.isFileTooManyBytes=ko.observable(!1),this.isFileFailureUnexpected=ko.observable(!1),this.isFileInvalid=ko.observable(!1),this.fileError=ko.observable(),this.fileFileExtension=ko.observable(),this.fileFileName=ko.observable(),this.fileSrc=ko.observable(),this.fileUploadSpinner=new App.Spinner(new App.SpinnerOptions(400)),this.fileDeleteSpinner=new App.Spinner(new App.SpinnerOptions(400)),this.tempFileId=0,this.agreementId=n,this.files=u,this.agreementIsEdit=t,this.spinner=i,this.establishmentItemViewModel=r,this.updateFile=this.updateFile.bind(this),this.fileVisibilityClicked=this.fileVisibilityClicked.bind(this),this.removeFile=this.removeFile.bind(this)}return n.prototype._$bindKendoFile=function(){var n=this,t="";t=this.agreementIsEdit()?App.Routes.WebApi.Agreements.Files.post(this.agreementId):App.Routes.WebApi.Uploads.post(),$("#fileUpload").kendoUpload({multiple:!0,showFileList:!1,localization:{select:"Choose a file to upload..."},select:function(t){for(var r,u,i=0,f=t.files.length;i<f;i++)u=ko.mapping.toJS({Name:t.files[i].name,Length:t.files[i].rawFile.size}),r=App.Routes.WebApi.Agreements.Files.Validate.post(),$.ajax({type:"POST",url:r,async:!1,data:u,success:function(){n.isFileInvalid(!1)},error:function(i){t.preventDefault(),n.isFileInvalid(!0),n.fileError(i.responseText)}})},async:{saveUrl:t},upload:function(t){n.agreementIsEdit()&&(t.data={originalName:t.files[0].name,visibility:"Private",customName:t.files[0].name,agreementId:n.agreementId}),t.isDefaultPrevented()||n.fileUploadSpinner.start()},complete:function(){n.fileUploadSpinner.stop()},success:function(t){var i,r;t.operation=="upload"&&(t.response&&t.response.message&&App.flasher.flash(t.response.message),n.agreementIsEdit()?(r=t.XMLHttpRequest!=undefined?t.XMLHttpRequest.getResponseHeader("Location"):t.response.location,i=parseInt(r.substring(r.lastIndexOf("/")+1))):(n.tempFileId=n.tempFileId+.01,i=n.tempFileId),n.files.push(ko.mapping.fromJS({id:i,originalName:t.files[0].name,customName:t.files[0].name,visibility:"Public",guid:t.response.guid,isEdit:!1,customNameFile:t.files[0].name.substring(0,t.files[0].name.indexOf(t.files[0].extension)),customNameExt:t.files[0].extension})),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*.85))},error:function(t){var i,r;t.files&&t.files.length>0&&(i=t.files[0].name,r=t.files[0].extension),i&&n.fileFileName(i),r&&n.fileFileExtension(r),t.XMLHttpRequest.status===415?n.isFileExtensionInvalid(!0):t.XMLHttpRequest.status===413?n.isFileTooManyBytes(!0):n.isFileFailureUnexpected(!0)}})},n.prototype.removeFile=function(n,t){var r=this,i;confirm("Are you sure you want to remove this file from this agreement?")&&(i="",i=this.agreementIsEdit()?App.Routes.WebApi.Agreements.Files.del(this.agreementId,n.id()):App.Routes.WebApi.Uploads.del(n.guid()),$.ajax({url:i,type:"DELETE",success:function(){r.files.remove(n),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*1.1)}})),t.preventDefault(),t.stopPropagation()},n.prototype.editAFile=function(n){n.isEdit(!0)},n.prototype.cancelEditAFile=function(n,t){return n.customNameFile(n.customName().substring(0,n.customName().lastIndexOf("."))),n.isEdit(!1),t.stopImmediatePropagation(),!1},n.prototype.updateFile=function(n){var t=this,i,r;n.customName(n.customNameFile()+n.customNameExt()),n.isEdit(!1),this.agreementIsEdit()&&(i=ko.mapping.toJS({agreementId:n.agreementId,uploadGuid:n.guid,originalName:n.guid,extension:n.extension,customName:n.customName,visibility:n.visibility}),r=App.Routes.WebApi.Agreements.Files.put(this.agreementId,n.id()),$.ajax({type:"PUT",url:r,data:i,success:function(){},error:function(n){t.spinner.stop(),n.status===400&&(t.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),t.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){t.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}}))},n.prototype.bindJquery=function(){this._$bindKendoFile(),$("#helpExpDate").kendoTooltip({width:520,position:"top",content:$("#templateExpToolTip").html(),showOn:"click",autoHide:!1})},n.prototype.fileVisibilityClicked=function(n,t){var i=this,r,u;return this.agreementIsEdit()&&t.target.textContent==""&&(r=ko.mapping.toJS({agreementId:this.agreementId,uploadGuid:n.guid,originalName:n.guid,extension:n.extension,customName:n.customName,visibility:n.visibility}),u=App.Routes.WebApi.Agreements.Files.put(this.agreementId,n.id()),$.ajax({type:"PUT",url:u,data:r,success:function(){},error:function(n){i.spinner.stop(),n.status===400&&(i.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),i.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){i.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}})),!0},n.prototype.postMe=function(n,t){var i=this;$.post(t,n).done(function(){}).fail(function(n){n.status===400&&(i.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),i.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){i.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))})},n.prototype.agreementPostFiles=function(){var t=this,i=App.Routes.WebApi.Agreements.Files.post(this.agreementId),n;$.each(this.files(),function(r,u){n=ko.mapping.toJS({agreementId:u.agreementId,uploadGuid:u.guid,originalName:u.guid,extension:u.extension,customName:u.customName,visibility:u.visibility}),t.postMe(n,i)}),this.spinner.stop()},n}();n.FileAttachments=t})(Agreements||(Agreements={}))