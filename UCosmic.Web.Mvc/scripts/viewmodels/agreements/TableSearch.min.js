var Agreements;(function(n){(function(n){var u=function(){function n(i){var r=this;this.settings=i,this.keyword=ko.observable(sessionStorage.getItem(n.KeywordSessionKey)||""),this.keywordThrottled=ko.computed(this.keyword).extend({throttle:400}),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.pager=new t(sessionStorage.getItem(n.PageNumberSessionKey)||1,sessionStorage.getItem(n.PageSizeSessionKey)||10),this.displayPager=new t(sessionStorage.getItem(n.PageNumberSessionKey)||1,sessionStorage.getItem(n.PageSizeSessionKey)||10),this.orderBy=ko.observable(sessionStorage.getItem(n.OrderBySessionKey)||"start-desc"),this._inputChanged=ko.computed(function(){sessionStorage.setItem(n.KeywordSessionKey,r.keyword()),sessionStorage.setItem(n.CountrySessionKey,r.countryCode()),sessionStorage.setItem(n.PageNumberSessionKey,r.pager.input.pageNumberText()),sessionStorage.setItem(n.PageSizeSessionKey,r.pager.input.pageSizeText()),sessionStorage.setItem(n.OrderBySessionKey,r.orderBy())}).extend({throttle:0}),this.countryOptions=ko.observableArray([{code:"any",name:"[Loading...]"}]),this._countryChanged=ko.computed(function(){r._onCountryChanged()}),this.sammy=Sammy(),this.routeFormat="#/{0}/country/{5}/sort/{1}/size/{2}/page/{3}/".format(this.settings.route).replace("{5}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return r._computeRoute()}),this._requestHistory=ko.observableArray(),this._currentRequest=ko.computed(function(){return r._computeCurrentRequest()}),this._requestDirty=ko.computed(function(){r._onRequestDirty()}).extend({throttle:1}),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this._loadCountryOptions(),this._runSammy(),ko.applyBindings(this,this.settings.element)}return n.prototype._onCountryChanged=function(){var t=this.countryCode(),n=this.countryOptions();n.length==1&&n[0].code!=t&&(n[0].code=t)},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){var r=i.slice(0);r=Enumerable.From([{code:"any",name:"[All countries]"}]).Concat(r).Concat([{code:"none",name:"[Without country]"}]).ToArray(),t.countryOptions(r),n.resolve()}),n},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n.countryCode(t.params.country),n.orderBy(t.params.sort),n.pager.input.pageSizeText(t.params.size),n.pager.input.pageNumberText(t.params.number),!0}),this.sammy.get(this.routeFormat.format(":country",":sort",":size",":number"),function(){var t=this;n._isActivated()||n._isActivated(!0)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){var t=this;n._setLocation()}),this.sammy.run()},n.prototype._computeRoute=function(){var n=this.countryCode(),t=this.orderBy(),i=this.pager.input.pageSize(),r=this.pager.input.pageNumber();return this.routeFormat.format(n,t,i,r)},n.prototype._setLocation=function(){var n=this._route();this.sammy.getLocation().indexOf(n)<0&&this.sammy.setLocation(n)},n.prototype._computeCurrentRequest=function(){return{keyword:this.keywordThrottled(),countryCode:this.countryCode(),orderBy:this.orderBy(),pageSize:this.pager.input.pageSize(),pageNumber:this.pager.input.pageNumber()}},n.prototype._onRequestDirty=function(){if(this._isActivated()){var n=this._requestHistory(),t=n.length?Enumerable.From(n).Last():null,i=this._currentRequest();t&&this._areRequestsAligned(i,t)||(this._requestHistory.push(i),this._load())}},n.prototype._load=function(){var n=this;this._request().done(function(){n.$results&&n.pager.output.hasItems()&&n.$results.fadeTo(0,1)})},n.prototype._request=function(){var n=this,i=$.Deferred(),u=Enumerable.From(this._requestHistory()).Last(),t=this._currentRequest();return t!=u?(i.reject(),i):(this.spinner.start(),this.$results&&this.$results.fadeTo(200,.5),$.get(App.Routes.WebApi.Agreements.Search.get(this.settings.domain),u).done(function(u){var f=n._currentRequest();t==f?(u.itemTotal<1&&t.pageNumber!=1?n._fixOverflowedPageNumber(t,1):u.pageNumber!=t.pageNumber&&n._fixOverflowedPageNumber(t,u.pageNumber),u.items=Enumerable.From(u.items).Select(function(t){return new r(t,n)}).ToArray(),n.pager.apply(u),n.displayPager.apply(u),n._setLocation(),i.resolve(),n.spinner.stop()):i.reject()}),i)},n.prototype._fixOverflowedPageNumber=function(n,t){for(var i=this._requestHistory().slice(0),u=i[i.length-1],r=i.length-1;r>=0;r--){if(!this._areRequestsAligned(n,i[r],!0))break;u=i[r],this._requestHistory().length>1&&this._areRequestsAligned(n,i[r-1],!0)&&this._requestHistory.pop()}u.pageNumber=t},n.prototype._areRequestsAligned=function(n,t,i){typeof i=="undefined"&&(i=!1);var r=n.keyword===t.keyword&&n.countryCode===t.countryCode&&n.orderBy===t.orderBy&&n.pageSize===t.pageSize;return i||(r=r&&n.pageNumber===t.pageNumber),r},n.prototype._getPageCount=function(n,t,i){return Math.ceil(i/t)},n.KeywordSessionKey="AgreementSearchKeyword2",n.PageSizeSessionKey="AgreementSearchPageSize2",n.OrderBySessionKey="AgreementSearchOrderBy2",n.CountrySessionKey="AgreementSearchCountry2",n.PageNumberSessionKey="AgreementSearchPageNumber2",n}(),r,t,i;n.TableSearch=u,r=function(){function n(n,t){var i=this;this.owner=t,this.id=ko.observable(),this.name=ko.observable(),this.countryNames=ko.observable(),this.startsOn=ko.observable(),this.expiresOn=ko.observable(),this.type=ko.observable(),this.status=ko.observable(),this.countries=ko.observableArray(),this.participants=ko.observableArray(),this.detailHref=ko.computed(function(){return i.owner.settings.detailUrl.format(i.id())}),this.hasCountries=ko.computed(function(){var n=i.countries();return n&&n.length>0}),this.partners=ko.computed(function(){return Enumerable.From(i.participants()).Where(function(n){return!n.isOwner()}).ToArray()}),this.startsOnFormatted=ko.computed(function(){var n=i.startsOn();return moment(n).format("M/D/YYYY")}),this.expiresOnFormatted=ko.computed(function(){var n=i.expiresOn();return n?moment(n).format("M/D/YYYY"):""}),ko.mapping.fromJS(n,{},this)}return n.prototype.partnerTranslatedName=function(n){var t=this.partners()[n];return t.establishmentTranslatedName()},n.prototype.partnerOfficialName=function(n){var t=this.partners()[n];return t.establishmentOfficialName()},n}(),n.TableRow=r,t=function(){function n(n,t){this.items=ko.observableArray(),this.input=new i(n,t),this.output=new i(n,t)}return n.prototype.apply=function(n){this.input.apply(n),this.output.apply(n),this.items(n.items)},n}(),n.SearchResultPager=t,i=function(){function n(n,t){var i=this;this.pageNumberText=ko.observable("1"),this.pageSizeText=ko.observable("10"),this.itemCount=ko.observable(),this.itemTotal=ko.observable(),this.pageNumber=ko.computed(function(){return parseInt(i.pageNumberText())}),this.pageSize=ko.computed(function(){return parseInt(i.pageSizeText())}),this.isItemTotalDefined=ko.computed(function(){var n=i.itemTotal();return n||n==0}),this.pageCount=ko.computed(function(){return i.isItemTotalDefined()?Math.ceil(i.itemTotal()/i.pageSize()):undefined}),this.pageIndex=ko.computed(function(){return i.pageNumber()-1}),this.firstIndex=ko.computed(function(){return i.pageIndex()*i.pageSize()}),this.firstNumber=ko.computed(function(){return i.firstIndex()+1}),this.lastNumber=ko.computed(function(){return i.isItemTotalDefined()?i.firstIndex()+i.itemCount():0}),this.lastIndex=ko.computed(function(){return i.lastNumber()-1}),this.nextAllowed=ko.computed(function(){var n=i.pageCount();return n==undefined||n>i.pageNumber()}),this.prevAllowed=ko.computed(function(){var n=i.pageNumber()-1;return n>0}),this.hasItems=ko.computed(function(){return i.isItemTotalDefined()&&i.itemTotal()>0}),this.hasManyItems=ko.computed(function(){return i.lastNumber()>i.firstNumber()}),this.hasNoItems=ko.computed(function(){return!i.hasItems()}),this.hasManyPages=ko.computed(function(){return i.pageCount()>1}),this.pageNumberText(n),this.pageSizeText(t)}return n.prototype.apply=function(n){this.pageSizeText(n.pageSize.toString()),this.pageNumberText(n.itemTotal>0?n.pageNumber.toString():"1"),this.itemTotal(n.itemTotal),this.itemCount(n.items.length)},n.prototype.next=function(){var n=this.pageNumber()+1;this.pageNumberText(n.toString())},n.prototype.prev=function(){var n=this.pageNumber()-1;this.pageNumberText(n.toString())},n}(),n.SearchResultPagerStatus=i})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))