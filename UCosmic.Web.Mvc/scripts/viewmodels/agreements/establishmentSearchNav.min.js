var Agreements;(function(n){var t=function(){function n(n,t,i,r){this.isOwner=ko.observable(n),this.establishmentId=ko.observable(t),this.establishmentOfficialName=ko.observable(i),this.establishmentTranslatedName=ko.observable(r)}return n}(),i;n.InstitutionalAgreementParticipantModel=t,i=function(){function n(n,t,i,r,u,f){this.establishmentSearchViewModel=new Establishments.ViewModels.Search,this.hasBoundSearch={does:!1},this.hasBoundItem=!1,this.editOrNewUrl=n,this.participants=t,this.agreementIsEdit=i,this.agreementId=r,this.scrollBody=u,this.deferredPageFadeIn=f}return n.prototype.SearchPageBind=function(n){var t=this,i=$("#cancelAddParticipant"),r=$("#searchSideBarAddNew"),u=$.Deferred(),f=$.Deferred(),e=$("#allParticipants"),o=$("#addEstablishment");this.establishmentSearchViewModel.detailTooltip=function(){return"Choose this establishment as a "+n},i.off(),r.off();r.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/new/"),n.preventDefault(),!1});if(n==="parent")i.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/new/"),n.preventDefault(),!1});else i.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/index"),n.preventDefault(),!1});this.fadeModsOut(u,f,e,o,500),$.when(u,f).done(function(){$("#estSearch").fadeIn(500)})},n.prototype.fadeModsOut=function(n,t,i,r,u){i.css("display")!=="none"?i.fadeOut(u,function(){n.resolve()}):n.resolve(),r.css("display")!=="none"?r.fadeOut(u,function(){t.resolve()}):t.resolve()},n.prototype.bindSearch=function(){var n=this,i;this.hasBoundSearch.does||(i="asdf",this.establishmentSearchViewModel.sammyBeforeRoute=/\#\/index\/(.*)\//,this.establishmentSearchViewModel.sammyGetPageRoute="#/index",this.establishmentSearchViewModel.sammyDefaultPageRoute="/agreements[/]?",ko.applyBindings(this.establishmentSearchViewModel,$("#estSearch")[0]),this.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf("#")===-1&&(this.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(""+this.editOrNewUrl.val+"")===-1?this.establishmentSearchViewModel.sammy.setLocation("/agreements/"+this.editOrNewUrl.val+"#/index"):this.establishmentSearchViewModel.sammy.setLocation("#/index")),sessionStorage.getItem("addest")==undefined&&sessionStorage.setItem("addest","no"),this.establishmentSearchViewModel.sammy.bind("location-changed",function(){var f,e,o;if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(i)<0)if(f=$("#asideRootSearch"),e=$("#asideParentSearch"),n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(""+n.editOrNewUrl.val+"#/new/")>0)o=$("#addEstablishment"),r=$.Deferred(),u=$.Deferred(),s=$("#estSearch"),h=$("#allParticipants"),c=500,n.fadeModsOut(r,u,s,h,c),$.when(r,u).done(function(){o.css("visibility","").hide().fadeIn(500,function(){if(!n.hasBoundItem){var t=$("#cancelAddEstablishment");n.establishmentItemViewModel=new Establishments.ViewModels.Item(null,!1),n.establishmentItemViewModel.goToSearch=function(){sessionStorage.setItem("addest","yes"),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/")},n.establishmentItemViewModel.submitToCreate=function(t){if(!n.establishmentItemViewModel.id||n.establishmentItemViewModel.id===0){var s=n.establishmentItemViewModel,i=n.establishmentItemViewModel.names()[0],r=n.establishmentItemViewModel.urls()[0],e=n.establishmentItemViewModel.location;if(n.establishmentItemViewModel.validatingSpinner.start(),i.text.isValidating()||r.value.isValidating()||n.establishmentItemViewModel.ceebCode.isValidating()||n.establishmentItemViewModel.uCosmicCode.isValidating())return setTimeout(function(){var i=n.establishmentItemViewModel.submitToCreate(t);return!1},50),!1;if(n.establishmentItemViewModel.isValidationSummaryVisible(!0),n.establishmentItemViewModel.isValid()||n.establishmentItemViewModel.errors.showAllMessages(),i.isValid()||i.errors.showAllMessages(),r.isValid()||r.errors.showAllMessages(),n.establishmentItemViewModel.validatingSpinner.stop(),i.isValid()&&r.isValid()&&n.establishmentItemViewModel.isValid()){var f=$("#LoadingPage").find("strong"),o=App.Routes.WebApi.Establishments.post(),u=n.establishmentItemViewModel.serializeData();f.text("Creating Establishment..."),u.officialName=i.serializeData(),u.officialUrl=r.serializeData(),u.location=e.serializeData(),n.establishmentItemViewModel.createSpinner.start(),$.post(o,u).done(function(){n.establishmentItemViewModel.createSpinner.stop(),f.text("Establishment created, you are being redirected to previous page..."),$("#addEstablishment").fadeOut(500,function(){$("#LoadingPage").fadeIn(500),setTimeout(function(){$("#LoadingPage").fadeOut(500,function(){f.text("Loading Page...")}),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/")},5e3)})}).fail(function(t){t.status===400&&(n.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))})}}return!1},ko.applyBindings(n.establishmentItemViewModel,o[0]);t.on("click",function(t){return sessionStorage.setItem("addest","no"),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/"),t.preventDefault(),!1});n.hasBoundItem=!0}})}),n.scrollBody.scrollMyBody(0),i="#/new/";else if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(""+n.editOrNewUrl.val+"#/page/")>0)sessionStorage.getItem("addest")==="yes"?(n.establishmentSearchViewModel.clickAction=function(t){return n.establishmentItemViewModel.parentEstablishment(t),n.establishmentItemViewModel.parentId(t.id()),n.establishmentSearchViewModel.sammy.setLocation("#/new/"),!1},n.establishmentSearchViewModel.header("Choose a parent establishment"),f.hide(),e.show(),n.SearchPageBind("parent"),n.establishmentSearchViewModel.header("Choose a parent establishment")):(f.show(),e.hide(),n.SearchPageBind("participant"),n.establishmentSearchViewModel.header("Choose a participant"),n.establishmentSearchViewModel.clickAction=function(i){for(var r=new t(!1,i.id(),i.officialName(),i.translatedName()),f=!1,u=0,e=n.participants.participants().length;u<e;u++)if(n.participants.participants()[u].establishmentId()===r.establishmentId()){f=!0;break}return f!==!0?$.ajax({url:App.Routes.WebApi.Agreements.Participants.isOwner(r.establishmentId()),type:"GET",async:!1}).done(function(t){if(r.isOwner(t),n.agreementIsEdit()){var i=App.Routes.WebApi.Agreements.Participants.put(n.agreementId,r.establishmentId());$.ajax({type:"PUT",url:i,data:r,success:function(){n.participants.participants.push(r)},error:function(n){alert(n.responseText)}})}else n.participants.participants.push(r);n.establishmentSearchViewModel.sammy.setLocation("agreements/"+n.editOrNewUrl.val+""),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*.85)}).fail(function(){if(n.agreementIsEdit()){var t=App.Routes.WebApi.Agreements.Participants.put(n.agreementId,r.establishmentId());$.ajax({type:"PUT",url:t,data:r,success:function(){n.participants.participants.push(r)},error:function(n){alert(n.responseText)}})}else n.participants.participants.push(r);n.establishmentSearchViewModel.sammy.setLocation("agreements/"+n.editOrNewUrl.val+"")}):alert("This Participant has already been added."),!1}),n.scrollBody.scrollMyBody(0),i="#/page/";else if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf("agreements/"+n.editOrNewUrl.val+"")>0){var r=$.Deferred(),u=$.Deferred(),s=$("#estSearch"),h=$("#addEstablishment"),c=500;sessionStorage.setItem("addest","no"),i="#/index",n.establishmentSearchViewModel.sammy.setLocation("#/index"),n.fadeModsOut(r,u,s,h,c),$.when(r,u).done(function(){$("#allParticipants").fadeIn(500).promise().done(function(){$(n).show(),n.scrollBody.scrollMyBody(0),n.deferredPageFadeIn.resolve()})})}else window.location.replace(n.establishmentSearchViewModel.sammy.getLocation())}),this.establishmentSearchViewModel.sammy.run())},n}(),n.EstablishmentSearchNav=i})(Agreements||(Agreements={}))