var Agreements;(function(n){(function(n){var t=function(){function n(n,t){var i=this,r,u;this.isBound=ko.observable(!1),this.files=ko.observableArray(),this.content=ko.observable(),this.expiresOn=ko.observable(),this.isAutoRenew=ko.observable(),this.status=ko.observable(),this.isExpirationEstimated=ko.observable(),this.name=ko.observable(),this.notes=ko.observable(),this.participants=ko.observableArray(),this.startsOn=ko.observable(),this.type=ko.observable(),this.umbrellaId=ko.observable(),this.myUrl=window.location.href.toLowerCase(),this.participantsNames=ko.computed(function(){var n="";return ko.utils.arrayForEach(i.participants(),function(t){n+="<div style='margin-bottom:10px'>",n+=t.establishmentTranslatedName!=null&&t.establishmentOfficialName!=t.establishmentTranslatedName&&t.establishmentOfficialName!=null?"<strong>"+t.establishmentTranslatedName+"<\/strong><br /> ("+t.establishmentOfficialName+")":t.establishmentTranslatedName!=null&&t.establishmentOfficialName!=t.establishmentTranslatedName?"<strong>"+t.establishmentTranslatedName+"<\/strong>":"<strong>"+t.establishmentOfficialName+"<\/strong>",n+="<\/div>"}),n}),this._googleMarkers=ko.observableArray(),isNaN(n)&&(n=0),this.agreementId={val:n},this.agreementVisibility=t||"Public",this.populateFilesClass=new agreements.populateFiles,this._setupDateComputeds(),this.agreementId.val!==0&&(r=this._bindData(),u=this._createMap(),$.when(r,u).done(function(){i._bindMap()}))}return n.prototype._bindData=function(){var n=this,t=$.Deferred();return $.get(App.Routes.WebApi.Agreements.get(this.agreementId.val)).done(function(i){var r={participants:{create:function(n){return n.data}}};ko.mapping.fromJS(i,r,n),n.isBound(!0),t.resolve()}),t},n.prototype.getData=function(){var n=this;$.get(App.Routes.WebApi.Agreements.get(this.agreementId.val)).done(function(t){n.content(t.content),n.expiresOn(t.expiresOn),n.isAutoRenew(t.isAutoRenew),n.status(t.status),n.isExpirationEstimated(t.isExpirationEstimated),n.name(t.name),n.notes(t.notes),ko.mapping.fromJS(t.participants,{},n.participants),n.startsOn(t.startsOn),n.type(t.type),n.umbrellaId(t.umbrellaId),n.isBound(!0)}),this.populateFilesClass.populate(this.agreementId),this.files=this.populateFilesClass.files},n.prototype._setupNameComputeds=function(){var n=this;this.participantsNames=ko.computed(function(){var t="";return ko.utils.arrayForEach(n.participants(),function(n){t+="<div style='margin-bottom:10px'>",t+=n.establishmentTranslatedName()!=null&&n.establishmentOfficialName()!=n.establishmentTranslatedName()&&n.establishmentOfficialName()!=null?"<strong>"+n.establishmentTranslatedName()+"<\/strong><br /> ("+n.establishmentOfficialName()+")":n.establishmentTranslatedName()!=null&&n.establishmentOfficialName()!=n.establishmentTranslatedName()?"<strong>"+n.establishmentTranslatedName()+"<\/strong>":"<strong>"+n.establishmentOfficialName()+"<\/strong>",t+="<\/div>"}),t})},n.prototype._setupDateComputeds=function(){var n=this;this.startsOnDate=ko.computed(function(){var t=n.startsOn(),i=new Date(t);return i.getFullYear()<1500?"unknown":moment(t).format("M/D/YYYY")}),this.expiresOnDate=ko.computed(function(){var t=n.expiresOn(),i=new Date(t);return i.getFullYear()<1500?"unknown":moment(t).format("M/D/YYYY")})},n.prototype._createMap=function(){this._googleMap=new google.maps.Map(document.getElementById("map-canvas"),{mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(0,0),zoom:1,draggable:!0,scrollwheel:!1});var n=$.Deferred();return google.maps.event.addListenerOnce(this._googleMap,"idle",function(){n.resolve()}),n},n.prototype._bindMap=function(){var e=this,r=Enumerable.From(this.participants()).Where(function(n){return!n.isOwner}).ToArray(),t=Enumerable.From(r).Where(function(n){return n.center&&n.center.hasValue}).Select(function(n){return n.center}).ToArray(),u=Enumerable.From(t).Select(function(n){return new google.maps.LatLng(n.latitude,n.longitude)}).ToArray(),i=new google.maps.LatLngBounds,n,f;$.each(u,function(n,u){var f=Enumerable.From(r).Single(function(i){return i.center&&i.center==t[n]}).establishmentTranslatedName,o={map:e._googleMap,position:u,title:f},s=new google.maps.Marker(o);i.extend(u),e._googleMarkers.push(s)}),t.length==1?(this._googleMap.setCenter(u[0]),n=Enumerable.From(r).Single(function(n){return n.center&&n.center==t[0]}),f=n.googleMapZoomLevel,f?this._googleMap.setZoom(f):n.boundingBox&&n.boundingBox.hasValue&&(i=new google.maps.LatLngBounds(new google.maps.LatLng(n.boundingBox.southWest.latitude,n.boundingBox.southWest.longitude),new google.maps.LatLng(n.boundingBox.northEast.latitude,n.boundingBox.northEast.longitude)),this._googleMap.fitBounds(i),this._googleMap.setCenter(u[0]))):t.length>0&&this._googleMap.fitBounds(i)},n.prototype._animateMapZoom=function(n){var r=this,t=this._googleMap.getZoom();if(t!=n){var u=n-t,f=u>0?1:-1,i=t+f;this._googleMap.setZoom(i),i!=t&&setTimeout(function(){r._animateMapZoom(n)},100)}},n.prototype.createMap=function(){function t(){for(var o=Enumerable.From(n.participants()).Where(function(n){return!n.isOwner}).ToArray(),e=Enumerable.From(n.participants()).Select(function(n){return n.center}).ToArray(),i=Enumerable.From(e).Select(function(n){return new google.maps.LatLng(n.latitude,n.longitude)}).ToArray(),r,u=new google.maps.LatLngBounds,t=0,f=i.length;t<f;t++)u.extend(i[t]);r=new google.maps.Map(document.getElementById("map-canvas"),{mapTypeId:google.maps.MapTypeId.ROADMAP,mapMaker:!0}),r.fitBounds(u)}var n=this;google.maps.event.addDomListener(window,"load",t)},n}();n.PublicView=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))