var Agreements;(function(n){(function(n){var i=function(){function n(t){var i=this;this.settings=t,this.continentCode=ko.observable(parseInt(sessionStorage.getItem(n.ContinentSessionKey))||"any"),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.placeId=ko.observable(parseInt(sessionStorage.getItem(n.PlaceIdSessionKey)||0)),this.zoom=ko.observable(parseInt(sessionStorage.getItem(n.ZoomSessionKey))||1),this.lat=ko.observable(parseInt(sessionStorage.getItem(n.LatSessionKey))||n._defaultMapCenter.lat()),this.lng=ko.observable(parseInt(sessionStorage.getItem(n.LngSessionKey))||n._defaultMapCenter.lng()),this.detailPreference=ko.observable(sessionStorage.getItem(n.DetailPrefSessionKey)),this.detailPreferenceChecked=ko.computed({read:function(){return i.detailPreference()=="_blank"},write:function(n){i.detailPreference(n?"_blank":"")}}),this._inputChanged=ko.computed(function(){i.countryCode()==undefined&&i.countryCode("any"),i.continentCode()==undefined&&i.continentCode("any"),sessionStorage.setItem(n.ContinentSessionKey,i.continentCode()),sessionStorage.setItem(n.CountrySessionKey,i.countryCode()),sessionStorage.setItem(n.PlaceIdSessionKey,i.placeId().toString()),sessionStorage.setItem(n.ZoomSessionKey,i.zoom().toString()),sessionStorage.setItem(n.LatSessionKey,i.lat().toString()),sessionStorage.setItem(n.LngSessionKey,i.lng().toString()),sessionStorage.setItem(n.DetailPrefSessionKey,i.detailPreference()||"")}).extend({throttle:0}),this._map=new App.GoogleMaps.Map("google_map_canvas",{center:new google.maps.LatLng(this.lat(),this.lng()),zoom:this.zoom(),streetViewControl:!1,panControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}},{maxPrecision:8,log:!0}),this.status={agreementCount:ko.observable("?"),partnerCount:ko.observable("?"),countryCount:ko.observable("?")},this.summary={agreementCount:ko.observable("?"),partnerCount:ko.observable("?"),countryCount:ko.observable("?")},this.countries=ko.observableArray(),this.countryOptions=ko.computed(function(){return i._computeCountryOptions()}),this.continentOptions=ko.computed(function(){return i._computeContinentOptions()}),this.routeFormat="#/{0}/continent/{6}/country/{1}/place/{2}/zoom/{3}/latitude/{4}/longitude/{5}/".format(this.settings.route).replace("{6}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return i._computeRoute()}),this._scopeHistory=ko.observableArray(),this._currentScope=ko.computed(function(){return i._computeCurrentScope()}),this._scopeDirty=ko.computed(function(){i._onScopeDirty()}).extend({throttle:1}),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!1)),this.infoWindowContent={partner:ko.observable({}),agreements:ko.observableArray([])},this._loadSummary(),this._loadCountryOptions(),this.sammy=this.settings.sammy||Sammy(),this._runSammy(),this.lat.subscribe(function(n){n})}return n.prototype._loadSummary=function(){var n=this;$.get(this.settings.summaryApi).done(function(t){ko.mapping.fromJS(t,{},n.summary)})},n.prototype.clearFilter=function(){this.placeId()?this.placeId(0):this.countryCode()!="any"?this.countryCode("any"):this.continentCode()!="any"&&this.continentCode("any")},n.prototype._computeCountryOptions=function(){var n=[{code:this.countryCode(),name:"[Loading...]"}],i=this.countries(),r,u,t;return i&&i.length&&(r={code:"any",name:"[All countries]"},u={code:"none",name:"[Without country]"},n=i.slice(0),t=this.continentCode(),t!="any"&&t!="none"&&(n=Enumerable.From(n).Where(function(n){return n.continentCode==t}).ToArray()),n=Enumerable.From([r]).Concat(n).Concat([u]).ToArray()),n},n.prototype._computeContinentOptions=function(){var n=[{code:this.continentCode(),name:"[Loading...]"}],t=this.countries(),i,r;return t&&t.length&&(i={code:"any",name:"[All continents]"},r={code:"none",name:"[Without continent]"},n=Enumerable.From(t).Select(function(n){return{code:n.continentCode,name:n.continentName}}).Distinct(function(n){return n.code}).OrderBy(function(n){return n.name}).ToArray(),n=Enumerable.From([i]).Concat(n).Concat([r]).ToArray()),n},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){t.countries(i),n.resolve()}),n},n.prototype.continentSelected=function(){this.countryCode("any"),this.placeId(0)},n.prototype.countrySelected=function(){this.placeId(0)},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n._onBeforeRoute(t)}),this.sammy.get(this.routeFormat.format(":continent",":country",":place",":zoom",":lat",":lng"),function(){var t=this;n._onRoute(t)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){n.setLocation()}),this.settings.sammy||this.sammy.isRunning()||this.sammy.run()},n.prototype._onBeforeRoute=function(){return!0},n.prototype._onRoute=function(n){var t=n.params.continent,i=n.params.country,r=n.params.place,u=n.params.zoom,f=n.params.lat,e=n.params.lng;this.continentCode(t),this.countryCode(i),this.placeId(parseInt(r)),this.zoom(parseInt(u)),this.lat(parseFloat(f)),this.lng(parseFloat(e)),this.activate()},n.prototype.activate=function(){var n=this;this._isActivated()||$.when(this._map.ready()).then(function(){n._isActivated(!0)})},n.prototype.deactivate=function(){this._isActivated()&&this._isActivated(!1)},n.prototype._computeRoute=function(){var n=this.continentCode(),t=this.countryCode(),i=this.placeId(),r=this.zoom(),u=this.lat(),f=this.lng();return this.routeFormat.format(n,t,i,r,u,f)},n.prototype.setLocation=function(){var n=this._route();this.sammy.getLocation().indexOf(n)<0&&this.sammy.setLocation(n)},n.prototype._computeCurrentScope=function(){return{continentCode:this.continentCode(),countryCode:this.countryCode(),placeId:this.placeId()}},n.prototype._onScopeDirty=function(){var i=this;if(this._isActivated()){var r=this._scopeHistory(),n=r.length?Enumerable.From(r).Last():null,t=this._currentScope();n&&n.countryCode==t.countryCode&&n.continentCode==t.continentCode&&n.placeId==t.placeId||(this._scopeHistory.push(t),$.when(this._map.ready()).then(function(){i._map.triggerResize(),i._load()}))}},n.prototype._load=function(){var n=this,r,u;if(this.spinner.start(),this.placeId())u=this._requestPartners(),$.when(u).done(function(){n._receivePartners()}).always(function(){n.spinner.stop()});else{var t="",f=this.continentCode(),i=this.countryCode();f=="any"&&i=="any"?t="continents":i=="any"&&(t="countries"),r=this._requestPlaces(t),$.when(r).done(function(){n._receivePlaces(t),setTimeout(function(){n._requestPlaces("continents"),n._requestPlaces("countries"),n._requestPlaces("")},0)}).always(function(){n.spinner.stop()})}},n.prototype._requestPlaces=function(n){var i=this,t=$.Deferred(),r;return n!="countries"||this._continentsResponse?(n!="continents"||this._continentsResponse)&&(n!="countries"||this._countriesResponse)&&(n||this._placesResponse)?t.resolve():$.get(this.settings.partnerPlacesApi.format(n)).done(function(r){n=="continents"?i._continentsResponse=ko.observableArray(r):n=="countries"?i._countriesResponse=ko.observableArray(r):i._placesResponse=ko.observableArray(r),t.resolve()}).fail(function(n){App.Failures.message(n,"while trying to load agreement map data",!0),t.reject()}):(r=this._requestPlaces("continents"),$.when(r).then(function(){i._requestPlaces("countries").done(function(){t.resolve()})})),t},n.prototype._receivePlaces=function(n){var f=this,t=n=="continents"?this._continentsResponse():n=="countries"?this._countriesResponse():this._placesResponse(),i,r,u;n=="countries"&&(i=this.continentCode(),t=Enumerable.From(t).Where(function(n){return i=="none"?!n.id:n.continentCode==i}).ToArray()),n||(r=this.countryCode(),t=Enumerable.From(t).Where(function(n){return r=="none"?!n.countryId:n.countryCode==r}).ToArray()),this._updateStatus(n,t),this._plotMarkers(n,t),u=this._getMapViewportSettings(n,t),this._map.setViewport(u).then(function(){f._updateRoute()})},n.prototype._getMapViewportSettings=function(t,i){var u={bounds:new google.maps.LatLngBounds},s,f,h,o,r,e;return t=="continents"?(u.zoom=1,u.center=n._defaultMapCenter):t=="countries"?(s=this.continentCode(),i.length?i.length==1?(r=i[0],r&&r.boundingBox&&r.boundingBox.hasValue&&(u.bounds=Places.Utils.convertToLatLngBounds(r.boundingBox))):(e=Enumerable.From(i).Select(function(n){return new google.maps.LatLng(n.center.latitude,n.center.longitude)}).ToArray(),$.each(e,function(n,t){u.bounds.extend(t)})):s&&this._continentsResponse&&(f=Enumerable.From(this._continentsResponse()).SingleOrDefault(undefined,function(n){return n.continentCode==s}),f&&f.boundingBox&&f.boundingBox.hasValue&&(u.bounds=Places.Utils.convertToLatLngBounds(f.boundingBox)))):(h=this.countryCode(),i.length?i.length==1?(r=i[0],r&&r.boundingBox&&r.boundingBox.hasValue&&(u.bounds=Places.Utils.convertToLatLngBounds(r.boundingBox))):(e=Enumerable.From(i).Select(function(n){return new google.maps.LatLng(n.center.latitude,n.center.longitude)}).ToArray(),$.each(e,function(n,t){u.bounds.extend(t)})):h&&this.countryOptions&&(o=Enumerable.From(this.countryOptions()).SingleOrDefault(undefined,function(n){return n.code==h}),o&&o.box&&o.box.hasValue&&(u.bounds=Places.Utils.convertToLatLngBounds(o.box)))),u},n.prototype._plotMarkers=function(n,t){var i=this,s=n=="countries"?this._getMarkerIconScaler(n,this._countriesResponse()):this._getMarkerIconScaler(n,t),o=this.continentCode(),u,f,r,e;n!="countries"||t.length||o=="none"||(u=Enumerable.From(this._continentsResponse()).SingleOrDefault(undefined,function(n){return n.continentCode==o}),u&&(t=[u])),f=this.countryCode(),n||t.length||f=="none"||(r=Enumerable.From(this.countryOptions()).SingleOrDefault(undefined,function(n){return n.code==f}),r&&(t=[{id:r.id,agreementCount:0,name:r.name,center:r.center,boundingBox:r.box,isCountry:!0,countryCode:r.code,continentCode:r.continentCode}])),e=[],$.each(t,function(t,r){var f,o,u;(n!="continents"||r.agreementCount)&&(f="{0} - {1} agreement{2}".format(r.name,r.agreementCount,r.agreementCount==1?"":"s"),!n&&r.agreementCount&&(f="{0} agreement{1}\r\nClick for more information".format(r.agreementCount,r.agreementCount==1?"":"s")),o={position:Places.Utils.convertToLatLng(r.center),title:f,clickable:r.agreementCount>0,cursor:"pointer"},i._setMarkerIcon(o,r.agreementCount.toString(),s),u=new google.maps.Marker(o),e.push(u),google.maps.event.addListener(u,"mouseover",function(){u.setOptions({zIndex:201})}),google.maps.event.addListener(u,"mouseout",function(){var n=u.getIcon().size.width;setTimeout(function(){u.setOptions({zIndex:200-n})},400)}),n==="continents"?google.maps.event.addListener(u,"click",function(){if(r.agreementCount==1){var n=i.settings.detailUrl.format(r.agreementIds[0]),t=i.detailPreference();t=="_blank"?window.open(n,t):location.href=n}else i._map.setViewport({bounds:Places.Utils.convertToLatLngBounds(r.boundingBox)}),r.id<1?i.continentCode("none"):(i.continentCode(r.continentCode),i.countryCode("any"),i.placeId(0))}):n==="countries"?google.maps.event.addListener(u,"click",function(){if(r.agreementCount==1){var n=i.settings.detailUrl.format(r.agreementIds[0]),t=i.detailPreference();t=="_blank"?window.open(n,t):location.href=n}else r.id>0&&(i.continentCode("any"),i.countryCode(r.countryCode),i.placeId(0))}):n||google.maps.event.addListener(u,"click",function(){if(r.agreementCount==1){var n=i.settings.detailUrl.format(r.agreementIds[0]),t=i.detailPreference();t=="_blank"?window.open(n,t):location.href=n}else r.id&&i.placeId(r.id)}))}),this._map.replaceMarkers(e)},n.prototype._updateRoute=function(){this.lat(this._map.lat()),this.lng(this._map.lng()),this.zoom(this._map.zoom()),this.setLocation()},n.prototype._updateStatus=function(n,t){var u,i,f,r;t&&t.length?(this.status.agreementCount(Enumerable.From(t).Sum(function(n){return n.agreementCount}).toString()),this.status.partnerCount(Enumerable.From(t).Sum(function(n){return n.partnerCount}).toString())):(this.status.agreementCount("0"),this.status.partnerCount("0")),n=="countries"?(u=this.continentCode(),u=="none"?this.status.countryCount("unknown continent"):(i=Enumerable.From(this.continentOptions()).SingleOrDefault(undefined,function(n){return n.code==u}),i&&i.name&&this.status.countryCount(i.name))):n||(f=this.countryCode(),f=="none"?this.status.countryCount("unknown country"):(r=Enumerable.From(this.countryOptions()).SingleOrDefault(undefined,function(n){return n.code==f}),r&&r.name&&this.status.countryCount(r.name)))},n.prototype._getMarkerIconScaler=function(n,i){if(!i||!i.length)return new t({min:0,max:1},{min:16,max:16});var u={min:Enumerable.From(i).Min(function(n){return n.agreementCount}),max:Enumerable.From(i).Max(function(n){return n.agreementCount})},r={min:24,max:48};return n||(r={min:24,max:32}),new t(u,r)},n.prototype._setMarkerIcon=function(n,t,i){var r=isNaN(parseInt(t))?24:i.scale(parseInt(t));t=="0"&&(r=24);var u=r/2,f={opacity:.7,side:r,text:t,fillColor:"rgb(11, 11, 11)"},e="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(f)),o={url:e,size:new google.maps.Size(r,r),anchor:new google.maps.Point(u,u)},s={type:"circle",coords:[u,u,u]};n.icon=o,n.shape=s,n.zIndex=200-r},n.prototype._requestPartners=function(){var i=this,n=$.Deferred(),r,u,t;return this._placesResponse?(u=this.placeId(),t=Enumerable.From(this._placesResponse()).SingleOrDefault(undefined,function(n){return n.id==u}),t&&t.agreementCount?$.get(this.settings.partnersApi,{agreementIds:t.agreementIds}).done(function(t){i._partnersResponse=ko.observableArray(t),n.resolve()}).fail(function(t){App.Failures.message(t,"while trying to load agreement partner data",!0),n.reject()}):(this.status.agreementCount("0"),this.status.partnerCount("0"),this.status.countryCount("this area"),n.reject(),this.spinner.stop())):(r=this._requestPlaces(""),$.when(r).then(function(){i._requestPartners().done(function(){n.resolve()})})),n},n.prototype._receivePartners=function(){var n=this,f=this._partnersResponse(),i=Enumerable.From(f).Distinct(function(n){return n.establishmentId}).ToArray(),r={bounds:new google.maps.LatLngBounds},t,u,e;i.length==1?(t=i[0],r.center=Places.Utils.convertToLatLng(t.center),t.googleMapZoomLevel?r.zoom=t.googleMapZoomLevel:t.boundingBox&&t.boundingBox.hasValue&&(r.bounds=Places.Utils.convertToLatLngBounds(t.boundingBox))):i.length>1?$.each(i,function(n,t){r.bounds.extend(Places.Utils.convertToLatLng(t.center))}):alert("Found no agreement partners for place #{0}.".format(this.placeId())),u=[],e=this._getMarkerIconScaler("",this._placesResponse()),$.each(i,function(t,i){var r=Enumerable.From(f).Where(function(n){return n.establishmentId==i.establishmentId}).Distinct(function(n){return n.agreementId}).ToArray(),s={position:Places.Utils.convertToLatLng(i.center),title:"{0} - {1} agreement{2}".format(i.establishmentTranslatedName,r.length,r.length==1?"":"s"),clickable:!0,cursor:"pointer"},o;n._setMarkerIcon(s,r.length.toString(),e),o=new google.maps.Marker(s),u.push(o),google.maps.event.addListener(o,"click",function(){var t,u,f,e;r.length==1?(t=n.settings.detailUrl.format(i.agreementId),u=n.detailPreference(),u=="_blank"?window.open(t,u):location.href=t):(n.infoWindowContent.partner(i),n.infoWindowContent.agreements(Enumerable.From(r).OrderByDescending(function(n){return n.agreementStartsOn}).ToArray()),f=n.$infoWindow.html(),e={content:$.trim(f)},n._map.clearInfoWindows(),n._map.openInfoWindowAtMarker(e,o))})}),this._map.replaceMarkers(u),u.length==1&&google.maps.event.trigger(u[0],"click"),this.status.agreementCount(Enumerable.From(f).Distinct(function(n){return n.agreementId}).Count().toString()),this.status.partnerCount(i.length.toString()),this.status.countryCount("this area"),this._map.setViewport(r).then(function(){n._updateRoute()})},n._defaultMapCenter=new google.maps.LatLng(0,17),n.ContinentSessionKey="AgreementSearchContinent",n.CountrySessionKey="AgreementSearchCountry2",n.PlaceIdSessionKey="AgreementMapSearchPlaceId",n.ZoomSessionKey="AgreementSearchZoom",n.LatSessionKey="AgreementSearchLat",n.LngSessionKey="AgreementSearchLng",n.DetailPrefSessionKey="AgreementSearchMapDetailPreference",n}(),t;n.SearchMap=i,t=function(){function n(n,t){this.from=n,this.into=t}return n.prototype.scale=function(n){var t=this.into.min,i=this.from.max-this.from.min,f=this.into.max-this.into.min,r,u;return i&&(r=(n-this.from.min)/i,u=Math.round(r*f),t+=u),t<this.into.min&&(t=this.into.min),t>this.into.max&&(t=this.into.max),t},n}(),n.Scaler=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))