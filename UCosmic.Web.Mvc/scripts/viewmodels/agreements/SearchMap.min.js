var Agreements;(function(n){(function(n){var t=function(){function n(t){var i=this;this.settings=t,this.keyword=ko.observable(sessionStorage.getItem(n.KeywordSessionKey)||""),this.keywordThrottled=ko.computed(this.keyword).extend({throttle:400}),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.zoom=ko.observable(parseInt(sessionStorage.getItem(n.ZoomSessionKey))||1),this.lat=ko.observable(parseInt(sessionStorage.getItem(n.LatSessionKey))||0),this.lng=ko.observable(parseInt(sessionStorage.getItem(n.LngSessionKey))||17),this.scope=ko.observable(parseInt(sessionStorage.getItem(n.ScopeSessionKey))||"continents"),this._inputChanged=ko.computed(function(){i.countryCode()==undefined&&i.countryCode("any"),sessionStorage.setItem(n.KeywordSessionKey,i.keyword()||""),sessionStorage.setItem(n.CountrySessionKey,i.countryCode()),sessionStorage.setItem(n.ZoomSessionKey,i.zoom().toString()),sessionStorage.setItem(n.LatSessionKey,i.lat().toString()),sessionStorage.setItem(n.LngSessionKey,i.lng().toString()),sessionStorage.setItem(n.ScopeSessionKey,i.scope())}).extend({throttle:0}),this.countryOptions=ko.observableArray([{code:"any",name:"[Loading...]"}]),this._countryChanged=ko.computed(function(){i._onCountryChanged()}),this.routeFormat="#/{0}/country/{4}/zoom/{1}/latitude/{2}/longitude/{3}/".format(this.settings.route).replace("{4}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return i._computeRoute()}),this.north=ko.observable(),this.south=ko.observable(),this.east=ko.observable(),this.west=ko.observable(),this.latitude=ko.observable(),this.longitude=ko.observable(),this.mag=ko.observable(),this._mapCreated=this._createMap(),$.when(this._mapCreated).then(function(){i._bindMap()}),this._loadCountryOptions(),this.sammy=this.settings.sammy||Sammy(),this._runSammy()}return n.prototype._onCountryChanged=function(){var t=this.countryCode(),n=this.countryOptions();n.length==1&&n[0].code!=t&&(n[0].code=t)},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){var r=i.slice(0);r=Enumerable.From([{code:"any",name:"[All countries]"}]).Concat(r).Concat([{code:"none",name:"[Without country]"}]).ToArray(),t.countryOptions(r),n.resolve()}),n},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n._onBeforeRoute(t)}),this.sammy.get(this.routeFormat.format(":country",":zoom",":lat",":lng"),function(){var t=this;n._onRoute(t)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){var t=this;n.onBeforeActivation(t)}),this.settings.sammy||this.sammy.isRunning()||this.sammy.run()},n.prototype._onBeforeRoute=function(){return!0},n.prototype._onRoute=function(n){var t=n.params.country,i=n.params.zoom,r=n.params.lat,u=n.params.lng;this.countryCode(t),this._isActivated()||this._isActivated(!0)},n.prototype.onBeforeActivation=function(){this._setLocation()},n.prototype._computeRoute=function(){var n=this.countryCode(),t=this.zoom(),i=this.lat(),r=this.lng();return this.routeFormat.format(n,t,i,r)},n.prototype._setLocation=function(){var n=this._route();this.sammy.getLocation().indexOf(n)<0&&this.sammy.setLocation(n)},n.prototype._createMap=function(){var n=this,i=document.getElementById("google_map_canvas"),t;return this._googleMap=new google.maps.Map(i,{mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(this.lat(),this.lng()),zoom:1,draggable:!0,scrollwheel:!1}),t=$.Deferred(),google.maps.event.addListenerOnce(this._googleMap,"idle",function(){google.maps.event.addListener(n._googleMap,"center_changed",function(){n._onMapCenterChanged()}),google.maps.event.addListener(n._googleMap,"zoom_changed",function(){n._onMapZoomChanged()}),google.maps.event.addListener(n._googleMap,"bounds_changed",function(){n._onMapBoundsChanged()}),google.maps.event.trigger(n._googleMap,"center_changed"),google.maps.event.trigger(n._googleMap,"zoom_changed"),google.maps.event.trigger(n._googleMap,"bounds_changed"),t.resolve()}),t},n.prototype._onMapZoomChanged=function(){this.mag(this._googleMap.getZoom())},n.prototype._onMapCenterChanged=function(){var n=this._googleMap.getCenter();this.latitude(n.lat()),this.longitude(n.lng())},n.prototype._onMapBoundsChanged=function(){var n=this._googleMap.getBounds(),i=n.getNorthEast().lat(),r=n.getSouthWest().lat(),u=n.getNorthEast().lng(),f=n.getSouthWest().lng(),t=11;this.north(Number(i.toString().substring(0,t))),this.south(Number(r.toString().substring(0,t))),this.east(Number(u.toString().substring(0,t))),this.west(Number(f.toString().substring(0,t)))},n.prototype._bindMap=function(){var t=this,n=this.scope();n==="continents"&&$.ajax({url:this.settings.partnerPlacesApi.format(n)}).done(function(n){t._onContinentsResponse(n)})},n.prototype._onContinentsResponse=function(n){for(var r={min:Enumerable.From(n).Min(function(n){return n.agreementCount}),max:Enumerable.From(n).Max(function(n){return n.agreementCount})},i,t=0;t<n.length;t++)i=n[t],this._onContinentResponse(i,r)},n.prototype._onContinentResponse=function(n,t){var e=this,r=this._getMarkerSide(t.min,t.max,n.agreementCount),i=r/2,o={opacity:.8,side:r,text:n.agreementCount},s="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(o)),h={url:s,size:new google.maps.Size(r,r),anchor:new google.maps.Point(i,i)},c={type:"circle",coords:[i,i,i]},u=n.agreementCount>0&&n.id>0,l=u?"pointer":"default",a={map:this._googleMap,position:new google.maps.LatLng(n.center.latitude,n.center.longitude),title:"{0} - {1} agreement(s)".format(n.name,n.agreementCount),clickable:!0,cursor:l,icon:h,shape:c,optimized:!1,zIndex:100},f=new google.maps.Marker(a);u&&google.maps.event.addListener(f,"click",function(t){e._onContinentClick(f,n,t)})},n.prototype._onContinentClick=function(n,t){var i=t.boundingBox.northEast.latitude,r=t.boundingBox.southWest.latitude,u=t.boundingBox.northEast.longitude,f=t.boundingBox.southWest.longitude,e=new google.maps.LatLng(r,f),o=new google.maps.LatLng(i,u),s=new google.maps.LatLngBounds(e,o);this._googleMap.fitBounds(s)},n.prototype._getMarkerSide=function(n,t,i){var r=24,u=t-n,f,e;return u&&(f=(i-n)/u,e=Math.round(f*24),r+=e),r>48&&(r=48),r<16&&(r=16),r},n.KeywordSessionKey="AgreementSearchKeyword2",n.CountrySessionKey="AgreementSearchCountry2",n.ZoomSessionKey="AgreementSearchZoom",n.LatSessionKey="AgreementSearchLat",n.LngSessionKey="AgreementSearchLng",n.ScopeSessionKey="AgreementSearchScope",n}();n.SearchMap=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))