var Agreements;(function(n){(function(n){var i=function(){function n(t){var i=this;this.settings=t,this.keyword=ko.observable(sessionStorage.getItem(n.KeywordSessionKey)||""),this.keywordThrottled=ko.computed(this.keyword).extend({throttle:400}),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.zoom=ko.observable(parseInt(sessionStorage.getItem(n.ZoomSessionKey))||1),this.lat=ko.observable(parseInt(sessionStorage.getItem(n.LatSessionKey))||0),this.lng=ko.observable(parseInt(sessionStorage.getItem(n.LngSessionKey))||17),this.scope=ko.observable(parseInt(sessionStorage.getItem(n.ScopeSessionKey))||"continents"),this._inputChanged=ko.computed(function(){i.countryCode()==undefined&&i.countryCode("any"),sessionStorage.setItem(n.KeywordSessionKey,i.keyword()||""),sessionStorage.setItem(n.CountrySessionKey,i.countryCode()),sessionStorage.setItem(n.ZoomSessionKey,i.zoom().toString()),sessionStorage.setItem(n.LatSessionKey,i.lat().toString()),sessionStorage.setItem(n.LngSessionKey,i.lng().toString()),sessionStorage.setItem(n.ScopeSessionKey,i.scope())}).extend({throttle:0}),this.countryOptions=ko.observableArray([{code:"any",name:"[Loading...]"}]),this._countryChanged=ko.computed(function(){i._onCountryChanged()}),this.routeFormat="#/{0}/scope/{5}/country/{1}/zoom/{2}/latitude/{3}/longitude/{4}/".format(this.settings.route).replace("{5}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return i._computeRoute()}),this.north=ko.observable(),this.south=ko.observable(),this.east=ko.observable(),this.west=ko.observable(),this.latitude=ko.observable(),this.longitude=ko.observable(),this.mag=ko.observable(),this._scopedContinentId=ko.observable(),this._continentMarkers=ko.observableArray(),this._mapCreated=this._createMap(),$.when(this._mapCreated).then(function(){i._bindMap()}),this._loadCountryOptions(),this.sammy=this.settings.sammy||Sammy(),this._runSammy()}return n.prototype._onCountryChanged=function(){var t=this.countryCode(),n=this.countryOptions();n.length==1&&n[0].code!=t&&(n[0].code=t)},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){var r=i.slice(0);r=Enumerable.From([{code:"any",name:"[All countries]"}]).Concat(r).Concat([{code:"none",name:"[Without country]"}]).ToArray(),t.countryOptions(r),n.resolve()}),n},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n._onBeforeRoute(t)}),this.sammy.get(this.routeFormat.format(":scope",":country",":zoom",":lat",":lng"),function(){var t=this;n._onRoute(t)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){var t=this;n.onBeforeActivation(t)}),this.settings.sammy||this.sammy.isRunning()||this.sammy.run()},n.prototype._onBeforeRoute=function(){return!0},n.prototype._onRoute=function(n){var i=n.params.scope,t=n.params.country,r=n.params.zoom,u=n.params.lat,f=n.params.lng;this.countryCode(t),this._isActivated()||this._isActivated(!0)},n.prototype.onBeforeActivation=function(){this._setLocation()},n.prototype._computeRoute=function(){var n=this.scope(),t=this.countryCode(),i=this.zoom(),r=this.lat(),u=this.lng();return this.routeFormat.format(n,t,i,r,u)},n.prototype._setLocation=function(){var t=this,n=this._route();this.sammy.getLocation().indexOf(n)<0&&setTimeout(function(){t.sammy.setLocation(n)},1)},n.prototype._createMap=function(){var n=this,i=document.getElementById("google_map_canvas"),t;return this._googleMap=new google.maps.Map(i,{mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(this.lat(),this.lng()),zoom:this.zoom(),draggable:!0,scrollwheel:!1,streetViewControl:!1,panControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}}),t=$.Deferred(),google.maps.event.addListenerOnce(this._googleMap,"idle",function(){google.maps.event.addListener(n._googleMap,"center_changed",function(){n._onMapCenterChanged()}),google.maps.event.addListener(n._googleMap,"zoom_changed",function(){n._onMapZoomChanged()}),google.maps.event.addListener(n._googleMap,"bounds_changed",function(){n._onMapBoundsChanged()}),google.maps.event.trigger(n._googleMap,"center_changed"),google.maps.event.trigger(n._googleMap,"zoom_changed"),google.maps.event.trigger(n._googleMap,"bounds_changed"),t.resolve()}),t},n.prototype._bindMap=function(){var t=this,n=this.scope();n==="continents"?$.ajax({url:this.settings.partnerPlacesApi.format(n)}).done(function(n){t._onContinentsResponse(n)}):n==="countries"&&$.ajax({url:this.settings.partnerPlacesApi.format(n)}).done(function(n){t._onCountriesResponse(n)})},n.prototype._onMapZoomChanged=function(){this.mag(this._googleMap.getZoom())},n.prototype._onMapCenterChanged=function(){var n=this._googleMap.getCenter();this.latitude(n.lat()),this.longitude(n.lng())},n.prototype._onMapBoundsChanged=function(){var n=this._googleMap.getBounds(),i=n.getNorthEast().lat(),r=n.getSouthWest().lat(),u=n.getNorthEast().lng(),f=n.getSouthWest().lng(),t=11;this.north(Number(i.toString().substring(0,t))),this.south(Number(r.toString().substring(0,t))),this.east(Number(u.toString().substring(0,t))),this.west(Number(f.toString().substring(0,t)))},n.prototype._onContinentsResponse=function(n){var u={min:Enumerable.From(n).Min(function(n){return n.agreementCount}),max:Enumerable.From(n).Max(function(n){return n.agreementCount})},f=new t(u,{min:24,max:48}),i,r;for(this._clearContinentMarkers(),i=0;i<n.length;i++)r=n[i],this._onContinentResponse(r,f)},n.prototype._onContinentResponse=function(n,t){var e=this,r=t.scale(n.agreementCount),i=r/2,o={opacity:.8,side:r,text:n.agreementCount},s="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(o)),h={url:s,size:new google.maps.Size(r,r),anchor:new google.maps.Point(i,i)},c={type:"circle",coords:[i,i,i]},u=n.agreementCount>0&&n.id>0;u=!0;var l=u?"pointer":"default",a={map:this._googleMap,position:new google.maps.LatLng(n.center.latitude,n.center.longitude),title:"{0} - {1} agreement(s)".format(n.name,n.agreementCount),clickable:!0,cursor:l,icon:h,shape:c,optimized:!1},f=new google.maps.Marker(a);this._continentMarkers.push(f),u&&google.maps.event.addListener(f,"click",function(t){e._onContinentClick(f,n,t)})},n.prototype._onContinentClick=function(n,t){var i=t.boundingBox.northEast.latitude,r=t.boundingBox.southWest.latitude,u=t.boundingBox.northEast.longitude,f=t.boundingBox.southWest.longitude,e=new google.maps.LatLng(r,f),o=new google.maps.LatLng(i,u),s=new google.maps.LatLngBounds(e,o);this._googleMap.fitBounds(s),this.scope("countries"),this._scopedContinentId(t.id),t.id!=0&&this._bindMap()},n.prototype._clearContinentMarkers=function(){for(var t=this._continentMarkers()||[],i,n=0;n<t.length;n++)i=t[n],i.setMap(null);this._continentMarkers([])},n.prototype._onCountriesResponse=function(n){var u,i;this._clearContinentMarkers();var e=this._scopedContinentId(),r=Enumerable.From(n).Where(function(n){return n.continentId==e}).ToArray(),f=new google.maps.LatLngBounds,o={min:Enumerable.From(n).Min(function(n){return n.agreementCount}),max:Enumerable.From(n).Max(function(n){return n.agreementCount})},s=new t(o,{min:24,max:48});for(u=0;u<r.length;u++)i=r[u],this._onCountryResponse(i,s,f);if(r.length==1){var i=r[0],h=new google.maps.LatLng(i.boundingBox.northEast.latitude,i.boundingBox.northEast.longitude),c=new google.maps.LatLng(i.boundingBox.southWest.latitude,i.boundingBox.southWest.longitude);f=new google.maps.LatLngBounds(c,h)}this._googleMap.fitBounds(f)},n.prototype._onCountryResponse=function(n,t,i){var f=new google.maps.LatLng(n.center.latitude,n.center.longitude);i.extend(f);var u=t.scale(n.agreementCount),r=u/2,e={opacity:.7,side:u,text:n.agreementCount},o="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(e)),s={url:o,size:new google.maps.Size(u,u),anchor:new google.maps.Point(r,r)},h={type:"circle",coords:[r,r,r]},c={map:this._googleMap,position:f,title:"{0} - {1} agreement(s)".format(n.name,n.agreementCount),icon:s,shape:h,optimized:!1},l=new google.maps.Marker(c)},n.KeywordSessionKey="AgreementSearchKeyword2",n.CountrySessionKey="AgreementSearchCountry2",n.ZoomSessionKey="AgreementSearchZoom",n.LatSessionKey="AgreementSearchLat",n.LngSessionKey="AgreementSearchLng",n.ScopeSessionKey="AgreementSearchScope",n}(),t;n.SearchMap=i,t=function(){function n(n,t){this.from=n,this.into=t}return n.prototype.scale=function(n){var t=this.into.min,i=this.from.max-this.from.min,f=this.into.max-this.into.min,r,u;return i&&(r=(n-this.from.min)/i,u=Math.round(r*f),t+=u),t<this.into.min&&(t=this.into.min),t>this.into.max&&(t=this.into.max),t},n}(),n.Scaler=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))