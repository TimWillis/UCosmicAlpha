var Agreements;(function(n){(function(n){var i=function(){function n(t){var i=this;this.settings=t,this.keyword=ko.observable(sessionStorage.getItem(n.KeywordSessionKey)||""),this.keywordThrottled=ko.computed(this.keyword).extend({throttle:400}),this.continentCode=ko.observable(parseInt(sessionStorage.getItem(n.ContinentSessionKey))||"any"),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.zoom=ko.observable(parseInt(sessionStorage.getItem(n.ZoomSessionKey))||1),this.lat=ko.observable(parseInt(sessionStorage.getItem(n.LatSessionKey))||n._defaultMapCenter.lat()),this.lng=ko.observable(parseInt(sessionStorage.getItem(n.LngSessionKey))||n._defaultMapCenter.lng()),this._inputChanged=ko.computed(function(){i.countryCode()==undefined&&i.countryCode("any"),i.continentCode()==undefined&&i.continentCode("any"),sessionStorage.setItem(n.KeywordSessionKey,i.keyword()||""),sessionStorage.setItem(n.ContinentSessionKey,i.continentCode()),sessionStorage.setItem(n.CountrySessionKey,i.countryCode()),sessionStorage.setItem(n.ZoomSessionKey,i.zoom().toString()),sessionStorage.setItem(n.LatSessionKey,i.lat().toString()),sessionStorage.setItem(n.LngSessionKey,i.lng().toString())}).extend({throttle:0}),this.countries=ko.observableArray(),this.countryOptions=ko.computed(function(){return i._computeCountryOptions()}),this.continentOptions=ko.computed(function(){return i._computeContinentOptions()}),this.routeFormat="#/{0}/continent/{5}/country/{1}/zoom/{2}/latitude/{3}/longitude/{4}/".format(this.settings.route).replace("{5}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return i._computeRoute()}),this._scopeHistory=ko.observableArray(),this._currentScope=ko.computed(function(){return i._computeCurrentScope()}),this._scopeDirty=ko.computed(function(){i._onScopeDirty()}).extend({throttle:1}),this._markers=ko.observableArray(),this.north=ko.observable(),this.south=ko.observable(),this.east=ko.observable(),this.west=ko.observable(),this.latitude=ko.observable(),this.longitude=ko.observable(),this.mag=ko.observable(),this._mapCreated=this._createMap(),this._loadCountryOptions(),this.sammy=this.settings.sammy||Sammy(),this._runSammy()}return n.prototype._computeCountryOptions=function(){var n=[{code:this.countryCode(),name:"[Loading...]"}],i=this.countries(),r,u,t;return i&&i.length&&(r={code:"any",name:"[All countries]"},u={code:"none",name:"[Without country]"},n=i.slice(0),t=this.continentCode(),t!="any"&&t!="none"&&(n=Enumerable.From(n).Where(function(n){return n.continentCode==t}).ToArray()),n=Enumerable.From([r]).Concat(n).Concat([u]).ToArray()),n},n.prototype._computeContinentOptions=function(){var n=[{code:this.continentCode(),name:"[Loading...]"}],t=this.countries(),i,r;return t&&t.length&&(i={code:"any",name:"[All continents]"},r={code:"none",name:"[Without continent]"},n=Enumerable.From(t).Select(function(n){return{code:n.continentCode,name:n.continentName}}).Distinct(function(n){return n.code}).OrderBy(function(n){return n.name}).ToArray(),n=Enumerable.From([i]).Concat(n).Concat([r]).ToArray()),n},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){t.countries(i),n.resolve()}),n},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n._onBeforeRoute(t)}),this.sammy.get(this.routeFormat.format(":continent",":country",":zoom",":lat",":lng"),function(){var t=this;n._onRoute(t)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){var t=this;n.onBeforeActivation(t)}),this.settings.sammy||this.sammy.isRunning()||this.sammy.run()},n.prototype._onBeforeRoute=function(){return!0},n.prototype._onRoute=function(n){var t=n.params.continent,i=n.params.country,r=n.params.zoom,u=n.params.lat,f=n.params.lng;this.continentCode(t),this.countryCode(i),this.zoom(parseInt(r)),this.lat(parseFloat(u)),this.lng(parseFloat(f)),this._isActivated()||this._isActivated(!0)},n.prototype.onBeforeActivation=function(){this._setLocation()},n.prototype._computeRoute=function(){var n=this.continentCode(),t=this.countryCode(),i=this.zoom(),r=this.lat(),u=this.lng();return this.routeFormat.format(n,t,i,r,u)},n.prototype._setLocation=function(){var t=this,n=this._route();this.sammy.getLocation().indexOf(n)<0&&setTimeout(function(){t.sammy.setLocation(n)},1)},n.prototype._computeCurrentScope=function(){return{continentCode:this.continentCode(),countryCode:this.countryCode()}},n.prototype._onScopeDirty=function(){var r=this;if(this._isActivated()){var i=this._scopeHistory(),n=i.length?Enumerable.From(i).Last():null,t=this._currentScope();n&&n.countryCode==t.countryCode&&n.continentCode==t.continentCode||(this._scopeHistory.push(t),$.when(this._mapCreated).then(function(){r._load()}))}},n.prototype._createMap=function(){var n=this,i,r,t;return google.maps.visualRefresh=!0,i=document.getElementById("google_map_canvas"),r={mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(this.lat(),this.lng()),zoom:this.zoom(),draggable:!0,scrollwheel:!1,streetViewControl:!1,panControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}},this._googleMap=new google.maps.Map(i,r),t=$.Deferred(),google.maps.event.addListenerOnce(this._googleMap,"idle",function(){google.maps.event.addListener(n._googleMap,"center_changed",function(){n._onMapCenterChanged()}),google.maps.event.addListener(n._googleMap,"zoom_changed",function(){n._onMapZoomChanged()}),google.maps.event.addListener(n._googleMap,"bounds_changed",function(){n._onMapBoundsChanged()}),google.maps.event.trigger(n._googleMap,"center_changed"),google.maps.event.trigger(n._googleMap,"zoom_changed"),google.maps.event.trigger(n._googleMap,"bounds_changed"),t.resolve()}),t},n.prototype._onMapZoomChanged=function(){this.mag(this._googleMap.getZoom())},n.prototype._onMapCenterChanged=function(){var n=this._googleMap.getCenter();this.latitude(n.lat()),this.longitude(n.lng())},n.prototype._onMapBoundsChanged=function(){var n=this._googleMap.getBounds(),i=n.getNorthEast().lat(),r=n.getSouthWest().lat(),u=n.getNorthEast().lng(),f=n.getSouthWest().lng(),t=11;this.north(Number(i.toString().substring(0,t))),this.south(Number(r.toString().substring(0,t))),this.east(Number(u.toString().substring(0,t))),this.west(Number(f.toString().substring(0,t)))},n.prototype._load=function(){var r=this,n="",u=this.continentCode(),t=this.countryCode(),i;u=="any"&&t=="any"?n="continents":t=="any"&&(n="countries"),i=this._sendRequest(n),$.when(i).done(function(){r._receiveResponse(n)})},n.prototype._sendRequest=function(n){var i=this,t=$.Deferred();return(n!="continents"||this._continentsResponse)&&(n!="countries"||this._countriesResponse)?t.resolve():$.ajax({url:this.settings.partnerPlacesApi.format(n)}).done(function(r){n=="continents"?i._continentsResponse=ko.observableArray(r):n=="countries"&&(i._countriesResponse=ko.observableArray(r)),t.resolve()}).fail(function(n){App.Failures.message(n,"while trying to load agreement map data",!0),t.reject()}),t},n.prototype._receiveResponse=function(n){var t,i;this._clearMarkers(),t=n=="continents"?this._continentsResponse():this._countriesResponse(),n=="countries"&&(i=this.continentCode(),t=Enumerable.From(t).Where(function(n){return n.continentCode==i}).ToArray()),this._setMapViewport(n,t),this._plotMarkers(n,t),this._updateRoute()},n.prototype._clearMarkers=function(){for(var i=this._markers()||[],t,n=0;n<i.length;n++)t=i[n],t.setMap(null),t=null;this._markers([])},n.prototype._setMapViewport=function(t,i){var e,r,u,f,o;t=="continents"&&this._googleMap.getZoom()!=1?(this._googleMap.setZoom(1),this._googleMap.setCenter(n._defaultMapCenter)):t=="countries"&&(e=this.continentCode(),i.length?i.length==1?(f=i[0],f&&f.boundingBox&&f.boundingBox.hasValue&&(r=Places.Utils.convertToLatLngBounds(f.boundingBox))):(r=new google.maps.LatLngBounds,o=Enumerable.From(i).Select(function(n){return new google.maps.LatLng(n.center.latitude,n.center.longitude)}).ToArray(),$.each(o,function(n,t){r.extend(t)}),this._googleMap.fitBounds(r)):e&&this._continentsResponse&&(u=Enumerable.From(this._continentsResponse()).SingleOrDefault(undefined,function(n){return n.continentCode==e}),u&&u.boundingBox&&u.boundingBox.hasValue&&(r=Places.Utils.convertToLatLngBounds(u.boundingBox))),r?this._googleMap.fitBounds(r):this._googleMap.getZoom()!=1&&(this._googleMap.setZoom(1),this._googleMap.setCenter(n._defaultMapCenter)))},n.prototype._plotMarkers=function(n,t){var i=this,r=n=="continents"?this._getMarkerIconScaler(t):this._getMarkerIconScaler(this._countriesResponse()),u=this.continentCode();$.each(t,function(t,u){var e={map:i._googleMap,position:Places.Utils.convertToLatLng(u.center),title:"{0} - {1} agreement(s)\r\nClick for more information.".format(u.name,u.agreementCount),clickable:!0,cursor:"pointer"},f;i._setMarkerIcon(e,u.agreementCount.toString(),r),f=new google.maps.Marker(e),i._markers.push(f),n==="continents"&&google.maps.event.addListener(f,"click",function(){i._googleMap.fitBounds(Places.Utils.convertToLatLngBounds(u.boundingBox)),u.id<1?i.continentCode("none"):i.continentCode(u.continentCode)})})},n.prototype._updateRoute=function(){this.lat(this.latitude()),this.lng(this.longitude()),this.zoom(this.mag()),this._setLocation()},n.prototype._getMarkerIconScaler=function(n){var i={min:Enumerable.From(n).Min(function(n){return n.agreementCount}),max:Enumerable.From(n).Max(function(n){return n.agreementCount})};return new t(i,{min:24,max:48})},n.prototype._setMarkerIcon=function(n,t,i){var u=isNaN(parseInt(t))?24:i.scale(parseInt(t)),r=u/2,f={opacity:.75,side:u,text:t},e="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(f)),o={url:e,size:new google.maps.Size(u,u),anchor:new google.maps.Point(r,r)},s={type:"circle",coords:[r,r,r]};n.icon=o,n.shape=s},n.prototype._onContinentsResponse=function(i){var u,f,r,e;for(this._clearMarkers(),u={min:Enumerable.From(i).Min(function(n){return n.agreementCount}),max:Enumerable.From(i).Max(function(n){return n.agreementCount})},f=new t(u,{min:24,max:48}),r=0;r<i.length;r++)e=i[r],this._onContinentResponse(e,f);this._googleMap.setZoom(1),this._googleMap.setCenter(n._defaultMapCenter)},n.prototype._onContinentResponse=function(n,t){var e=this,r=t.scale(n.agreementCount),i=r/2,o={opacity:.8,side:r,text:n.agreementCount},s="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(o)),h={url:s,size:new google.maps.Size(r,r),anchor:new google.maps.Point(i,i)},c={type:"circle",coords:[i,i,i]},u=n.agreementCount>0&&n.id>0;u=!0;var l=u?"pointer":"default",a={map:this._googleMap,position:new google.maps.LatLng(n.center.latitude,n.center.longitude),title:"{0} - {1} agreement(s)\r\nClick for more information".format(n.name,n.agreementCount),clickable:!0,cursor:l,icon:h,shape:c},f=new google.maps.Marker(a);this._markers.push(f),u&&google.maps.event.addListener(f,"click",function(t){e._onContinentClick(f,n,t)})},n.prototype._onContinentClick=function(n,t){var i=t.boundingBox.northEast.latitude,r=t.boundingBox.southWest.latitude,u=t.boundingBox.northEast.longitude,f=t.boundingBox.southWest.longitude,e=new google.maps.LatLng(r,f),o=new google.maps.LatLng(i,u),s=new google.maps.LatLngBounds(e,o);this._googleMap.fitBounds(s),this.continentCode(t.continentCode)},n.prototype._onCountriesResponse=function(i){var r=this,s,h;this._clearMarkers();var o=this.continentCode(),u=Enumerable.From(i).Where(function(n){return n.continentCode==o}).ToArray(),f=new google.maps.LatLngBounds;if(u.length==1){var e=u[0],c=new google.maps.LatLng(e.boundingBox.northEast.latitude,e.boundingBox.northEast.longitude),l=new google.maps.LatLng(e.boundingBox.southWest.latitude,e.boundingBox.southWest.longitude);f=new google.maps.LatLngBounds(l,c),this._googleMap.fitBounds(f)}else u.length>1?(s=Enumerable.From(u).Select(function(n){return new google.maps.LatLng(n.center.latitude,n.center.longitude)}).ToArray(),$.each(s,function(n,t){f.extend(t)}),this._googleMap.fitBounds(f)):(this._googleMap.setCenter(n._defaultMapCenter),this._googleMap.setZoom(1),o!="any"?(h=Enumerable.From(this.continentOptions()).Single(function(n){return n.code==o}),alert("No agreements found in {0}. Click your back button or select a different continent or country.".format(h.name))):alert("No agreements found. Click your back button or select a different continent or country."));google.maps.event.addListenerOnce(this._googleMap,"idle",function(){for(var s=r.continentCode(),e={min:Enumerable.From(i).Min(function(n){return n.agreementCount}),max:Enumerable.From(i).Max(function(n){return n.agreementCount})},o=new t(e,{min:24,max:48}),f,n=0;n<u.length;n++)f=u[n],r._onCountryResponse(f,o,new google.maps.LatLngBounds);r.lat(r.latitude()),r.lng(r.longitude()),r.zoom(r.mag()),r._setLocation()})},n.prototype._onCountryResponse=function(n,t){var u=new google.maps.LatLng(n.center.latitude,n.center.longitude),r=t.scale(n.agreementCount),i=r/2,f={opacity:1,side:r,text:n.agreementCount},e="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(f)),o={url:e,size:new google.maps.Size(r,r),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(i,i)},s={type:"circle",coords:[i,i,i]},h={map:this._googleMap,position:u,title:"{0} - {1} agreement(s)\r\nClick for more information.".format(n.name,n.agreementCount),clickable:!0,cursor:"pointer",icon:o,shape:s},c=new google.maps.Marker(h);this._markers.push(c)},n._defaultMapCenter=new google.maps.LatLng(0,17),n.KeywordSessionKey="AgreementSearchKeyword2",n.CountrySessionKey="AgreementSearchCountry2",n.ContinentSessionKey="AgreementSearchContinent",n.ZoomSessionKey="AgreementSearchZoom",n.LatSessionKey="AgreementSearchLat",n.LngSessionKey="AgreementSearchLng",n}(),t;n.SearchMap=i,t=function(){function n(n,t){this.from=n,this.into=t}return n.prototype.scale=function(n){var t=this.into.min,i=this.from.max-this.from.min,f=this.into.max-this.into.min,r,u;return i&&(r=(n-this.from.min)/i,u=Math.round(r*f),t+=u),t<this.into.min&&(t=this.into.min),t>this.into.max&&(t=this.into.max),t},n}(),n.Scaler=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))