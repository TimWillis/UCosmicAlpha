var Agreements;(function(n){(function(n){var i=function(){function n(t){var i=this;this.settings=t,this.continentCode=ko.observable(parseInt(sessionStorage.getItem(n.ContinentSessionKey))||"any"),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.placeId=ko.observable(parseInt(sessionStorage.getItem(n.PlaceIdSessionKey)||0)),this.zoom=ko.observable(parseInt(sessionStorage.getItem(n.ZoomSessionKey))||1),this.lat=ko.observable(parseInt(sessionStorage.getItem(n.LatSessionKey))||n._defaultMapCenter.lat()),this.lng=ko.observable(parseInt(sessionStorage.getItem(n.LngSessionKey))||n._defaultMapCenter.lng()),this._inputChanged=ko.computed(function(){i.countryCode()==undefined&&i.countryCode("any"),i.continentCode()==undefined&&i.continentCode("any"),sessionStorage.setItem(n.ContinentSessionKey,i.continentCode()),sessionStorage.setItem(n.CountrySessionKey,i.countryCode()),sessionStorage.setItem(n.ZoomSessionKey,i.zoom().toString()),sessionStorage.setItem(n.LatSessionKey,i.lat().toString()),sessionStorage.setItem(n.LngSessionKey,i.lng().toString()),sessionStorage.setItem(n.PlaceIdSessionKey,i.placeId().toString())}).extend({throttle:0}),this.north=ko.observable(),this.south=ko.observable(),this.east=ko.observable(),this.west=ko.observable(),this.latitude=ko.observable(),this.longitude=ko.observable(),this.mag=ko.observable(),this.status={agreementCount:ko.observable("?"),partnerCount:ko.observable("?"),countryCount:ko.observable("?")},this.summary={agreementCount:ko.observable("?"),partnerCount:ko.observable("?"),countryCount:ko.observable("?")},this.countries=ko.observableArray(),this.countryOptions=ko.computed(function(){return i._computeCountryOptions()}),this.continentOptions=ko.computed(function(){return i._computeContinentOptions()}),this._countryChanged=ko.computed(function(){i._onCountryChanged()}).extend({throttle:1}),this.routeFormat="#/{0}/continent/{6}/country/{1}/place/{2}/zoom/{3}/latitude/{4}/longitude/{5}/".format(this.settings.route).replace("{6}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return i._computeRoute()}),this._scopeHistory=ko.observableArray(),this._currentScope=ko.computed(function(){return i._computeCurrentScope()}),this._scopeDirty=ko.computed(function(){i._onScopeDirty()}).extend({throttle:1}),this._markers=ko.observableArray(),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!1)),this._loadSummary(),this._mapCreated=this._createMap(),this._loadCountryOptions(),this.sammy=this.settings.sammy||Sammy(),this._runSammy()}return n.prototype._createMap=function(){var n=this,i,r,t;return google.maps.visualRefresh=!0,i=document.getElementById("google_map_canvas"),r={mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(this.lat(),this.lng()),zoom:this.zoom(),draggable:!0,scrollwheel:!1,streetViewControl:!1,panControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}},this._googleMap=new google.maps.Map(i,r),t=$.Deferred(),google.maps.event.addListenerOnce(this._googleMap,"idle",function(){google.maps.event.addListener(n._googleMap,"center_changed",function(){n._onMapCenterChanged()}),google.maps.event.addListener(n._googleMap,"zoom_changed",function(){n._onMapZoomChanged()}),google.maps.event.addListener(n._googleMap,"bounds_changed",function(){n._onMapBoundsChanged()}),google.maps.event.trigger(n._googleMap,"center_changed"),google.maps.event.trigger(n._googleMap,"zoom_changed"),google.maps.event.trigger(n._googleMap,"bounds_changed"),t.resolve()}),t},n.prototype._onMapZoomChanged=function(){this.mag(this._googleMap.getZoom())},n.prototype._onMapCenterChanged=function(){var n=this._googleMap.getCenter();this.latitude(n.lat()),this.longitude(n.lng())},n.prototype._onMapBoundsChanged=function(){var n=this._googleMap.getBounds(),i=n.getNorthEast().lat(),r=n.getSouthWest().lat(),u=n.getNorthEast().lng(),f=n.getSouthWest().lng(),t=11;this.north(Number(i.toString().substring(0,t))),this.south(Number(r.toString().substring(0,t))),this.east(Number(u.toString().substring(0,t))),this.west(Number(f.toString().substring(0,t)))},n.prototype._loadSummary=function(){var n=this;$.get(this.settings.summaryApi).done(function(t){ko.mapping.fromJS(t,{},n.summary)})},n.prototype._computeCountryOptions=function(){var n=[{code:this.countryCode(),name:"[Loading...]"}],i=this.countries(),r,u,t;return i&&i.length&&(r={code:"any",name:"[All countries]"},u={code:"none",name:"[Without country]"},n=i.slice(0),t=this.continentCode(),t!="any"&&t!="none"&&(n=Enumerable.From(n).Where(function(n){return n.continentCode==t}).ToArray()),n=Enumerable.From([r]).Concat(n).Concat([u]).ToArray()),n},n.prototype._computeContinentOptions=function(){var n=[{code:this.continentCode(),name:"[Loading...]"}],t=this.countries(),i,r;return t&&t.length&&(i={code:"any",name:"[All continents]"},r={code:"none",name:"[Without continent]"},n=Enumerable.From(t).Select(function(n){return{code:n.continentCode,name:n.continentName}}).Distinct(function(n){return n.code}).OrderBy(function(n){return n.name}).ToArray(),n=Enumerable.From([i]).Concat(n).Concat([r]).ToArray()),n},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){t.countries(i),n.resolve()}),n},n.prototype._onCountryChanged=function(){var t=this.countryCode(),i=this.continentCode(),r=this.countryOptions(),n;t!="any"&&t!="none"&&(n=Enumerable.From(r).SingleOrDefault(undefined,function(n){return n.code==t}),n&&n.continentCode!=i&&this.continentCode(n.continentCode))},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n._onBeforeRoute(t)}),this.sammy.get(this.routeFormat.format(":continent",":country",":place",":zoom",":lat",":lng"),function(){var t=this;n._onRoute(t)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){var t=this;n.onBeforeActivation(t)}),this.settings.sammy||this.sammy.isRunning()||this.sammy.run()},n.prototype._onBeforeRoute=function(){return!0},n.prototype._onRoute=function(n){var t=n.params.continent,i=n.params.country,r=n.params.place,u=n.params.zoom,f=n.params.lat,e=n.params.lng;this.continentCode(t),this.countryCode(i),this.placeId(parseInt(r)),this.zoom(parseInt(u)),this.lat(parseFloat(f)),this.lng(parseFloat(e)),this._isActivated()||this._isActivated(!0)},n.prototype.onBeforeActivation=function(){this._setLocation()},n.prototype._computeRoute=function(){var n=this.continentCode(),t=this.countryCode(),i=this.placeId(),r=this.zoom(),u=this.lat(),f=this.lng();return this.routeFormat.format(n,t,i,r,u,f)},n.prototype._setLocation=function(){var t=this,n=this._route();this.sammy.getLocation().indexOf(n)<0&&setTimeout(function(){t.sammy.setLocation(n)},1)},n.prototype._computeCurrentScope=function(){return{continentCode:this.continentCode(),countryCode:this.countryCode(),placeId:this.placeId()}},n.prototype._onScopeDirty=function(){var r=this;if(this._isActivated()){var i=this._scopeHistory(),n=i.length?Enumerable.From(i).Last():null,t=this._currentScope();n&&n.countryCode==t.countryCode&&n.continentCode==t.continentCode&&n.placeId==t.placeId||(this._scopeHistory.push(t),$.when(this._mapCreated).then(function(){r._load()}))}},n.prototype._load=function(){var n=this,r,u;if(this.placeId())this.spinner.start(),u=this._requestPartners(),$.when(u).done(function(t){n._receivePartners(t),n.spinner.stop()});else{var t="",f=this.continentCode(),i=this.countryCode();f=="any"&&i=="any"?t="continents":i=="any"&&(t="countries"),this.spinner.start(),r=this._requestPlaces(t),$.when(r).done(function(){n._receivePlaces(t),n.spinner.stop(),setTimeout(function(){n._requestPlaces("continents"),n._requestPlaces("countries"),n._requestPlaces("")},0)})}},n.prototype._requestPlaces=function(n){var i=this,t=$.Deferred(),r;return n!="countries"||this._continentsResponse?(n!="continents"||this._continentsResponse)&&(n!="countries"||this._countriesResponse)&&(n||this._placesResponse)?t.resolve():$.get(this.settings.partnerPlacesApi.format(n)).done(function(r){n=="continents"?i._continentsResponse=ko.observableArray(r):n=="countries"?i._countriesResponse=ko.observableArray(r):i._placesResponse=ko.observableArray(r),t.resolve()}).fail(function(n){App.Failures.message(n,"while trying to load agreement map data",!0),t.reject()}):(r=this._requestPlaces("continents"),$.when(r).then(function(){i._requestPlaces("countries").done(function(){t.resolve()})})),t},n.prototype._receivePlaces=function(n){var t=n=="continents"?this._continentsResponse():n=="countries"?this._countriesResponse():this._placesResponse(),i,r;n=="countries"&&(i=this.continentCode(),t=Enumerable.From(t).Where(function(n){return i=="none"?!n.id:n.continentCode==i}).ToArray()),n||(r=this.countryCode(),t=Enumerable.From(t).Where(function(n){return r=="none"?!n.countryId:n.countryCode==r}).ToArray()),this._updateStatus(n,t),this._clearMarkers(),this._setMapViewport(n,t),this._plotMarkers(n,t),this._updateRoute()},n.prototype._clearMarkers=function(){for(var i=this._markers()||[],t,n=0;n<i.length;n++)t=i[n],t.setMap(null),t=null;this._markers([])},n.prototype._setMapViewport=function(t,i){var s,f,h,r,o,u,e;t=="continents"?this._googleMap.getZoom()!=1&&(this._googleMap.setZoom(1),this._googleMap.setCenter(n._defaultMapCenter)):t=="countries"?(s=this.continentCode(),i.length?i.length==1?(u=i[0],u&&u.boundingBox&&u.boundingBox.hasValue&&(r=Places.Utils.convertToLatLngBounds(u.boundingBox))):(r=new google.maps.LatLngBounds,e=Enumerable.From(i).Select(function(n){return new google.maps.LatLng(n.center.latitude,n.center.longitude)}).ToArray(),$.each(e,function(n,t){r.extend(t)}),this._googleMap.fitBounds(r)):s&&this._continentsResponse&&(f=Enumerable.From(this._continentsResponse()).SingleOrDefault(undefined,function(n){return n.continentCode==s}),f&&f.boundingBox&&f.boundingBox.hasValue&&(r=Places.Utils.convertToLatLngBounds(f.boundingBox))),r?this._googleMap.fitBounds(r):this._googleMap.getZoom()!=1&&(this._googleMap.setZoom(1),this._googleMap.setCenter(n._defaultMapCenter))):(h=this.countryCode(),i.length?i.length==1?(u=i[0],u&&u.boundingBox&&u.boundingBox.hasValue&&(r=Places.Utils.convertToLatLngBounds(u.boundingBox))):(r=new google.maps.LatLngBounds,e=Enumerable.From(i).Select(function(n){return new google.maps.LatLng(n.center.latitude,n.center.longitude)}).ToArray(),$.each(e,function(n,t){r.extend(t)}),this._googleMap.fitBounds(r)):h&&this.countryOptions&&(o=Enumerable.From(this.countryOptions()).SingleOrDefault(undefined,function(n){return n.code==h}),o&&o.box&&o.box.hasValue&&(r=Places.Utils.convertToLatLngBounds(o.box))),r?this._googleMap.fitBounds(r):this._googleMap.getZoom()!=1&&(this._googleMap.setZoom(1),this._googleMap.setCenter(n._defaultMapCenter)))},n.prototype._plotMarkers=function(n,t){var i=this,o=n=="countries"?this._getMarkerIconScaler(n,this._countriesResponse()):this._getMarkerIconScaler(n,t),e=this.continentCode(),u,f,r;n!="countries"||t.length||e=="none"||(u=Enumerable.From(this._continentsResponse()).SingleOrDefault(undefined,function(n){return n.continentCode==e}),u&&(t=[u])),f=this.countryCode(),n||t.length||f=="none"||(r=Enumerable.From(this.countryOptions()).SingleOrDefault(undefined,function(n){return n.code==f}),r&&(t=[{id:r.id,agreementCount:0,name:r.name,center:r.center,boundingBox:r.box,isCountry:!0,countryCode:r.code,continentCode:r.continentCode}])),$.each(t,function(t,r){var f,e,u;(n!="continents"||r.agreementCount)&&(f="{0} - {1} agreement(s)".format(r.name,r.agreementCount),n||(f="{0} agreement(s)\r\nClick for more information".format(r.agreementCount)),e={map:i._googleMap,position:Places.Utils.convertToLatLng(r.center),title:f,clickable:!0,cursor:"pointer"},i._setMarkerIcon(e,r.agreementCount.toString(),o),u=new google.maps.Marker(e),i._markers.push(u),google.maps.event.addListener(u,"mouseover",function(){u.setOptions({zIndex:201})}),google.maps.event.addListener(u,"mouseout",function(){var n=u.getIcon().size.width;u.setOptions({zIndex:200-n})}),n==="continents"?google.maps.event.addListener(u,"click",function(){r.agreementCount==1?location.href=i.settings.detailUrl.format(r.agreementIds[0]):(i._googleMap.fitBounds(Places.Utils.convertToLatLngBounds(r.boundingBox)),r.id<1?i.continentCode("none"):i.continentCode(r.continentCode))}):n==="countries"?google.maps.event.addListener(u,"click",function(){r.agreementCount==1?location.href=i.settings.detailUrl.format(r.agreementIds[0]):r.id>0&&i.countryCode(r.countryCode)}):n||google.maps.event.addListener(u,"click",function(){r.agreementCount==1?location.href=i.settings.detailUrl.format(r.agreementIds[0]):r.id&&i.placeId(r.id)}))})},n.prototype._updateRoute=function(){this.lat(this.latitude()),this.lng(this.longitude()),this.zoom(this.mag()),this._setLocation()},n.prototype._updateStatus=function(n,t){var u,i,f,r;t&&t.length&&(this.status.agreementCount(Enumerable.From(t).Sum(function(n){return n.agreementCount}).toString()),this.status.partnerCount(Enumerable.From(t).Sum(function(n){return n.partnerCount}).toString())),n=="countries"?(u=this.continentCode(),u=="none"?this.status.countryCount("unknown continent"):(i=Enumerable.From(this.continentOptions()).SingleOrDefault(undefined,function(n){return n.code==u}),i&&i.name&&this.status.countryCount(i.name))):n||(f=this.countryCode(),f=="none"?this.status.countryCount("unknown country"):(r=Enumerable.From(this.countryOptions()).SingleOrDefault(undefined,function(n){return n.code==f}),r&&r.name&&this.status.countryCount(r.name)))},n.prototype._getMarkerIconScaler=function(n,i){if(!i||!i.length)return new t({min:0,max:1},{min:16,max:16});var u={min:Enumerable.From(i).Min(function(n){return n.agreementCount}),max:Enumerable.From(i).Max(function(n){return n.agreementCount})},r={min:24,max:48};return n||(r={min:24,max:32}),new t(u,r)},n.prototype._setMarkerIcon=function(n,t,i){var r=isNaN(parseInt(t))?24:i.scale(parseInt(t));t=="0"&&(r=16);var u=r/2,f={opacity:.7,side:r,text:t},e="{0}?{1}".format(this.settings.graphicsCircleApi,$.param(f)),o={url:e,size:new google.maps.Size(r,r),anchor:new google.maps.Point(u,u)},s={type:"circle",coords:[u,u,u]};n.icon=o,n.shape=s,n.zIndex=200-r},n.prototype._requestPartners=function(){var r=this,n=$.Deferred(),u,i,t;return this._placesResponse?(i=this.placeId(),t=Enumerable.From(this._placesResponse()).SingleOrDefault(undefined,function(n){return n.id==i}),t||t.agreementCount?$.get(this.settings.partnersApi,{agreementIds:t.agreementIds}).done(function(i){r._partnersResponse=ko.observableArray(i),n.resolve(t)}).fail(function(t){App.Failures.message(t,"while trying to load agreement partner data",!0),n.reject()}):(alert("There are no agreements for place #{0}.".format(i)),n.reject())):(u=this._requestPlaces(""),$.when(u).then(function(){r._requestPartners().done(function(){n.resolve()})})),n},n.prototype._receivePartners=function(n){var u=this,f=this._partnersResponse(),i=Enumerable.From(f).Distinct(function(n){return n.establishmentId}).ToArray(),t,r;i.length==1?(t=i[0],this._googleMap.setCenter(Places.Utils.convertToLatLng(t.center)),t.googleMapZoomLevel?this._googleMap.setZoom(t.googleMapZoomLevel):t.boundingBox&&t.boundingBox.hasValue&&this._googleMap.fitBounds(Places.Utils.convertToLatLngBounds(t.boundingBox))):i.length>1?(r=new google.maps.LatLngBounds,$.each(i,function(n,t){r.extend(Places.Utils.convertToLatLng(t.center))}),this._googleMap.fitBounds(r)):alert("Found no agreement partners for place #{0}.".format(n.id)),this._clearMarkers(),$.each(i,function(n,t){var i={map:u._googleMap,position:Places.Utils.convertToLatLng(t.center)},r=new google.maps.Marker(i);u._markers.push(r)}),this._updateRoute()},n._defaultMapCenter=new google.maps.LatLng(0,17),n.ContinentSessionKey="AgreementSearchContinent",n.CountrySessionKey="AgreementSearchCountry2",n.ZoomSessionKey="AgreementSearchZoom",n.LatSessionKey="AgreementSearchLat",n.LngSessionKey="AgreementSearchLng",n.PlaceIdSessionKey="AgreementMapSearchPlaceId",n}(),t;n.SearchMap=i,t=function(){function n(n,t){this.from=n,this.into=t}return n.prototype.scale=function(n){var t=this.into.min,i=this.from.max-this.from.min,f=this.into.max-this.into.min,r,u;return i&&(r=(n-this.from.min)/i,u=Math.round(r*f),t+=u),t<this.into.min&&(t=this.into.min),t>this.into.max&&(t=this.into.max),t},n}(),n.Scaler=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))