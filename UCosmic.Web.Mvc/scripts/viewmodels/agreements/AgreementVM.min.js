var InstitutionalAgreementEditModel=function(){function n(n){var t=this,i;this.agreementId=n,this.percentOffBodyHeight=.6,this.deferredUAgreements=$.Deferred(),this.deferredPopParticipants=$.Deferred(),this.deferredPopContacts=$.Deferred(),this.deferredPopFiles=$.Deferred(),this.deferredPageFadeIn=$.Deferred(),this.agreementIsEdit=ko.observable(),this.editOrNewUrl={val:"new"},this.trail=ko.observableArray([]),this.nextForceDisabled=ko.observable(!1),this.prevForceDisabled=ko.observable(!1),this.pageNumber=ko.observable(),this.$genericAlertDialog=undefined,this.kendoWindowBug={val:0},this.isBound=ko.observable(),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this.selectConstructor=function(n,t){this.name=n,this.id=t},this.officialNameDoesNotMatchTranslation=ko.computed(function(){return!(this.participants.establishmentOfficialName===this.participants.establishmentTranslatedName)}),$("table.data").children("tbody").addClass("searchResults"),i=$("meta[name='accept-language']").attr("content"),this.scrollBody=new scrollBody.scroll("participants","basicInfo","effectiveDatesCurrentStatus","contacts","fileAttachments","overallVisibility",null,null,null,null,this.kendoWindowBug),this.establishmentSearchNav=new agreements.establishmentSearchNav(this.editOrNewUrl,this.participants,this.agreementIsEdit,this.agreementId,this.scrollBody,this.deferredPageFadeIn),this.participants=new agreements.participants(this.agreementId,this.deferredPopParticipants,this.agreementIsEdit,this.establishmentSearchNav.establishmentSearchViewModel,this.establishmentSearchNav.hasBoundSearch),this.establishmentSearchNav.participants=this.participants,ko.applyBindings(this.participants,$("#participants")[0]),this.basicInfo=new agreements.basicInfo(this.agreementId,this.deferredUAgreements),ko.applyBindings(this.basicInfo,$("#basicInfo")[0]),this.contact=new agreements.contacts(this.basicInfo.isCustomContactTypeAllowed,this.establishmentSearchNav.establishmentItemViewModel,this.agreementIsEdit,this.agreementId,this.kendoWindowBug,this.deferredPopContacts),ko.applyBindings(this.contact,$("#contacts")[0]),this.populateFiles=new agreements.populateFiles,this.fileAttachment=new agreements.fileAttachments(this.agreementId,this.agreementIsEdit,this.spinner,this.establishmentSearchNav.establishmentItemViewModel,this.populateFiles.files),ko.applyBindings(this.fileAttachment,$("#fileAttachments")[0]),this.datesStatus=new agreements.datesStatus(this.basicInfo.isCustomStatusAllowed),ko.applyBindings(this.datesStatus,$("#effectiveDatesCurrentStatus")[0]),this.visibility=new agreements.visibility,ko.applyBindings(this.visibility,$("#overallVisibility")[0]),this.agreementId===0?(Globalize.culture(i),this.editOrNewUrl.val="new/",this.agreementIsEdit(!1),this.visibility.visibility("Public"),$("#LoadingPage").hide(),this.participants.populateParticipants(),$.when(this.deferredPageFadeIn,this.deferredPopParticipants).done(function(){t.updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})):(this.percentOffBodyHeight=.2,this.editOrNewUrl.val=n+"/edit/",this.agreementIsEdit(!0),this.participants.populateParticipants(),this.populateFiles.populate(this.agreementId,this.deferredPopFiles),this.contact.populateContacts(),Globalize.culture(i),this.populateAgreementData(),$("#LoadingPage").hide(),$.when(this.deferredPopContacts,this.deferredPopFiles,this.deferredPopParticipants,this.deferredPageFadeIn).done(function(){t.updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})),this.isBound(!0),this.basicInfo.populateUmbrella(),this.establishmentSearchNav.bindSearch(),this.getSettings(),$(window).resize(function(){t.updateKendoDialog($(window).width())}),this.hideOtherGroups()}return n.prototype.hideOtherGroups=function(){$("#allParticipants").css("visibility","").hide(),$("#estSearch").css("visibility","").hide(),$("#addEstablishment").css("visibility","").hide()},n.prototype.populateAgreementData=function(){var n=this;$.when(this.deferredUAgreements).done(function(){$.get(App.Routes.WebApi.Agreements.get(n.agreementId)).done(function(t){var i,r=$("#agreementContent").data("kendoEditor");n.basicInfo.content(t.content),n.datesStatus.expDate(Globalize.format(new Date(t.expiresOn.substring(0,t.expiresOn.lastIndexOf("T"))),"d")),n.datesStatus.startDate(Globalize.format(new Date(t.startsOn.substring(0,t.startsOn.lastIndexOf("T"))),"d")),t.isAutoRenew==null?n.datesStatus.autoRenew(2):n.datesStatus.autoRenew(t.isAutoRenew),n.basicInfo.nickname(t.name),n.basicInfo.privateNotes(t.notes),n.visibility.visibility(t.visibility),n.datesStatus.isEstimated(t.isExpirationEstimated),ko.mapping.fromJS(t.participants,n.participants.participants),n.deferredPopParticipants.resolve(),n.basicInfo.uAgreementSelected(t.umbrellaId),i=$("#uAgreements").data("kendoDropDownList"),i.select(function(t){return t.value==n.basicInfo.uAgreementSelected()}),n.datesStatus.statusOptionSelected(t.status),n.basicInfo.isCustomStatusAllowed()?(i=$("#statusOptions").data("kendoComboBox"),i.select(function(t){return t.name===n.datesStatus.statusOptionSelected()}),i.selectedIndex===-1&&(i.dataSource.add({name:n.datesStatus.statusOptionSelected()}),i.select(i.dataSource.length))):(i=$("#statusOptions").data("kendoDropDownList"),i.select(function(t){return t.text===n.datesStatus.statusOptionSelected()})),n.basicInfo.typeOptionSelected(t.type),n.basicInfo.isCustomTypeAllowed()?(i=$("#typeOptions").data("kendoComboBox"),i.select(function(t){return t.name===n.basicInfo.typeOptionSelected()}),i.selectedIndex===-1&&(i.dataSource.add({name:n.basicInfo.typeOptionSelected()}),i.select(i.dataSource.length))):(i=$("#typeOptions").data("kendoDropDownList"),i.select(function(t){return t.text===n.basicInfo.typeOptionSelected()}))})})},n.prototype.updateKendoDialog=function(n){$(".k-window").css({left:n/2-$(".k-window").width()/2+10})},n.prototype.bindjQueryKendo=function(n){var r=this,t,i;for(this.basicInfo.isCustomTypeAllowed(n.isCustomTypeAllowed),this.basicInfo.isCustomStatusAllowed(n.isCustomStatusAllowed),this.basicInfo.isCustomContactTypeAllowed(n.isCustomContactTypeAllowed),this.datesStatus.statusOptions.push(new this.selectConstructor("","")),t=0,i=n.statusOptions.length;t<i;t++)this.datesStatus.statusOptions.push(new this.selectConstructor(n.statusOptions[t],n.statusOptions[t]));for(this.contact.contactTypeOptions.push(new this.selectConstructor("",undefined)),t=0,i=n.contactTypeOptions.length;t<i;t++)this.contact.contactTypeOptions.push(new this.selectConstructor(n.contactTypeOptions[t],n.contactTypeOptions[t]));for(this.basicInfo.typeOptions.push(new this.selectConstructor("","")),t=0,i=n.typeOptions.length;t<i;t++)this.basicInfo.typeOptions.push(new this.selectConstructor(n.typeOptions[t],n.typeOptions[t]));$(".hasDate").each(function(n,t){$(t).kendoDatePicker({value:new Date($(t).val()),change:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))},close:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))}})}),$(".k-window").css({position:"fixed",margin:"auto",top:"20px"}),$("#agreementContent").kendoEditor({tools:["bold","italic","underline","strikethrough","fontName","foreColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","subscript","superscript","viewHtml",{name:"formatting",items:[{text:"Paragraph",value:"p"},{text:"Quotation",value:"blockquote"},{text:"Heading 2",value:"h2"},{text:"Heading 3",value:"h3"},{text:"Heading 4",value:"h4"},{text:"Heading 5",value:"h5"},{text:"Heading 6",value:"h6"}],width:"200px"}]}),this.basicInfo.bindJquery(),this.contact.bindJquery(),this.fileAttachment.bindJquery(),this.datesStatus.bindJquery(),this.scrollBody.bindJquery()},n.prototype.getSettings=function(){var _this=this,url="App.Routes.WebApi.Agreements.Settings.get()",agreementSettingsGet;$.ajax({url:eval(url),type:"GET"}).done(function(n){_this.bindjQueryKendo(n)}).fail(function(n){alert("fail: status = "+n.status+" "+n.statusText+'; message = "'+n.responseText+'"')})},n.prototype.saveUpdateAgreement=function(){var n=this,t;if(this.datesStatus.validateEffectiveDatesCurrentStatus.isValid()||(t=$("#effectiveDatesCurrentStatus").offset(),this.datesStatus.validateEffectiveDatesCurrentStatus.errors.showAllMessages(!0),$("#navEffectiveDatesCurrentStatus").closest("ul").find("li").removeClass("current"),$("#navEffectiveDatesCurrentStatus").addClass("current")),this.basicInfo.validateBasicInfo.isValid()||(t=$("#basicInfo").offset(),this.basicInfo.validateBasicInfo.errors.showAllMessages(!0),$("#navValidateBasicInfo").closest("ul").find("li").removeClass("current"),$("#navValidateBasicInfo").addClass("current")),$("#participantsErrorMsg").show(),this.participants.participantsShowErrorMsg()&&(t=$("#participants").offset(),$("#navParticipants").closest("ul").find("li").removeClass("current"),$("#navParticipants").addClass("current")),t!=undefined)$("body").scrollTop()?$("body").scrollTop(t.top-20):$("html, body").scrollTop(t.top-20);else{var i,r=$("#LoadingPage").find("strong"),e=$("#agreementContent").data("kendoEditor"),r=$("#LoadingPage").find("strong"),u=null,f;this.spinner.start(),$("body").scrollTop()?$("body").scrollTop(0):$("html, body").scrollTop(0),r.text("Saving agreement..."),$("#allParticipants").show().fadeOut(500,function(){$("#LoadingPage").hide().fadeIn(500)}),$.each(this.participants.participants(),function(t,i){n.participants.participantsExport.push({agreementId:i.agreementId,establishmentId:i.establishmentId,establishmentOfficialName:i.establishmentOfficialName,establishmentTranslatedName:i.establishmentTranslatedName,isOwner:i.isOwner,center:i.center})}),this.datesStatus.autoRenew()==0?u=!1:this.datesStatus.autoRenew()==1&&(u=!0),this.basicInfo.content(e.value()),f=ko.mapping.toJS({content:this.basicInfo.content(),expiresOn:this.datesStatus.expDate(),startsOn:this.datesStatus.startDate(),isAutoRenew:u,name:this.basicInfo.nickname(),notes:this.basicInfo.privateNotes(),status:this.datesStatus.statusOptionSelected(),visibility:this.visibility.visibility(),isExpirationEstimated:this.datesStatus.isEstimated(),participants:this.participants.participantsExport,umbrellaId:this.basicInfo.uAgreementSelected()!=0?this.basicInfo.uAgreementSelected():undefined,type:this.basicInfo.typeOptionSelected()}),this.agreementIsEdit()?(i=App.Routes.WebApi.Agreements.put(this.agreementId),$.ajax({type:"PUT",url:i,data:f,success:function(){r.text("Agreement Saved..."),setTimeout(function(){$("#LoadingPage").show().fadeOut(500,function(){$("#allParticipants").hide().fadeIn(500)})},5e3)},error:function(t){n.spinner.stop(),t.status===400&&(n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}})):(i=App.Routes.WebApi.Agreements.post(),$.post(i,f).done(function(t,i,u){var f=u.getResponseHeader("Location");n.agreementId=parseInt(f.substring(f.lastIndexOf("/")+1)),n.fileAttachment.agreementId=n.agreementId,n.contact.agreementId=n.agreementId,n.fileAttachment.agreementPostFiles(t,i,u),n.contact.agreementPostContacts(t,i,u),r.text("Agreement Saved..."),setTimeout(function(){u!=undefined?(window.location.hash="",window.location.href="/agreements/"+u.getResponseHeader("Location").substring(u.getResponseHeader("Location").lastIndexOf("/")+1)+"/edit/"):alert("success, but no location")},5e3)}).fail(function(t){n.spinner.stop(),t.status===400&&(n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}))}},n}()