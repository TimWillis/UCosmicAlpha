var InstitutionalAgreementParticipantModel=function(){function n(n,t,i,r){this.isOwner=ko.observable(n),this.establishmentId=ko.observable(t),this.establishmentOfficialName=ko.observable(i),this.establishmentTranslatedName=ko.observable(r)}return n}(),InstitutionalAgreementEditModel=function(){function n(n){var t,i;typeof n=="undefined"&&(n=!0),t=this,this.initDefaultPageRoute=n,this.selectConstructor=function(n,t){this.name=n,this.id=t},this.percentOffBodyHeight=.6,this.dfdUAgreements=$.Deferred(),this.dfdPopParticipants=$.Deferred(),this.dfdPopContacts=$.Deferred(),this.dfdPopFiles=$.Deferred(),this.dfdPageFadeIn=$.Deferred(),this.agreementIsEdit=ko.observable(),this.agreementId=0,this.visibility=ko.observable(),this.trail=ko.observableArray([]),this.nextForceDisabled=ko.observable(!1),this.prevForceDisabled=ko.observable(!1),this.pageNumber=ko.observable(),this.$genericAlertDialog=undefined,this.kendoWindowBug=0,this.$uAgreements=ko.observable(),this.uAgreements=ko.mapping.fromJS([]),this.uAgreementSelected=ko.observable(""),this.nickname=ko.observable(),this.content=ko.observable(),this.privateNotes=ko.observable(),this.$typeOptions=ko.observable(),this.typeOptions=ko.mapping.fromJS([]),this.typeOptionSelected=ko.observable(),this.agreementContent=ko.observable(),this.isCustomTypeAllowed=ko.observable(),this.isCustomStatusAllowed=ko.observable(),this.isCustomContactTypeAllowed=ko.observable(),this.startDate=ko.observable(),this.expDate=ko.observable(),this.isEstimated=ko.observable(),this.autoRenew=ko.observable(2),this.$statusOptions=ko.observable(),this.statusOptions=ko.mapping.fromJS([]),this.statusOptionSelected=ko.observable(),this.$file=ko.observable(),this.hasFile=ko.observable(),this.isFileExtensionInvalid=ko.observable(!1),this.isFileTooManyBytes=ko.observable(!1),this.isFileFailureUnexpected=ko.observable(!1),this.isFileInvalid=ko.observable(!1),this.fileError=ko.observable(),this.fileFileExtension=ko.observable(),this.fileFileName=ko.observable(),this.fileSrc=ko.observable(),this.fileUploadSpinner=new App.Spinner(new App.SpinnerOptions(400)),this.fileDeleteSpinner=new App.Spinner(new App.SpinnerOptions(400)),this.tempFileId=0,this.files=ko.mapping.fromJS([]),this.participantsExport=ko.mapping.fromJS([]),this.participants=ko.mapping.fromJS([]),this.participantsErrorMsg=ko.observable(),this.establishmentSearchViewModel=new Establishments.ViewModels.Search,this.hasBoundSearch=!1,this.hasBoundItem=!1,this.isBound=ko.observable(),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this.officialNameDoesNotMatchTranslation=ko.computed(function(){return!(this.participants.establishmentOfficialName===this.participants.establishmentTranslatedName)}),this.contactClass=new agreements.contacts(this.isCustomContactTypeAllowed,this.spinner,this.establishmentItemViewModel,this.agreementIsEdit,this.agreementId,this.kendoWindowBug),ko.applyBindings(this.contactClass,$("#contacts")[0]),i=$("meta[name='accept-language']").attr("content"),window.location.href.toLowerCase().indexOf("agreements/new")>0?(Globalize.culture(i),this.editOrNewUrl="new/",this.agreementIsEdit(!1),this.visibility("Public"),$("#LoadingPage").hide(),this.populateParticipants(),$.when(this.dfdPageFadeIn,this.dfdPopParticipants).done(function(){t.updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})):(this.percentOffBodyHeight=.2,this.editOrNewUrl=window.location.href.toLowerCase().substring(window.location.href.toLowerCase().indexOf("agreements/")+11),this.editOrNewUrl=this.editOrNewUrl.substring(0,this.editOrNewUrl.indexOf("/edit")+5)+"/",this.agreementIsEdit(!0),this.agreementId=this.editOrNewUrl.substring(0,this.editOrNewUrl.indexOf("/")),this.populateParticipants(),this.populateFiles(),this.populateContacts(),Globalize.culture(i),this.populateAgreementData(),$("#LoadingPage").hide(),$.when(this.dfdPopContacts,this.dfdPopFiles,this.dfdPopParticipants,this.dfdPageFadeIn).done(function(){t.updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})),this.isBound(!0),this.removeParticipant=this.removeParticipant.bind(this),this.updateFile=this.updateFile.bind(this),this.fileVisibilityClicked=this.fileVisibilityClicked.bind(this),this.removeFile=this.removeFile.bind(this),this._setupValidation=this._setupValidation.bind(this),this.participantsShowErrorMsg=ko.computed(function(){var n=!1;return $.each(t.participants(),function(t,i){i.isOwner()==!0&&(n=!0)}),n==!1?(t.participantsErrorMsg("Home participant is required."),!0):!1}),this.populateUmbrella(),this.hideOtherGroups(),this.bindSearch(),this.getSettings(),this._setupValidation(),$(window).resize(function(){t.updateKendoDialog($(window).width())})}return n.prototype.receiveParticipants=function(n){n?ko.mapping.fromJS(n,this.participants):ko.mapping.fromJS({items:[],itemTotal:0},this.participants)},n.prototype.populateParticipants=function(){var n=this;$.get(App.Routes.WebApi.Agreements.Participants.get(this.agreementId)).done(function(t){n.receiveParticipants(t),n.dfdPopParticipants.resolve()})},n.prototype.populateAgreementData=function(){var n=this;$.when(this.dfdUAgreements).done(function(){$.get(App.Routes.WebApi.Agreements.get(n.agreementId)).done(function(t){var i,r=$("#agreementContent").data("kendoEditor");r.value(t.content),n.content(t.content),n.expDate(Globalize.format(new Date(t.expiresOn.substring(0,t.expiresOn.lastIndexOf("T"))),"d")),n.startDate(Globalize.format(new Date(t.startsOn.substring(0,t.startsOn.lastIndexOf("T"))),"d")),t.isAutoRenew==null?n.autoRenew(2):n.autoRenew(t.isAutoRenew),n.nickname(t.name),n.privateNotes(t.notes),n.visibility(t.visibility),n.isEstimated(t.isExpirationEstimated),ko.mapping.fromJS(t.participants,n.participants),n.dfdPopParticipants.resolve(),n.uAgreementSelected(t.umbrellaId),i=$("#uAgreements").data("kendoDropDownList"),i.select(function(t){return t.value==n.uAgreementSelected()}),n.statusOptionSelected(t.status),n.isCustomStatusAllowed()?(i=$("#statusOptions").data("kendoComboBox"),i.select(function(t){return t.name===n.statusOptionSelected()})):(i=$("#statusOptions").data("kendoDropDownList"),i.select(function(t){return t.text===n.statusOptionSelected()})),n.typeOptionSelected(t.type),n.isCustomTypeAllowed()?(i=$("#typeOptions").data("kendoComboBox"),i.select(function(t){return t.name===n.typeOptionSelected()})):(i=$("#typeOptions").data("kendoDropDownList"),i.select(function(t){return t.text===n.typeOptionSelected()}))})})},n.prototype.populateFiles=function(){var n=this;$.get(App.Routes.WebApi.Agreements.Files.get(this.agreementId),{useTestData:!0}).done(function(t){$.each(t,function(t,i){n.files.push(ko.mapping.fromJS({id:i.id,originalName:i.originalName,customName:i.customName,visibility:i.visibility,isEdit:!1,customNameFile:i.customName.substring(0,i.customName.lastIndexOf(".")),customNameExt:i.customName.substring(i.customName.lastIndexOf("."),i.customName.length)}))}),n.dfdPopFiles.resolve()})},n.prototype.populateContacts=function(){var n=this;$.get(App.Routes.WebApi.Agreements.Contacts.get(this.agreementId),{useTestData:!1}).done(function(t){ko.mapping.fromJS(t,n.contactClass.contacts),n.dfdPopContacts.resolve()})},n.prototype.populateUmbrella=function(){var n=this;$.get(App.Routes.WebApi.Agreements.UmbrellaOptions.get(this.agreementId)).done(function(t){n.uAgreements(t),$("#uAgreements").kendoDropDownList({dataTextField:"text",dataValueField:"value",optionLabel:"[None - this is a top-level or standalone agreement]",dataSource:new kendo.data.DataSource({data:n.uAgreements()})}),n.dfdUAgreements.resolve()})},n.prototype.$bindKendoFile=function(){var n=this,t="";t=this.agreementIsEdit()?App.Routes.WebApi.Agreements.Files.post(this.agreementId):App.Routes.WebApi.Uploads.post(),$("#fileUpload").kendoUpload({multiple:!0,showFileList:!1,localization:{select:"Choose a file to upload..."},select:function(t){for(var r,u,i=0;i<t.files.length;i++)r=ko.mapping.toJS({Name:t.files[i].name,Length:t.files[i].rawFile.size}),u=App.Routes.WebApi.Agreements.Files.Validate.post(),$.ajax({type:"POST",url:u,async:!1,data:r,success:function(){n.isFileInvalid(!1)},error:function(i){t.preventDefault(),n.isFileInvalid(!0),n.fileError(i.responseText)}})},async:{saveUrl:t},upload:function(t){n.agreementIsEdit()&&(t.data={originalName:t.files[0].name,visibility:"Private",customName:t.files[0].name,agreementId:n.agreementId}),t.isDefaultPrevented()||n.fileUploadSpinner.start()},complete:function(){n.fileUploadSpinner.stop()},success:function(t){var i,r;t.operation=="upload"&&(t.response&&t.response.message&&App.flasher.flash(t.response.message),n.agreementIsEdit()?(r=t.XMLHttpRequest!=undefined?t.XMLHttpRequest.getResponseHeader("Location"):t.response.location,i=parseInt(r.substring(r.lastIndexOf("/")+1))):(n.tempFileId=n.tempFileId+.01,i=n.tempFileId),n.files.push(ko.mapping.fromJS({id:i,originalName:t.files[0].name,customName:t.files[0].name,visibility:"Public",guid:t.response.guid,isEdit:!1,customNameFile:t.files[0].name.substring(0,t.files[0].name.indexOf(t.files[0].extension)),customNameExt:t.files[0].extension})),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*.85))},error:function(t){var i,r;t.files&&t.files.length>0&&(i=t.files[0].name,r=t.files[0].extension),i&&n.fileFileName(i),r&&n.fileFileExtension(r),t.XMLHttpRequest.status===415?n.isFileExtensionInvalid(!0):t.XMLHttpRequest.status===413?n.isFileTooManyBytes(!0):n.isFileFailureUnexpected(!0)}})},n.prototype.removeFile=function(n,t){var r=this,i;confirm("Are you sure you want to remove this file from this agreement?")&&(i="",i=this.agreementIsEdit()?App.Routes.WebApi.Agreements.Files.del(this.agreementId,n.id()):App.Routes.WebApi.Uploads.del(n.guid()),$.ajax({url:i,type:"DELETE",success:function(){r.files.remove(n),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*1.1)}})),t.preventDefault(),t.stopPropagation()},n.prototype.editAFile=function(n){n.isEdit(!0)},n.prototype.cancelEditAFile=function(n,t){return n.customNameFile(n.customName().substring(0,n.customName().lastIndexOf("."))),n.isEdit(!1),t.stopImmediatePropagation(),!1},n.prototype.updateFile=function(n){var t=this,i,r;n.customName(n.customNameFile()+n.customNameExt()),n.isEdit(!1),this.agreementIsEdit()&&(i=ko.mapping.toJS({agreementId:n.agreementId,uploadGuid:n.guid,originalName:n.guid,extension:n.extension,customName:n.customName,visibility:n.visibility}),r=App.Routes.WebApi.Agreements.Files.put(this.agreementId,n.id()),$.ajax({type:"PUT",url:r,data:i,success:function(){},error:function(n){t.spinner.stop(),n.status===400&&(t.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),t.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){t.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}}))},n.prototype.fileVisibilityClicked=function(n,t){var i=this,r,u;return this.agreementIsEdit()&&t.target.textContent==""&&(r=ko.mapping.toJS({agreementId:this.agreementId,uploadGuid:n.guid,originalName:n.guid,extension:n.extension,customName:n.customName,visibility:n.visibility}),u=App.Routes.WebApi.Agreements.Files.put(this.agreementId,n.id()),$.ajax({type:"PUT",url:u,data:r,success:function(){},error:function(n){i.spinner.stop(),n.status===400&&(i.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),i.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){i.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}})),!0},n.prototype.updateKendoDialog=function(n){$(".k-window").css({left:n/2-$(".k-window").width()/2+10})},n.prototype.bindjQueryKendo=function(n){var i=this,r=this,t;for(this.isCustomTypeAllowed(n.isCustomTypeAllowed),this.isCustomStatusAllowed(n.isCustomStatusAllowed),this.isCustomContactTypeAllowed(n.isCustomContactTypeAllowed),this.statusOptions.push(new this.selectConstructor("","")),this.typeOptions.push(new this.selectConstructor("","")),t=0;t<n.statusOptions.length;t++)this.statusOptions.push(new this.selectConstructor(n.statusOptions[t],n.statusOptions[t]));for(this.contactClass.contactTypeOptions.push(new this.selectConstructor("",undefined)),t=0;t<n.contactTypeOptions.length;t++)this.contactClass.contactTypeOptions.push(new this.selectConstructor(n.contactTypeOptions[t],n.contactTypeOptions[t]));for(t=0;t<n.typeOptions.length;t++)this.typeOptions.push(new this.selectConstructor(n.typeOptions[t],n.typeOptions[t]));this.isCustomTypeAllowed?$("#typeOptions").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:new kendo.data.DataSource({data:this.typeOptions()})}):$("#typeOptions").kendoDropDownList({dataTextField:"name",dataValueField:"id",dataSource:new kendo.data.DataSource({data:this.typeOptions()})}),this.isCustomStatusAllowed?$("#statusOptions").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:new kendo.data.DataSource({data:this.statusOptions()})}):$("#statusOptions").kendoDropDownList({dataTextField:"name",dataValueField:"id",dataSource:new kendo.data.DataSource({data:this.statusOptions()})}),$(".hasDate").each(function(n,t){$(t).kendoDatePicker({value:new Date($(t).val()),change:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))},close:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))}})}),this.$bindKendoFile(),$("#helpExpDate").kendoTooltip({width:520,position:"top",content:$("#templateExpToolTip").html(),showOn:"click",autoHide:!1}),$(".k-window").css({position:"fixed",margin:"auto",top:"20px"}),$(window).scroll(function(){i.kendoWindowBug!=0&&scrollBody.scrollMyBody(i.kendoWindowBug);var t=$("#participants"),r=$("#basicInfo"),u=$("#effectiveDatesCurrentStatus"),f=$("#contacts"),e=$("#fileAttachments"),l=$("#overallVisibility"),a=$("#navParticipants"),v=$("#navBasicInfo"),y=$("#navEffectiveDatesCurrentStatus"),p=$("#navContacts"),w=$("#navFileAttachments"),b=$("#navOverallVisibility"),k=t.offset(),o=r.offset(),s=u.offset(),h=f.offset(),c=e.offset(),d=l.offset(),n;n=$("body").scrollTop()?$("body").scrollTop()+100:$("html, body").scrollTop()+100,n<=k.top+t.height()+40?($("aside").find("li").removeClass("current"),a.addClass("current")):n>=o.top&&n<=o.top+r.height()+40?($("aside").find("li").removeClass("current"),v.addClass("current")):n>=s.top&&n<=s.top+u.height()+40?($("aside").find("li").removeClass("current"),y.addClass("current")):n>=h.top&&n<=h.top+f.height()+40?($("aside").find("li").removeClass("current"),p.addClass("current")):n>=c.top&&n<=c.top+e.height()+40?($("aside").find("li").removeClass("current"),w.addClass("current")):n>=d.top&&($("aside").find("li").removeClass("current"),b.closest("li").addClass("current"))}),$("#agreementContent").kendoEditor({tools:["bold","italic","underline","strikethrough","fontName","foreColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","subscript","superscript","viewHtml",{name:"formatting",items:[{text:"Paragraph",value:"p"},{text:"Quotation",value:"blockquote"},{text:"Heading 2",value:"h2"},{text:"Heading 3",value:"h3"},{text:"Heading 4",value:"h4"},{text:"Heading 5",value:"h5"},{text:"Heading 6",value:"h6"}],width:"200px"}]}),this.contactClass.bindJquery()},n.prototype.getSettings=function(){var _this=this,url="App.Routes.WebApi.Agreements.Settings.get()",agreementSettingsGet;$.ajax({url:eval(url),type:"GET"}).done(function(n){_this.bindjQueryKendo(n)}).fail(function(n){alert("fail: status = "+n.status+" "+n.statusText+'; message = "'+n.responseText+'"')})},n.prototype.hideOtherGroups=function(){$("#allParticipants").css("visibility","").hide(),$("#estSearch").css("visibility","").hide(),$("#addEstablishment").css("visibility","").hide()},n.prototype.removeParticipant=function(n,t){var i,r;return confirm('Are you sure you want to remove "'+n.establishmentTranslatedName()+'" as a participant from this agreement?')&&(i=this,this.agreementIsEdit()?(r=App.Routes.WebApi.Agreements.Participants.del(this.agreementId,ko.dataFor(t.target).establishmentId()),$.ajax({url:r,type:"DELETE",success:function(){i.participants.remove(function(t){return t.establishmentId()===n.establishmentId()&&$(t.participantEl).slideUp("fast",function(){i.participants.remove(t),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*1.1)}),!1})},error:function(n){alert(n.responseText)}})):i.participants.remove(function(t){return t.establishmentId()===n.establishmentId()&&$(t.participantEl).slideUp("fast",function(){i.participants.remove(t),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*1.1)}),!1})),t.preventDefault(),t.stopPropagation(),!1},n.prototype.addParticipant=function(){this.establishmentSearchViewModel.sammy.setLocation("#/page/1/"),this.hasBoundSearch=!0},n.prototype.SearchPageBind=function(n){var t=this,i=$("#cancelAddParticipant"),r=$("#searchSideBarAddNew");this.establishmentSearchViewModel.detailTooltip=function(){return"Choose this establishment as a "+n},i.off(),r.off();r.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/new/"),n.preventDefault(),!1});if(n==="parent")i.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/new/"),n.preventDefault(),!1});else i.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/index"),n.preventDefault(),!1});var u=$.Deferred(),f=$.Deferred(),e=$("#allParticipants"),o=$("#addEstablishment");this.fadeModsOut(u,f,e,o,500),$.when(u,f).done(function(){$("#estSearch").fadeIn(500)})},n.prototype.fadeModsOut=function(n,t,i,r,u){i.css("display")!=="none"?i.fadeOut(u,function(){n.resolve()}):n.resolve(),r.css("display")!=="none"?r.fadeOut(u,function(){t.resolve()}):t.resolve()},n.prototype.bindSearch=function(){var n=this,t;this.hasBoundSearch||(this.establishmentSearchViewModel.sammyBeforeRoute=/\#\/index\/(.*)\//,this.establishmentSearchViewModel.sammyGetPageRoute="#/index",this.establishmentSearchViewModel.sammyDefaultPageRoute="/agreements[/]?",ko.applyBindings(this.establishmentSearchViewModel,$("#estSearch")[0]),t="asdf",this.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf("#")===-1&&(this.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(""+this.editOrNewUrl+"")===-1?this.establishmentSearchViewModel.sammy.setLocation("/agreements/"+this.editOrNewUrl+"#/index"):this.establishmentSearchViewModel.sammy.setLocation("#/index")),sessionStorage.getItem("addest")==undefined&&sessionStorage.setItem("addest","no"),this.establishmentSearchViewModel.sammy.bind("location-changed",function(){var u,f;if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(t)<0)if(u=$("#asideRootSearch"),f=$("#asideParentSearch"),n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(""+n.editOrNewUrl+"#/new/")>0){var h=$("#addEstablishment"),i=$.Deferred(),r=$.Deferred(),e=$("#estSearch"),o=$("#allParticipants"),s=500;n.fadeModsOut(i,r,e,o,s),$.when(i,r).done(function(){h.css("visibility","").hide().fadeIn(500,function(){if(!n.hasBoundItem){n.establishmentItemViewModel=new Establishments.ViewModels.Item,n.establishmentItemViewModel.goToSearch=function(){sessionStorage.setItem("addest","yes"),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/")},n.establishmentItemViewModel.submitToCreate=function(t){var e;if(!n.establishmentItemViewModel.id||n.establishmentItemViewModel.id===0){e=n.establishmentItemViewModel,n.establishmentItemViewModel.validatingSpinner.start();var i=n.establishmentItemViewModel.names()[0],r=n.establishmentItemViewModel.urls()[0],o=n.establishmentItemViewModel.location;if(i.text.isValidating()||r.value.isValidating()||n.establishmentItemViewModel.ceebCode.isValidating()||n.establishmentItemViewModel.uCosmicCode.isValidating())return setTimeout(function(){var i=n.establishmentItemViewModel.submitToCreate(t);return!1},50),!1;if(n.establishmentItemViewModel.isValidationSummaryVisible(!0),n.establishmentItemViewModel.isValid()||n.establishmentItemViewModel.errors.showAllMessages(),i.isValid()||i.errors.showAllMessages(),r.isValid()||r.errors.showAllMessages(),n.establishmentItemViewModel.validatingSpinner.stop(),i.isValid()&&r.isValid()&&n.establishmentItemViewModel.isValid()){var f=$("#LoadingPage").find("strong"),s=App.Routes.WebApi.Establishments.post(),u=n.establishmentItemViewModel.serializeData();f.text("Creating Establishment..."),u.officialName=i.serializeData(),u.officialUrl=r.serializeData(),u.location=o.serializeData(),n.establishmentItemViewModel.createSpinner.start(),$.post(s,u).done(function(){n.establishmentItemViewModel.createSpinner.stop(),f.text("Establishment created, you are being redirected to previous page..."),$("#addEstablishment").fadeOut(500,function(){$("#LoadingPage").fadeIn(500),setTimeout(function(){$("#LoadingPage").fadeOut(500,function(){f.text("Loading Page...")}),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/")},5e3)})}).fail(function(t){t.status===400&&(n.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))})}}return!1},ko.applyBindings(n.establishmentItemViewModel,h[0]);var t=$("#cancelAddEstablishment");t.on("click",function(t){return sessionStorage.setItem("addest","no"),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/"),t.preventDefault(),!1});n.hasBoundItem=!0}})}),scrollBody.scrollMyBody(0),t="#/new/"}else if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(""+n.editOrNewUrl+"#/page/")>0)sessionStorage.getItem("addest")==="yes"?(n.establishmentSearchViewModel.clickAction=function(t){return n.establishmentItemViewModel.parentEstablishment(t),n.establishmentItemViewModel.parentId(t.id()),n.establishmentSearchViewModel.sammy.setLocation("#/new/"),!1},n.establishmentSearchViewModel.header("Choose a parent establishment"),u.hide(),f.show(),n.SearchPageBind("parent"),n.establishmentSearchViewModel.header("Choose a parent establishment")):(u.show(),f.hide(),n.SearchPageBind("participant"),n.establishmentSearchViewModel.header("Choose a participant"),n.establishmentSearchViewModel.clickAction=function(t){for(var i=new InstitutionalAgreementParticipantModel(!1,t.id(),t.officialName(),t.translatedName()),u=!1,r=0;r<n.participants().length;r++)if(n.participants()[r].establishmentId()===i.establishmentId()){u=!0;break}return u!==!0?$.ajax({url:App.Routes.WebApi.Agreements.Participants.isOwner(i.establishmentId()),type:"GET",async:!1}).done(function(t){if(i.isOwner(t),n.agreementIsEdit()){var r=App.Routes.WebApi.Agreements.Participants.put(n.agreementId,i.establishmentId());$.ajax({type:"PUT",url:r,data:i,success:function(){n.participants.push(i)},error:function(n){alert(n.responseText)}})}else n.participants.push(i);n.establishmentSearchViewModel.sammy.setLocation("agreements/"+n.editOrNewUrl+""),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*.85)}).fail(function(){if(n.agreementIsEdit()){var t=App.Routes.WebApi.Agreements.Participants.put(n.agreementId,i.establishmentId());$.ajax({type:"PUT",url:t,data:i,success:function(){n.participants.push(i)},error:function(n){alert(n.responseText)}})}else n.participants.push(i);n.establishmentSearchViewModel.sammy.setLocation("agreements/"+n.editOrNewUrl+"")}):alert("This Participant has already been added."),!1}),scrollBody.scrollMyBody(0),t="#/page/";else if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf("agreements/"+n.editOrNewUrl+"")>0){sessionStorage.setItem("addest","no"),t="#/index",n.establishmentSearchViewModel.sammy.setLocation("#/index");var i=$.Deferred(),r=$.Deferred(),e=$("#estSearch"),o=$("#addEstablishment"),s=500;n.fadeModsOut(i,r,e,o,s),$.when(i,r).done(function(){$("#allParticipants").fadeIn(500).promise().done(function(){$(n).show(),scrollBody.scrollMyBody(0),n.dfdPageFadeIn.resolve()})})}else window.location.replace(n.establishmentSearchViewModel.sammy.getLocation())}),this.establishmentSearchViewModel.sammy.run())},n.prototype._setupValidation=function(){ko.validation.rules.greaterThan={validator:function(n,t){return t()==undefined?!0:Globalize.parseDate(n)>Globalize.parseDate(t())},message:"The field must be greater than start date"},ko.validation.rules.date.validator=function(n,t){return!n.length||t&&Globalize.parseDate(n)!=null},ko.validation.registerExtenders(),this.validateEffectiveDatesCurrentStatus=ko.validatedObservable({startDate:this.startDate.extend({required:{message:"Start date is required."},date:{message:"Start date must valid."},maxLength:50}),expDate:this.expDate.extend({required:{message:"Expiration date is required."},date:{message:"Expiration date must valid."},maxLength:50,greaterThan:this.startDate}),autoRenew:this.autoRenew.extend({required:{message:"Auto renew is required."}}),statusOptionSelected:this.statusOptionSelected.extend({required:{message:"Current Status is required."}})}),this.validateBasicInfo=ko.validatedObservable({agreementType:this.typeOptionSelected.extend({required:{message:"Agreement type is required."},maxLength:50}),nickname:this.nickname.extend({maxLength:50}),content:this.content.extend({maxLength:5e3}),privateNotes:this.privateNotes.extend({maxLength:250})})},n.prototype.postMe=function(n,t){var i=this;$.post(t,n).done(function(){}).fail(function(n){i.spinner.stop(),n.status===400&&(i.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),i.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){i.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))})},n.prototype.agreementPostFiles=function(){var n=this,t=App.Routes.WebApi.Agreements.Files.post(this.agreementId);$.each(this.files(),function(i,r){var u=ko.mapping.toJS({agreementId:r.agreementId,uploadGuid:r.guid,originalName:r.guid,extension:r.extension,customName:r.customName,visibility:r.visibility});n.postMe(u,t)}),this.spinner.stop()},n.prototype.agreementPostContacts=function(){var n=this,t=App.Routes.WebApi.Agreements.Contacts.post(this.agreementId);$.each(this.contactClass.contacts(),function(i,r){var u={agreementId:n.agreementId,title:r.title(),firstName:r.firstName(),lastName:r.lastName(),userId:r.id(),personId:r.personId(),phones:r.phones(),emailAddress:r.emailAddress(),type:r.type(),suffix:r.suffix(),salutation:r.salutation(),displayName:r.displayName(),middleName:r.middleName};n.postMe(u,t)})},n.prototype.saveUpdateAgreement=function(){var n=this,t,r,e,i,u,f;this.validateEffectiveDatesCurrentStatus.isValid()||(t=$("#effectiveDatesCurrentStatus").offset(),this.validateEffectiveDatesCurrentStatus.errors.showAllMessages(!0),$("#navEffectiveDatesCurrentStatus").closest("ul").find("li").removeClass("current"),$("#navEffectiveDatesCurrentStatus").addClass("current")),this.validateBasicInfo.isValid()||(t=$("#basicInfo").offset(),this.validateBasicInfo.errors.showAllMessages(!0),$("#navValidateBasicInfo").closest("ul").find("li").removeClass("current"),$("#navValidateBasicInfo").addClass("current")),$("#participantsErrorMsg").show(),this.participantsShowErrorMsg()&&(t=$("#participants").offset(),$("#navParticipants").closest("ul").find("li").removeClass("current"),$("#navParticipants").addClass("current")),t!=undefined?$("body").scrollTop()?$("body").scrollTop(t.top-20):$("html, body").scrollTop(t.top-20):(i=$("#LoadingPage").find("strong"),e=$("#agreementContent").data("kendoEditor"),this.spinner.start(),$("body").scrollTop()?$("body").scrollTop(0):$("html, body").scrollTop(0),i=$("#LoadingPage").find("strong"),i.text("Saving agreement..."),$("#allParticipants").show().fadeOut(500,function(){$("#LoadingPage").hide().fadeIn(500)}),$.each(this.participants(),function(t,i){n.participantsExport.push({agreementId:i.agreementId,establishmentId:i.establishmentId,establishmentOfficialName:i.establishmentOfficialName,establishmentTranslatedName:i.establishmentTranslatedName,isOwner:i.isOwner,center:i.center})}),u=null,this.autoRenew()==0?u=!1:this.autoRenew()==1&&(u=!0),this.content(e.value()),f=ko.mapping.toJS({content:this.content(),expiresOn:this.expDate(),startsOn:this.startDate(),isAutoRenew:u,name:this.nickname(),notes:this.privateNotes(),status:this.statusOptionSelected(),visibility:this.visibility(),isExpirationEstimated:this.isEstimated(),participants:this.participantsExport,umbrellaId:this.uAgreementSelected(),type:this.typeOptionSelected()}),this.agreementIsEdit()?(r=App.Routes.WebApi.Agreements.put(this.agreementId),$.ajax({type:"PUT",url:r,data:f,success:function(){i.text("Agreement Saved..."),setTimeout(function(){$("#LoadingPage").show().fadeOut(500,function(){$("#allParticipants").hide().fadeIn(500)})},5e3)},error:function(t){n.spinner.stop(),t.status===400&&(n.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}})):(r=App.Routes.WebApi.Agreements.post(),$.post(r,f).done(function(t,r,u){var f=u.getResponseHeader("Location");n.agreementId=parseInt(f.substring(f.lastIndexOf("/")+1)),n.agreementPostFiles(t,r,u),n.agreementPostContacts(t,r,u),i.text("Agreement Saved..."),setTimeout(function(){u!=undefined?(window.location.hash="",window.location.href="/agreements/"+u.getResponseHeader("Location").substring(u.getResponseHeader("Location").lastIndexOf("/")+1)+"/edit/"):alert("success, but no location")},5e3)}).fail(function(t){n.spinner.stop(),t.status===400&&(n.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))})))},n}()