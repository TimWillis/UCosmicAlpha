var InstitutionalAgreementEditModel=function(){function n(n){var t=this,i;this.agreementId=n,this.percentOffBodyHeight=.6,this.deferredUAgreements=$.Deferred(),this.deferredPopParticipants=$.Deferred(),this.deferredPopContacts=$.Deferred(),this.deferredPopFiles=$.Deferred(),this.deferredPageFadeIn=$.Deferred(),this.agreementIsEdit=ko.observable(),this.editOrNewUrl={val:"new"},this.trail=ko.observableArray([]),this.nextForceDisabled=ko.observable(!1),this.prevForceDisabled=ko.observable(!1),this.pageNumber=ko.observable(),this.$genericAlertDialog=undefined,this.kendoWindowBug={val:0},this.isBound=ko.observable(),this.spinner=new App.Spinner({delay:400,runImmediately:!0}),this.officialNameDoesNotMatchTranslation=ko.computed(function(){return!(this.participants.establishmentOfficialName===this.participants.establishmentTranslatedName)}),$("table.data").children("tbody").addClass("searchResults"),i=$("meta[name='accept-language']").attr("content"),this.scrollBody=new ScrollBody.Scroll("participants","basic_info","effective_dates_current_status","contacts","file_attachments","overall_visibility",null,null,null,null,this.kendoWindowBug),this.establishmentSearchNav=new Agreements.EstablishmentSearchNav(this.editOrNewUrl,this.participants,this.agreementIsEdit,this.agreementId,this.scrollBody,this.deferredPageFadeIn),this.participants=new Agreements.Participants(this.agreementId,this.deferredPopParticipants,this.agreementIsEdit,this.establishmentSearchNav.establishmentSearchViewModel,this.establishmentSearchNav.hasBoundSearch),this.establishmentSearchNav.participants=this.participants,ko.applyBindings(this.participants,$("#participants")[0]),this.basicInfo=new Agreements.BasicInfo(this.agreementId,this.deferredUAgreements),ko.applyBindings(this.basicInfo,$("#basic_info")[0]),this.contact=new Agreements.Contacts(this.basicInfo.isCustomContactTypeAllowed,this.establishmentSearchNav.establishmentItemViewModel,this.agreementIsEdit,this.agreementId,this.kendoWindowBug,this.deferredPopContacts),ko.applyBindings(this.contact,$("#contacts")[0]),this.fileListPopulator=new Agreements.FileListPopulator,this.fileAttachment=new Agreements.FileAttachments(this.agreementId,this.agreementIsEdit,this.spinner,this.establishmentSearchNav.establishmentItemViewModel,this.fileListPopulator.files),ko.applyBindings(this.fileAttachment,$("#file_attachments")[0]),this.datesStatus=new Agreements.DatesStatus(this.basicInfo.isCustomStatusAllowed),ko.applyBindings(this.datesStatus,$("#effective_dates_current_status")[0]),this.visibility=new Agreements.Visibility,ko.applyBindings(this.visibility,$("#overall_visibility")[0]),this._getSettings(),this.agreementId===0?(Globalize.culture(i),this.editOrNewUrl.val="new/",this.agreementIsEdit(!1),this.visibility.visibility("Public"),$("#Loading_page").hide(),this.participants.populateParticipants(),$.when(this.deferredPageFadeIn,this.deferredPopParticipants).done(function(){t._updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight),t._bindjQueryKendo()})):(this.percentOffBodyHeight=.2,this.editOrNewUrl.val=n+"/edit/",this.agreementIsEdit(!0),this.participants.populateParticipants(),this.fileListPopulator.populate(this.agreementId,this.deferredPopFiles),this.contact.populateContacts(),Globalize.culture(i),this._populateAgreementData(),$("#Loading_page").hide(),$.when(this.deferredPopContacts,this.deferredPopFiles,this.deferredPopParticipants,this.deferredPageFadeIn).done(function(){t._updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})),this.isBound(!0),this.basicInfo.populateUmbrella(),this.establishmentSearchNav.bindSearch(),$(window).resize(function(){t._updateKendoDialog($(window).width())}),this._hideOtherGroups()}return n.prototype._hideOtherGroups=function(){$("[data-current-module='agreements']").css("visibility","").hide(),$("#establishment_search").css("visibility","").hide(),$("#add_establishment").css("visibility","").hide()},n.prototype._populateAgreementData=function(){var n=this;$.when(this.deferredUAgreements).done(function(){$.get(App.Routes.WebApi.Agreements.get(n.agreementId)).done(function(t){var i;n.basicInfo.content(t.content),n.datesStatus.expDate(Globalize.format(new Date(t.expiresOn.substring(0,t.expiresOn.lastIndexOf("T"))),"d")),n.datesStatus.startDate(Globalize.format(new Date(t.startsOn.substring(0,t.startsOn.lastIndexOf("T"))),"d")),t.isAutoRenew==null?n.datesStatus.autoRenew(2):n.datesStatus.autoRenew(t.isAutoRenew),n.basicInfo.nickname(t.name),n.basicInfo.privateNotes(t.notes),n.visibility.visibility(t.visibility),n.datesStatus.isEstimated(t.isExpirationEstimated),ko.mapping.fromJS(t.participants,n.participants.participants),n.deferredPopParticipants.resolve(),n.basicInfo.uAgreementSelected(t.umbrellaId),n.datesStatus.statusOptionSelected(t.status),n.basicInfo.typeOptionSelected(t.type),n._bindjQueryKendo(),i=$("#umbrella_agreements").data("kendoDropDownList"),i.select(function(t){return t.value==n.basicInfo.uAgreementSelected()}),n.basicInfo.isCustomStatusAllowed()?(i=$("#status_options").data("kendoComboBox"),i.select(function(t){return t.name===n.datesStatus.statusOptionSelected()}),i.selectedIndex===-1&&(i.dataSource.add({name:n.datesStatus.statusOptionSelected()}),i.select(i.dataSource.length))):(i=$("#status_options").data("kendoDropDownList"),i.select(function(t){return t.text===n.datesStatus.statusOptionSelected()})),n.basicInfo.isCustomTypeAllowed()?(i=$("#type_options").data("kendoComboBox"),i.select(function(t){return t.name===n.basicInfo.typeOptionSelected()}),i.selectedIndex===-1&&(i.dataSource.add({name:n.basicInfo.typeOptionSelected()}),i.select(i.dataSource.length))):(i=$("#type_options").data("kendoDropDownList"),i.select(function(t){return t.text===n.basicInfo.typeOptionSelected()}))})})},n.prototype._updateKendoDialog=function(n){$(".k-window").css({left:n/2-$(".k-window").width()/2+10})},n.prototype.processSettings=function(n){var r=this,t,i;for(this.basicInfo.isCustomTypeAllowed(n.isCustomTypeAllowed),this.basicInfo.isCustomStatusAllowed(n.isCustomStatusAllowed),this.basicInfo.isCustomContactTypeAllowed(n.isCustomContactTypeAllowed),this.datesStatus.statusOptions.push(new Agreements.SelectConstructor("","")),t=0,i=n.statusOptions.length;t<i;t++)this.datesStatus.statusOptions.push(new Agreements.SelectConstructor(n.statusOptions[t],n.statusOptions[t]));for(this.contact.contactTypeOptions.push(new Agreements.SelectConstructor("",undefined)),t=0,i=n.contactTypeOptions.length;t<i;t++)this.contact.contactTypeOptions.push(new Agreements.SelectConstructor(n.contactTypeOptions[t],n.contactTypeOptions[t]));for(this.basicInfo.typeOptions.push(new Agreements.SelectConstructor("","")),t=0,i=n.typeOptions.length;t<i;t++)this.basicInfo.typeOptions.push(new Agreements.SelectConstructor(n.typeOptions[t],n.typeOptions[t]))},n.prototype._bindjQueryKendo=function(){var n=this;$(".hasDate").each(function(n,t){$(t).kendoDatePicker({value:new Date($(t).val()),change:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))},close:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))}})}),$(".k-window").css({position:"fixed",margin:"auto",top:"20px"}),$("#agreement_content").kendoEditor({tools:["bold","italic","underline","strikethrough","fontName","foreColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","subscript","superscript","viewHtml",{name:"formatting",items:[{text:"Paragraph",value:"p"},{text:"Quotation",value:"blockquote"},{text:"Heading 3",value:"h3"},{text:"Heading 4",value:"h4"}],width:"200px"}]}),this.basicInfo.bindJquery(),this.contact.bindJquery(),this.fileAttachment.bindJquery(),this.datesStatus.bindJquery(),this.scrollBody.bindJquery()},n.prototype._getSettings=function(){var _this=this,url="App.Routes.WebApi.Agreements.Settings.get()",agreementSettingsGet;$.ajax({url:eval(url),type:"GET"}).done(function(n){_this.processSettings(n)}).fail(function(n){alert("fail: status = "+n.status+" "+n.statusText+'; message = "'+n.responseText+'"')})},n.prototype.saveUpdateAgreement=function(){var n=this,t;if(this.datesStatus.validateEffectiveDatesCurrentStatus.isValid()||(t=$("#effective_dates_current_status").offset(),this.datesStatus.validateEffectiveDatesCurrentStatus.errors.showAllMessages(!0),$("#nav_effective_dates_current_status").closest("ul").find("li").removeClass("current"),$("#nav_effective_dates_current_status").addClass("current")),this.basicInfo.validateBasicInfo.isValid()||(t=$("#basic_info").offset(),this.basicInfo.validateBasicInfo.errors.showAllMessages(!0),$("#nav_basic_info").closest("ul").find("li").removeClass("current"),$("#nav_basic_info").addClass("current")),$("#participants_error_msg").show(),this.participants.participantsShowErrorMsg()&&(t=$("#participants").offset(),$("#nav_participants").closest("ul").find("li").removeClass("current"),$("#nav_participants").addClass("current")),t!=undefined)$("body").scrollTop()?$("body").scrollTop(t.top-20):$("html, body").scrollTop(t.top-20);else{var r,i=$("#Loading_page").find("strong"),e=$("#agreement_content").data("kendoEditor"),i=$("#Loading_page").find("strong"),u=null,f;this.spinner.start(),$("body").scrollTop()?$("body").scrollTop(0):$("html, body").scrollTop(0),$.each(this.participants.participants(),function(t,i){n.participants.participantsExport.push({agreementId:i.agreementId,establishmentId:i.establishmentId,establishmentOfficialName:i.establishmentOfficialName,establishmentTranslatedName:i.establishmentTranslatedName,isOwner:i.isOwner,center:i.center})}),this.datesStatus.autoRenew()==0?u=!1:this.datesStatus.autoRenew()==1&&(u=!0),this.basicInfo.content(e.value()),f=ko.mapping.toJS({content:this.basicInfo.content(),expiresOn:this.datesStatus.expDate(),startsOn:this.datesStatus.startDate(),isAutoRenew:u,name:this.basicInfo.nickname(),notes:this.basicInfo.privateNotes(),status:this.datesStatus.statusOptionSelected(),visibility:this.visibility.visibility(),isExpirationEstimated:this.datesStatus.isEstimated(),participants:this.participants.participantsExport,umbrellaId:this.basicInfo.uAgreementSelected()!=0?this.basicInfo.uAgreementSelected():undefined,type:this.basicInfo.typeOptionSelected()}),this.agreementIsEdit()?(i.text("Saving changes..."),$("[data-current-module='agreements']").show().fadeOut(500,function(){$("#Loading_page").hide().fadeIn(500)}),r=App.Routes.WebApi.Agreements.put(this.agreementId),$.ajax({type:"PUT",url:r,data:f,success:function(){i.text("Agreement Saved..."),setTimeout(function(){$("#Loading_page").show().fadeOut(500,function(){$("[data-current-module='agreements']").hide().fadeIn(500)})},5e3)},error:function(t){n.spinner.stop(),t.status===400&&(n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}})):(i.text("Saving agreement..."),$("[data-current-module='agreements']").show().fadeOut(500,function(){$("#Loading_page").hide().fadeIn(500)}),r=App.Routes.WebApi.Agreements.post(),$.post(r,f).done(function(t,r,u){var f=u.getResponseHeader("Location");n.agreementId=parseInt(f.substring(f.lastIndexOf("/")+1)),n.fileAttachment.agreementId=n.agreementId,n.contact.agreementId=n.agreementId,n.fileAttachment.agreementPostFiles(t,r,u),n.contact.agreementPostContacts(t,r,u),i.text("Agreement Saved..."),setTimeout(function(){u!=undefined?(window.location.hash="",window.location.href="/agreements/"+u.getResponseHeader("Location").substring(u.getResponseHeader("Location").lastIndexOf("/")+1)+"/edit/"):alert("success, but no location")},5e3)}).fail(function(t){n.spinner.stop(),t.status===400&&(n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentSearchNav.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}))}},n}()