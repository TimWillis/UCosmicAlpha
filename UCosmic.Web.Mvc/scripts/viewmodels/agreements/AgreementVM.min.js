var InstitutionalAgreementEditModel=function(){function n(n){var t,i;typeof n=="undefined"&&(n=!0),t=this,this.initDefaultPageRoute=n,this.percentOffBodyHeight=.6,this.dfdUAgreements=$.Deferred(),this.dfdPopParticipants=$.Deferred(),this.dfdPopContacts=$.Deferred(),this.dfdPopFiles=$.Deferred(),this.dfdPageFadeIn=$.Deferred(),this.agreementIsEdit=ko.observable(),this.agreementId={val:0},this.editOrNewUrl={val:"new"},this.trail=ko.observableArray([]),this.nextForceDisabled=ko.observable(!1),this.prevForceDisabled=ko.observable(!1),this.pageNumber=ko.observable(),this.$genericAlertDialog=undefined,this.kendoWindowBug={val:0},this.isBound=ko.observable(),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this.selectConstructor=function(n,t){this.name=n,this.id=t},this.officialNameDoesNotMatchTranslation=ko.computed(function(){return!(this.participants.establishmentOfficialName===this.participants.establishmentTranslatedName)}),i=$("meta[name='accept-language']").attr("content"),this.scrollBodyClass=new scrollBody.scroll("participants","basicInfo","effectiveDatesCurrentStatus","contacts","fileAttachments","overallVisibility",null,null,null,null,this.kendoWindowBug),this.establishmentSearchNavClass=new agreements.establishmentSearchNav(this.editOrNewUrl,this.participantsClass,this.agreementIsEdit,this.agreementId,this.scrollBodyClass,this.dfdPageFadeIn),this.participantsClass=new agreements.participants(this.agreementId,this.dfdPopParticipants,this.agreementIsEdit,this.establishmentSearchNavClass.establishmentSearchViewModel,this.establishmentSearchNavClass.hasBoundSearch),this.establishmentSearchNavClass.participantsClass=this.participantsClass,ko.applyBindings(this.participantsClass,$("#participants")[0]),this.basicInfoClass=new agreements.basicInfo(this.agreementId,this.dfdUAgreements),ko.applyBindings(this.basicInfoClass,$("#basicInfo")[0]),this.contactClass=new agreements.contacts(this.basicInfoClass.isCustomContactTypeAllowed,this.establishmentSearchNavClass.establishmentItemViewModel,this.agreementIsEdit,this.agreementId,this.kendoWindowBug,this.dfdPopContacts),ko.applyBindings(this.contactClass,$("#contacts")[0]),this.fileAttachmentClass=new agreements.fileAttachments(this.agreementId,this.agreementIsEdit,this.spinner,this.establishmentSearchNavClass.establishmentItemViewModel,this.dfdPopFiles),ko.applyBindings(this.fileAttachmentClass,$("#fileAttachments")[0]),this.datesStatusClass=new agreements.datesStatus(this.basicInfoClass.isCustomStatusAllowed),ko.applyBindings(this.datesStatusClass,$("#effectiveDatesCurrentStatus")[0]),this.visibilityClass=new agreements.visibility,ko.applyBindings(this.visibilityClass,$("#overallVisibility")[0]),window.location.href.toLowerCase().indexOf("agreements/new")>0?(Globalize.culture(i),this.editOrNewUrl.val="new/",this.agreementIsEdit(!1),this.visibilityClass.visibility("Public"),$("#LoadingPage").hide(),this.participantsClass.populateParticipants(),$.when(this.dfdPageFadeIn,this.dfdPopParticipants).done(function(){t.updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})):(this.percentOffBodyHeight=.2,this.editOrNewUrl.val=window.location.href.toLowerCase().substring(window.location.href.toLowerCase().indexOf("agreements/")+11),this.editOrNewUrl.val=this.editOrNewUrl.val.substring(0,this.editOrNewUrl.val.indexOf("/edit")+5)+"/",this.agreementIsEdit(!0),this.agreementId.val=parseInt(this.editOrNewUrl.val.substring(0,this.editOrNewUrl.val.indexOf("/"))),this.participantsClass.populateParticipants(),this.fileAttachmentClass.populateFiles(),this.contactClass.populateContacts(),Globalize.culture(i),this.populateAgreementData(),$("#LoadingPage").hide(),$.when(this.dfdPopContacts,this.dfdPopFiles,this.dfdPopParticipants,this.dfdPageFadeIn).done(function(){t.updateKendoDialog($(window).width()),$("body").css("min-height",$(window).height()+$("body").height()-$(window).height()*t.percentOffBodyHeight)})),this.isBound(!0),this.basicInfoClass.populateUmbrella(),this.hideOtherGroups(),this.establishmentSearchNavClass.bindSearch(),this.getSettings(),$(window).resize(function(){t.updateKendoDialog($(window).width())})}return n.prototype.hideOtherGroups=function(){$("#allParticipants").css("visibility","").hide(),$("#estSearch").css("visibility","").hide(),$("#addEstablishment").css("visibility","").hide()},n.prototype.populateAgreementData=function(){var n=this;$.when(this.dfdUAgreements).done(function(){$.get(App.Routes.WebApi.Agreements.get(n.agreementId.val)).done(function(t){var i,r=$("#agreementContent").data("kendoEditor");r.value(t.content),n.basicInfoClass.content(t.content),n.datesStatusClass.expDate(Globalize.format(new Date(t.expiresOn.substring(0,t.expiresOn.lastIndexOf("T"))),"d")),n.datesStatusClass.startDate(Globalize.format(new Date(t.startsOn.substring(0,t.startsOn.lastIndexOf("T"))),"d")),t.isAutoRenew==null?n.datesStatusClass.autoRenew(2):n.datesStatusClass.autoRenew(t.isAutoRenew),n.basicInfoClass.nickname(t.name),n.basicInfoClass.privateNotes(t.notes),n.visibilityClass.visibility(t.visibility),n.datesStatusClass.isEstimated(t.isExpirationEstimated),ko.mapping.fromJS(t.participants,n.participantsClass.participants),n.dfdPopParticipants.resolve(),n.basicInfoClass.uAgreementSelected(t.umbrellaId),i=$("#uAgreements").data("kendoDropDownList"),i.select(function(t){return t.value==n.basicInfoClass.uAgreementSelected()}),n.datesStatusClass.statusOptionSelected(t.status),n.basicInfoClass.isCustomStatusAllowed()?(i=$("#statusOptions").data("kendoComboBox"),i.select(function(t){return t.name===n.datesStatusClass.statusOptionSelected()})):(i=$("#statusOptions").data("kendoDropDownList"),i.select(function(t){return t.text===n.datesStatusClass.statusOptionSelected()})),n.basicInfoClass.typeOptionSelected(t.type),n.basicInfoClass.isCustomTypeAllowed()?(i=$("#typeOptions").data("kendoComboBox"),i.select(function(t){return t.name===n.basicInfoClass.typeOptionSelected()})):(i=$("#typeOptions").data("kendoDropDownList"),i.select(function(t){return t.text===n.basicInfoClass.typeOptionSelected()}))})})},n.prototype.updateKendoDialog=function(n){$(".k-window").css({left:n/2-$(".k-window").width()/2+10})},n.prototype.bindjQueryKendo=function(n){var r=this,t,i;for(this.basicInfoClass.isCustomTypeAllowed(n.isCustomTypeAllowed),this.basicInfoClass.isCustomStatusAllowed(n.isCustomStatusAllowed),this.basicInfoClass.isCustomContactTypeAllowed(n.isCustomContactTypeAllowed),this.datesStatusClass.statusOptions.push(new this.selectConstructor("","")),t=0,i=n.statusOptions.length;t<i;t++)this.datesStatusClass.statusOptions.push(new this.selectConstructor(n.statusOptions[t],n.statusOptions[t]));for(this.contactClass.contactTypeOptions.push(new this.selectConstructor("",undefined)),t=0,i=n.contactTypeOptions.length;t<i;t++)this.contactClass.contactTypeOptions.push(new this.selectConstructor(n.contactTypeOptions[t],n.contactTypeOptions[t]));for(this.basicInfoClass.typeOptions.push(new this.selectConstructor("","")),t=0,i=n.typeOptions.length;t<i;t++)this.basicInfoClass.typeOptions.push(new this.selectConstructor(n.typeOptions[t],n.typeOptions[t]));$(".hasDate").each(function(n,t){$(t).kendoDatePicker({value:new Date($(t).val()),change:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))},close:function(n){this.value()!=null&&$(n.sender.element).val(Globalize.format(this.value(),"d"))}})}),$(".k-window").css({position:"fixed",margin:"auto",top:"20px"}),$("#agreementContent").kendoEditor({tools:["bold","italic","underline","strikethrough","fontName","foreColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","subscript","superscript","viewHtml",{name:"formatting",items:[{text:"Paragraph",value:"p"},{text:"Quotation",value:"blockquote"},{text:"Heading 2",value:"h2"},{text:"Heading 3",value:"h3"},{text:"Heading 4",value:"h4"},{text:"Heading 5",value:"h5"},{text:"Heading 6",value:"h6"}],width:"200px"}]}),this.basicInfoClass.bindJquery(),this.contactClass.bindJquery(),this.fileAttachmentClass.bindJquery(),this.datesStatusClass.bindJquery(),this.scrollBodyClass.bindJquery()},n.prototype.getSettings=function(){var _this=this,url="App.Routes.WebApi.Agreements.Settings.get()",agreementSettingsGet;$.ajax({url:eval(url),type:"GET"}).done(function(n){_this.bindjQueryKendo(n)}).fail(function(n){alert("fail: status = "+n.status+" "+n.statusText+'; message = "'+n.responseText+'"')})},n.prototype.saveUpdateAgreement=function(){var n=this,t;if(this.datesStatusClass.validateEffectiveDatesCurrentStatus.isValid()||(t=$("#effectiveDatesCurrentStatus").offset(),this.datesStatusClass.validateEffectiveDatesCurrentStatus.errors.showAllMessages(!0),$("#navEffectiveDatesCurrentStatus").closest("ul").find("li").removeClass("current"),$("#navEffectiveDatesCurrentStatus").addClass("current")),this.basicInfoClass.validateBasicInfo.isValid()||(t=$("#basicInfo").offset(),this.basicInfoClass.validateBasicInfo.errors.showAllMessages(!0),$("#navValidateBasicInfo").closest("ul").find("li").removeClass("current"),$("#navValidateBasicInfo").addClass("current")),$("#participantsErrorMsg").show(),this.participantsClass.participantsShowErrorMsg()&&(t=$("#participants").offset(),$("#navParticipants").closest("ul").find("li").removeClass("current"),$("#navParticipants").addClass("current")),t!=undefined)$("body").scrollTop()?$("body").scrollTop(t.top-20):$("html, body").scrollTop(t.top-20);else{var i,r=$("#LoadingPage").find("strong"),e=$("#agreementContent").data("kendoEditor"),r=$("#LoadingPage").find("strong"),u=null,f;this.spinner.start(),$("body").scrollTop()?$("body").scrollTop(0):$("html, body").scrollTop(0),r.text("Saving agreement..."),$("#allParticipants").show().fadeOut(500,function(){$("#LoadingPage").hide().fadeIn(500)}),$.each(this.participantsClass.participants(),function(t,i){n.participantsClass.participantsExport.push({agreementId:i.agreementId,establishmentId:i.establishmentId,establishmentOfficialName:i.establishmentOfficialName,establishmentTranslatedName:i.establishmentTranslatedName,isOwner:i.isOwner,center:i.center})}),this.datesStatusClass.autoRenew()==0?u=!1:this.datesStatusClass.autoRenew()==1&&(u=!0),this.basicInfoClass.content(e.value()),f=ko.mapping.toJS({content:this.basicInfoClass.content(),expiresOn:this.datesStatusClass.expDate(),startsOn:this.datesStatusClass.startDate(),isAutoRenew:u,name:this.basicInfoClass.nickname(),notes:this.basicInfoClass.privateNotes(),status:this.datesStatusClass.statusOptionSelected(),visibility:this.visibilityClass.visibility(),isExpirationEstimated:this.datesStatusClass.isEstimated(),participants:this.participantsClass.participantsExport,umbrellaId:this.basicInfoClass.uAgreementSelected(),type:this.basicInfoClass.typeOptionSelected()}),this.agreementIsEdit()?(i=App.Routes.WebApi.Agreements.put(this.agreementId.val),$.ajax({type:"PUT",url:i,data:f,success:function(){r.text("Agreement Saved..."),setTimeout(function(){$("#LoadingPage").show().fadeOut(500,function(){$("#allParticipants").hide().fadeIn(500)})},5e3)},error:function(t){n.spinner.stop(),t.status===400&&(n.establishmentSearchNavClass.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentSearchNavClass.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentSearchNavClass.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}})):(i=App.Routes.WebApi.Agreements.post(),$.post(i,f).done(function(t,i,u){var f=u.getResponseHeader("Location");n.agreementId.val=parseInt(f.substring(f.lastIndexOf("/")+1)),n.fileAttachmentClass.agreementPostFiles(t,i,u),n.contactClass.agreementPostContacts(t,i,u),r.text("Agreement Saved..."),setTimeout(function(){u!=undefined?(window.location.hash="",window.location.href="/agreements/"+u.getResponseHeader("Location").substring(u.getResponseHeader("Location").lastIndexOf("/")+1)+"/edit/"):alert("success, but no location")},5e3)}).fail(function(t){n.spinner.stop(),t.status===400&&(n.establishmentSearchNavClass.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentSearchNavClass.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentSearchNavClass.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))}))}},n}()