define(["require","exports","../amd-modules/Establishments/SearchResult","../amd-modules/Establishments/Search","../amd-modules/Establishments/Item","../amd-modules/Widgets/Spinner"],function(n,t,i,r,u,f){var c=i,l=r,a=u,o=f,e=l.Search,v=a.Item,y=c.SearchResult,s=function(){function n(n,t,i,r){this.isOwner=ko.observable(n),this.establishmentId=ko.observable(t),this.establishmentOfficialName=ko.observable(i),this.establishmentTranslatedName=ko.observable(r)}return n}(),h;t.InstitutionalAgreementParticipantModel=s,h=function(){function n(n){typeof n=="undefined"&&(n=!0),this.initDefaultPageRoute=n,this.participants=ko.mapping.fromJS([]),this.officialNameDoesNotMatchTranslation=ko.computed(function(){return!(this.participants.establishmentOfficialName===this.participants.establishmentTranslatedName)}),this.isBound=ko.observable(),this.back=function(){history.back()},this.sideSwiper=new App.SideSwiper({speed:"",frameWidth:970,root:"[data-current-module=agreements]"}),this.owner=new e(!1),this.owner2=new e(!1),this.tenantDomain="uc.edu",this.spinner=new o.Spinner(new o.SpinnerOptions(400,!0)),this.establishmentSearchViewModel=new e,this.hasBoundSearch=!1,this.hasBoundItem=!1,this.SearchPageBind=function(n){var t=this,i=$("#cancelAddParticipant"),r=$("#searchSideBarAddNew");this.establishmentSearchViewModel.detailTooltip=function(){return"Choose this establishment as a "+n},i.off(),r.off();r.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/new/"),n.preventDefault(),!1});if(n==="parent")i.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/new/"),n.preventDefault(),!1});else i.on("click",function(n){return t.establishmentSearchViewModel.sammy.setLocation("#/index"),n.preventDefault(),!1});var u=$.Deferred(),f=$.Deferred(),e=$("#allParticipants"),o=$("#addEstablishment");this.fadeModsOut(u,f,e,o,500),$.when(u,f).done(function(){$("#estSearch").fadeIn(500)})},this.fadeModsOut=function(n,t,i,r,u){i.fadeOut(u,function(){n.resolve()}),r.fadeOut(u,function(){t.resolve()})},this.bindSearch=function(){var n=this,t;this.hasBoundSearch||(this.establishmentSearchViewModel.sammyBeforeRoute=/\#\/page\/(.*)\//,this.establishmentSearchViewModel.sammyGetPageRoute="#/page/:pageNumber/",this.establishmentSearchViewModel.sammyDefaultPageRoute="/agreements[/]?",ko.applyBindings(this.establishmentSearchViewModel,$("#estSearch")[0]),t="asdf",sessionStorage.getItem("addest")==undefined&&sessionStorage.setItem("addest","no"),this.establishmentSearchViewModel.sammy.bind("location-changed",function(){var u,f;if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf(t)<0)if(u=$("#asideRootSearch"),f=$("#asideParentSearch"),n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf("#/new/")>0){var c=$("#addEstablishment"),i=$.Deferred(),r=$.Deferred(),e=$("#estSearch"),o=$("#allParticipants"),h=500;n.fadeModsOut(i,r,e,o,h),$.when(i,r).done(function(){c.css("visibility","").hide().fadeIn(500,function(){if(!n.hasBoundItem){n.establishmentItemViewModel=new v,n.establishmentItemViewModel.goToSearch=function(){sessionStorage.setItem("addest","yes"),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/")},n.establishmentItemViewModel.submitToCreate=function(t){var e;if(!n.establishmentItemViewModel.id||n.establishmentItemViewModel.id===0){e=n.establishmentItemViewModel,n.establishmentItemViewModel.validatingSpinner.start();var i=n.establishmentItemViewModel.names()[0],r=n.establishmentItemViewModel.urls()[0],o=n.establishmentItemViewModel.location;if(i.text.isValidating()||r.value.isValidating()||n.establishmentItemViewModel.ceebCode.isValidating()||n.establishmentItemViewModel.uCosmicCode.isValidating())return setTimeout(function(){var i=n.establishmentItemViewModel.submitToCreate(t);return!1},50),!1;if(n.establishmentItemViewModel.isValidationSummaryVisible(!0),n.establishmentItemViewModel.isValid()||n.establishmentItemViewModel.errors.showAllMessages(),i.isValid()||i.errors.showAllMessages(),r.isValid()||r.errors.showAllMessages(),n.establishmentItemViewModel.validatingSpinner.stop(),i.isValid()&&r.isValid()&&n.establishmentItemViewModel.isValid()){var f=$("#LoadingPage").find("strong"),s=App.Routes.WebApi.Establishments.post(),u=n.establishmentItemViewModel.serializeData();f.text("Creating Establishment..."),u.officialName=i.serializeData(),u.officialUrl=r.serializeData(),u.location=o.serializeData(),n.establishmentItemViewModel.createSpinner.start(),$.post(s,u).done(function(){n.establishmentItemViewModel.createSpinner.stop(),f.text("Establishment created, you are being redirected to previous page..."),$("#addEstablishment").fadeOut(500,function(){$("#LoadingPage").fadeIn(500),setTimeout(function(){$("#LoadingPage").fadeOut(500,function(){f.text("Loading Page...")}),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/")},5e3)})}).fail(function(t){t.status===400&&(n.establishmentItemViewModel.$genericAlertDialog.find("p.content").html(t.responseText.replace("\n","<br /><br />")),n.establishmentItemViewModel.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.establishmentItemViewModel.$genericAlertDialog.dialog("close")}}}))})}}return!1},ko.applyBindings(n.establishmentItemViewModel,c[0]);var t=$("#cancelAddEstablishment");t.on("click",function(t){return sessionStorage.setItem("addest","no"),n.establishmentSearchViewModel.sammy.setLocation("#/page/1/"),t.preventDefault(),!1});n.hasBoundItem=!0}})}),t="#/new/"}else if(n.establishmentSearchViewModel.sammy.getLocation().toLowerCase().indexOf("#/page/")>0)sessionStorage.getItem("addest")==="yes"?(n.establishmentSearchViewModel.clickAction=function(t){n.establishmentItemViewModel.parentEstablishment(t),n.establishmentItemViewModel.parentId(t.id()),n.establishmentSearchViewModel.sammy.setLocation("#/new/")},n.establishmentSearchViewModel.header("Choose a parent establishment"),u.hide(),f.show(),n.SearchPageBind("parent"),n.establishmentSearchViewModel.header("Choose a parent establishment")):(u.show(),f.hide(),n.SearchPageBind("participant"),n.establishmentSearchViewModel.header("Choose a participant"),n.establishmentSearchViewModel.clickAction=function(t){for(var i=new s(!1,t.id(),t.officialName(),t.translatedName()),u=!1,r=0;r<n.participants().length;r++)if(n.participants()[r].establishmentId()===i.establishmentId()){u=!0;break}u!==!0?$.ajax({url:App.Routes.WebApi.Agreements.Participant.get(i.establishmentId()),type:"GET",async:!1}).done(function(t){i.isOwner(t.isOwner),n.participants.push(i),n.establishmentSearchViewModel.sammy.setLocation("Agreements/")}).fail(function(){n.participants.push(i),n.establishmentSearchViewModel.sammy.setLocation("Agreements/")}):alert("This Participant has already been added.")}),t="#/page/";else{sessionStorage.setItem("addest","no"),t="#/index",n.establishmentSearchViewModel.sammy.setLocation("#/index");var i=$.Deferred(),r=$.Deferred(),e=$("#estSearch"),o=$("#addEstablishment"),h=500;n.fadeModsOut(i,r,e,o,h),$.when(i,r).done(function(){$("#allParticipants").fadeIn(500)})}}),this.establishmentSearchViewModel.sammy.run())},this.trail=ko.observableArray([]),this.nextForceDisabled=ko.observable(!1),this.prevForceDisabled=ko.observable(!1),this.pageNumber=ko.observable(),this.populateParticipants(),this.isBound(!0),this.removeParticipant=this.removeParticipant.bind(this),this.hideOtherGroups(),this.bindSearch()}return n.prototype.receiveResults=function(n){n?ko.mapping.fromJS(n,this.participants):ko.mapping.fromJS({items:[],itemTotal:0},this.participants),this.spinner.stop()},n.prototype.populateParticipants=function(){var n=this;$.get(App.Routes.WebApi.Agreements.Participants.get()).done(function(t){n.receiveResults(t),$("#LoadingPage").hide()})},n.prototype.hideOtherGroups=function(){$("#allParticipants").css("visibility","").hide(),$("#estSearch").css("visibility","").hide(),$("#addEstablishment").css("visibility","").hide()},n.prototype.removeParticipant=function(n,t){if(confirm('Are you sure you want to remove "'+n.establishmentTranslatedName()+'" as a participant from this agreement?')){var i=this;i.participants.remove(function(t){return t.establishmentId()===n.establishmentId()&&$(t.participantEl).slideUp("fast",function(){i.participants.remove(t)}),!1})}return t.preventDefault(),t.stopPropagation(),!1},n.prototype.addParticipant=function(){this.establishmentSearchViewModel.sammy.setLocation("#/page/1/"),this.hasBoundSearch=!0},n.prototype.swipeCallback=function(){},n.prototype.lockAnimation=function(){this.nextForceDisabled(!0),this.prevForceDisabled(!0)},n.prototype.unlockAnimation=function(){this.nextForceDisabled(!1),this.prevForceDisabled(!1)},n}(),t.InstitutionalAgreementEditModel=h})