var Agreements;(function(n){(function(n){var i=function(){function n(t){var i=this;this.settings=t,this.keyword=ko.observable(sessionStorage.getItem(n.KeywordSessionKey)||""),this.keywordThrottled=ko.computed(this.keyword).extend({throttle:400}),this.countryCode=ko.observable(sessionStorage.getItem(n.CountrySessionKey)||"any"),this.pager=new App.Pager(sessionStorage.getItem(n.PageNumberSessionKey)||1,sessionStorage.getItem(n.PageSizeSessionKey)||10),this.displayPager=new App.Pager(sessionStorage.getItem(n.PageNumberSessionKey)||1,sessionStorage.getItem(n.PageSizeSessionKey)||10),this.orderBy=ko.observable(sessionStorage.getItem(n.OrderBySessionKey)||"start-desc"),this._inputChanged=ko.computed(function(){i.countryCode()==undefined&&i.countryCode("any"),isNaN(i.pager.input.pageNumber())&&i.pager.input.pageNumberText("1"),sessionStorage.setItem(n.KeywordSessionKey,i.keyword()||""),sessionStorage.setItem(n.CountrySessionKey,i.countryCode()),sessionStorage.setItem(n.PageNumberSessionKey,i.pager.input.pageNumberText()),sessionStorage.setItem(n.PageSizeSessionKey,i.pager.input.pageSizeText()),sessionStorage.setItem(n.OrderBySessionKey,i.orderBy())}).extend({throttle:0}),this.countryOptions=ko.observableArray([{code:"any",name:"[Loading...]"}]),this._countryChanged=ko.computed(function(){i._onCountryChanged()}),this._filterChanged=ko.computed(function(){var n=i.keywordThrottled(),t=i.pager.input.pageSize(),r=i.countryCode();i.pager.input.pageNumberText("1")}),this.routeFormat="#/{0}/country/{4}/sort/{1}/size/{2}/page/{3}/".format(this.settings.route).replace("{4}","{0}"),this._isActivated=ko.observable(!1),this._route=ko.computed(function(){return i._computeRoute()}),this.spinner=new App.Spinner(new App.SpinnerOptions(400,!0)),this._requestHistory=ko.observableArray(),this._currentRequest=ko.computed(function(){return i._computeCurrentRequest()}),this._requestDirty=ko.computed(function(){i._onRequestDirty()}).extend({throttle:1}),this._loadCountryOptions(),this.sammy=this.settings.sammy||Sammy(),this._runSammy()}return n.prototype._onCountryChanged=function(){var t=this.countryCode(),n=this.countryOptions();n.length==1&&n[0].code!=t&&(n[0].code=t)},n.prototype._loadCountryOptions=function(){var t=this,n=$.Deferred();return $.get(App.Routes.WebApi.Countries.get()).done(function(i){var r=i.slice(0);r=Enumerable.From([{code:"any",name:"[All countries]"}]).Concat(r).Concat([{code:"none",name:"[Without country]"}]).ToArray(),t.countryOptions(r),n.resolve()}),n},n.prototype._runSammy=function(){var n=this,t=new RegExp("\\{0}".format(this.routeFormat.format("(.*)","(.*)","(.*)","(.*)").replace(/\//g,"\\/")));this.sammy.before(t,function(){var t=this;return n._onBeforeRoute(t)}),this.sammy.get(this.routeFormat.format(":country",":sort",":size",":number"),function(){var t=this;n._onRoute(t)}),this.sammy.get(this.settings.activationRoute||this.sammy.getLocation(),function(){n.setLocation()}),this.settings.sammy||this.sammy.isRunning()||this.sammy.run()},n.prototype._onBeforeRoute=function(){return!0},n.prototype._onRoute=function(n){var t=n.params.country,i=n.params.sort,r=n.params.size,u=n.params.number;this.countryCode(t),this.orderBy(i),this.pager.input.pageSizeText(r),this.pager.input.pageNumberText(u),this.activate()},n.prototype.activate=function(){this._isActivated()||(this._requestHistory([]),this._isActivated(!0))},n.prototype.deactivate=function(){this._isActivated()&&this._isActivated(!1)},n.prototype._computeRoute=function(){var n=this.countryCode(),t=this.orderBy(),i=this.pager.input.pageSize(),r=this.pager.input.pageNumber();return this.routeFormat.format(n,t,i,r)},n.prototype.setLocation=function(){var n=this._route();this.sammy.getLocation().indexOf(n)<0&&this.sammy.setLocation(n)},n.prototype._computeCurrentRequest=function(){return{keyword:this.keywordThrottled(),countryCode:this.countryCode(),orderBy:this.orderBy(),pageSize:this.pager.input.pageSize(),pageNumber:this.pager.input.pageNumber()}},n.prototype._onRequestDirty=function(){if(this._isActivated()){var n=this._requestHistory(),t=n.length?Enumerable.From(n).Last():null,i=this._currentRequest();t&&this._areRequestsAligned(i,t)||(this._requestHistory.push(i),this._load())}},n.prototype._load=function(){this._request().done(function(){})},n.prototype._request=function(){var n=this,r=$.Deferred(),u=this._requestHistory(),f=u[u.length-1],i=this._currentRequest();return this._areRequestsAligned(i,f)?(this.spinner.start(),this.$results&&this.$results.fadeTo(200,.5),$.get(App.Routes.WebApi.Agreements.Search.get(this.settings.domain),f).done(function(u){var f=n._currentRequest();n._areRequestsAligned(i,f)?(u.itemTotal<1&&i.pageNumber!=1?n._fixOverflowedPageNumber(i,1):u.pageNumber!=i.pageNumber&&n._fixOverflowedPageNumber(i,u.pageNumber),u.items=Enumerable.From(u.items).Select(function(i){return new t(i,n)}).ToArray(),n.pager.apply(u),n.displayPager.apply(u),n.setLocation(),r.resolve(),n.spinner.stop()):r.reject()}).always(function(){n._restoreResultOpactity(),setTimeout(function(){n._restoreResultOpactity()},100)}),r):(r.reject(),r)},n.prototype._fixOverflowedPageNumber=function(n,t){for(var i=this._requestHistory().slice(0),u=i[i.length-1],r=i.length-1;r>=0;r--){if(!this._areRequestsAligned(n,i[r],!0))break;u=i[r],this._requestHistory().length>1&&this._areRequestsAligned(n,i[r-1],!0)&&this._requestHistory.pop()}u.pageNumber=t},n.prototype._areRequestsAligned=function(n,t,i){typeof i=="undefined"&&(i=!1);var r=n.keyword===t.keyword&&n.countryCode===t.countryCode&&n.orderBy===t.orderBy&&n.pageSize===t.pageSize;return i||(r=r&&n.pageNumber===t.pageNumber),r},n.prototype._restoreResultOpactity=function(){this.$results&&this.pager.output.hasItems()&&(this.$results.fadeTo(1,1),this.$results.css({opacity:1}))},n.KeywordSessionKey="AgreementSearchKeyword2",n.PageSizeSessionKey="AgreementSearchPageSize2",n.OrderBySessionKey="AgreementSearchOrderBy2",n.CountrySessionKey="AgreementSearchCountry2",n.PageNumberSessionKey="AgreementSearchPageNumber2",n}(),t;n.SearchTable=i,t=function(){function n(n,t){var i=this;this.owner=t,this.id=ko.observable(),this.name=ko.observable(),this.countryNames=ko.observable(),this.startsOn=ko.observable(),this.expiresOn=ko.observable(),this.type=ko.observable(),this.status=ko.observable(),this.countries=ko.observableArray(),this.participants=ko.observableArray(),this.detailHref=ko.computed(function(){return i.owner.settings.detailUrl.format(i.id())}),this.hasCountries=ko.computed(function(){var n=i.countries();return n&&n.length>0}),this.partners=ko.computed(function(){return Enumerable.From(i.participants()).Where(function(n){return!n.isOwner()}).ToArray()}),this.startsOnFormatted=ko.computed(function(){var n=i.startsOn();return moment(n).format("M/D/YYYY")}),this.expiresOnFormatted=ko.computed(function(){var n=i.expiresOn();return n?moment(n).format("M/D/YYYY"):""}),ko.mapping.fromJS(n,{},this)}return n.prototype.partnerTranslatedName=function(n){var t=this.partners()[n];return t.establishmentTranslatedName()},n.prototype.partnerOfficialName=function(n){var t=this.partners()[n];return t.establishmentOfficialName()},n}(),n.TableRow=t})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(Agreements||(Agreements={}))