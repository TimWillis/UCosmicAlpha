var ViewModels;(function(n){(function(t){var r=function(){function n(){this.id=ko.observable(),this.establishmentId=ko.observable(),this.establishment=ko.observable(),this.jobTitles=ko.observable(),this.isDefault=ko.observable(!1),this.isPrimary=ko.observable(!1),this.isAcknowledged=ko.observable(!1),this.isClaimingStudent=ko.observable(!1),this.isClaimingEmployee=ko.observable(!1),this.isClaimingInternationalOffice=ko.observable(!1),this.isClaimingAdministrator=ko.observable(!1),this.isClaimingFaculty=ko.observable(!1),this.isClaimingStaff=ko.observable(!1),this.campusId=ko.observable(null),this.collegeId=ko.observable(null),this.departmentId=ko.observable(null),this.facultyRankId=ko.observable(null)}return n}(),i;t.Affiliation=r,i=function(){function t(){this._sammy=Sammy(),this._activitiesViewModel=null,this._geographicExpertisesViewModel=null,this._languageExpertisesViewModel=null,this._degreesViewModel=null,this._internationalAffiliationsViewModel=null,this.hasPhoto=ko.observable(),this.isPhotoExtensionInvalid=ko.observable(!1),this.isPhotoTooManyBytes=ko.observable(!1),this.isPhotoFailureUnexpected=ko.observable(!1),this.photoFileExtension=ko.observable(),this.photoFileName=ko.observable(),this.photoSrc=ko.observable(App.Routes.WebApi.My.Profile.Photo.get({maxSide:128})),this.photoUploadSpinner=new n.Spinner(new n.SpinnerOptions(400)),this.photoDeleteSpinner=new n.Spinner(new n.SpinnerOptions(400)),this.isDisplayNameDerived=ko.observable(),this.displayName=ko.observable(),this._userDisplayName="",this.personId=0,this.salutation=ko.observable(),this.firstName=ko.observable(),this.middleName=ko.observable(),this.lastName=ko.observable(),this.suffix=ko.observable(),this.facultyRanks=ko.observableArray(),this.facultyRankId=ko.observable(null),this.defaultEstablishmentHasCampuses=ko.observable(!1),this.preferredTitle=ko.observable(),this.affiliations=ko.observableArray(),this.gender=ko.observable(),this.isActive=ko.observable(),this.$photo=ko.observable(),this.$facultyRanks=ko.observable(),this.$nameSalutation=ko.observable(),this.$nameSuffix=ko.observable(),this.editMode=ko.observable(!1),this.saveSpinner=new n.Spinner(new n.SpinnerOptions(200)),this.startInEdit=ko.observable(!1),this.startTabName=ko.observable("Activities"),this._initialize()}return t.prototype._initialize=function(){},t.prototype.load=function(n){var t=this,r=$.Deferred(),u=$.Deferred(),i;return $.get(App.Routes.WebApi.Employees.ModuleSettings.FacultyRanks.get()).done(function(n){u.resolve(n)}).fail(function(n,t,i){u.reject(n,t,i)}),i=$.Deferred(),$.get(App.Routes.WebApi.My.Profile.get()).done(function(n){i.resolve(n)}).fail(function(n,t,r){i.reject(n,t,r)}),$.when(u,i).done(function(i,u){if(t.facultyRanks(i),i.length==0&&t.facultyRankId(null),ko.mapping.fromJS(u,{ignore:"personId"},t),t.personId=u.personId,t._originalValues=u,t._setupValidation(),t._setupKendoWidgets(),t._setupDisplayNameDerivation(),t._setupCardComputeds(),n==="")t._setupRouting(),t._sammy.run("#/activities");else{var f=location.href,e=f.lastIndexOf("?");e!=-1?(t._startTab(n),t._setupRouting()):(t._setupRouting(),t._sammy.run("#/"+n))}r.resolve()}).fail(function(n,t,i){r.reject(n,t,i)}),r},t.prototype._startTab=function(t){var r=this,i=$("#tabstrip").data("kendoTabStrip");t==="activities"?(this._activitiesViewModel==null&&(this._activitiesViewModel=new n.Activities.ActivityList(this.personId),this._activitiesViewModel.load().done(function(){ko.applyBindings(r._activitiesViewModel,$("#activities")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),i.select()!=0&&i.select(0)):t==="geographic-expertise"?(this._geographicExpertisesViewModel==null&&(this._geographicExpertisesViewModel=new n.GeographicExpertises.GeographicExpertiseList(this.personId),this._geographicExpertisesViewModel.load().done(function(){ko.applyBindings(r._geographicExpertisesViewModel,$("#geographic-expertises")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),i.select()!=1&&i.select(1)):t==="language-expertise"?(this._languageExpertisesViewModel==null&&(this._languageExpertisesViewModel=new n.LanguageExpertises.LanguageExpertiseList(this.personId),this._languageExpertisesViewModel.load().done(function(){ko.applyBindings(r._languageExpertisesViewModel,$("#language-expertises")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),i.select()!=2&&i.select(2)):t==="formal-education"?(this._degreesViewModel==null&&(this._degreesViewModel=new n.Degrees.DegreeList(this.personId),this._degreesViewModel.load().done(function(){ko.applyBindings(r._degreesViewModel,$("#degrees")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),i.select()!=3&&i.select(3)):t==="affiliations"&&(this._internationalAffiliationsViewModel==null&&(this._internationalAffiliationsViewModel=new n.InternationalAffiliations.InternationalAffiliationList(this.personId),this._internationalAffiliationsViewModel.load().done(function(){ko.applyBindings(r._internationalAffiliationsViewModel,$("#international-affiliations")[0])}).fail(function(n,t,i){alert(t+" |"+i)})),i.select()!=4&&i.select(4))},t.prototype.tabClickHandler=function(n){var t=n.item.innerText;t==null&&(t=n.item.textContent),t=this.tabTitleToName(t),location.href="#/"+t},t.prototype.tabTitleToName=function(n){var t=null;return n==="Activities"&&(t="activities"),n==="Geographic Expertise"&&(t="geographic-expertise"),n==="Language Expertise"&&(t="language-expertise"),n==="Formal Education"&&(t="formal-education"),n==="Affiliations"&&(t="affiliations"),t},t.prototype.startEditing=function(){this.editMode(!0),this.$editSection.length&&this.$editSection.slideDown()},t.prototype.stopEditing=function(){this.editMode(!1),this.$editSection.length&&this.$editSection.slideUp()},t.prototype.cancelEditing=function(){ko.mapping.fromJS(this._originalValues,{},this),this.stopEditing()},t.prototype.saveInfo=function(){var n=this,t;this.isValid()?(t=ko.mapping.toJS(this),this.saveSpinner.start(),$.ajax({url:App.Routes.WebApi.My.Profile.put(),type:"PUT",dataType:"json",contentType:"application/json",data:ko.toJSON(t)}).done(function(t){App.flasher.flash(t),n.stopEditing(),n._initialize()}).fail(function(){}).always(function(){n.saveSpinner.stop()})):this.errors.showAllMessages()},t.prototype.startDeletingPhoto=function(){var n=this;this.$confirmPurgeDialog&&this.$confirmPurgeDialog.length?this.$confirmPurgeDialog.dialog({dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm delete",click:function(){n.$confirmPurgeDialog.dialog("close"),n._deletePhoto()}},{text:"No, cancel delete",click:function(){n.$confirmPurgeDialog.dialog("close"),n.photoDeleteSpinner.stop()},"data-css-link":!0}]}):confirm("Are you sure you want to delete your profile photo?")&&this._deletePhoto()},t.prototype._deletePhoto=function(){var n=this;this.photoDeleteSpinner.start(),this.isPhotoExtensionInvalid(!1),this.isPhotoTooManyBytes(!1),this.isPhotoFailureUnexpected(!1),$.ajax({url:App.Routes.WebApi.My.Profile.Photo.del(),type:"DELETE"}).always(function(){n.photoDeleteSpinner.stop()}).done(function(t){typeof t=="string"&&App.flasher.flash(t),n.hasPhoto(!1),n.photoSrc(App.Routes.WebApi.My.Profile.Photo.get({maxSide:128,refresh:(new Date).toUTCString()}))}).fail(function(){n.isPhotoFailureUnexpected(!0)})},t.prototype._setupRouting=function(){var n=this;this._sammy.route("get","#/",function(){n._startTab("activities")}),this._sammy.route("get","#/activities",function(){n._startTab("activities")}),this._sammy.route("get","#/geographic-expertise",function(){n._startTab("geographic-expertise")}),this._sammy.route("get","#/language-expertise",function(){n._startTab("language-expertise")}),this._sammy.route("get","#/formal-education",function(){n._startTab("formal-education")}),this._sammy.route("get","#/affiliations",function(){n._startTab("affiliations")})},t.prototype._setupValidation=function(){this.displayName.extend({required:{message:"Display name is required."},maxLength:200}),this.salutation.extend({maxLength:50}),this.firstName.extend({maxLength:100}),this.middleName.extend({maxLength:100}),this.lastName.extend({maxLength:100}),this.suffix.extend({maxLength:50}),this.preferredTitle.extend({maxLength:500}),ko.validation.group(this)},t.prototype._setupKendoWidgets=function(){var n=this,t=$("#tabstrip");t.kendoTabStrip({select:function(t){n.tabClickHandler(t)},animation:!1}).show(),this.$nameSalutation.subscribe(function(n){n&&n.length&&n.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.People.Names.Salutations.get()}}})})}),this.$nameSuffix.subscribe(function(n){n&&n.length&&n.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.People.Names.Suffixes.get()}}})})}),this.$photo.subscribe(function(t){t&&t.length&&t.kendoUpload({multiple:!1,showFileList:!1,localization:{select:"Choose a photo to upload..."},async:{saveUrl:App.Routes.WebApi.My.Profile.Photo.post(),removeUrl:App.Routes.WebApi.My.Profile.Photo.kendoRemove()},upload:function(t){var i=[".png",".jpg",".jpeg",".gif"];n.isPhotoExtensionInvalid(!1),n.isPhotoTooManyBytes(!1),n.isPhotoFailureUnexpected(!1),$(t.files).each(function(r){var f=!1,e=t.files[r].extension,u;for(n.photoFileExtension(e||"[NONE]"),n.photoFileName(t.files[r].name),u=0;u<i.length;u++)if(i[u]===e.toLowerCase()){f=!0;break}f?t.files[r].size&&t.files[r].size>1048576&&(t.preventDefault(),n.isPhotoTooManyBytes(!0)):(t.preventDefault(),n.isPhotoExtensionInvalid(!0))}),t.isDefaultPrevented()||n.photoUploadSpinner.start()},complete:function(){n.photoUploadSpinner.stop()},success:function(t){t.operation=="upload"&&(t.response&&t.response.message&&App.flasher.flash(t.response.message),n.hasPhoto(!0),n.photoSrc(App.Routes.WebApi.My.Profile.Photo.get({maxSide:128,refresh:(new Date).toUTCString()})))},error:function(t){var i,r;t.files&&t.files.length>0&&(i=t.files[0].name,r=t.files[0].extension),i&&n.photoFileName(i),r&&n.photoFileExtension(r),t.XMLHttpRequest.status===415?n.isPhotoExtensionInvalid(!0):t.XMLHttpRequest.status===413?n.isPhotoTooManyBytes(!0):n.isPhotoFailureUnexpected(!0)}})})},t.prototype._setupDisplayNameDerivation=function(){var n=this;this.displayName.subscribe(function(t){n.isDisplayNameDerived()||(n._userDisplayName=t)}),ko.computed(function(){if(n.isDisplayNameDerived()){var t={id:n.personId,isDisplayNameDerived:n.isDisplayNameDerived(),displayName:n.displayName(),salutation:n.salutation(),firstName:n.firstName(),middleName:n.middleName(),lastName:n.lastName(),suffix:n.suffix()},i=ko.mapping.toJS(t);$.ajax({url:App.Routes.WebApi.People.Names.DeriveDisplayName.get(),type:"GET",cache:!1,data:i}).done(function(t){n.displayName(t)})}else n._userDisplayName||(n._userDisplayName=n.displayName()),n.displayName(n._userDisplayName)}).extend({throttle:400})},t.prototype._setupCardComputeds=function(){var n=this;this.genderText=ko.computed(function(){var t=n.gender();return t==="M"?"Male":t==="F"?"Female":t==="P"?"Gender Undisclosed":"Gender Unknown"}),this.isActiveText=ko.computed(function(){return n.isActive()?"Active":"Inactive"}),this.isFacultyRankEditable=ko.computed(function(){return n.facultyRanks()&&n.facultyRanks().length>0}),this.facultyRankText=this.facultyRankId()!=null?ko.computed(function(){for(var r=n.facultyRankId(),i,t=0;t<n.facultyRanks().length;t++)if(i=n.facultyRanks()[t],r===i.id)return i.rank;return undefined}):undefined,this.isFacultyRankVisible=ko.computed(function(){return n.isFacultyRankEditable()&&n.facultyRankId()&&n.facultyRankText()&&n.facultyRankText().toLowerCase()!=="other"})},t.prototype.reloadAffiliations=function(){var n=this;$.ajax({async:!0,url:App.Routes.WebApi.My.Profile.Affiliation.get(),type:"GET"}).done(function(t,i,r){var f,u;if(i==="success")for(f=ko.mapping.fromJS(t),n.affiliations.removeAll(),u=0;u<f().length;u+=1)n.affiliations.push(f()[u]);else alert("Error reloading affiliations: "+r.responseText)}).fail(function(n,t,i){alert("Saving affiliation failed: "+t+"|"+i)})},t.prototype.editAffiliation=function(n){for(var i=this,r=null,t=0,f,u;t<this.affiliations().length&&!this.affiliations()[t].isDefault;)t+=1;if(t<this.affiliations().length)r=this.affiliations()[t];else return;$("#editAffiliationDepartmentDropList").kendoDropDownList({dataTextField:"officialName",dataValueField:"id",change:function(){},dataBound:function(){if(this.selectedIndex!=null&&this.selectedIndex!=-1){var n=this.dataItem(this.selectedIndex);n==null?(this.text(""),$("#editAffiliationDepartmenDiv").hide()):$("#editAffiliationDepartmenDiv").show()}else $("#editAffiliationDepartmenDiv").hide()}}),f=null,this.defaultEstablishmentHasCampuses()||(f=new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Establishments.getChildren(r.establishmentId(),!0)}}})),$("#editAffiliationCollegeDropList").kendoDropDownList({dataTextField:"officialName",dataValueField:"id",dataSource:f,change:function(n){var i=n.sender.selectedIndex,t,r;i!=-1&&(t=this.dataItem(i),t!=null&&(r=new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Establishments.getChildren(t.id,!0)}}}),$("#editAffiliationDepartmentDropList").data("kendoDropDownList").setDataSource(r)))},dataBound:function(){var n,t,i;this.selectedIndex!=null&&this.selectedIndex!=-1&&(n=this.dataItem(this.selectedIndex),n!=null&&(t=n.id,t!=null&&(i=new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Establishments.getChildren(t,!0)}}}),$("#editAffiliationDepartmentDropList").data("kendoDropDownList").setDataSource(i))))}}),this.defaultEstablishmentHasCampuses()&&$("#editAffiliationCampusDropList").kendoDropDownList({dataTextField:"officialName",dataValueField:"id",dataSource:new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Establishments.getChildren(r.establishmentId(),!1)}}}),change:function(n){var t=n.sender.selectedIndex,i,r;t!=null&&t!=-1&&(i=this.dataItem(t),i!=null&&(r=new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Establishments.getChildren(i.id,!0)}}}),$("#editAffiliationCollegeDropList").data("kendoDropDownList").setDataSource(r)))},dataBound:function(){var n,t,i;this.selectedIndex!=null&&this.selectedIndex!=-1&&(n=this.dataItem(this.selectedIndex),n!=null?(t=n.id,t!=null&&(i=new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Establishments.getChildren(t,!0)}}}),$("#editAffiliationCollegeDropList").data("kendoDropDownList").setDataSource(i))):$("#editAffiliationCollegeDropList").data("kendoDropDownList").setDataSource(null))}}),this.facultyRanks()!=null&&this.facultyRanks().length>0&&$("#editAffiliationFacultyRankDropList").kendoDropDownList({dataTextField:"rank",dataValueField:"id",dataSource:new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.Employees.ModuleSettings.FacultyRanks.get()}}})}),u=300,u-=this.defaultEstablishmentHasCampuses()?0:40,u-=this.facultyRanks()!=null&&this.facultyRanks().length>0?0:40,$("#editAffiliationDialog").dialog({dialogClass:"no-close",title:n==null?"Create Affiliation":"Edit Affiliation",width:750,height:u,resizable:!1,draggable:!0,modal:!0,buttons:[{text:"Save",click:function(){i.saveAffiliation(n==null?null:n.id(),r.establishmentId())}},{text:"Cancel",click:function(){$("#editAffiliationDialog").dialog("close")}}],open:function(){if(n!=null){var r={text:"Delete",click:function(){i.deleteAffiliation(n.id())}},t=$(this).dialog("option","buttons");t.push(r),$(this).dialog("option","buttons",t),i.defaultEstablishmentHasCampuses()&&n.campusId()!=null&&$("#editAffiliationCampusDropList").data("kendoDropDownList").value(n.campusId()),n.collegeId()!=null&&$("#editAffiliationCollegeDropList").data("kendoDropDownList").value(n.collegeId()),n.departmentId()!=null&&$("#editAffiliationDepartmentDropList").data("kendoDropDownList").value(n.departmentId()),i.isFacultyRankVisible()&&n.facultyRankId()!=null&&$("#editAffiliationFacultyRankDropList").data("kendoDropDownList").value(n.facultyRankId())}}})},t.prototype.GetDropListSelectedItem=function(n){var r=null,i=$("#"+n).data("kendoDropDownList"),t;return i!=null&&(t=i.selectedIndex,t!=null&&t!=-1&&(r=i.dataItem(t))),r},t.prototype.saveAffiliation=function(n,t){var r=this,u=null,f=null,e=null,o=null,i,s,h;this.defaultEstablishmentHasCampuses()&&(i=r.GetDropListSelectedItem("editAffiliationCampusDropList"),i!=null&&(u=i.id)),i=r.GetDropListSelectedItem("editAffiliationCollegeDropList"),i!=null&&(f=i.id),i=r.GetDropListSelectedItem("editAffiliationDepartmentDropList"),i!=null&&(e=i.id),this.facultyRanks()!=null&&this.facultyRanks().length>0&&(i=r.GetDropListSelectedItem("editAffiliationFacultyRankDropList"),i!=null&&(o=i.id)),s={id:n,personId:r.personId,establishmentId:t,campusId:u,collegeId:f,departmentId:e,facultyRankId:o},h=ko.mapping.toJS(s),$.ajax({async:!1,dataType:"json",contentType:"application/json",url:n==null?App.Routes.WebApi.My.Profile.Affiliation.post():App.Routes.WebApi.My.Profile.Affiliation.put(),type:n==null?"POST":"PUT",data:ko.toJSON(h)}).done(function(n,t,i){t==="success"?($("#editAffiliationDialog").dialog("close"),r.reloadAffiliations()):$("#affiliationErrorDialog").dialog({title:i.statusText,width:400,height:250,modal:!0,resizable:!1,draggable:!1,buttons:{Ok:function(){$("#affiliationErrorDialog").dialog("close")}},open:function(){$("#affiliationErrorDialogMessage").text(i.responseText)}})}).fail(function(n,t,i){alert("Saving affiliation failed: "+t+"|"+i),$("#editAffiliationDialog").dialog("close")})},t.prototype.deleteAffiliation=function(n){var t=this;$("#confirmAffiliationDeleteDialog").dialog({width:300,height:200,modal:!0,resizable:!1,draggable:!1,buttons:{Delete:function(){$(this).dialog("close");var i={id:n,personId:t.personId,establishmentId:null,campusId:null,collegeId:null,departmentId:null,facultyRankId:null},r=ko.mapping.toJS(i);$.ajax({async:!1,type:"DELETE",url:App.Routes.WebApi.My.Profile.Affiliation.del(),dataType:"json",contentType:"application/json",data:ko.toJSON(r),success:function(n,i,r){i!=="success"&&$("#affiliationErrorDialog").dialog({title:r.statusText,width:400,height:250,modal:!0,resizable:!1,draggable:!1,buttons:{Ok:function(){$("#affiliationErrorDialog").dialog("close")}},open:function(){$("#affiliationErrorDialogMessage").text(r.responseText)}}),$("#editAffiliationDialog").dialog("close"),t.reloadAffiliations()},error:function(n,t){alert(t),$("#editAffiliationDialog").dialog("close")}})},Cancel:function(){$(this).dialog("close")}}})},t.prototype.deleteProfile=function(){var n=this;$("#confirmProfileDeleteDialog").dialog({width:300,height:200,modal:!0,resizable:!1,draggable:!1,buttons:{Delete:function(){$.ajax({async:!1,type:"DELETE",url:App.Routes.WebApi.People.del(n.personId),success:function(n,t,i){alert(i.statusText)},error:function(n,t){alert(t)},complete:function(){$("#confirmProfileDeleteDialog").dialog("close")}})},Cancel:function(){$(this).dialog("close")}}})},t}(),t.Profile=i})(n.My||(n.My={}));var t=n.My})(ViewModels||(ViewModels={}))