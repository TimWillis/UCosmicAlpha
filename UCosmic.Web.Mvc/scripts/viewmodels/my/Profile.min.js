var RootViewModels=ViewModels,People;(function(n){(function(t){var r=function(){function n(n,t,i){var f=this,r,u;this.owner=n,this.select=new App.FormSelect({kendoOptions:{}}),r=this._getOptionsCaption(t),u=this._getSelectOptions(t),this.select.caption(r),this.select.options(u.slice(0)),this.select.value(i?i.id:undefined),this.select.value.subscribe(function(n){f._onSelectedValueChanged(n)})}return n.prototype._getOptionsCaption=function(n){var t=this,i=Enumerable.From(n).All(function(n){return n.parentId==t.owner.owner.defaultAffiliation.establishmentId});return i?"[Select main affiliation]":"[Select sub-affiliation or leave empty]"},n.prototype._getSelectOptions=function(n){return Enumerable.From(n).Select(function(n){return{text:n.contextName||n.officialName,value:n.id}}).ToArray()},n.prototype._onSelectedValueChanged=function(n){var t=this.owner.establishmentEditors();if(n)this.owner.bindEstablishmentEditors(n);else{var r=Enumerable.From(t).IndexOf(this),u=t.slice(0,r).reverse(),i=Enumerable.From(u).FirstOrDefault(undefined,function(n){return n.select.value()&&n.select.value()>0});i?this.owner.bindEstablishmentEditors(i.select.value()):this.owner.bindEstablishmentEditors(this.owner.owner.defaultAffiliation.establishmentId)}},n}(),i,u;t.AffiliatedEstablishmentEditor=r,i=function(){function t(n,t){var i=this;this.affiliationId=ko.observable(),this.personId=ko.observable(),this.establishmentId=ko.observable(),this.isDefault=ko.observable(),this.jobTitles=ko.observable(),this.facultyRank=ko.observable(),this.establishments=ko.observableArray(),this.hideValidationMessages=ko.observable(!0),this.saveSpinner=new App.Spinner({delay:200}),this.purgeSpinner=new App.Spinner,this.establishmentEditors=ko.observableArray(),this.firstEstablishmentId=ko.computed(function(){var n=i.establishmentEditors(),t,r;return n.length?(t=n[0],r=t.select.value(),r):-1}),this.lastEstablishmentId=ko.computed(function(){var t=i.establishmentEditors(),n;return t.length&&(n=Enumerable.From(t).LastOrDefault(undefined,function(n){return n.select.value()&&n.select.value()>0}),n)?n.select.value():-1}),this.facultyRankSelect=new App.FormSelect({kendoOptions:{}}),this.hasFacultyRanks=ko.observable(!1),this.jobTitlesHtml=ko.computed(function(){return i._computeJobTitles()}),this.owner=n,isNaN(t)&&(this.data=t),this.data?(ko.mapping.fromJS(this.data,{},this),this.isEditing=ko.observable(!1)):(this.personId(t),this.isEditing=ko.observable(!0)),setTimeout(function(){i._loadFacultyRankOptions()},0),this._initValidation()}return t.prototype.edit=function(){this.bindEstablishmentEditors(this.establishmentId()),this.isEditing(!0)},t.prototype.cancel=function(){var t=this.affiliationId(),n;if(!t){this.owner.editableAffiliations.remove(this);return}ko.mapping.fromJS(this.data,{},this),n=this.facultyRank(),n&&this.facultyRankSelect.value(n.facultyRankId()),this.isEditing(!1)},t.prototype._initValidation=function(){var n=this;this.jobTitles.extend({maxLength:{message:"Position Title(s) cannot contain more than 500 characters.",params:500}}),this.firstEstablishmentId.extend({required:{message:"At least one main affiliation is required."}}),this.lastEstablishmentId.extend({validation:{validator:function(t){if(t<1)return!0;var i=Enumerable.From(n.owner.editableAffiliations()).FirstOrDefault(undefined,function(i){return i!==n&&i.establishmentId()==t});return typeof i=="undefined"},message:"You already have another affiliation with this organizational unit."}}),ko.validation.group(this)},t.prototype.save=function(){var i=this,t;if(!this.isValid()){this.hideValidationMessages(!1),this.errors.showAllMessages();return}this.hideValidationMessages(!0),t={establishmentId:this.lastEstablishmentId(),facultyRankId:this.facultyRankSelect.value(),jobTitles:this.jobTitles()},this.saveSpinner.start(),n.Servers.PutAffiliation(t,this.establishmentId()||t.establishmentId).done(function(){i.owner.affiliationData.reload()}).fail(function(n){App.Failures.message(n,"while trying to save your affiliation",!0),i.saveSpinner.stop()})},t.prototype.purge=function(){var n=this;this.purgeSpinner.start(),this.owner.$confirmDeleteAffiliation&&this.owner.$confirmDeleteAffiliation.length?this.owner.$confirmDeleteAffiliation.dialog({dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm delete",click:function(){n.owner.$confirmDeleteAffiliation.dialog("close"),n.purgeSpinner.start(!0),n._purge()},"data-css-link":!0,"data-confirm-delete-link":!0},{text:"No, cancel delete",click:function(){n.owner.$confirmDeleteAffiliation.dialog("close")},"data-css-link":!0}],close:function(){n.purgeSpinner.stop()}}):confirm("Are you sure you want to delete this affiliation?")?this._purge():this.purgeSpinner.stop()},t.prototype._purge=function(){var t=this;n.Servers.DeleteAffiliation(this.establishmentId()).done(function(){t.owner.affiliationData.reload()}).fail(function(n){App.Failures.message(n,"while trying to delete your affiliation",!0),t.purgeSpinner.stop()})},t.prototype.bindEstablishmentEditors=function(n){var t=this;this.owner.establishmentData.ready().done(function(i){t._bindEstablishmentEditors(n,i)})},t.prototype._bindEstablishmentEditors=function(n,t){var i,r;for(this.establishmentEditors([]),i=n;i&&i!=this.owner.defaultAffiliation.establishmentId;)r=this._bindEstablishmentEditor(i,t),i=r.parentId;this._bindEstablishmentEditor(n,t,!0)},t.prototype._bindEstablishmentEditor=function(n,t,i){var u,e,f;return typeof i=="undefined"&&(i=!1),u=this._getEstablishmentById(n,t),e=this._getEstablishmentEditorOptions(u?i?u.id:u.parentId:this.owner.defaultAffiliation.establishmentId,t),e.length&&(f=new r(this,e,i?undefined:u),i?this.establishmentEditors.push(f):this.establishmentEditors.unshift(f),this.owner.load().done(function(){f.select.applyKendo()})),u},t.prototype._getEstablishmentById=function(n,t){return Enumerable.From(t).SingleOrDefault(undefined,function(t){return t.id==n})},t.prototype._getEstablishmentEditorOptions=function(n,t){return Enumerable.From(t).Where(function(t){return t.parentId==n}).OrderBy(function(n){return n.rank}).ThenBy(function(n){return n.contextName||n.officialName}).ToArray()},t.prototype._loadFacultyRankOptions=function(){var n=this;this.owner.employeeSettingsData.ready().done(function(t){n._bindFacultyRankOptions(t)})},t.prototype._bindFacultyRankOptions=function(n){var r=this,i,t;n&&n.facultyRanks&&n.facultyRanks.length&&(this.hasFacultyRanks(!0),i=this._getFacultyRankSelectOptions(n),this.facultyRankSelect.caption("[None]"),this.facultyRankSelect.options(i),t=this.facultyRank(),t&&this.facultyRankSelect.value(t.facultyRankId()),this.owner.load().done(function(){r.facultyRankSelect.applyKendo()}))},t.prototype._getFacultyRankSelectOptions=function(n){return Enumerable.From(n.facultyRanks).OrderBy(function(n){return n.rank}).Select(function(n){return{text:n.text,value:n.facultyRankId}}).ToArray()},t.prototype._computeJobTitles=function(){var n=this.jobTitles();return n=n||"",n.replace(/\n/g,"<br />")},t}(),t.Affiliation=i,u=function(){function t(n){var t=this;this._sammy=Sammy(),this._activitiesViewModel=null,this._geographicExpertisesViewModel=null,this._languageExpertisesViewModel=null,this._degreesViewModel=null,this._internationalAffiliationsViewModel=null,this.hasPhoto=ko.observable(),this.photoUploadError=ko.observable(),this.photoSrc=ko.observable(App.Routes.WebApi.My.Photo.get({maxSide:128,refresh:(new Date).toUTCString()})),this.photoUploadSpinner=new App.Spinner({delay:400}),this.photoDeleteSpinner=new App.Spinner({delay:400}),this.isDisplayNameDerived=ko.observable(),this.displayName=ko.observable(),this._userDisplayName="",this.personId=0,this.salutation=ko.observable(),this.firstName=ko.observable(),this.middleName=ko.observable(),this.lastName=ko.observable(),this.suffix=ko.observable(),this.defaultEstablishmentHasCampuses=ko.observable(!1),this.preferredTitle=ko.observable(),this.gender=ko.observable(),this.isActive=ko.observable(),this.$photo=ko.observable(),this.$facultyRanks=ko.observable(),this.$nameSalutation=ko.observable(),this.$nameSuffix=ko.observable(),this.editMode=ko.observable(!1),this.saveSpinner=new App.Spinner({delay:200}),this.startInEdit=ko.observable(!1),this.startTabName=ko.observable("Activities"),this.editableAffiliations=ko.observableArray(),this.affiliationsSpinner=new App.Spinner({delay:400,runImmediately:!0}),this.isEditingAffiliation=ko.computed(function(){var n=t.editableAffiliations(),i=Enumerable.From(n).FirstOrDefault(undefined,function(n){return n.isEditing()});return typeof i!="undefined"}),this.affiliationData=new App.DataCacher(function(){return t._loadAffiliationData()}),this.establishmentData=new App.DataCacher(function(){return t._loadEstablishmentData()}),this.employeeSettingsData=new App.DataCacher(function(){return t._loadEmployeeSettingsData()}),this.personId2=n,this.affiliationData.ready()}return t.prototype._loadAffiliationData=function(){var t=this,r=$.Deferred();return n.Servers.GetAffiliationsByPerson().done(function(n){t.defaultAffiliation=Enumerable.From(n).Single(function(n){return n.isDefault}),t.preferredTitle(t.defaultAffiliation.jobTitles);var u=Enumerable.From(n).Except([t.defaultAffiliation]).OrderBy(function(n){return n.affiliationId}).ToArray();ko.mapping.fromJS(u,{create:function(n){return new i(t,n.data)}},t.editableAffiliations),t.establishmentData.ready(),t.employeeSettingsData.ready(),t.affiliationsSpinner.stop(),r.resolve(n)}),r},t.prototype._loadEstablishmentData=function(){var n=$.Deferred();return Establishments.Servers.GetOffspring(this.defaultAffiliation.establishmentId).done(function(t){n.resolve(t)}),n},t.prototype._loadEmployeeSettingsData=function(){var n=$.Deferred();return Employees.Servers.GetSettingsByPerson().done(function(t){n.resolve(t)}),n},t.prototype.addAffiliation=function(){var n=new i(this,this.personId);this.editableAffiliations.push(n),n.bindEstablishmentEditors(undefined)},t.prototype.load=function(n){var t,i;return(typeof n=="undefined"&&(n=""),t=this,this._loadPromise)?this._loadPromise:(this._loadPromise=$.Deferred(),i=$.Deferred(),$.get("/api/user/person").done(function(n){i.resolve(n)}).fail(function(n,t,r){i.reject(n,t,r)}),i.done(function(i){if(ko.mapping.fromJS(i,{ignore:"id"},t),t.personId=i.personId,t._originalValues=i,t._setupValidation(),t._setupKendoWidgets(),t._setupDisplayNameDerivation(),t._setupCardComputeds(),n==="")t._setupRouting(),t._sammy.run("#/activities");else{var r=location.href,u=r.lastIndexOf("?");u!=-1?(t._startTab(n),t._setupRouting()):(t._setupRouting(),t._sammy.run("#/"+n))}t._loadPromise.resolve()}).fail(function(n,i,r){t._loadPromise.reject(n,i,r)}),this._loadPromise)},t.prototype._startTab=function(n){var i=this,t=$("#tabstrip").data("kendoTabStrip");n==="activities"?(this._activitiesViewModel==null&&(this._activitiesViewModel=new Activities.ViewModels.ActivityList,this._activitiesViewModel.load().done(function(){ko.applyBindings(i._activitiesViewModel,$("#activities")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),t.select()!=0&&t.select(0)):n==="geographic-expertise"?(this._geographicExpertisesViewModel==null&&(this._geographicExpertisesViewModel=new RootViewModels.GeographicExpertises.GeographicExpertiseList(this.personId),this._geographicExpertisesViewModel.load().done(function(){ko.applyBindings(i._geographicExpertisesViewModel,$("#geographic-expertises")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),t.select()!=1&&t.select(1)):n==="language-expertise"?(this._languageExpertisesViewModel==null&&(this._languageExpertisesViewModel=new RootViewModels.LanguageExpertises.LanguageExpertiseList(this.personId),this._languageExpertisesViewModel.load().done(function(){ko.applyBindings(i._languageExpertisesViewModel,$("#language-expertises")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),t.select()!=2&&t.select(2)):n==="formal-education"?(this._degreesViewModel==null&&(this._degreesViewModel=new RootViewModels.Degrees.DegreeList(this.personId),this._degreesViewModel.load().done(function(){ko.applyBindings(i._degreesViewModel,$("#degrees")[0])}).fail(function(n,t,i){alert(t+"|"+i)})),t.select()!=3&&t.select(3)):n==="affiliations"&&(this._internationalAffiliationsViewModel==null&&(this._internationalAffiliationsViewModel=new RootViewModels.InternationalAffiliations.InternationalAffiliationList(this.personId),this._internationalAffiliationsViewModel.load().done(function(){ko.applyBindings(i._internationalAffiliationsViewModel,$("#international-affiliations")[0])}).fail(function(n,t,i){alert(t+" |"+i)})),t.select()!=4&&t.select(4))},t.prototype.tabClickHandler=function(n){var t=n.item.innerText;t==null&&(t=n.item.textContent),t=this.tabTitleToName(t),location.href="#/"+t},t.prototype.tabTitleToName=function(n){var t=null;return n==="Activities"&&(t="activities"),n==="Geographic Expertise"&&(t="geographic-expertise"),n==="Language Expertise"&&(t="language-expertise"),n==="Formal Education"&&(t="formal-education"),n==="Affiliations"&&(t="affiliations"),t},t.prototype.startEditing=function(){this.editMode(!0),this.$editSection.length&&this.$editSection.slideDown()},t.prototype.stopEditing=function(){this.editMode(!1),this.$editSection.length&&this.$editSection.slideUp()},t.prototype.cancelEditing=function(){ko.mapping.fromJS(this._originalValues,{},this),this.stopEditing()},t.prototype.saveInfo=function(){var t=this,i,r;this.isValid()?(i=ko.mapping.toJS(this),this.saveSpinner.start(),r={jobTitles:this.preferredTitle()},n.Servers.PutAffiliation(r,this.defaultAffiliation.establishmentId),$.ajax({url:"/api/user/person",type:"PUT",data:i}).done(function(n){App.flasher.flash(n),t.stopEditing()}).fail(function(){}).always(function(){t.saveSpinner.stop()})):this.errors.showAllMessages()},t.prototype.startDeletingPhoto=function(){var n=this;this.$confirmPurgeDialog&&this.$confirmPurgeDialog.length?this.$confirmPurgeDialog.dialog({dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:[{text:"Yes, confirm delete",click:function(){n.$confirmPurgeDialog.dialog("close"),n._deletePhoto()}},{text:"No, cancel delete",click:function(){n.$confirmPurgeDialog.dialog("close"),n.photoDeleteSpinner.stop()},"data-css-link":!0}]}):confirm("Are you sure you want to delete your profile photo?")&&this._deletePhoto()},t.prototype._deletePhoto=function(){var n=this;this.photoDeleteSpinner.start(),this.photoUploadError(undefined),$.ajax({url:App.Routes.WebApi.My.Photo.del(),type:"DELETE"}).always(function(){n.photoDeleteSpinner.stop()}).done(function(t){typeof t=="string"&&App.flasher.flash(t),n.hasPhoto(!1),n.photoSrc(App.Routes.WebApi.My.Photo.get({maxSide:128,refresh:(new Date).toUTCString()}))}).fail(function(){n.photoUploadError(t.photoUploadUnexpectedErrorMessage)})},t.prototype._setupRouting=function(){var n=this;this._sammy.route("get","#/",function(){n._startTab("activities")}),this._sammy.route("get","#/activities",function(){n._startTab("activities")}),this._sammy.route("get","#/geographic-expertise",function(){n._startTab("geographic-expertise")}),this._sammy.route("get","#/language-expertise",function(){n._startTab("language-expertise")}),this._sammy.route("get","#/formal-education",function(){n._startTab("formal-education")}),this._sammy.route("get","#/affiliations",function(){n._startTab("affiliations")})},t.prototype._setupValidation=function(){this.displayName.extend({required:{message:"Display name is required."},maxLength:200}),this.salutation.extend({maxLength:50}),this.firstName.extend({maxLength:100}),this.middleName.extend({maxLength:100}),this.lastName.extend({maxLength:100}),this.suffix.extend({maxLength:50}),this.preferredTitle.extend({maxLength:500}),ko.validation.group(this)},t.prototype._setupKendoWidgets=function(){var n=this,i=$("#tabstrip");i.kendoTabStrip({select:function(t){n.tabClickHandler(t)},animation:!1}).show(),this.$nameSalutation.subscribe(function(n){n&&n.length&&n.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.People.Names.Salutations.get()}}})})}),this.$nameSuffix.subscribe(function(n){n&&n.length&&n.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:new kendo.data.DataSource({transport:{read:{url:App.Routes.WebApi.People.Names.Suffixes.get()}}})})}),this.$photo.subscribe(function(i){i&&i.length&&i.kendoUpload({multiple:!1,showFileList:!1,localization:{select:"Choose a photo to upload..."},async:{saveUrl:App.Routes.WebApi.My.Photo.post()},select:function(t){n.photoUploadSpinner.start(),$.ajax({type:"POST",async:!1,url:App.Routes.WebApi.My.Photo.validate(),data:{name:t.files[0].name,length:t.files[0].size}}).done(function(){n.photoUploadError(undefined)}).fail(function(i){n.photoUploadError(i.responseText),t.preventDefault(),n.photoUploadSpinner.stop()})},complete:function(){n.photoUploadSpinner.stop()},success:function(t){t.operation=="upload"&&(t.response&&t.response.message&&App.flasher.flash(t.response.message),n.hasPhoto(!0),n.photoSrc(App.Routes.WebApi.My.Photo.get({maxSide:128,refresh:(new Date).toUTCString()})))},error:function(i){i.XMLHttpRequest.responseText&&i.XMLHttpRequest.responseText.length<1e3?n.photoUploadError(i.XMLHttpRequest.responseText):n.photoUploadError(t.photoUploadUnexpectedErrorMessage)}})})},t.prototype._setupDisplayNameDerivation=function(){var n=this;this.displayName.subscribe(function(t){n.isDisplayNameDerived()||(n._userDisplayName=t)}),ko.computed(function(){if(n.isDisplayNameDerived()){var t={id:n.personId,isDisplayNameDerived:n.isDisplayNameDerived(),displayName:n.displayName(),salutation:n.salutation(),firstName:n.firstName(),middleName:n.middleName(),lastName:n.lastName(),suffix:n.suffix()},i=ko.mapping.toJS(t);$.ajax({url:App.Routes.WebApi.People.Names.DeriveDisplayName.get(),type:"GET",cache:!1,data:i}).done(function(t){n.displayName(t)})}else n._userDisplayName||(n._userDisplayName=n.displayName()),n.displayName(n._userDisplayName)}).extend({throttle:400})},t.prototype._setupCardComputeds=function(){var n=this;this.genderText=ko.computed(function(){var t=n.gender();return t==="M"?"Male":t==="F"?"Female":t==="P"?"Gender Undisclosed":"Gender Unknown"}),this.isActiveText=ko.computed(function(){return n.isActive()?"Active":"Inactive"})},t.prototype.deleteProfile=function(){var n=this;$("#confirmProfileDeleteDialog").dialog({width:300,height:200,modal:!0,resizable:!1,draggable:!1,buttons:{Delete:function(){$.ajax({async:!1,type:"DELETE",url:App.Routes.WebApi.People.del(n.personId),success:function(n,t,i){alert(i.statusText)},error:function(n,t){alert(t)},complete:function(){$("#confirmProfileDeleteDialog").dialog("close")}})},Cancel:function(){$(this).dialog("close")}}})},t.photoUploadUnexpectedErrorMessage="UCosmic experienced an unexpected error managing your photo, please try again. If you continue to experience this issue, please use the Feedback & Support link on this page to report it.",t}(),t.Profile=u})(n.ViewModels||(n.ViewModels={}));var t=n.ViewModels})(People||(People={}))