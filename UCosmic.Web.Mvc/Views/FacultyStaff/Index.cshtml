 @model UCosmic.Web.Mvc.Models.FacultyStaffFilterModel

@{
    ViewBag.Title = "Search Faculty & Staff";
}

@section bib
{
    <nav class="bib hide" data-current-bib="search">
        @Html.Partial(MVC.FacultyStaff.Views._Bib)
    </nav>
}


@section scripts
{
    @Scripts.Render("~/bundles/employees")

    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
    <@*script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=visualization"></script>*@
       
    <script type="text/javascript">

        google.load('visualization', '1', { 'packages': ['geochart'] });
        google.setOnLoadCallback(drawRegionsMap);

        function drawRegionsMap() {

            var countryData = new Array();
            countryData.push(['Country', 'Activities']);

            $.ajax({
                type: "GET",
                async: false,
                url: App.Routes.WebApi.Activities.CountryCounts.get(),
                success: function(data, textStatus, jqXHR) {
                    for (var i = 0; i < data.length; i += 1) {
                        countryData.push([data[i].officialName, data[i].count]);
                    }
                },
                error: function(jqXhr, textStatus, errorThrown) {
                    debugger;
                },
                dataType: 'json'
            });

            var countryDataTable = google.visualization.arrayToDataTable(countryData);

            var options = {
                //is3D: true,
                width: 680,
                height: 500,
                //magnifyingGlass: { enable: true, zoomFactor: 7.5 },
                region: 'world', //'150',    // 002 Africa, 142 Asia
                backgroundColor: 'lightBlue',
                keepAspectRatio: true,
                colorAxis: { colors: ['#FFFFFF', 'green'] },
                //displayMode: 'markers'
            };

            window.heatmap = new google.visualization.GeoChart($('#heatmap')[0]);
            window.heatmap.draw(countryDataTable, options);
        }

        window.pointmap = new google.maps.Map(document.getElementById('pointmap'),
            {
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                center: new google.maps.LatLng(0, 0), // americas on left, australia on right
                zoom: 1, // zoom out
                draggable: true, // allow map panning
                scrollwheel: false // prevent mouse wheel zooming
            });

        $(function() {

            debugger;

            var model = @Model;
            var facultyAndStaffViewModel = new ViewModels.Employees.FacultyAndStaff(model);
            facultyAndStaffViewModel.load()
                .done(function() {

                    facultyAndStaffViewModel.setupWidgets("location", "fromDate", "toDate", "institutionTextbox",
                        "campusDropList", "collegeDropList", "departmentDropList" );

                    var rootElement = $("#faculty-staff")[0];
                    ko.applyBindings(facultyAndStaffViewModel, rootElement);

                    var locationSelector = $("#location").data("kendoMultiSelect");
                    locationSelector.setDataSource(new kendo.data.DataSource({
                        serverFiltering: true,
                        transport: {
                            read: function(options) {
                                $.ajax({
                                    url: App.Routes.WebApi.Places.get(),

                                    /*
                                        Bug - There's a bug in KendoUI Multiselect whereby the datasource.read()
                                        gets called as soon as the widget gets focus.  This is bad as the Place
                                        service will respond with all the Places in the DB since there is no 
                                        filter being provided.  Our workaround is to trap the empty filter
                                        and send a special character for the service to ignore.  Also,
                                        If options.success() is not actually call, the widget stops functioning
                                        altogether.
                                    */
                                    data: {
                                        keyword: ((options.data.filter != null) &&
                                            (options.data.filter.filters != null) &&
                                            (options.data.filter.filters.length > 0) &&
                                            (options.data.filter.filters[0].value != null)) ?
                                            options.data.filter.filters[0].value : "~"
                                    },
                                    success: function(results) {
                                        options.success(results);
                                    }
                                });
                            }
                        }
                    }));

                    facultyAndStaffViewModel.setupValidation();
                    facultyAndStaffViewModel.setupSubscriptions();

                })
                .fail(function(jqXhr, textStatus, errorThrown) {
                    alert(textStatus + "|" + errorThrown);
                });
        });
    </script>    
    }

    <div class="content fixed to-top" data-current-module="employees">
        <div id="faculty-staff" class="on-left from-top">
            <header>
                <h1>@ViewBag.Title</h1>
            </header>
            <div style="width: 680px; margin-bottom: 8px; text-align: center">
                <span style="font-family: monospace; font-size: large">
                    <span id="heatmapText" class="maptype-hover" style="margin-right: 12px; font-weight: normal" data-bind="click: function ( item, event ) { selectMap( 'heatmap' ); }">HEATMAP</span>
                    <span id="pointmapText" class="maptype-hover" style="margin-right: 12px; font-weight: bold" data-bind="click: function ( item, event ) { selectMap( 'pointmap' ); }">MAP</span>
                    <span id="resultstableText" class="maptype-hover" style="font-weight: normal" data-bind="click: function ( item, event ) { selectMap( 'resultstable' ); }">TABLE</span>
                </span>
            </div>
            <div style="width: 680px; height: 500px">
                <div id="heatmap" style="display: none" data-bind="visible: isHeatmapVisible()"></div>
                <div data-bind="visible: isPointmapVisible()">
                    <div id="pointmap" style="width: 680px; height: 500px"></div>
                </div>
                <div id="resultstable" style="display: none" data-bind="visible: isTableVisible()">
                    
                    <table class="data">
                        <colgroup>
                            <col style="width: 40%;" />
                            <col style="width: 30%;" />
                            <col style="width: 30%;" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Faculty</th>
                                <th>Activity</th>
                                <th>Locations</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                        </tbody>
                    </table>                  
                </div>
            </div>
        </div>
        <div class="on-right from-top">
            @Html.Partial(MVC.FacultyStaff.Views._SearchSideBar)
        </div>
    </div>
