@using UCosmic.Web.Mvc.Models
@{
    ViewBag.Title = "Student Mobility Snapshot";
    ViewBag.StudentsDomain = "usf.edu"; //temporary for prototype demo
}

@section bib
{
    <nav class="bib">
        @Html.Partial(MVC.Students.Views._Bib, new StudentsBibNavModel { })
    </nav>
}

@section styles
{
    <link rel="stylesheet" type="text/css" href="~/styles/sass/sheets/employees/summary.css" />

}


<link rel="import" href="~/components/Polymer/bower_components/core-ajax/core-ajax.html">


<div class="content fixed to-top" data-current-module="students">
    <form class="group" method="GET" id="activity_search_form" data-bind="jQuery: '$form'">
        <div class="on-left from-top">

            <div class="group" style="height:30px;">
                <div class="on-left">
                    <header style=" margin-bottom:0px;">
                        <h1>
                           Student Mobility
                        </h1>
                    </header>
                </div>
                
                <div class="on-right">
                    <a href="/usf.edu/students/table/" class="restore-underline">Reset search</a>
                </div>
            </div>

            <polymer-element name="activity-table" attributes="pager resp url table-headers">
                <template>
                    <style>
                        table {
                            display: table;
                            border-collapse: collapse;
                            border-spacing: 0px;
                            border-color: gray;
                            margin: 0;
                            padding: 0;
                            border: 0;
                            font-size: 100%;
                            font: inherit;
                            vertical-align: baseline;
                            cursor: default;
                        }
                        th {
                            border: solid 1px #fff;
                            padding: 4px 8px;
                            vertical-align: text-top;
                            text-align: left;
                            background-color: black;
                            color: white;
                            font-weight: bold;
                        }
                        ul {
                            list-style: none;
                        }

                        table.data tbody tr:nth-child(odd) td {
                            background-color: #dddddd;
                        }

                       table.data td {
                            border: solid 1px #fff;
                            padding: 4px;
                            vertical-align: top;
                        }

                        table.data th {
                            border: solid 1px #fff;
                            padding: 4px 8px;
                            vertical-align: text-top;
                            text-align: left;
                            background-color: black;
                            color: white;
                            font-weight: bold;
                        }

                        table.data .searchResults tr:hover td {
                            background-color: #ffffaa;
                        }

                        .align-top > col {
                            vertical-align: top;
                        }


                    </style>

                    <link href="~/styles/reset.css" rel="stylesheet" />
                    <link rel="stylesheet" type="text/css" href="~/styles/sass/sheets/employees/summary.css" />

                    <core-ajax id="cajax" url="{{url}}" params='{{urlParams}}' loading='{{loading}}' auto on-core-response="{{resp}}"
                               attributes="urlParams"></core-ajax>

                    <table style="width:100%">
                        <tr>
                            <td align="left">
                                <div style="height: 24px; ">
                                    <strong>Showing {{pager.pageStart}} - {{pager.pageEnd}} of {{pager.numStudents}}</strong>
                                    (page
                                    <select id="pageNumber" on-change="{{changePage}}" data-sel="this">
                                        <!--TODO: Replace 10 with # Per Page Option-->
                                        <option value="{{i}}" selected="{{isSelected}}" template repeat="{{i in pageRange}}">
                                            {{i}}
                                        </option>
                                    </select>
                                    of <span>{{pager.pageMax}}</span>)
                                </div>

                                <div>
                                    <button class="link" id="prev_button" on-click="{{prevPage}}">&lt;&lt; Previous</button>                                  
                                    <button class="link" id="next_button" on-click="{{nextPage}}">Next &gt;&gt;</button>
                                </div>

                                <template if="{{loading}}">
                                    <div>
                                        <img src="/images/icons/spinner/spinner-20-blue.gif" alt="" />
                                        <strong>Loading...</strong>
                                    </div>
                                </template>
                            </td>
                            <td align="right">
                                <div class="field"
                                     style=" margin: 10px 0 0 0;">
                                    <select name="orderBy" class="side" id="orderby" on-change="{{changeOrderBy}}" data-sel="this">
                                        <option selected="selected" value="term-desc">Sort by term most recent at top</option>
                                        <option value="term-asc">Sort with term most recent at bottom</option>
                                        <option value="status-asc">Sort by status inbound at top</option>
                                        <option value="status-desc">Sort by status inbound at bottom</option>
                                        <option value="country-asc">Sort by country A-Z</option>
                                        <option value="country-desc">Sort by country Z-A</option>
                                        <option value="level-desc">Sort by level highest at top</option>
                                        <option value="level-asc">Sort by level highest at bottom</option>
                                        <option value="program-asc">Sort by degree program A-Z</option>
                                        <option value="program-desc">Sort by degree program Z-A</option>
                                        
                                    </select>
                                </div>

                                <div class="field"
                                     style="margin:4px 0;">

                                    <select name="pageSize" class="side" id="Input_PageSize" on-change="{{changePageSize}}" data-size="this">
                                        <option selected="selected" value="10">Show 10 results per page</option>
                                        <option value="20">Show 20 results per page</option>
                                        <option value="50">Show 50 results per page</option>
                                        <option value="100">Show 100 results per page</option>
                                        <option value="250">Show 250 results per page</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <table class="data">     
                        <thead>
                            <tr>
                                <th>Term</th>
                                <th>Status</th>
                                <th>Country</th>
                                <th>Level</th>
                                <th>Degree Program</th>
                                <th>Feeder Institution</th>
                                <th>Host Institution</th>
                            </tr>
                        </thead>

                        <tbody class="searchResults">
                            <template repeat="{{student in pager.students}}">
                                <tr>
                                    <td>{{student.term}}</td>
                                    <td>{{student.status}}</td>
                                    <td>{{student.country}}</td>
                                    <td>{{student.level}}</td>
                                    <td>{{student.program}}</td>
                                    <td>{{student.localEstablishmentName}}</td>
                                    <td>{{student.foreignEstablishmentName}}</td>                                       
                                </tr>
                            </template>
                        </tbody>

                    </table>
                </template>
                <script>
                    Polymer('activity-table',
                    {
                        
                        pageRange: [],

                        pager: {
                            page: 0,
                            pageSize: 0,
                            pageMax: 0,
                            pageEnd: 0,
                            numStudents: 0,
                            order: '',
                            orderDirection: '',
                            students: []
                        },

                        changePage: function (sel) {
                            this.urlParams.page = parseInt(sel.target.value);
                            this.refresh();
                        },

                        changePageSize: function (sel) {
                            this.urlParams.pageSize = parseInt(sel.target.value);
                            this.refresh();
                        },
                        
                        changeOrderBy: function (sel) {
                            //Select orderby and direction for url parameters
                            switch(sel.target.value){
                                case "term-desc"  : 
                                    this.urlParams.orderby          = "termStart"; 
                                    this.urlParams.orderDirection   = "DESC"; 
                                    break;
                                case "term-asc"   :
                                    this.urlParams.orderby          = "termStart"; 
                                    this.urlParams.orderDirection   = "ASC"; 
                                    break;
                                case "status-asc" :
                                    this.urlParams.orderby          = "status"; 
                                    this.urlParams.orderDirection   = "ASC"; 
                                    break;
                                case "status-desc":
                                    this.urlParams.orderby          = "status"; 
                                    this.urlParams.orderDirection   = "DESC"; 
                                    break;
                                case "country-asc":
                                    this.urlParams.orderby          = "country"; 
                                    this.urlParams.orderDirection   = "ASC"; 
                                    break;
                                case "country-desc":
                                    this.urlParams.orderby          = "country"; 
                                    this.urlParams.orderDirection   = "DESC"; 
                                    break;
                                case "level-desc":
                                    //rank is the numerical version of level
                                    this.urlParams.orderby          = "rank";
                                    this.urlParams.orderDirection   = "DESC";
                                    break;
                                case "level-asc":
                                    this.urlParams.orderby          = "rank";
                                    this.urlParams.orderDirection   = "ASC";
                                    break;
                                case "program-asc":
                                    this.urlParams.orderby          = "program";
                                    this.urlParams.orderDirection   = "ASC";
                                    break;
                                case "program-desc":
                                    this.urlParams.orderby          = "program";
                                    this.urlParams.orderDirection   = "DESC";
                                    break;

                                //whew!
                            }
                            this.refresh();

                        },

                        changeLevelBy: function (sel) {
                            //Select orderby and direction for url parameters
                            switch (sel.target.value) {
                                case "UG":
                                    this.urlParams.FLevel = "UG";
                                    break;
                                case "GR":
                                    this.urlParams.FLevel = "GR";
                                    break;
                            }
                            this.refresh();

                        },

                        isSelected: function (sel) {
                            if (parseInt(sel.target.value) == this.pager.page) return true;
                            else return false; 
                        },

                        loading: false,

                        nextPage:function(){this.urlParams.page+=1; this.refresh();},

                        prevPage:function(){this.urlParams.page-=1; this.refresh();},

                        range: function (s, l) {
                            var o = []
                            for (var i = 0; i < l; i++) {
                                o.push(s + i);
                            }
                            return o;
                        },

                        refresh: function () {
                            this.$.cajax.go();
                        },

                        resp: function (response) {
                            this.pager = JSON.parse(response.detail.response);
                            this.pageRange = this.range(1, this.pager.pageMax);

                            //disable buttons on first/last page
                            this.$.prev_button.disabled = (this.pager.page == 1) ? true : false;
                            this.$.next_button.disabled = (this.pager.page == this.pager.pageMax) ? true : false;
                        },

                        urlParams: {
                            domain: "",
                            page: 1,
                            pageSize: 10,
                            orderby: "termStart",
                            orderDirection: "DESC",
                            FCountry: "%%",
                            dateStart: "19000101", //January 1st, 1900 by default (show activities after 1900)
                            dateEnd: "99990101", //January 1st, 9999 by default (show activities before 9999)
                            FContinent: "%%",
                            FDegree: "%%",
                            FLevel: "%%",
                            FInstitution: "%%"
                            //filter terms here
                        }
                    });
                </script>
            </polymer-element>

            <activity-table id="activity-table" url="~/api/students/"></activity-table>

    </div>
    <aside class="on-right from-top" data-fixed-scroll="root">
        <div data-fixed-scroll="anchor"></div>
        <div data-fixed-scroll="content">
            <nav class="side">

                <ul class="top">
                    <li class="static square-bottom" style="margin-bottom: 0;">
                        <div class="group">
                            <div class="on-left"></div>
                        </div>
                        <div class="group no-link" style="margin-left: 15px;">
                            <span class="text">
                            </span>
                        </div>
                    </li>
                    <li class="static square-bottom">
                        <div class="content">
                            <div class="field">
                                <div>
                                    <ul data-bind="foreach: affiliations()">
                                        <li style="margin-bottom: 4px;display: none" data-bind="visible: $parent.hasEstablishmentSelects()">
                                            <div>
                                                <select class="campusSelect" data-bind="options: options, value: value,
optionsText: 'text', optionsValue: 'value', jQuery: '$select',
attr: { id: 'campusSelect' + $index() }"
                                                        style="padding: 1px; margin: initial; height: auto; width: 100%; font-size: 14px;">
                                                    <option>[Loading...]</option>
                                                </select>
                                            </div>
                                        </li>
                                    </ul>
                                    <span data-bind="visible: !hasEstablishmentSelects()">Loading...</span>
                                    <input type="hidden" data-bind="value: selectedEstablishment" name="ancestorid" />
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
                <ul class="middle">
                    <li class="static square-bottom " style="margin-bottom: 0;">
                        <div class="group">
                            <div class="on-left"></div>
                        </div>
                        <div class="group no-link">
                            <span class="arrow"></span>
                            <span class="text" style="border-radius: 0;">
                                Filter by location
                                <img src="/images/icons/spinner/spinner-20-blue-on-ddd.gif" alt=""
                                     style="margin-left: 4px; display: none;" data-bind="visible: loadingSpinner.isVisible" />
                            </span>
                        </div>
                    </li>
                    <li class="static square-bottom">
                        <div class="content">

                            <div class="location combobox field">
                                <input name="placeNames" type="text" placeholder="[Filter by continent]" data-bind="jQuery: '$location'"
                                       value=""
                                       class="side" />
                                <input name="placeIds" type="hidden" data-bind="jQuery: '$placeIds'" />
                            </div>

                            <div class="location combobox field">
                                <input name="placeNames" type="text" placeholder="[Filter by country]" data-bind="jQuery: '$location'"
                                       value=""
                                       class="side" />
                                <input name="placeIds" type="hidden" data-bind="jQuery: '$placeIds'" />
                            </div>

                            <div class="location combobox field">
                                <input name="placeNames" type="text" placeholder="[Filter by degree]" data-bind="jQuery: '$location'"
                                       value=""
                                       class="side" />
                                <input name="placeIds" type="hidden" data-bind="jQuery: '$placeIds'" />
                            </div>

                            <div class="field"
                                 style=" margin: 10px 0 0 0;">
                                <select name="levelby" class="side" id="levelby" on-change="{{changeLevelBy}}" data-sel="this">
                                    <option selected="selected" value="%%">ALL</option>
                                    <option value="GR">Graduate</option>
                                    <option value="UG">Undergraduate</option>
                                </select>
                            </div>

            <div class="dates picker field" style="margin-top: 12px;">
                <strong>Filter by date(s)</strong>
                <div class="group">
                    <div class="on-left" style="width: 110px;">
                        <input type="text" name="Since" placeholder="From" class="side" data-role="datepicker"
    data-bind="value: since, valueUpdate: 'afterkeydown', jQuery: '$since'" />
</div>
<div class="on-right" style="width: 110px;">
    <input type="text" name="Until" placeholder="To" class="side" data-role="datepicker"
    data-bind="value: until, valueUpdate: 'afterkeydown', jQuery: '$until'" />
</div>
</div>
<div style="font-size: 12px; color: #555;">
    YYYY or M/YYYY or M/D/YYYY
</div>
<div style="color: #000; font-size: 13px; line-height: 13px; margin-top: 4px;">

    <label style="cursor: pointer; vertical-align: top;">
        <input type="checkbox" name="includeUndated" checked="checked" value="true" style="cursor: pointer;" /> Include undated activities
        <input type="hidden" name="includeUndated" value="false" />
    </label>
</div>
<div style="margin-top: 8px">

    <input type="submit" value="Search" style="font-size: 14px; line-height: normal; padding: 4px 8px; margin-right: 4px;" />
    <button type="button" class="link"
    data-bind="click: clearSince, disable: isClearSinceDisabled"
    disabled="disabled"
    style="font-size: 14px; line-height: normal; margin-right: 4px;">
Clear from
</button>
<button type="button" class="link"
    data-bind="click: clearUntil, disable: isClearUntilDisabled"
    disabled="disabled"
    style="font-size: 14px; line-height: normal;">
Clear to
</button>
</div>
</div>
</div>
</li>
</ul>



<ul class="bottom">
    <li>
        <a href="/usf.edu/students/" class="group">
            <span class="arrow"></span>
            <span class="text">Global Snapshot</span>
        </a>
    </li>
    <li class="current">
        <a class="group">
            <span class="arrow"></span>
            <span class="text">Advanced Search (Table)</span>
        </a>
    </li>
    <li>

        <a style=" display: none;" href="/usf.edu/students/map/" class="group" data-bind="visible: !MapDataIsLoading()">
            <span class="arrow"></span>
            <span class="text">Advanced Search (Map)</span>
        </a>
        <a class="group" style="cursor: not-allowed" data-bind="visible: MapDataIsLoading">
            <span class="arrow"></span>
            <span class="text">
                <img src="/images/icons/spinner/spinner-20-grey.gif" alt="" />
                <strong title="This can take a few minutes.">Loading Search (Map)...</strong>
            </span>
        </a>
    </li>
</ul>
</nav>
</div>
</aside>
</form>
</div>
