@{
    ViewBag.Title = "My International Activity";
}

@section styles
{
    <style>
        .k-upload .k-upload-button {
            max-width: 500px;
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
        }

        .k-autocomplete, .k-autocomplete.k-state-default, .k-autocomplete.k-state-focused {
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
            border: solid 1px #aaa;
            border-right-color: #ddd;
            border-bottom-color: #ddd;
        }

            .k-autocomplete .k-input, .k-autocomplete.k-state-focused .k-input {
                -webkit-border-radius: 0;
                -moz-border-radius: 0;
                border-radius: 0;
                padding: 8px;
                font-size: 16px;
                line-height: 20px;
                height: auto;
                text-indent: 0;
            }

        .k-list-container, .k-list-container.k-state-border-up, .k-list-container.k-state-border-down {
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
        }

        .k-multiselect {
            background-image: none;
            background-color: transparent;
        }

            .k-multiselect.k-header {
                border: solid 1px #aaa;
                border-right-color: #ddd;
                border-bottom-color: #ddd;
            }

            .k-multiselect.k-state-focused {
                -webkit-box-shadow: none;
                box-shadow: none;
            }

            .k-multiselect .k-input {
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
                display: block;
                padding: 8px 0 8px 4px;
                font-size: 16px;
                line-height: 20px;
                height: 36px;
                margin: 0;
                font-family: Arial;
                color: #000;
            }

                .k-multiselect .k-input.k-readonly {
                    color: #666;
                }

            .k-multiselect.k-state-hover, .xk-multiselect.k-state-hover:hover {
                background-image: none;
                background-color: transparent;
            }

            .k-multiselect, .k-multiselect.k-state-border-down, .k-multiselect.k-state-border-up, .k-multiselect .k-multiselect-wrap {
                -webkit-border-radius: 0;
                -moz-border-radius: 0;
                border-radius: 0;
                min-height: 36px;
            }

                .k-multiselect ul .k-button {
                    -webkit-border-radius: 0;
                    -moz-border-radius: 0;
                    border-radius: 0;
                    margin: 2px 0 0 2px;
                    padding: 5px 6px 5px 8px;
                    line-height: 16px;
                    font-size: 16px;
                    vertical-align: middle;
                    color: #000;
                    background-color: #eee;
                    background-image: none;
                    border-color: #ddd;
                }

                    .k-multiselect ul .k-button .k-delete.k-icon {
                        background-position: top left;
                        background-image: url('/images/icons/minus/minus-20-red.png');
                        width: 20px;
                        height: 20px;
                        margin-left: 8px;
                        cursor: pointer;
                    }

        .k-datepicker {
            width: 175px;
        }

            .k-datepicker .k-picker-wrap {
                -webkit-border-radius: 0;
                -moz-border-radius: 0;
                border-radius: 0;
                padding-right: 28px;
                border-color: #aaa;
                border-right-color: #ddd;
                border-bottom-color: #ddd;
            }

                .k-datepicker .k-picker-wrap .k-input {
                    -moz-box-sizing: border-box;
                    -webkit-box-sizing: border-box;
                    box-sizing: border-box;
                    color: #000;
                    font-size: 16px;
                    line-height: 20px;
                    color: #000;
                    padding: 8px 0 8px 8px;
                    height: 36px;
                    text-indent: 0;
                }

                .k-datepicker .k-picker-wrap .k-select {
                    -moz-box-sizing: border-box;
                    -webkit-box-sizing: border-box;
                    box-sizing: border-box;
                    height: 36px;
                    width: 29px;
                    padding-top: 1px;
                    padding-left: 0;
                    cursor: pointer;
                    margin-left: 0;
                }

        .k-animation-container .k-calendar-container {
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
        }

        .k-calendar-container .k-calendar {
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
            font-size: 12px;
        }

        .k-calendar .k-meta-view td {
            vertical-align: middle;
        }

            .k-calendar .k-meta-view td.k-state-hover, .k-calendar .k-meta-view td.k-state-hover:hover, .k-calendar .k-meta-view td.k-other-month.k-state-hover, .k-calendar .k-meta-view td.k-other-month.k-state-hover:hover {
                background-color: #ddd;
                background-image: none;
                -webkit-box-shadow: none;
                box-shadow: none;
            }

                .k-calendar .k-meta-view td.k-state-hover .k-link, .k-calendar .k-meta-view td.k-state-hover:hover .k-link, .k-calendar .k-meta-view td.k-other-month.k-state-hover .k-link, .k-calendar .k-meta-view td.k-other-month.k-state-hover:hover .k-link {
                    background-color: #ddd;
                    background-image: none;
                    -webkit-box-shadow: none;
                    box-shadow: none;
                }

        .k-calendar .k-content td.k-state-hover, .k-calendar .k-content td.k-state-hover:hover, .k-calendar .k-content td.k-other-month.k-state-hover, .k-calendar .k-content td.k-other-month.k-state-hover:hover {
            background-color: #ddd;
            background-image: none;
            -webkit-box-shadow: none;
            box-shadow: none;
        }

            .k-calendar .k-content td.k-state-hover .k-link, .k-calendar .k-content td.k-state-hover:hover .k-link, .k-calendar .k-content td.k-other-month.k-state-hover .k-link, .k-calendar .k-content td.k-other-month.k-state-hover:hover .k-link {
                background-color: #ddd;
                background-image: none;
                -webkit-box-shadow: none;
                box-shadow: none;
            }
    </style>
}

@section scripts
{
    @* include tinymce unbundled so it can find its plugins and other scripts internally when bundles are optimized *@
    @if (BundleTable.EnableOptimizations)
    {
        <script type="text/javascript" src="~/scripts/tinymce/tiny_mce.js"></script>
    }
    else
    {
        <script type="text/javascript" src="~/scripts/tinymce/tiny_mce_src.js"></script>
    }

    @Scripts.Render("~/bundles/activity")

    <script type="text/javascript">
        (function($, window) {
            var activityId = @ViewBag.ActivityId, activityWorkCopyId = @ViewBag.ActivityWorkCopyId;
            var activityViewModel = new ViewModels.Activities.Activity(activityId, activityWorkCopyId);
            activityViewModel.load()
                .done(function() {
                    activityViewModel.setupWidgets("fromDatePicker", "toDatePicker", "countrySelector", "uploadFile", "newTag");

                    activityViewModel.setupValidation();

                    ko.applyBindings(activityViewModel, $("#activity-edit")[0]);

                    var datePicker = $("#fromDatePicker").data("kendoDatePicker");
                    datePicker.options.format = activityViewModel.values.dateFormat();
                    datePicker.value(activityViewModel.values.startsOn());

                    datePicker = $("#toDatePicker").data("kendoDatePicker");
                    datePicker.options.format = activityViewModel.values.dateFormat();
                    datePicker.value(activityViewModel.values.endsOn());

                    /* NOTE: Using TinyMCE autosave plugin will disable window.onbeforeunload. */
                    window.onbeforeunload = function() {
                        activityViewModel.autoSave();
                    };

                    activityViewModel.setupSubscriptions();
                    activityViewModel.ready(true);
                })
                .fail(function(xhr) {
                    App.Failures.message(xhr, 'while trying to load the activity editor', true);
                });
        } (jQuery, window));

    </script>

}

@section bib
{
    <nav class="bib hide" data-current-bib="my">
        @Html.Partial(MVC.Home.Views._Bib)
    </nav>
}

<div class="fixed content" data-current-module="home">
    <div data-side-swiper="root">
        <div data-side-swiper="deck">
            <div data-side-swiper="on">
                <div id="activity-edit" data-bind="visible: ready" style="display: none;">

                    @* BUTTONS *@
                    <div style="margin-bottom: 32px" data-bind="template: { name: 'buttons-template'}"></div>

                    <header>
                        <h1>@ViewBag.Title</h1>
                        <span class="red badge" style="vertical-align: middle;" data-bind="visible: modeText().toLowerCase() == 'draft'">Draft</span>
                    </header>

                    <div style="margin-bottom: 38px">
                        <table class="activity">
                            <tbody>
                                <tr>
                                    @* TITLE *@
                                    <td class="label"><span class="container required"><span class="text">Title</span></span></td>
                                    <td>
                                        <textarea rows="1" placeholder="[Enter Title]" maxlength="500" data-bind="value: values.title"></textarea>
                                    </td>
                                </tr>
                                @* COUNTRY *@
                                <tr>
                                    <td class="label"><span class="container required"><span class="text">Countries / Locations</span></span></td>
                                    <td>
                                        <select id="countrySelector" style="overflow-y: auto" data-bind="selectedOptions: kendoPlaceIds"></select>
                                        <span data-bind="validationMessage: values.locations" class="validationMessage"></span>
                                    </td>
                                </tr>
                                @* TYPE *@
                                <tr>
                                    @* TODO: activity types / categories are not always required *@
                                    <td class="label" style="padding-top: 0;"><span class="container required"><span class="text">Type(s)</span></span></td>
                                    <td>
                                        @* Need this div for the validation message to display. *@
                                        <div>
                                            <ul class="data-items" data-bind="template: { name: 'activity-types-template', foreach: activityTypes }" />
                                        </div>
                                        <span data-bind="validationMessage: values.types" class="validationMessage"></span>
                                    </td>
                                </tr>
                                @* FROM and TO DATES *@
                                <tr>
                                    <td class="label"><span class="container required"><span class="text">On / From</span></span></td>
                                    <td>
                                        <div data-bind='validationOptions: { insertMessages: false }'>
                                            <span style="display: inline-block; margin-right: 24px;">
                                                <input id="fromDatePicker" data-bind="value: values.startsOn" />
                                            </span>
                                            <span style="display: inline-block; margin-right: 24px;">
                                                <label>
                                                    <input id="ongoingCheckbox" type="checkbox" data-bind="checked: values.onGoing" />
                                                    <span>&nbsp;On-going&nbsp;</span>
                                                </label>
                                            </span>
                                            <span style="display: inline-block; width: 220px;" data-bind="visible: !values.onGoing()">
                                                <span>To:</span>
                                                &nbsp;
                                                <input id="toDatePicker" data-bind="value: values.endsOn" />
                                            </span>
                                        </div>
                                        @*<span data-bind="validationMessage: values.endsOn" class="validationMessage"></span>*@
                                        <div class="example" style="margin-top: 8px">
                                            <span>Enter dates as yyyy, mm/yyyy or use date picker.</span>
                                            <div>
                                                <span data-bind="validationMessage: values.startsOn" class="validationMessage"></span>
                                                <span data-bind="validationMessage: values.endsOn" class="validationMessage"></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                @* FUNDING *@
                                <tr>
                                    <td class="label" style="padding-top: 0;"><span class="container"><span class="text">Funding</span></span></td>
                                    <td>
                                        <div style="margin-bottom: 4px;">
                                            <label>
                                                <input type="checkbox" style="margin-right: 4px; margin-left: 4px" data-bind="checked: values.wasExternallyFunded" />
                                                <span>This activity received <strong>external</strong> funding</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label>
                                                <input type="checkbox" style="margin-right: 4px; margin-left: 4px" data-bind="checked: values.wasInternallyFunded" />
                                                <span>This activity received <strong>internal</strong> funding</span>
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        @* DESCRIPTION *@
                        <div style="margin-bottom: inherit">
                            <header style="margin-bottom: 4px">
                                <h2 style="font-weight: normal">Description</h2>
                                 @*<img src="~/images/icons/help/question-mark-24-blue.png" alt="Help" style="width: 16px; height: 16px; float: right; margin-bottom: 3px"/>*@ 
                            </header>
                            <textarea data-bind="tinymce: values.content, valueUpdate: ['afterkeydown','keyup'], tinymceOptions:
                                {
                                    content_css: App.Routes.Content.styles('tinymce.css'),
                                    convert_urls: false,
                                    theme: 'advanced',
                                    gecko_spellcheck : true,
                                    mode: 'exact',
                                    height: '300',
                                    width: '100%',
                                    verify_html: true,
                                    plugins: 'paste,searchreplace,table,nonbreaking,inlinepopups',
                                    theme_advanced_buttons1: 'undo,redo,restoredraft,|,formatselect,fontsizeselect ,bold,italic,underline,|,link,unlink,|,bullist,numlist,|,outdent,indent,blockquote,|,sub,sup,charmap,code',
                                    theme_advanced_buttons2: 'cut,copy,paste,pastetext,pasteword,|,search,replace,|,image,hr,nonbreaking,tablecontrols',
                                    theme_advanced_buttons3: '',
                                    theme_advanced_font_sizes: '10px,12px,14px,16px,24px',
                                    theme_advanced_toolbar_location: 'top',
                                    theme_advanced_toolbar_align: 'left',
                                    theme_advanced_statusbar_location: 'bottom',
                                    theme_advanced_resizing: true,
                                    theme_advanced_resizing_max_height: '580',
                                    theme_advanced_resize_horizontal: false,
                                    theme_advanced_blockformats: 'h2,h3,p,blockquote',
                                    save_enablewhendirty: true,
                                    gecko_spellcheck : true,
                                    theme_advanced_path : false
                                }">
                            </textarea>
                            @*<textarea id="description" rows="8" data-bind="value: values.content"></textarea>*@
                        </div>
                        @* TAGS *@
                        <div style="margin-bottom: 32px">
                            <header style="margin-bottom: 10px">
                                <h2 style="font-weight: normal">
                                    <span>Tags or Keywords</span>
                                </h2>
                            </header>
                            <div style="width: 100%; margin-bottom: 16px">
                                <input id="newTag" style="width: 600px; white-space: nowrap; overflow: hidden" data-bind="value: newTag" />
                                &nbsp;
                                <a href="/#" data-bind="click: addTag" title="Add tag">
                                    <img src="~/images/icons/plus/plus-24-green.png" alt="Add new tag" />
                                </a>
                            </div>
                            <div data-bind="visible: !values.tags().length">
                                <p style="padding-bottom: 10px;">
                                    There are currently no tags or keywords associated with this activity.
                                </p>
                            </div>
                            <ul data-bind="template: { name: 'tags-template', foreach: values.tags, visible: values.tags().length }"></ul>
                            <div style="clear: left;"></div>
                        </div>

                        @* DOCUMENTS *@
                        <div style="width: 100%; margin-bottom: inherit">
                            <header>
                                <h2>
                                    <span style="font-weight: normal">Shared Documents</span>
                                </h2>
                            </header>
                            <div data-bind="visible: !values.documents().length">
                                <p>
                                    There are currently no shared documents associated with this activity.
                                </p>
                            </div>
                            <div style="margin-bottom: 16px">
                                <input type="file" name="uploadFile" id="uploadFile" />
                            </div>
                            <div data-bind="visible: fileUploadErrors().length" style="display: none;">
                                <ul data-bind="foreach: fileUploadErrors">
                                    <li style="margin-bottom: 0.5em;">
                                        <div>
                                            <span class="validationMessage" data-bind="text: message" style="display: inline; line-height: 1.2em;"></span>
                                            &nbsp;
                                            <a href="#" data-bind="click: function() { $root.dismissFileUploadError($index()); }">OK</a>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div data-bind="visible: values.documents().length">
                                <table class="data">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%; text-align: center">Preview</th>
                                            <th style="width: 65%">Title</th>
                                            <th style="width: 10%; text-align: center">Type</th>
                                            <th style="width: 10%; text-align: center">Size</th>
                                            @*<th style="width: 5%; text-align: center">Hide</th>*@
                                            <th style="width: 5%"></th>
                                        </tr>
                                    </thead>
                                    <tbody data-bind="template: { name: 'activity-document-template', foreach: values.documents }"></tbody>
                                </table>
                            </div>
                        </div>

                        @* BUTTONS *@
                        <div style="margin-bottom: 32px" data-bind="template: { name: 'buttons-template'}"></div>

                        @* LAST UPDATED *@
                        <div style="width: 50%; height: 1.5em; border-top: 1px; border-style: solid">
                            <span style="font-size: smaller; color: slategray">
                                <span>Last updated</span>
                                <label id="last-updated-date" data-bind="text: (whenLastUpdated() != null) ? moment(whenLastUpdated()).format('MM/DD/YYYY') : ''"></label>
                                <span>by </span>
                                <label id="last-updated-name" data-bind="text: whoLastUpdated()"></label>
                            </span>
                        </div>

                        @* API URL's *@
                        <div style="display: none">
                            @{
                                var placePutUrlFormat = Url.HttpRouteUrl(null, new { controller = "ActivityPlaces", action = "Put", activityId = 0, placeId = 1 });
                                if (placePutUrlFormat != null)
                                {
                                    placePutUrlFormat = placePutUrlFormat.Replace("0", "{0}").Replace("1", "{1}");
                                }
                                var placeDeleteUrlFormat = Url.HttpRouteUrl(null, new { controller = "ActivityPlaces", action = "Delete", activityId = 0, placeId = 1 });
                                if (placeDeleteUrlFormat != null)
                                {
                                    placeDeleteUrlFormat = placeDeleteUrlFormat.Replace("0", "{0}").Replace("1", "{1}");
                                }
                                var typePutUrlFormat = Url.HttpRouteUrl(null, new { controller = "ActivityTypes", action = "Put", activityId = 0, activityTypeId = 1 });
                                if (typePutUrlFormat != null)
                                {
                                    typePutUrlFormat = typePutUrlFormat.Replace("0", "{0}").Replace("1", "{1}");
                                }
                                var typeDeleteUrlFormat = Url.HttpRouteUrl(null, new { controller = "ActivityTypes", action = "Delete", activityId = 0, activityTypeId = 1 });
                                if (typeDeleteUrlFormat != null)
                                {
                                    typeDeleteUrlFormat = typeDeleteUrlFormat.Replace("0", "{0}").Replace("1", "{1}");
                                }
                                var establishmentNameGetUrlFormat = Url.HttpRouteUrl(null, new { controller = "EstablishmentNames", action = "GetByKeyword" });
                                var tagPostUrlFormat = Url.HttpRouteUrl(null, new { controller = "ActivityTags", action = "Post", activityId = 0 });
                                if (tagPostUrlFormat != null)
                                {
                                    tagPostUrlFormat = tagPostUrlFormat.Replace("0", "{0}");
                                }
                                var tagDeleteUrlFormat = Url.HttpRouteUrl(null, new { controller = "ActivityTags", action = "Delete", activityId = 0 });
                                if (tagDeleteUrlFormat != null)
                                {
                                    tagDeleteUrlFormat = tagDeleteUrlFormat.Replace("0", "{0}");
                                }
                            }
                            <span id="place_put_url_format">@placePutUrlFormat</span>
                            <span id="place_delete_url_format">@placeDeleteUrlFormat</span>
                            <span id="type_put_url_format">@typePutUrlFormat</span>
                            <span id="type_delete_url_format">@typeDeleteUrlFormat</span>
                            <span id="establishment_names_get_url_format">@establishmentNameGetUrlFormat</span>
                            <span id="tag_post_url_format">@tagPostUrlFormat</span>
                            <span id="tag_delete_url_format">@tagDeleteUrlFormat</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@* JQUERY DIALOGS *@
<div id="documentRenameErrorDialog" class="dialog" title="Error Renaming Document">
    <span id="message" style="float: left"></span>
</div>

<div id="cancelConfirmDialog" class="dialog" title="Please confirm your intent">
    <div>
        Are you sure you want to cancel editing this Activity? You will lose all of your changes since your last save or publish.
    </div>
    <div class="spinner" style="visibility: hidden; margin-top: 8px;">
        <img src="@Url.Content("~/images/icons/spinner/spinner-20-blue.gif")" alt="" />
        <strong>Canceling...</strong>
    </div>
</div>

<div id="deleteDocumentConfirmDialog" class="dialog" title="Please confirm your intent">
    <div>
        Are you sure you want to delete this document?
    </div>
    <div class="spinner" style="visibility: hidden; margin-top: 8px;">
        <img src="@Url.Content("~/images/icons/spinner/spinner-20-blue.gif")" alt="" />
        <strong>Deleting document...</strong>
    </div>
</div>

<div id="activityBeingEditedDialog" class="dialog" title="Error Renaming Document">
    <span style="font-weight: bold">The activity cannot be edited at this time because it is in use by:</span>
    <div id="editingUserName" style="text-align: center"></div>
    <a id="editingUserEmail" style="text-align: center"></a>
</div>


@* KNOCKOUT TEMPLATES *@

<script type="text/html" id="activity-types-template">
    <li>
        <label>
            <input type="checkbox" style="margin-right: 4px; margin-left: 4px" data-bind="checked: checked" /><span data-bind="    text: text"></span>
        </label>
    </li>
</script>

<script type="text/html" id="tags-template">
    <li style="float: left; margin: 0 2px 2px 0;">
        <div style="display: inline-block; padding: 5px 6px 5px 8px; background-color: #eee; border: solid 1px #ddd;">
            <span>
                <span data-bind="text: text"></span>
                <a href="/#" data-bind="click: function (item) { $parent.deleteTag(item); }" title="Remove tag" style="margin-left: 8px;">
                    <img src="@Links.images.icons.minus.minus_20_red_png" alt="Remove tag" style="vertical-align: middle;" /></a>
            </span>
        </div>
    </li>
</script>

<script type="text/html" id="activity-document-template">
    <tr class="hover-hilite" style="white-space: normal">
        <!-- Preview -->
        <td style="text-align: center">
            <img alt="thumbnail" data-bind="attr: { src: proxyImageSource }">
        </td>
        <!-- Title -->
        <td>
            <span style="display: inline"
                id="documentTitle"
                data-bind="text: title, click: function (item, event) { $parent.startDocumentTitleEdit(item, event); }"></span>
            <input type="text"
                id="documentTitleInput"
                style="display: none"
                data-bind="value: title" />
        </td>
        <!-- Type -->
        <td style="text-align: center">
            <span data-bind="text: extension"></span>
        </td>
        <!-- Size -->
        <td style="text-align: center">
            <span data-bind="text: size"></span>
        </td>
        <!-- Remove Button -->
        <td style="text-align: center; vertical-align: middle">
            <a href="#" title="Delete this document" data-bind="click: function (item, index) { $parent.deleteDocument(item, $index()); }, clickBubble: false">
                <img src="@Links.images.icons.minus.minus_24_red_png" alt="Delete this document" />
            </a>
        </td>
    </tr>
</script>

<script type="text/html" id="buttons-template">
    <span>
        <input type="button" value="Save as Draft" data-bind="click: saveDraft" />
        <input type="button" value="Publish" data-bind="click: publish" />
        <input type="button" value="Guide Me" style="margin-left: 50px" />
        <span style="margin-left: 50px" data-bind="visible: saveSpinner.isVisible()">
            <img src="@Url.Content("~/images/icons/spinner/spinner-20-blue.gif")" alt="" />
            <strong>Saving...</strong>
        </span>
        <input type="button" value="Cancel" style="float: right" data-bind="click: cancel" />
    </span>
</script>

